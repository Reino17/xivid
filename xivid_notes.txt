--------------------------------
Xivid notities
--------------------------------

[Reeksen en positionering]

$ xidel -se 'join(1 to 10)'
$ xidel -se 'join(for $x in 1 to 10 return $x)'
1 2 3 4 5 6 7 8 9 10

$ xidel -se 'join((1 to 10) ! .[. mod 2 eq 1])'
$ xidel -se 'join(for $x in 1 to 10 where $x mod 2 eq 1 return $x)
1 3 5 7 9

$ xidel -se 'join((1 to 10) ! .[. mod 2 eq 0])'
$ xidel -se 'join(for $x in 1 to 10 where $x mod 2 eq 0 return $x)'
2 4 6 8 10

$ xidel -se 'join((65 to 74) ! codepoints-to-string(.))'
$ xidel -se 'join((65 to 74) ! x:cps(.))'
$ xidel -se 'join(for $x in 65 to 74 return x:cps($x))'
A B C D E F G H I J

------------------------------------------------------------------------------------------------

$ xidel -se 'let $a:=(65 to 74) ! x:cps(.) return join($a)'
A B C D E F G H I J

$ xidel -se 'let $a:=(65 to 74) ! x:cps(.) return $a[1]'
$ xidel -se 'let $a:=(65 to 74) ! x:cps(.) return head($a)'
A

$ xidel -se 'let $a:=(65 to 74) ! x:cps(.) return $a[10]'
$ xidel -se 'let $a:=(65 to 74) ! x:cps(.) return $a[last()]'
J

$ xidel -se 'let $a:=(65 to 74) ! x:cps(.) return join(tail($a))'
$ xidel -se 'let $a:=(65 to 74) ! x:cps(.) return join($a[position() gt 1])'
$ xidel -se 'let $a:=(65 to 74) ! x:cps(.) return join(subsequence($a,2))'
B C D E F G H I J

$ xidel -se 'let $a:=(65 to 74) ! x:cps(.) return join($a[position() lt last()])'
$ xidel -se 'let $a:=(65 to 74) ! x:cps(.) return join($a[position() lt 10])'
$ xidel -se 'let $a:=(65 to 74) ! x:cps(.) return join(subsequence($a,1,count($a) - 1))'
A B C D E F G H I

$ xidel -se 'let $a:=(65 to 74) ! x:cps(.) return join($a[position() ne 5])'
$ xidel -se 'let $a:=(65 to 74) ! x:cps(.) return join(remove($a,5))'
A B C D F G H I J

$ xidel -se 'let $a:=(65 to 74) ! x:cps(.) return join($a[position() gt 3][position() lt 5])'
$ xidel -se 'let $a:=(65 to 74) ! x:cps(.) return join($a[position() = 4 to 7])'
$ xidel -se 'let $a:=(65 to 74) ! x:cps(.) return join(subsequence($a,4,4))'
D E F G

$ xidel -se 'let $a:=(65 to 74) ! x:cps(.) return join($a[position() mod 2 eq 1])'
A C E G I

$ xidel -se 'let $a:=(65 to 74) ! x:cps(.) return join($a[position() mod 2 eq 0])'
B D F H J

$ xidel -se 'let $a:=(65 to 74) ! x:cps(.) return join(reverse($a))'
J I H G F E D C B A

$ xidel -se 'let $a:=1 to 10 return (join($a),join($a ! x:cps(. + 64)),join(reverse($a)),join(reverse($a) ! x:cps(. + 64)))'
1 2 3 4 5 6 7 8 9 10
A B C D E F G H I J
10 9 8 7 6 5 4 3 2 1
J I H G F E D C B A

================================================================================================

[JSON filtering and selection]

$ xidel -se '
  let $a:={"a":1,"b":2} return (
    {"foo":{"bar":$a/c}},
    {"foo":{"bar":$a/c}[bar]},
    {"foo":{"bar1"?:$a/a,"bar2"?:$a/b,"bar3"?:$a/c}},
    {"foo":{"bar1"?:$a/a,"bar2"?:$a/c}},
    {"foo":{"bar"?:$a/c}},
    {"foo":array{{"bar":$a/a},{"bar":$a/b},{"bar":$a/c}[bar]}},
    {"foo":array{{"bar":$a/a},{"bar":$a/c}[bar]}},
    {"foo":array{{"bar":$a/c}[bar]}},
    {"foo":({"bar":$a/a},{"bar":$a/b},{"bar":$a/c}[bar])},
    {"foo":({"bar":$a/a},{"bar":$a/c}[bar])},
    {"foo":({"bar":$a/c}[bar])},
    {"foo":({"bar":$a/a},{"bar":$a/b},{"bar":$a/c}[bar]) ! [.]},
    {"foo":({"bar":$a/a},{"bar":$a/c}[bar]) ! [.]},
    {"foo":({"bar":$a/c}[bar]) ! [.]},
    {"foo":let $b:=({"bar":$a/a},{"bar":$a/b},{"bar":$a/c}[bar]) return array{$b}},
    {"foo":let $b:=({"bar":$a/a},{"bar":$a/c}[bar]) return array{$b}},
    {"foo":let $b:=({"bar":$a/c}[bar]) return array{$b}},
    {"foo":let $b:=({"bar":$a/a},{"bar":$a/b},{"bar":$a/c}[bar]) return array{$b}[exists($b)]},
    {"foo":let $b:=({"bar":$a/a},{"bar":$a/c}[bar]) return array{$b}[exists($b)]},
    {"foo":let $b:=({"bar":$a/c}[bar]) return array{$b}[exists($b)]}
  )
' --printed-json-format=compact
{"foo": {"bar": null}}
{"foo": null}                           # [bar] evalueert naar null, waardoor het hele object verdwijnt.
{"foo": {"bar1": 1, "bar2": 2}}         # ? is "optional pair".
{"foo": {"bar1": 1}}
{"foo": {}}                             # Geen attribute-value-pair? Dan krijg je een leeg object.
{"foo": [{"bar": 1}, {"bar": 2}]}
{"foo": [{"bar": 1}]}
{"foo": []}                             # Met blokhaken krijg je zonder één object een lege array.
{"foo": [{"bar": 1}, {"bar": 2}]}       # Met haakjes evalueert de reeks automatisch tot array.
{"foo": {"bar": 1}}                     # De reeks, uiteindelijk één object, blijft ook een object.
{"foo": null}
{"foo": [[{"bar": 1}], [{"bar": 2}]]}   # Elk object van de reeks wordt een array en dit evalueert tot weer een array.
{"foo": [{"bar": 1}]}
{"foo": null}
{"foo": [{"bar": 1}, {"bar": 2}]}       # De hele reeks wordt een array.
{"foo": [{"bar": 1}]}
{"foo": []}                             # Zonder te controleren of $b minimaal één object heeft krijg je weer een lege array.
{"foo": [{"bar": 1}, {"bar": 2}]}
{"foo": [{"bar": 1}]}
{"foo": null}                           # De enige manier voor de eis "Eén of meerdere objecten? Array. Nul objecten? null.

------------------------------------------------------------------------------------------------

$ xidel -se '
  let $a:={"a":1,"b":2},
      $b:={"a":"x","b":"y"}
  return (
    {"foo":$a[b]/{"bar":b}},
    {"foo":$a[exists(b)]/{"bar":b}},
    {"foo":$b[b]/{"bar":b}},
    {"foo":$b[exists(b)]/{"bar":b}},
    {"foo":$a[c]/{"bar":c}},
    {"foo":$b[c]/{"bar":c}}
  )
' --printed-json-format=compact
{"foo": null}                           # $a[b] evalueert naar $a[2], maar er is geen 2e object, dus krijg je null.
{"foo": {"bar": 2}}                     # Als de waarde van het attribuut dat je checkt een integer is, dan is exists() vereist.
{"foo": {"bar": "y"}}                   # $b/b is een string en dus is exists() niet vereist.
{"foo": {"bar": "y"}}
{"foo": null}
{"foo": null}

------------------------------------------------------------------------------------------------

$ echo '{"a":null}' | xidel -se '
  $json/join((exists(a),a)),
  jn:parse-json($raw)/join((exists(a),a)),
  parse-json($raw)/join((exists(a),a))
'
false
true null
false

$ echo '{"a":null}' | xidel --json-mode=deprecated -se '
  $json/join((exists(a),a)),
  jn:parse-json($raw)/join((exists(a),a)),
  parse-json($raw)/join((exists(a),a))
'
true null
true null
false

$ echo '{"a":null,"b":"foo"}' | xidel -se '$json/concat((a,b),"bar")'
$ echo '{"a":null,"b":"foo"}' | xidel -se 'parse-json($raw)/concat((a,b),"bar")'
$ echo '{"a":null,"b":"foo"}' | xidel -se 'jn:parse-json($raw)/concat((a,b)[.],"bar")'
$ echo '{"a":null,"b":"foo"}' | xidel --json-mode=deprecated -se '$json/concat((a,b)[.],"bar")'
$ echo '{"a":null,"b":"foo"}' | xidel --json-mode=deprecated -se 'parse-json($raw)/concat((a,b),"bar")'
foobar

$ echo '{"a":null,"b":"foo"}' | xidel --json-mode=deprecated -se '$json/concat((a,b),"bar")'
$ echo '{"a":null,"b":"foo"}' | xidel -se 'jn:parse-json($raw)/concat((a,b),"bar")'
Error:
err:XPTY0004: Invalid conversion from (null, "foo") to type singleton

------------------------------------------------------------------------------------------------

$ xidel -se 'let $a:={"a":1,"b":{"c":2}} return $a[b]/b' --printed-json-format=compact   # xidel-0.9.9-7580-9cac3c1
{"c": 2}

$ xidel -se 'let $a:={"a":1,"b":{"c":2}} return $a[b]/b' --printed-json-format=compact   # xidel-0.9.9-7622-1650cd0
Error:
err:FORG0006: Object cannot be used as boolean:
{"c": 2}

$ xidel -se 'let $a:={"a":1,"b":{"c":2}} return $a[exists(b)]/b' --printed-json-format=compact   # xidel-0.9.9-7622-1650cd0
{"c": 2}

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

$ xidel -se 'let $a:=array{{"a":1},{"b":2}} return if ($a(2)) then $a(2) else ()' --printed-json-format=compact   # xidel-0.9.9-7580-9cac3c1
{"b": 2}

$ xidel -se 'let $a:=array{{"a":1},{"b":2}} return if ($a(2)) then $a(2) else ()' --printed-json-format=compact   # xidel-0.9.9-7622-1650cd0
Error:
err:FORG0006: Object cannot be used as boolean:
{"b": 2}

$ xidel -se 'let $a:=array{{"a":1},{"b":2}} return if (exists($a(2))) then $a(2) else ()' --printed-json-format=compact   # xidel-0.9.9-7622-1650cd0
{"b": 2}

================================================================================================

[Base conversions]

Decimal     (Base 10)    31 = (3*10^1)+(1*10^0)                       = 30+1       = 31
Binary      (Base  2) 11111 = (1*2^4)+(1*2^3)+(1*2^2)+(1*2^1)+(1*2^0) = 16+8+4+2+1 = 31
Hexadecimal (Base 16)    1F = (1*16^1)+(15*16^0)                      = 16+15      = 31

Dec to Bin/Hex:

$ xidel -se 'x:integer-to-base(31,2)'
11111

$ xidel -se 'x:integer-to-base(31,16)'
1F

Bin/Hex to Dec:

$ xidel -se 'x:integer("11111",2)'
$ xidel -se 'x:integer("0b11111")'
31

$ xidel -se 'x:integer("1F",16)'
$ xidel -se 'x:integer("0x1F")'
31

Bin to Hex:

$ xidel -se 'x:integer-to-base(x:integer("11111",2),16)'
$ xidel -se 'x:integer-to-base(x:integer("0b11111"),16)'
1F

Hex to Bin:

$ xidel -se 'x:integer-to-base(x:integer("1F",16),2)'
$ xidel -se 'x:integer-to-base(x:integer("0x1F"),2)'
11111

------------------------------------------------------------------------------------------------

Unsigned (32bit) Hex to Dec:

xidel -se "x:integer('0xffffff88')"
4294967176

Signed (32bit) Hex to Dec:

https://www.digital-detective.net/manual-identification-of-suspect-computer-time-zone-2/
http://core.ecu.edu/csci/wirthj/Basen/signBin-c.html
https://stackoverflow.com/q/5826818
https://stackoverflow.com/q/33629416

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

Check of de hoeveelheid bits groter is dan 31:

- Tel het aantal bits.

  $ xidel -se 'x:integer-to-base(x:integer("0xffffff88"),2)'
  11111111111111111111111110001000

  $ xidel -se 'string-length(x:integer-to-base(x:integer("0xffffff88"),2))'
  32

- Converteer als unsigned 32bit Hex en trek daar 2^(aantal bits) van af.

  $ xidel -se 'math:pow(2,string-length(x:integer-to-base(x:integer("0xffffff88"),2)))'
  4.294967296E9

  $ xidel -se 'integer(math:pow(2,string-length(x:integer-to-base(x:integer("0xffffff88"),2))))'
  4294967296

  $ xidel -se 'let $a:=x:integer("0xffffff88") return $a - integer(math:pow(2,string-length(x:integer-to-base($a,2))))'
  -120

- Dit geldt alleen voor 0x80000000 en hoger. Converteer 0x7fffffff en lager als unsigned 32bit Hex!

  $ xidel -se 'x:integer-to-base(x:integer("0x80000000"),2)'
  10000000000000000000000000000000

  $ xidel -se 'x:integer-to-base(x:integer("0x7fffffff"),2)'
  1111111111111111111111111111111

  $ xidel -se 'let $a:=x:integer("0x80000000"),$b:=x:integer-to-base($a,2) return if (string-length($b) gt 31) then $a - integer(math:pow(2,string-length($b))) else $a'
  -2147483648

  $ xidel -se 'let $a:=x:integer("0x7fffffff"),$b:=x:integer-to-base($a,2) return if (string-length($b) gt 31) then $a - integer(math:pow(2,string-length($b))) else $a'
  2147483647   # 2^31

  $ xidel -se 'let $a:=x:integer("0xffffff88"),$b:=x:integer-to-base($a,2) return if (string-length($b) gt 31) then $a - integer(math:pow(2,string-length($b))) else $a'
  -120

$ time xidel -se 'declare function local:shex-to-dec($shex as string) as integer {let $a:=x:integer($shex),$b:=x:integer-to-base($a,2) return if (string-length($b) gt 31) then $a - integer(math:pow(2,string-length($b))) else $a}; ((1 to 100000) ! local:shex-to-dec("0xffffff88"))[1]'
-120

real    0m30.359s
user    0m0.015s
sys     0m0.015s

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

Check of de decimale waarde groter is dan 2^31:

- Tel het aantal bits.

  $ xidel -se '(string-length("0xffffff88") - 2) * 4'
  $ xidel -se 'string-length("ffffff88") * 4'
  32

  x4, want F_16 is 1111_2 (4 bits):
  $ xidel -se 'x:integer-to-base(x:integer("0xf"),2)'
  1111

- Converteer als unsigned 32bit Hex en trek daar 2^(aantal bits) van af.

  $ xidel -se 'math:pow(2,(string-length("0xffffff88") - 2) * 4)'
  4.294967296E9

  $ xidel -se 'integer(math:pow(2,(string-length("0xffffff88") - 2) * 4))'
  4294967296

  $ xidel -se 'x:integer("0xffffff88") - integer(math:pow(2,(string-length("0xffffff88") - 2) * 4))'
  -120

- Dit geldt alleen voor 0x80000000 en hoger. Converteer 0x7fffffff en lager als unsigned 32bit Hex!

  $ xidel -se 'x:integer("0x80000000")'
  2147483648

  $ xidel -se 'integer(math:pow(2,(string-length("0x80000000") - 2) * 4 - 1))'
  2147483648   # 2^31

  $ xidel -se 'integer(math:pow(2,(string-length("0x80000000") - 2) * 4)) div 2'
  2147483648

  $ xidel -se 'let $a:=x:integer("0x80000000"),$b:=integer(math:pow(2,(string-length("0x80000000") - 2) * 4)) return if ($a gt $b div 2) then $a - $b else $a'
  -2147483648

  $ xidel -se 'let $a:=x:integer("0x7fffffff"),$b:=integer(math:pow(2,(string-length("0x7fffffff") - 2) * 4)) return if ($a gt $b div 2) then $a - $b else $a'
  2147483647

  $ xidel -se 'let $a:=x:integer("0xffffff88"),$b:=integer(math:pow(2,(string-length("0xffffff88") - 2) * 4)) return if ($a gt $b div 2) then $a - $b else $a'
  -120

$ time xidel -se 'declare function local:shex-to-dec($shex as string) as integer {let $a:=x:integer($shex),$b:=integer(math:pow(2,(string-length($shex) - 2) * 4)) return if ($a gt $b div 2) then $a - $b else $a}; ((1 to 100000) ! local:shex-to-dec("0xffffff88"))[1]'
-120

real    0m4.813s   # Veel snellere methode!
user    0m0.015s
sys     0m0.015s

declare function xivid:shex-to-dec($shex as string) as integer {
  let $a:=x:integer($shex),
      $b:=integer(math:pow(2,(string-length($shex) - 2) * 4))
  return
  if ($a gt $b div 2) then
    $a - $b
  else
    $a
};

------------------------------------------------------------------------------------------------

Genereer een willekeurig 128bit hexadecimaal getal:

$ xidel -se 'join((1 to 32))'
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32

$ xidel -se 'random-seed(),join((1 to 32) ! random(16))'
8 5 3 4 15 0 13 7 15 2 7 3 13 1 10 8 6 7 11 5 5 8 9 3 11 5 5 1 10 8 0 1

$ xidel -se 'random-seed(),join((1 to 32) ! x:integer-to-base(random(16),16))'
8 5 3 4 F 0 D 7 F 2 7 3 D 1 A 8 6 7 B 5 5 8 9 3 B 5 5 1 A 8 0 1

$ xidel -se 'random-seed(),string-join((1 to 32) ! x:integer-to-base(random(16),16))'
8534F0D7F273D1A867B55893B551A801

------------------------------------------------------------------------------------------------

Base64:

https://en.wikipedia.org/wiki/Base64

$ xidel -se 'string-to-base64Binary("Xivid")'
WGl2aWQ=

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

String to Base64 (zonder string-to-base64Binary() ):

----------------------------------------------------------------

Base64 tekens:

$ xidel -se 'string-join((for $x in (65 to 90,97 to 122,48 to 57) return x:cps($x),"+","/"))'
ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/
|        65 t/m 90       ||        97 t/m 122      ||48 t/m57|     # Codepoints in ASCII tabel.
0                                                              63  # 64 tekens, range: 0-63.

Principe:

X        i        v        i        d                  # van teken
88       105      118      105      100                # naar codepoint/decimaal
01011000 01101001 01110110 01101001 01100100           # naar binair
010110 000110 100101 110110 011010 010110 0100[00]     # opdelen in groepjes van 6 bits
22     6      37     54     26     22     16           # naar decimaal/codepoint
W      G      l      2      a      W      Q        =   # naar base64 met eventuele padding

----------------------------------------------------------------

$ xidel -se 'join(string-to-codepoints("Xivid"))'
$ xidel -se 'join(x:cps("Xivid"))'
88 105 118 105 100

$ xidel -se 'join(x:cps("Xivid") ! ("0"||x:integer-to-base(.,2)))'
01011000 01101001 01110110 01101001 01100100

$ xidel -se 'string-join(x:cps("Xivid") ! ("0"||x:integer-to-base(.,2)))'
0101100001101001011101100110100101100100

Deze string moet opgedeeld worden in substrings met een lengte van 6 tekens.

$ xidel -se 'let $bin:=string-join(x:cps("Xivid") ! ("0"||x:integer-to-base(.,2))) return substring($bin,1,6)'
010110

$ xidel -se 'let $bin:=string-join(x:cps("Xivid") ! ("0"||x:integer-to-base(.,2))) return substring($bin,37,6)'
0100

Dus opdelen op de indexes 1, 7, 13, 19, 25, 31, 37.

$ xidel -se 'let $bin:=string-join(x:cps("Xivid") ! ("0"||x:integer-to-base(.,2))) return join((1 to string-length($bin)) ! .[. mod 6 eq 1])'
$ xidel -se 'let $bin:=string-join(x:cps("Xivid") ! ("0"||x:integer-to-base(.,2))) return join(for $x in 1 to string-length($bin) where $x mod 6 eq 1 return $x)'
1 7 13 19 25 31 37

$ xidel -se 'join(let $bin:=string-join(x:cps("Xivid") ! ("0"||x:integer-to-base(.,2))) for $x in 1 to string-length($bin) where $x mod 6 eq 1 return substring($bin,$x,6))'
010110 000110 100101 110110 011010 010110 0100

De binaire getallen dienen altijd 6 bits te bevatten.

$ xidel -se 'join(let $bin:=string-join(x:cps("Xivid") ! ("0"||x:integer-to-base(.,2))) for $x in 1 to string-length($bin) where $x mod 6 eq 1 let $a:=substring($bin,$x,6) return substring($a||"0000",1,6))'
010110 000110 100101 110110 011010 010110 010000

De extra nullen worden later als padding (=) toegevoegd. 00 wordt =, 0000 wordt ==.

$ xidel -se 'join(let $bin:=string-join(x:cps("Xivid") ! ("0"||x:integer-to-base(.,2))) for $x in 1 to string-length($bin) where $x mod 6 eq 1 let $a:=substring($bin,$x,6) return string-length($a))'
6 6 6 6 6 6 4

$ xidel -se 'join(let $bin:=string-join(x:cps("Xivid") ! ("0"||x:integer-to-base(.,2))) for $x in 1 to string-length($bin) where $x mod 6 eq 1 let $a:=substring($bin,$x,6) return (1 to (6 - string-length($a)[. ne 6]) div 2) ! "=")'
=

$ xidel -se 'join(let $bin:=string-join(x:cps("Xivid") ! ("0"||x:integer-to-base(.,2))) for $x in 1 to string-length($bin) where $x mod 6 eq 1 let $a:=substring($bin,$x,6) return (substring($a||"0000",1,6),(1 to (6 - string-length($a)[. ne 6]) div 2) ! "="))'
010110 000110 100101 110110 011010 010110 010000 =

$ xidel -se 'join(let $bin:=string-join(x:cps("Xivid") ! ("0"||x:integer-to-base(.,2))) for $x in 1 to string-length($bin) where $x mod 6 eq 1 let $a:=substring($bin,$x,6) return (x:integer(substring($a||"0000",1,6),2),(1 to (6 - string-length($a)[. ne 6]) div 2) ! "="))'
22 6 37 54 26 22 16 =

$ xidel -se 'join(let $base64:=(for $x in (65 to 90,97 to 122,48 to 57) return codepoints-to-string($x),"+","/"),$bin:=string-join(x:cps("Xivid") ! ("0"||x:integer-to-base(.,2))) for $x in 1 to string-length($bin) where $x mod 6 eq 1 let $a:=substring($bin,$x,6) return ($base64[x:integer(substring($a||"0000",1,6),2) + 1],(1 to (6 - string-length($a)[. ne 6]) div 2) ! "="))'
W G l 2 a W Q =

$ xidel -se 'string-join(let $base64:=(for $x in (65 to 90,97 to 122,48 to 57) return codepoints-to-string($x),"+","/"),$bin:=string-join(x:cps("Xivid") ! ("0"||x:integer-to-base(.,2))) for $x in 1 to string-length($bin) where $x mod 6 eq 1 let $a:=substring($bin,$x,6) return ($base64[x:integer(substring($a||"0000",1,6),2) + 1],(1 to (6 - string-length($a)[. ne 6]) div 2) ! "="))'
WGl2aWQ=

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

Base64 to string:

$ xidel -se 'binary-to-string(base64Binary("WGl2aWQ="))'
Xivid

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

File to Base64:

$ xidel -se 'file:read-binary("nl.png")'   # Nederlandse vlag van 18 bij 12 pixels.
iVBORw0KGgoAAAANSUhEUgAAABIAAAAMCAIAAADgcHrrAAAAG0lEQVQoz2P4z8BABmIYGtrIAkND21CJAjIQAF2WZqj5EZlfAAAAAElFTkSuQmCC

File to Base64 (html):

$ xidel -se 'concat("<img src=&quot;data:image/png;base64,",file:read-binary("nl.png"),"&quot;>")'
<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABIAAAAMCAIAAADgcHrrAAAAG0lEQVQoz2P4z8BABmIYGtrIAkND21CJAjIQAF2WZqj5EZlfAAAAAElFTkSuQmCC">

Base64 to file:

$ xidel -se 'file:write-binary("nl.png",base64Binary("iVBORw0KGgoAAAANSUhEUgAAABIAAAAMCAIAAADgcHrrAAAAG0lEQVQoz2P4z8BABmIYGtrIAkND21CJAjIQAF2WZqj5EZlfAAAAAElFTkSuQmCC"))'

================================================================================================

[Exclusieve disjunctie (exclusive or / xor)]

Zolang Xidel de "EXPath Binary Module" (met bin:xor()) niet aan boord heeft is een zelfgemaakte functie nodig.
Zie https://github.com/benibela/xidel/issues/54.

$ echo $((33 ^ 73))
104

$ xidel -se 'let $a:=33,$b:=73 return system(x"bash -c ""printf $(({$a} ^ {$b}))""")'
104

33_10  = 0100001_2
73_10  = 1001001_2
         ------- XOR
104_10 = 1101000_2   # Output is alleen 1 als input 0 én 1 of 1 én 0 is.

$ xidel -se '(33,73) ! x:integer-to-base(.,2)'
100001
1001001

$ xidel -se 'let $bin:=(33,73) ! x:integer-to-base(.,2) return $bin ! string-length()'
6
7

$ xidel -se 'let $bin:=(33,73) ! x:integer-to-base(.,2) return max($bin ! string-length())'
7

$ xidel -se 'let $bin:=(33,73) ! x:integer-to-base(.,2),$len:=max($bin ! string-length()) return $bin ! concat(string-join((1 to $len - string-length()) ! 0),.)'
0100001
1001001

$ xidel -se 'let $bin:=(33,73) ! x:integer-to-base(.,2),$len:=max($bin ! string-length()),$val:=$bin ! concat(string-join((1 to $len - string-length()) ! 0),.) return string-join(for $x in 1 to $len return if (substring($val[1],$x,1) eq substring($val[2],$x,1)) then 0 else 1)'
1101000

$ xidel -se 'let $bin:=(33,73) ! x:integer-to-base(.,2),$len:=max($bin ! string-length()),$val:=$bin ! concat(string-join((1 to $len - string-length()) ! 0),.) return x:integer(string-join(for $x in 1 to $len return if (substring($val[1],$x,1) eq substring($val[2],$x,1)) then 0 else 1),2)'
104

$ xidel -se 'declare function local:bin-xor($a,$b){let $bin:=($a,$b) ! x:integer-to-base(.,2),$len:=max($bin ! string-length()),$val:=$bin ! concat(string-join((1 to $len - string-length()) ! 0),.) return x:integer(string-join(for $x in 1 to $len return if (substring($val[1],$x,1) eq substring($val[2],$x,1)) then 0 else 1),2)}; local:bin-xor(33,73)'
104

------------------------------------------------------------------------------------------------

$ time xidel -se 'declare function local:bin-xor($a,$b){let $bin:=($a,$b) ! x:integer-to-base(.,2),$len:=max($bin ! string-length()),$val:=$bin ! concat(string-join((1 to $len - string-length()) ! 0),.) return x:integer(string-join(for $x in 1 to $len return if (substring($val[1],$x,1) eq substring($val[2],$x,1)) then 0 else 1),2)}; ((1 to 100000) ! local:bin-xor(33,73))[1]'
104

real    0m25.563s
user    0m0.015s
sys     0m0.015s

$ time xidel -se 'declare function local:bin-xor($a,$b){let $bin:=($a,$b) ! x:integer-to-base(.,2),$len:=max($bin ! string-length()),$val:=$bin ! concat(string-join((1 to $len - string-length()) ! 0),.),$v1:=$val[1],$v2:=$val[2] return x:integer(string-join(for $x in 1 to $len return if (substring($v1,$x,1) eq substring($v2,$x,1)) then 0 else 1),2)}; ((1 to 100000) ! local:bin-xor(33,73))[1]'
104

real    0m23.109s
user    0m0.015s
sys     0m0.000s

let $v1:=$val[1] return substring($v1,$x,1)
...is dus iets sneller dan...
substring($val[1],$x,1)

------------------------------------------------------------------------------------------------

declare function xivid:bin-xor($a as integer,$b as integer) as integer {
  let $bin:=($a,$b) ! x:integer-to-base(.,2),
      $len:=max($bin ! string-length()),
      $val:=$bin ! concat(
        string-join((1 to $len - string-length()) ! 0),
        .
      ),
      $v1:=$val[1],
      $v2:=$val[2]
  return
  x:integer(
    string-join(
      for $x in 1 to $len return
      if (substring($v1,$x,1) eq substring($v2,$x,1)) then 0 else 1
    ),
    2
  )
};

================================================================================================

[Codepoints en tekensets]

https://nl.wikipedia.org/wiki/ASCII_%28tekenset%29
https://nl.wikipedia.org/wiki/ISO_8859-1
https://en.wikipedia.org/wiki/Control_character

ASCII 7bit (2^7=128), 0 t/m 127:

- 0 t/m 127 in 16 rijen van 8.

  $ xidel -se '(0 to 15) ! join(for $x in 0 to 127 where $x mod 16 eq . return $x)'
  $ xidel -se 'for $x in 0 to 15 return join((0 to 127)[. mod 16 eq $x])'
  $ xidel -se 'for $x in 0 to 15 return join((0 to 7) ! (. * 16 + $x))'
  $ xidel -se '(0 to 15) ! join(for $x in 0 to 7 return ($x * 16 + .))'
  0 16 32 48 64 80 96 112
  1 17 33 49 65 81 97 113
  2 18 34 50 66 82 98 114
  3 19 35 51 67 83 99 115
  4 20 36 52 68 84 100 116
  5 21 37 53 69 85 101 117
  6 22 38 54 70 86 102 118
  7 23 39 55 71 87 103 119
  8 24 40 56 72 88 104 120
  9 25 41 57 73 89 105 121
  10 26 42 58 74 90 106 122
  11 27 43 59 75 91 107 123
  12 28 44 60 76 92 108 124
  13 29 45 61 77 93 109 125
  14 30 46 62 78 94 110 126
  15 31 47 63 79 95 111 127

- Uitlijnen. I.p.v. if ((. eq 0) or (. eq 1) or ...) then... geeft een vergelijking met een reeks ook een boolean.

  $ xidel -se 'for $x in 0 to 15 return join((0 to 127)[. mod 16 eq $x] ! (if (. = (0 to 9,96 to 99)) then " "||. else .))'
  $ xidel -se 'for $x in 0 to 15 return join((0 to 7) ! (. * 16 + $x) ! (if (. = (0 to 9,96 to 99)) then " "||. else .))'
   0 16 32 48 64 80  96 112
   1 17 33 49 65 81  97 113
   2 18 34 50 66 82  98 114
   3 19 35 51 67 83  99 115
   4 20 36 52 68 84 100 116
   5 21 37 53 69 85 101 117
   6 22 38 54 70 86 102 118
   7 23 39 55 71 87 103 119
   8 24 40 56 72 88 104 120
   9 25 41 57 73 89 105 121
  10 26 42 58 74 90 106 122
  11 27 43 59 75 91 107 123
  12 28 44 60 76 92 108 124
  13 29 45 61 77 93 109 125
  14 30 46 62 78 94 110 126
  15 31 47 63 79 95 111 127

- Hexadecimale getallen erbij, met | als scheiding en een extra 0 voor 0 t/m 9.

  $ xidel -se 'for $x in 0 to 15 return join((0 to 127)[. mod 16 eq $x] ! (concat(if (. = (0 to 9,96 to 99)) then " "||. else .,"|",x:integer-to-base(.,16) ! (if (string-length(.) eq 1) then "0"||. else .))))'
  $ xidel -se 'for $x in 0 to 15 return join((0 to 7) ! (. * 16 + $x) ! (concat(if (. = (0 to 9,96 to 99)) then " "||. else .,"|",x:integer-to-base(.,16) ! (if (string-length(.) eq 1) then "0"||. else .))))'
   0|00 16|10 32|20 48|30 64|40 80|50  96|60 112|70
   1|01 17|11 33|21 49|31 65|41 81|51  97|61 113|71
   2|02 18|12 34|22 50|32 66|42 82|52  98|62 114|72
   3|03 19|13 35|23 51|33 67|43 83|53  99|63 115|73
   4|04 20|14 36|24 52|34 68|44 84|54 100|64 116|74
   5|05 21|15 37|25 53|35 69|45 85|55 101|65 117|75
   6|06 22|16 38|26 54|36 70|46 86|56 102|66 118|76
   7|07 23|17 39|27 55|37 71|47 87|57 103|67 119|77
   8|08 24|18 40|28 56|38 72|48 88|58 104|68 120|78
   9|09 25|19 41|29 57|39 73|49 89|59 105|69 121|79
  10|0A 26|1A 42|2A 58|3A 74|4A 90|5A 106|6A 122|7A
  11|0B 27|1B 43|2B 59|3B 75|4B 91|5B 107|6B 123|7B
  12|0C 28|1C 44|2C 60|3C 76|4C 92|5C 108|6C 124|7C
  13|0D 29|1D 45|2D 61|3D 77|4D 93|5D 109|6D 125|7D
  14|0E 30|1E 46|2E 62|3E 78|4E 94|5E 110|6E 126|7E
  15|0F 31|1F 47|2F 63|3F 79|4F 95|5F 111|6F 127|7F

- Tekens erbij, maar vervang 0, 7, 8, 9, 10 en 13 met spaties, omdat dit beheertekens (control characters) betreft.

  $ xidel -se 'for $x in 0 to 15 return join((0 to 127)[. mod 16 eq $x] ! (concat(if (. = (0 to 9,96 to 99)) then " "||. else .,"|",x:integer-to-base(.,16) ! (if (string-length(.) eq 1) then "0"||. else .)),if (. = (0,7,8,9,10,13)) then " " else x:cps(.)))'
  $ xidel -se 'for $x in 0 to 15 return join((0 to 7) ! (. * 16 + $x) ! (concat(if (. = (0 to 9,96 to 99)) then " "||. else .,"|",x:integer-to-base(.,16) ! (if (string-length(.) eq 1) then "0"||. else .)),if (. = (0,7,8,9,10,13)) then " " else x:cps(.)))'
   0|00   16|10 ► 32|20   48|30 0 64|40 @ 80|50 P  96|60 ` 112|70 p
   1|01 ☺ 17|11 ◄ 33|21 ! 49|31 1 65|41 A 81|51 Q  97|61 a 113|71 q
   2|02 ☻ 18|12 ↕ 34|22 " 50|32 2 66|42 B 82|52 R  98|62 b 114|72 r
   3|03 ♥ 19|13 ‼ 35|23 # 51|33 3 67|43 C 83|53 S  99|63 c 115|73 s
   4|04 ♦ 20|14 ¶ 36|24 $ 52|34 4 68|44 D 84|54 T 100|64 d 116|74 t
   5|05 ♣ 21|15 § 37|25 % 53|35 5 69|45 E 85|55 U 101|65 e 117|75 u
   6|06 ♠ 22|16 ▬ 38|26 & 54|36 6 70|46 F 86|56 V 102|66 f 118|76 v
   7|07   23|17 ↨ 39|27 ' 55|37 7 71|47 G 87|57 W 103|67 g 119|77 w
   8|08   24|18 ↑ 40|28 ( 56|38 8 72|48 H 88|58 X 104|68 h 120|78 x
   9|09   25|19 ↓ 41|29 ) 57|39 9 73|49 I 89|59 Y 105|69 i 121|79 y
  10|0A   26|1A → 42|2A * 58|3A : 74|4A J 90|5A Z 106|6A j 122|7A z
  11|0B ♂ 27|1B ← 43|2B + 59|3B ; 75|4B K 91|5B [ 107|6B k 123|7B {
  12|0C ♀ 28|1C ∟ 44|2C , 60|3C < 76|4C L 92|5C \ 108|6C l 124|7C |
  13|0D   29|1D ↔ 45|2D - 61|3D = 77|4D M 93|5D ] 109|6D m 125|7D }
  14|0E ♫ 30|1E ▲ 46|2E . 62|3E > 78|4E N 94|5E ^ 110|6E n 126|7E ~
  15|0F ☼ 31|1F ▼ 47|2F / 63|3F ? 79|4F O 95|5F _ 111|6F o 127|7F ⌂

ALT+<cp> voor weergave (Windows).   # ALT 1 of ALT 127.
&#<cp>; / &#x<hex> voor HTML.       # &#1; / &#x01; of &#127; / &#x7F;.
\x<hex> voor Javascript.            # \x01 of \x7F.
\u00<hex> voor JSON.                # \u0001 of \u007F.

- De beheertekens (control characters).

 0|NUL \0 &#0;  null
 7|BEL \a &#7;  bell
 8|BS  \b &#8;  backspace
 9|HT  \t &#9;  horizontal tab
10|LF  \n &#10; line feed
13|CR  \r &#13; carriage return

------------------------------------------------------------------------------------------------

Extended ASCII 8bit (2^8=256), 127 t/m 255:

- ISO 8859-1 / Latin-1 / "Unicode" in charmap.exe (Character Map).

  $ xidel -se 'for $x in 0 to 15 return join((128 to 255)[. mod 16 eq $x] ! (concat(.,"|",x:integer-to-base(.,16)),x:cps(.)))' [--output-encoding=oem]
  $ xidel -se 'for $x in 0 to 15 return join((128 to 255)[. mod 16 eq $x] ! (concat(.,"|",x:integer-to-base(.,16)),binary-to-string(xs:hexBinary(x:integer-to-base(.,16)),"latin1")))'
  128|80 ? 144|90 ? 160|A0   176|B0 ° 192|C0 A 208|D0 D 224|E0 à 240|F0 d
  129|81 ? 145|91 ? 161|A1 ¡ 177|B1 ± 193|C1 A 209|D1 Ñ 225|E1 á 241|F1 ñ
  130|82 ? 146|92 ? 162|A2 ¢ 178|B2 ² 194|C2 A 210|D2 O 226|E2 â 242|F2 ò
  131|83 ? 147|93 ? 163|A3 £ 179|B3 3 195|C3 A 211|D3 O 227|E3 a 243|F3 ó
  132|84 ? 148|94 ? 164|A4 ☼ 180|B4 ' 196|C4 Ä 212|D4 O 228|E4 ä 244|F4 ô
  133|85 ? 149|95 ? 165|A5 ¥ 181|B5 µ 197|C5 Å 213|D5 O 229|E5 å 245|F5 o
  134|86 ? 150|96 ? 166|A6 ▌ 182|B6 ¶ 198|C6 Æ 214|D6 Ö 230|E6 æ 246|F6 ö
  135|87 ? 151|97 ? 167|A7 § 183|B7 · 199|C7 Ç 215|D7 x 231|E7 ç 247|F7 ÷
  136|88 ? 152|98 ? 168|A8 " 184|B8 , 200|C8 E 216|D8 O 232|E8 è 248|F8 o
  137|89 ? 153|99 ? 169|A9 c 185|B9 1 201|C9 É 217|D9 U 233|E9 é 249|F9 ù
  138|8A ? 154|9A ? 170|AA ª 186|BA º 202|CA E 218|DA U 234|EA ê 250|FA ú
  139|8B ? 155|9B ? 171|AB « 187|BB » 203|CB E 219|DB U 235|EB ë 251|FB û
  140|8C ? 156|9C ? 172|AC ¬ 188|BC ¼ 204|CC I 220|DC Ü 236|EC ì 252|FC ü
  141|8D ? 157|9D ? 173|AD - 189|BD ½ 205|CD I 221|DD Y 237|ED í 253|FD y
  142|8E ? 158|9E ? 174|AE r 190|BE _ 206|CE I 222|DE _ 238|EE î 254|FE _
  143|8F ? 159|9F ? 175|AF _ 191|BF ¿ 207|CF I 223|DF ß 239|EF ï 255|FF ÿ

  128 t/m 159 zijn beheertekens. ANSI / Windows-1252 / "Windows: Western" in charmap.exe heeft deze vervangen met de volgende grafische tekens:

    128|80 € 144|90 
    129|81   145|91 ‘
    130|82 ‚ 146|92 ’
    131|83 ƒ 147|93 “
    132|84 „ 148|94 ”
    133|85 … 149|95 •
    134|86 † 150|96 –
    135|87 ‡ 151|97 —
    136|88 ˆ 152|98 ˜
    137|89 ‰ 153|99 ™
    138|8A Š 154|9A š
    139|8B ‹ 155|9B ›
    140|8C Œ 156|9C œ
    141|8D   157|9D 
    142|8E Ž 158|9E ž
    143|8F   159|9F Ÿ

  "latin1" heeft ze dus niet, maar het "Raster Fonts" in CMD (en dus Cygwin Bash) ondersteunt ze ook niet.

  Geldige opties voor $encoding: utf8, utf-32le, oem, utf-8, latin1, utf-16, utf-16be, utf-32be, utf-32.

ALT+0<cp> voor weergave (Windows).   # ALT 0163 of ALT 0255.
&#<cp>; / &#x<hex> voor HTML.        # &#163; / &#xA3; of &#255; / &#xFF;.
\x<hex> voor Javascript.             # \xA3 of \xFF.
\u00<hex> voor JSON.                 # \u00A3 of \u00FF.

- Code page 437 / CP437 / OEM-US / "DOS: United States" in charmap.exe.

  $ xidel -se 'for $x in 0 to 15 return join((128 to 255)[. mod 16 eq $x] ! (concat(.,"|",x:integer-to-base(.,16)),x:cps(.)))' --output-encoding=latin1
  $ xidel -se 'for $x in 0 to 15 return join((128 to 255)[. mod 16 eq $x] ! (concat(.,"|",x:integer-to-base(.,16)),binary-to-string(xs:hexBinary(x:integer-to-base(.,16)),"oem")))'
  128|80 Ç 144|90 É 160|A0 á 176|B0 ░ 192|C0 └ 208|D0 ╨ 224|E0 α 240|F0 ≡
  129|81 ü 145|91 æ 161|A1 í 177|B1 ▒ 193|C1 ┴ 209|D1 ╤ 225|E1 ß 241|F1 ±
  130|82 é 146|92 Æ 162|A2 ó 178|B2 ▓ 194|C2 ┬ 210|D2 ╥ 226|E2 Γ 242|F2 ≥
  131|83 â 147|93 ô 163|A3 ú 179|B3 │ 195|C3 ├ 211|D3 ╙ 227|E3 π 243|F3 ≤
  132|84 ä 148|94 ö 164|A4 ñ 180|B4 ┤ 196|C4 ─ 212|D4 ╘ 228|E4 Σ 244|F4 ⌠
  133|85 à 149|95 ò 165|A5 Ñ 181|B5 ╡ 197|C5 ┼ 213|D5 ╒ 229|E5 σ 245|F5 ⌡
  134|86 å 150|96 û 166|A6 ª 182|B6 ╢ 198|C6 ╞ 214|D6 ╓ 230|E6 µ 246|F6 ÷
  135|87 ç 151|97 ù 167|A7 º 183|B7 ╖ 199|C7 ╟ 215|D7 ╫ 231|E7 τ 247|F7 ≈
  136|88 ê 152|98 ÿ 168|A8 ¿ 184|B8 ╕ 200|C8 ╚ 216|D8 ╪ 232|E8 Φ 248|F8 °
  137|89 ë 153|99 Ö 169|A9 ⌐ 185|B9 ╣ 201|C9 ╔ 217|D9 ┘ 233|E9 Θ 249|F9 ∙
  138|8A è 154|9A Ü 170|AA ¬ 186|BA ║ 202|CA ╩ 218|DA ┌ 234|EA Ω 250|FA ·
  139|8B ï 155|9B ¢ 171|AB ½ 187|BB ╗ 203|CB ╦ 219|DB █ 235|EB δ 251|FB √
  140|8C î 156|9C £ 172|AC ¼ 188|BC ╝ 204|CC ╠ 220|DC ▄ 236|EC ∞ 252|FC ⁿ
  141|8D ì 157|9D ¥ 173|AD ¡ 189|BD ╜ 205|CD ═ 221|DD ▌ 237|ED φ 253|FD ²
  142|8E Ä 158|9E ₧ 174|AE « 190|BE ╛ 206|CE ╬ 222|DE ▐ 238|EE ε 254|FE ■
  143|8F Å 159|9F ƒ 175|AF » 191|BF ┐ 207|CF ╧ 223|DF ▀ 239|EF ∩ 255|FF  

  CMD (en dus Cygwin Bash) is standaard afgesteld op CHCP 437 (oem). Hierdoor krijg je dit rare tafereel dat --output-encoding precies andersom werkt.

ALT+<cp> voor weergave (Windows).   # ALT 128 of ALT 253.

$ xidel -se 'for $x in 0 to 31 return join((0 to 7) ! (. * 32 + $x) ! (concat(if (. = (0 to 9,96 to 99)) then " "||. else .,"|",x:integer-to-base(.,16) ! (if (string-length(.) eq 1) then "0"||. else .)),if (. = (0,7,8,9,10,13)) then " " else x:cps(.)))' --output-encoding=latin1
$ xidel -se 'for $x in 0 to 31 return join((0 to 7) ! (. * 32 + $x) ! (concat(if (. = (0 to 9,96 to 99)) then " "||. else .,"|",x:integer-to-base(.,16) ! (substring("0",string-length(.),1)||.)),if (. = (0,7,8,9,10,13)) then " " else x:integer-to-base(.,16) ! binary-to-string(hexBinary(substring("0",string-length(.),1)||.),"oem")))'
 0|00   32|20   64|40 @  96|60 ` 128|80 Ç 160|A0 á 192|C0 └ 224|E0 α
 1|01 ☺ 33|21 ! 65|41 A  97|61 a 129|81 ü 161|A1 í 193|C1 ┴ 225|E1 ß
 2|02 ☻ 34|22 " 66|42 B  98|62 b 130|82 é 162|A2 ó 194|C2 ┬ 226|E2 Γ
 3|03 ♥ 35|23 # 67|43 C  99|63 c 131|83 â 163|A3 ú 195|C3 ├ 227|E3 π
 4|04 ♦ 36|24 $ 68|44 D 100|64 d 132|84 ä 164|A4 ñ 196|C4 ─ 228|E4 Σ
 5|05 ♣ 37|25 % 69|45 E 101|65 e 133|85 à 165|A5 Ñ 197|C5 ┼ 229|E5 σ
 6|06 ♠ 38|26 & 70|46 F 102|66 f 134|86 å 166|A6 ª 198|C6 ╞ 230|E6 µ
 7|07   39|27 ' 71|47 G 103|67 g 135|87 ç 167|A7 º 199|C7 ╟ 231|E7 τ
 8|08   40|28 ( 72|48 H 104|68 h 136|88 ê 168|A8 ¿ 200|C8 ╚ 232|E8 Φ
 9|09   41|29 ) 73|49 I 105|69 i 137|89 ë 169|A9 ⌐ 201|C9 ╔ 233|E9 Θ
10|0A   42|2A * 74|4A J 106|6A j 138|8A è 170|AA ¬ 202|CA ╩ 234|EA Ω
11|0B ♂ 43|2B + 75|4B K 107|6B k 139|8B ï 171|AB ½ 203|CB ╦ 235|EB δ
12|0C ♀ 44|2C , 76|4C L 108|6C l 140|8C î 172|AC ¼ 204|CC ╠ 236|EC ∞
13|0D   45|2D - 77|4D M 109|6D m 141|8D ì 173|AD ¡ 205|CD ═ 237|ED φ
14|0E ♫ 46|2E . 78|4E N 110|6E n 142|8E Ä 174|AE « 206|CE ╬ 238|EE ε
15|0F ☼ 47|2F / 79|4F O 111|6F o 143|8F Å 175|AF » 207|CF ╧ 239|EF ∩
16|10 ► 48|30 0 80|50 P 112|70 p 144|90 É 176|B0 ░ 208|D0 ╨ 240|F0 ≡
17|11 ◄ 49|31 1 81|51 Q 113|71 q 145|91 æ 177|B1 ▒ 209|D1 ╤ 241|F1 ±
18|12 ↕ 50|32 2 82|52 R 114|72 r 146|92 Æ 178|B2 ▓ 210|D2 ╥ 242|F2 ≥
19|13 ‼ 51|33 3 83|53 S 115|73 s 147|93 ô 179|B3 │ 211|D3 ╙ 243|F3 ≤
20|14 ¶ 52|34 4 84|54 T 116|74 t 148|94 ö 180|B4 ┤ 212|D4 ╘ 244|F4 ⌠
21|15 § 53|35 5 85|55 U 117|75 u 149|95 ò 181|B5 ╡ 213|D5 ╒ 245|F5 ⌡
22|16 ▬ 54|36 6 86|56 V 118|76 v 150|96 û 182|B6 ╢ 214|D6 ╓ 246|F6 ÷
23|17 ↨ 55|37 7 87|57 W 119|77 w 151|97 ù 183|B7 ╖ 215|D7 ╫ 247|F7 ≈
24|18 ↑ 56|38 8 88|58 X 120|78 x 152|98 ÿ 184|B8 ╕ 216|D8 ╪ 248|F8 °
25|19 ↓ 57|39 9 89|59 Y 121|79 y 153|99 Ö 185|B9 ╣ 217|D9 ┘ 249|F9 ∙
26|1A → 58|3A : 90|5A Z 122|7A z 154|9A Ü 186|BA ║ 218|DA ┌ 250|FA ·
27|1B ← 59|3B ; 91|5B [ 123|7B { 155|9B ¢ 187|BB ╗ 219|DB █ 251|FB √
28|1C ∟ 60|3C < 92|5C \ 124|7C | 156|9C £ 188|BC ╝ 220|DC ▄ 252|FC ⁿ
29|1D ↔ 61|3D = 93|5D ] 125|7D } 157|9D ¥ 189|BD ╜ 221|DD ▌ 253|FD ²
30|1E ▲ 62|3E > 94|5E ^ 126|7E ~ 158|9E ₧ 190|BE ╛ 222|DE ▐ 254|FE ■
31|1F ▼ 63|3F ? 95|5F _ 127|7F ⌂ 159|9F ƒ 191|BF ┐ 223|DF ▀ 255|FF  

================================================================================================

[Epoch/datum/tijd/tijdzone conversies]

$ date +%:z
+01:00   # UTC+1 (Nederland, wintertijd).

$ xidel -se 'implicit-timezone()'
$ xidel -se 'time("00:00:00") - time("00:00:00'$(date +%:z)'")'   # Vóór xidel-0.9.9.7433-8b7ba70.
PT1H   # Tijdzone als dayTimeDuration().

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

"Unix time (also known as Epoch time, POSIX time, seconds since the Epoch, or UNIX Epoch time) is a system for describing a point in time. It is the number of seconds that have elapsed since the Unix epoch, minus leap seconds; the Unix epoch is 00:00:00 UTC on 1 January 1970" (https://en.wikipedia.org/wiki/Unix_time)

$ date -d @946683000 -u '+%FT%T%:z'
1999-12-31T23:30:00+00:00   # UTC tijd.

$ xidel -se 'duration("PT"||946683000||"S") + dateTime("1970-01-01T00:00:00Z")'
$ xidel -se '946683000 * duration("PT1S") + dateTime("1970-01-01T00:00:00Z")'
1999-12-31T23:30:00Z   # UTC tijd.

$ date -d @946683000 '+%FT%T%:z'
$ xidel -se 'adjust-dateTime-to-timezone(946683000 * duration("PT1S") + implicit-timezone() + dateTime("1970-01-01T00:00:00"))'
$ xidel -se 'adjust-dateTime-to-timezone(946683000 * duration("PT1S") + dateTime("1970-01-01T00:00:00Z"))'
2000-01-01T00:30:00+01:00   # UTC+1 tijd.

$ date -d 2000-01-01T00:30:00+01:00 '+%s'
$ xidel -se '(dateTime("2000-01-01T00:30:00+01:00") - dateTime("1970-01-01T00:00:00") - implicit-timezone()) div dayTimeDuration("PT1S")'
$ xidel -se '(dateTime("2000-01-01T00:30:00+01:00") - dateTime("1970-01-01T00:00:00Z")) div dayTimeDuration("PT1S")'
946683000

Voor een deling is expliciet dayTimeDuration() nodig. Zie https://sourceforge.net/p/videlibri/mailman/videlibri-xidel/thread/7e952f3d-18d5-ede8-17df-8480b2594b7c%40benibela.de/#msg36722060.

$ date -d @946683000 '+%d-%m-%Y'
$ xidel -se 'format-date(adjust-dateTime-to-timezone(946683000 * duration("PT1S") + dateTime("1970-01-01T00:00:00Z")),"[D01]-[M01]-[Y]")'
01-01-2000

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

$ xidel -se '
  adjust-dateTime-to-timezone(dateTime("1999-12-31T23:30:00")),
  adjust-dateTime-to-timezone(dateTime("1999-12-31T23:30:00Z")),
  adjust-dateTime-to-timezone(dateTime("1999-12-31T23:30:00-05:00")),
  adjust-dateTime-to-timezone(dateTime("1999-12-31T23:30:00-05:00"),duration("PT0S")),
  adjust-dateTime-to-timezone(dateTime("1999-12-31T23:30:00-05:00"),duration("PT9H"))
'
1999-12-31T23:30:00+01:00   # Datetime zonder tijdzone wordt beschouwd als lokaal en krijgt alleen de lokale tijdzone er achter.
2000-01-01T00:30:00+01:00   # Datetime met tijdzone wordt geconverteerd naar lokale datetime; UTC+1 (Nederland, wintertijd).
2000-01-01T05:30:00+01:00   # Van UTC−5 (New York) naar UTC+1 (Nederland, wintertijd).
2000-01-01T04:30:00Z        # Van UTC−5 (New York) naar UTC.
2000-01-01T13:30:00+09:00   # Van UTC−5 (New York) naar UTC+9 (Japan).

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

$ xidel -se '
  "'$(date +%FT%T%:z)'",
  "'$(date -u +%FT%T%:z)'",
  current-dateTime(),
  adjust-dateTime-to-timezone(current-dateTime(),duration("PT0S")),
  format-dateTime(current-dateTime(),"[Y]-[M01]-[D01]T[H01]:[m01]:[s01][Z]"),
  format-dateTime(current-dateTime() + duration("PT0.5S"),"[Y]-[M01]-[D01]T[H01]:[m01]:[s01][Z]"),
  format-dateTime(adjust-dateTime-to-timezone(current-dateTime() + duration("PT0.5S"),duration("PT0S")),"[Y]-[M01]-[D01]T[H01]:[m01]:[s01][Z]")
'
2020-12-18T13:53:33+01:00       # Huidige lokale tijd.
2020-12-18T12:53:33+00:00       # Huidige UTC tijd.
2020-12-18T13:53:33.718+01:00   # Huidige lokale tijd.
2020-12-18T12:53:33.718Z        # Huidige UTC tijd.
2020-12-18T13:53:33+01:00       # Huidige lokale tijd, zonder milliseconden.
2020-12-18T13:53:34+01:00       # Huidige lokale tijd, met afgeronde seconden.
2020-12-18T12:53:34+00:00       # Huidige UTC tijd, met afgeronde seconden.

$ xidel -se '
  "'$(date +%s)'",
  (current-dateTime() - dateTime("1970-01-01T00:00:00Z")) div dayTimeDuration("PT1S"),
  round((current-dateTime() - dateTime("1970-01-01T00:00:00Z")) div dayTimeDuration("PT1S"))
'
1608296013
1608296013.718
1608296014

------------------------------------------------------------------------------------------------

Afronden:

$ xidel -se '
  format-time(time("00:19:06.040"),"[H01]:[m01]:[s01]"),
  format-time(time("00:19:06.540"),"[H01]:[m01]:[s01]"),
  format-time(time("00:19:06.540") + duration("PT0.5S"),"[H01]:[m01]:[s01]")
'
00:19:06
00:19:06
00:19:07

------------------------------------------------------------------------------------------------

Zomer-/Wintertijd gecorrigeerde dateTime:

$ xidel -s --module=functx-1.0.1-doc.xq -e 'functx:day-of-week("2020-12-25")'   # http://www.xqueryfunctions.com/xq/functx_day-of-week.html
$ xidel -se 'days-from-duration(date("2020-12-25") - date("1901-01-06")) mod 7'
5   # 0 = zondag, 6 = zaterdag.

$ xidel -se '("zo","ma","di","wo","do","vr","za")[days-from-duration(date("2020-12-25") - date("1901-01-06")) mod 7 + 1]'
$ xidel -se '("zo","ma","di","wo","do","vr","za")[days-from-duration(date("2020-12-25") - date("0000-01-01")) mod 7 + 1]'
vr   # Eerste Kerstdag 2020 was dus op een vrijdag.

functx:day-of-week() gebruikt 1901-01-06, een zondag, als referentiepunt, maar teruggerekend was 1 januari in het jaar 0 ook een zondag.

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

$ xidel -se '(25 to 31)[days-from-duration(date("2020-03-"||.) - date("0000-01-01")) mod 7 eq 0],(25 to 31)[days-from-duration(date("2020-10-"||.) - date("0000-01-01")) mod 7 eq 0]'
$ xidel -se 'for $x in ("-03-","-10-") return (25 to 31)[days-from-duration(date("2020"||$x||.) - date("0000-01-01")) mod 7 eq 0]'
$ xidel -se 'for $x in (3,10) return (25 to 31)[days-from-duration(date(join(("2020",format-integer($x,"00"),.),"-")) - date("0000-01-01")) mod 7 eq 0]'
29   # 29 maart 2020, de laatste zondag van de maand, begin zomertijd.
25   # 25 oktober 2020, de laatste zondag van de maand, einde zomertijd.

$ xidel -se 'let $year:=year-from-dateTime(current-dateTime()) for $x in ("-03-","-10-") return dateTime(concat($year,$x,(25 to 31)[days-from-duration(date(concat($year,$x,.)) - date("0000-01-01")) mod 7 eq 0],"T01:00:00Z"))'
2020-03-29T01:00:00Z   # Begin zomertijd.
2020-10-25T01:00:00Z   # Einde zomertijd.

Vóór 1996 golden er andere regels, maar aangezien de kans vrij groot is dat de data die Xivid ontleedt allemaal
van ná die tijd is ga ik die hier niet in betrekken. Zie https://nl.wikipedia.org/wiki/Zomertijd#Nederland.

----------------------------------------------------------------

$ xidel -se 'declare function local:is-summertime($arg as dateTime) as boolean {let $year:=year-from-dateTime($arg),$dst:=for $x in ("-03-","-10-") return dateTime(concat($year,$x,(25 to 31)[days-from-duration(date(concat($year,$x,.)) - date("0000-01-01")) mod 7 eq 0],"T01:00:00Z")) return $dst[1] le dateTime($arg) and dateTime($arg) lt $dst[2]}; local:is-summertime(dateTime("2020-03-29T01:00:00Z"))'
true

----------------------------------------------------------------

$ xidel -se 'declare function local:adjust-dateTime-to-dst($arg as anyAtomicType) as dateTime {let $is-summertime:=function($arg as dateTime) as boolean {let $year:=year-from-dateTime($arg),$dst:=for $x in ("-03-","-10-") return dateTime(concat($year,$x,(25 to 31)[days-from-duration(date(concat($year,$x,.)) - date("0000-01-01")) mod 7 eq 0],"T01:00:00Z")) return $dst[1] le dateTime($arg) and dateTime($arg) lt $dst[2]} return adjust-dateTime-to-timezone(dateTime($arg),if ($is-summertime(current-dateTime())) then if ($is-summertime(dateTime($arg))) then implicit-timezone() else implicit-timezone() - duration("PT1H") else if ($is-summertime(dateTime($arg))) then implicit-timezone() + duration("PT1H") else implicit-timezone())}; local:adjust-dateTime-to-dst("2020-03-29T01:00:00Z")'
2020-03-29T03:00:00+02:00

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

declare function xivid:adjust-dateTime-to-dst($arg as anyAtomicType) as dateTime {
  let $is-summertime:=function($arg as dateTime) as boolean {
        let $year:=year-from-dateTime($arg),
            $dst:=for $x in ("-03-","-10-") return
            dateTime(
              concat(
                $year,
                $x,
                (25 to 31)[
                  days-from-duration(
                    date(concat($year,$x,.)) - date("0000-01-01")
                  ) mod 7 eq 0
                ],
                "T01:00:00Z"
              )
            )
        return
        $dst[1] le dateTime($arg) and dateTime($arg) lt $dst[2]
      }
  return
  adjust-dateTime-to-timezone(
    dateTime($arg),
    if ($is-summertime(current-dateTime())) then
      if ($is-summertime(dateTime($arg))) then
        implicit-timezone()
      else
        implicit-timezone() - duration("PT1H")
    else
      if ($is-summertime(dateTime($arg))) then
        implicit-timezone() + duration("PT1H")
      else
        implicit-timezone()
  )
};

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

Begin zomertijd 2020:

$ date -d 2020-03-29T02:00:00+01:00 +%s
$ date -d 2020-03-29T03:00:00+02:00 +%s
$ xidel -se '(dateTime("2020-03-29T02:00:00+01:00") - dateTime("1970-01-01T00:00:00Z")) div dayTimeDuration("PT1S")'
$ xidel -se '(dateTime("2020-03-29T03:00:00+02:00") - dateTime("1970-01-01T00:00:00Z")) div dayTimeDuration("PT1S")'
1585443600

$ date -d 2020-03-29T01:59:59+01:00 -u +%FT%T%:z  /  $ date -d @1585443599 -u +%FT%T%:z
$ date -d 2020-03-29T02:00:00+01:00 -u +%FT%T%:z  /  $ date -d @1585443600 -u +%FT%T%:z
$ date -d 2020-03-29T01:59:59+01:00 +%FT%T%:z     /  $ date -d @1585443599 +%FT%T%:z
$ date -d 2020-03-29T02:00:00+01:00 +%FT%T%:z     /  $ date -d @1585443600 +%FT%T%:z
2020-03-29T00:59:59+00:00
2020-03-29T01:00:00+00:00
2020-03-29T01:59:59+01:00   # 1 seconde vóór begin zomertijd.
2020-03-29T03:00:00+02:00   # begin zomertijd.

$ xidel -s --module=xivid.xqm -e '
  adjust-dateTime-to-timezone(dateTime("2020-03-29T01:59:59+01:00"),duration("PT0S")),
  adjust-dateTime-to-timezone(dateTime("2020-03-29T02:00:00+01:00"),duration("PT0S")),
  adjust-dateTime-to-timezone(dateTime("2020-03-29T01:59:59+01:00")),
  adjust-dateTime-to-timezone(dateTime("2020-03-29T02:00:00+01:00")),
  xivid:adjust-dateTime-to-dst("2020-03-29T01:59:59+01:00"),
  xivid:adjust-dateTime-to-dst("2020-03-29T02:00:00+01:00")
'
2020-03-29T00:59:59Z
2020-03-29T01:00:00Z
2020-03-29T01:59:59+01:00
2020-03-29T02:00:00+01:00   # Xidel heeft geen zomertijd/wintertijd database en past de dateTime aan met de implicit-timezone() van dit moment (december; PT1H).
2020-03-29T01:59:59+01:00
2020-03-29T03:00:00+02:00

$ xidel -s --module=xivid.xqm -e '
  1585443599 * duration("PT1S") + dateTime("1970-01-01T00:00:00Z"),
  1585443600 * duration("PT1S") + dateTime("1970-01-01T00:00:00Z"),
  adjust-dateTime-to-timezone(1585443599 * duration("PT1S") + dateTime("1970-01-01T00:00:00Z")),
  adjust-dateTime-to-timezone(1585443600 * duration("PT1S") + dateTime("1970-01-01T00:00:00Z")),
  xivid:adjust-dateTime-to-dst(1585443599 * duration("PT1S") + dateTime("1970-01-01T00:00:00Z")),
  xivid:adjust-dateTime-to-dst(1585443600 * duration("PT1S") + dateTime("1970-01-01T00:00:00Z"))
'
2020-03-29T00:59:59Z
2020-03-29T01:00:00Z
2020-03-29T01:59:59+01:00
2020-03-29T02:00:00+01:00
2020-03-29T01:59:59+01:00
2020-03-29T03:00:00+02:00

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

Begin wintertijd 2020:

$ date -d 2020-10-25T03:00:00+02:00 +%s
$ date -d 2020-10-25T02:00:00+01:00 +%s
$ xidel -se '(dateTime("2020-10-25T03:00:00+02:00") - dateTime("1970-01-01T00:00:00Z")) div dayTimeDuration("PT1S")'
$ xidel -se '(dateTime("2020-10-25T02:00:00+01:00") - dateTime("1970-01-01T00:00:00Z")) div dayTimeDuration("PT1S")'
1603587600

$ date -d 2020-10-25T02:59:59+02:00 -u +%FT%T%:z  /  $ date -d @1603587599 -u +%FT%T%:z
$ date -d 2020-10-25T03:00:00+02:00 -u +%FT%T%:z  /  $ date -d @1603587600 -u +%FT%T%:z
$ date -d 2020-10-25T02:59:59+02:00 +%FT%T%:z     /  $ date -d @1603587599 +%FT%T%:z
$ date -d 2020-10-25T03:00:00+02:00 +%FT%T%:z     /  $ date -d @1603587600 +%FT%T%:z
2020-10-25T00:59:59+00:00
2020-10-25T01:00:00+00:00
2020-10-25T02:59:59+02:00   # 1 seconde vóór begin wintertijd.
2020-10-25T02:00:00+01:00   # begin wintertijd.

$ xidel -s --module=xivid.xqm -e '
  adjust-dateTime-to-timezone(dateTime("2020-10-25T02:59:59+02:00"),duration("PT0S")),
  adjust-dateTime-to-timezone(dateTime("2020-10-25T03:00:00+02:00"),duration("PT0S")),
  adjust-dateTime-to-timezone(dateTime("2020-10-25T02:59:59+02:00")),
  adjust-dateTime-to-timezone(dateTime("2020-10-25T03:00:00+02:00")),
  xivid:adjust-dateTime-to-dst("2020-10-25T02:59:59+02:00"),
  xivid:adjust-dateTime-to-dst("2020-10-25T03:00:00+02:00")
'
2020-10-25T00:59:59Z
2020-10-25T01:00:00Z
2020-10-25T01:59:59+01:00   # Xidel heeft geen zomertijd/wintertijd database en past de dateTime aan met de implicit-timezone() van dit moment (december; PT1H).
2020-10-25T02:00:00+01:00
2020-10-25T02:59:59+02:00
2020-10-25T02:00:00+01:00

$ xidel -s --module=xivid.xqm -e '
  1603587599 * duration("PT1S") + dateTime("1970-01-01T00:00:00Z"),
  1603587600 * duration("PT1S") + dateTime("1970-01-01T00:00:00Z"),
  adjust-dateTime-to-timezone(1603587599 * duration("PT1S") + dateTime("1970-01-01T00:00:00Z")),
  adjust-dateTime-to-timezone(1603587600 * duration("PT1S") + dateTime("1970-01-01T00:00:00Z")),
  xivid:adjust-dateTime-to-dst(1603587599 * duration("PT1S") + dateTime("1970-01-01T00:00:00Z")),
  xivid:adjust-dateTime-to-dst(1603587600 * duration("PT1S") + dateTime("1970-01-01T00:00:00Z"))
'
2020-10-25T00:59:59Z
2020-10-25T01:00:00Z
2020-10-25T01:59:59+01:00
2020-10-25T02:00:00+01:00
2020-10-25T02:59:59+02:00
2020-10-25T02:00:00+01:00

------------------------------------------------------------------------------------------------

Aanroepen externe programma's:

$ xidel -se 'let $a:=1561935600 return [system(x"date -d @{$a} +%FT%T")]'
["2019-07-01T01:00:00\n"]

$ xidel -se 'let $a:=1561935600 return [replace(system(x"date -d @{$a} +%FT%T"),"\n","")]'
$ xidel -se 'let $a:=1561935600 return [x:lines(system(x"date -d @{$a} +%FT%T"))[1]]'
["2019-07-01T01:00:00"]

Date, zoals bijna elk programma, voegt een nieuwe regel (Unix:'\n', Windows:'\r\n') toe aan het einde.

$ xidel -se         'let $a:=1561935600 return system(x"bash -c ""echo -n $(date -d @{$a} +%FT%T)""")'
$ xidel -se         'let $a:=1561935600 return system(x"bash -c ""printf '\''%(%FT%T)T'\'' {$a}""")'
$ xidel -se         'let $a:=1561935600 return system(x"bash -c ""printf """"%(%FT%T)T"""" {$a}""")'
$ xidel -se 'let $a:=1561935600 return system(x"bash -c ""printf &apos;%(%FT%T)T&apos; {$a}""")'
2019-07-01T01:00:00

Printf en echo (met de '-n' optie) voegen geen nieuwe regel toe.
I.t.t. date zijn printf en echo geen programma's, maar functies van Bash, waardoor ze d.m.v. een nieuwe aanroep van bash aangeroepen moeten worden.

------------------------------------------------------------------------------------------------

Datum-string naar (UTC) dateTime:

$ xidel -se 'parse-ietf-date("Tue Oct 29 01:10:02 +0000 2019")'
2019-10-29T01:10:02Z

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

$ xidel -se '
  x:parse-date("1 january 2020 7:00","d mmmm yyyy"),
  x:parse-dateTime("1 january 2020 7:00","d mmmm yyyy h:nn")
'
2020-01-01
2020-01-01T07:00:00

Het Pascal format (https://www.freepascal.org/docs-html/rtl/sysutils/formatchars.html) komt heel precies,
MAAR Xidel ondersteunt (op dit moment) alleen Engels en Duits:

$ xidel -se 'x:parse-date("1 januari 2020 7:00","d mmmm yyyy")'
Error:
err:FORG0001: Invalid conversion from 1 januari 2020 7:00 to date format d mmmm yyyy

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

$ xidel -se 'tokenize("01-07-2020 07:00","[\s-]")'      $ xidel -se 'tokenize("1 juli 2020 7:00")'
01                                                      1
07                                                      juli
2020                                                    2020
07:00                                                   7:00

$ xidel -se 'let $i:=tokenize("01-07-2020 07:00","[\s-]") return (format-integer($i[1],"00"),$i[2],$i[3],join(tokenize($i[4],":") ! format-integer(.,"00"),":")||":00")'
$ xidel -se 'let $i:=tokenize("01-07-2020 07:00:00","[\s-]") return (format-integer($i[1],"00"),$i[2],$i[3],substring(join(tokenize($i[4],":") ! format-integer(.,"00"),":")||":00",1,8))'
$ xidel -se 'let $month:={"jan":"01","feb":"02","mrt":"03","apr":"04","mei":"05","jun":"06","jul":"07","aug":"08","sep":"09","okt":"10","nov":"11","dec":"12"},$i:=tokenize("1 juli 2020 7:00","[\s-]") return (format-integer($i[1],"00"),if ($i[2] castable as integer) then $i[2] else $month(substring($i[2],1,3)),$i[3],substring(join(tokenize($i[4],":") ! format-integer(.,"00"),":")||":00",1,8))'
01
07
2020
07:00:00

$ xidel -se '("01-07-2020 07:00","1 juli 2020 7:00") ! (let $month:={"jan":"01","feb":"02","mrt":"03","apr":"04","mei":"05","jun":"06","jul":"07","aug":"08","sep":"09","okt":"10","nov":"11","dec":"12"},$i:=tokenize(.,"[\s-]") return concat(join(($i[3],if ($i[2] castable as integer) then $i[2] else $month(substring($i[2],1,3)),format-integer($i[1],"00")),"-"),"T",substring(join(tokenize($i[4],":") ! format-integer(.,"00"),":")||":00",1,8)))'
2020-07-01T07:00:00
2020-07-01T07:00:00

----------------------------------------------------------------

$ xidel -s --module=xivid.xqm -e '
  implicit-timezone(),
  adjust-dateTime-to-timezone(adjust-dateTime-to-timezone(dateTime("2020-07-01T07:00:00")),duration("PT0S")),
  adjust-dateTime-to-timezone(xivid:adjust-dateTime-to-dst("2020-07-01T07:00:00"),duration("PT0S"))
'
PT1H
2020-07-01T06:00:00Z   # De huidige tijdzone is +01:00. Eén uur eerder voor UTC tijd in juli klopt dus niet.
2020-07-01T05:00:00Z   # De tijdzone op dat moment is +02:00. Twee uur eerder voor UTC tijd in juli is dus de enige juiste uitkomst.

----------------------------------------------------------------

$ xidel -s --module=xivid.xqm -e 'declare function local:string-to-utc-dateTime($arg as string) as dateTime {let $month:={"jan":"01","feb":"02","mrt":"03","apr":"04","mei":"05","jun":"06","jul":"07","aug":"08","sep":"09","okt":"10","nov":"11","dec":"12"},$dt:=let $i:=tokenize($arg,"[\s-]") return concat(join(($i[3],if ($i[2] castable as integer) then $i[2] else $month(substring($i[2],1,3)),format-integer($i[1],"00")),"-"),"T",substring(join(tokenize($i[4],":") ! format-integer(.,"00"),":")||":00",1,8)) return adjust-dateTime-to-timezone(xivid:adjust-dateTime-to-dst($dt),duration("PT0S"))}; local:string-to-utc-dateTime("1 juli 2020 7:00")'
2020-07-01T05:00:00Z

$ xidel -s --module=xivid.xqm -e 'declare function local:string-to-utc-dateTime($arg as string) as dateTime {let $month:={"jan":"01","feb":"02","mrt":"03","maart":"03","apr":"04","mei":"05","jun":"06","jul":"07","aug":"08","sep":"09","okt":"10","nov":"11","dec":"12"},$dt:=let $i:=tokenize($arg,"[\s-]") return concat(join(($i[3],if ($i[2] castable as integer) then $i[2] else ($month($i[2]),$month(substring($i[2],1,3))),format-integer($i[1],"00")),"-"),"T",substring(join(tokenize($i[4],":") ! format-integer(.,"00"),":")||":00",1,8)) return adjust-dateTime-to-timezone(xivid:adjust-dateTime-to-dst($dt),duration("PT0S"))}; local:string-to-utc-dateTime("1 maart 2020 7:00")'
2020-03-01T06:00:00Z

$ xidel -s --module=xivid.xqm -e 'declare function local:string-to-utc-dateTime($arg as string) as dateTime {let $month:={"jan":"01","feb":"02","mrt":"03","maart":"03","apr":"04","mei":"05","jun":"06","jul":"07","aug":"08","sep":"09","okt":"10","nov":"11","dec":"12"},$dt:=if ($arg castable as dateTime) then $arg else let $i:=tokenize($arg,"[\s-]") return concat(join(($i[3],if ($i[2] castable as integer) then $i[2] else ($month($i[2]),$month(substring($i[2],1,3))),format-integer($i[1],"00")),"-"),"T",substring(join(tokenize($i[4],":") ! format-integer(.,"00"),":")||":00",1,8)) return adjust-dateTime-to-timezone(xivid:adjust-dateTime-to-dst($dt),duration("PT0S"))}; local:string-to-utc-dateTime("2020-07-01T07:00:00")'
2020-07-01T05:00:00Z

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

declare function xivid:string-to-utc-dateTime($arg as string) as dateTime {
  let $month:={
        "jan":"01","feb":"02","mrt":"03","maart":"03","apr":"04",
        "mei":"05","jun":"06","jul":"07","aug":"08",
        "sep":"09","okt":"10","nov":"11","dec":"12"
      },
      $dt:=if ($arg castable as dateTime) then
        $arg
      else
        let $i:=tokenize($arg,"[\s-]") return
        concat(
          join(
            (
              $i[3],
              if ($i[2] castable as integer) then
                $i[2]
              else
                ($month($i[2]),$month(substring($i[2],1,3))),
              format-integer($i[1],"00")
            ),
            "-"
          ),
          "T",
          substring(
            join(tokenize($i[4],":") ! format-integer(.,"00"),":")||":00",
            1,8
          )
        )
  return
  adjust-dateTime-to-timezone(
    xivid:adjust-dateTime-to-dst($dt),
    duration("PT0S")
  )
};

================================================================================================

[Batch escape characters voor prettification]

https://www.robvanderwoude.com/escapechars.php

Query (Unix quoting):

-e '
  let $a:=string-join(
        tokenize($raw) ! x:integer-to-base(.,16)
      ),
      $b:=x:integer($a,16)
  return
  concat("<^| ",$a," & ",$b," |%>")
'

Query (Windows quoting):

-e "
  let $a:=string-join(
        tokenize($raw) ! x:integer-to-base(.,16)
      ),
      $b:=x:integer($a,16)
  return
  concat('<^| ',$a,' & ',$b,' |%>')
"

------------------------------------------------------------------------------------------------

Directe commando:

SET "var=11 7 14 3"
ECHO %var% | xidel -s - ^
-e ^"^
  let $a:=string-join(^
        tokenize($raw) ! x:integer-to-base(.,16)^
      ),^
      $b:=x:integer($a,16)^
  return^
  concat('^<^^^| ',$a,' ^& ',$b,' ^|%%^>')^
"

- In het geval van een Unix query dienen de aanhalingstekens omgedraaid te worden (Windows quoting). ' wordt " en andersom.
- De dubbele aanhalingstekens dienen ge-escaped te worden: ^". Die aan het einde query NIET. Tenzij er een spatie vóór zit.
- De tekens % & < > ^ | dienen "ge-escaped" te worden: %% ^& ^< ^> ^^ ^|.
- Het einde van iedere regel, behalve de laatste, dient ge-escaped te worden.
  Begint de nieuwe regel NIET met een spatie, dan moet er nog een statie vóór de ^.

Output commando:
<^| B7E3 & 47075 |%>

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

Xidel commando Unix --> Windows in Bash:

$ sed -n 810,817p xivid_notes.txt
$ xidel -se 'file:read-text-lines("xivid_notes.txt")[position() = 810 to 817]'
-e '
  let $a:=string-join(
        tokenize($raw) ! x:integer-to-base(.,16)
      ),
      $b:=x:integer($a,16)
  return
  concat("<^| ",$a," & ",$b," |%>")
'

----------------------------------------------------------------

$ xidel -se 'let $a:=file:read-text-lines("xivid_notes.txt")[position() = 810 to 817] return (replace($a[1],"'\''","^""")||"^",replace($a[last()],"'\''",""""))'
$ xidel -se 'let $a:=file:read-text-lines("xivid_notes.txt") return (replace($a[810],"&apos;","^&quot;")||"^",replace($a[817],"&apos;","&quot;"))'
-e ^"^
"

----------------------------------------------------------------

$ xidel -se 'let $a:=file:read-text-lines("xivid_notes.txt") return (replace($a[810],"&apos;","^&quot;")||"^",$a[position() = 811 to 816] ! (replace(replace(replace(.,"%","%%"),"&quot;","&apos;"),"([&amp;<>^|])","^$1")||"^"),replace($a[817],"&apos;","&quot;"))'
-e ^"^
  let $a:=string-join(^
        tokenize($raw) ! x:integer-to-base(.,16)^
      ),^
      $b:=x:integer($a,16)^
  return^
  concat('^<^^^| ',$a,' ^& ',$b,' ^|%%^>')^
"

Een here-string als input werkt ook, maar de $ moet dan wel ge-escaped worden:

$ xidel -se 'let $a:=x:lines($raw) return (replace($a[1],"&apos;","^&quot;")||"^",$a[position() = 2 to last() - 1] ! (replace(replace(replace(.,"%","%%"),"&quot;","&apos;"),"([&amp;<>^|])","^$1")||"^"),replace($a[last()],"&apos;","&quot;"))' <<EOF
-e '
  let \$a:=string-join(
        tokenize(\$raw) ! x:integer-to-base(.,16)
      ),
      \$b:=x:integer(\$a,16)
  return
  concat("<^| ",\$a," & ",\$b," |%>")
'
EOF
-e ^"^
  let $a:=string-join(^
        tokenize($raw) ! x:integer-to-base(.,16)^
      ),^
      $b:=x:integer($a,16)^
  return^
  concat('^<^^^| ',$a,' ^& ',$b,' ^|%%^>')^
"

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

Xidel commando Unix --> Windows in Batch:

----------------------------------------------------------------

xidel -se "let $a:=file:read-text-lines('xivid_notes.txt')[position() = 810 to 817] return (replace($a[1],'''','^\"')^|^|'^',replace($a[last()],'''','\"'))"
xidel -se "let $a:=file:read-text-lines('xivid_notes.txt') return (replace($a[810],'&apos;','^&quot;'),replace($a[817],'&apos;','&quot;'))"
-e ^"^
"

----------------------------------------------------------------

xidel -se "let $a:=file:read-text-lines('xivid_notes.txt') return (replace($a[810],'&apos;','^&quot;')||'^',$a[position() = 811 to 816] ! (replace(replace(replace(.,'%','%%'),'&quot;','&apos;'),'([&amp;<>^|])','^$1')||'^'),replace($a[817],'&apos;','&quot;'))"
-e ^"^
  let $a:=string-join(^
        tokenize($raw) ! x:integer-to-base(.,16)^
      ),^
      $b:=x:integer($a,16)^
  return^
  concat('^<^^^| ',$a,' ^& ',$b,' ^|%%^>')^
"

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

Xidel commando Windows --> Windows in Batch:

----------------------------------------------------------------

xidel -se "let $a:=file:read-text-lines('xivid_notes.txt')[position() = 821 to 828] return (replace($a[1],'\"','^^\"')||'^',$a[last()])"
xidel -se "let $a:=file:read-text-lines('xivid_notes.txt') return (replace($a[821],'&quot;','^&quot;')||'^',$a[828])"
-e ^"^
"

----------------------------------------------------------------

xidel -se "let $a:=file:read-text-lines('xivid_notes.txt') return (replace($a[821],'&quot;','^&quot;')||'^',$a[position() = 822 to 827] ! (replace(replace(.,'%','%%'),'([&amp;<>^|])','^$1')||'^'),$a[828])"
-e ^"^
  let $a:=string-join(^
        tokenize($raw) ! x:integer-to-base(.,16)^
      ),^
      $b:=x:integer($a,16)^
  return^
  concat('^<^^^| ',$a,' ^& ',$b,' ^|%%^>')^
"

------------------------------------------------------------------------------------------------

Directe commando (delayed expansion):

SET "var=11 7 14 3"
SETLOCAL ENABLEDELAYEDEXPANSION
ECHO !var! | xidel -s - ^
-e ^"^
  let $a:=string-join(^
        tokenize($raw) ^^! x:integer-to-base(.,16)^
      ),^
      $b:=x:integer($a,16)^
  return^
  concat('^<^^^^^| ',$a,' ^& ',$b,' ^|%%^>')^
"

- Zie hier boven.
- Het uitroepteken dient dubbel ge-escaped te worden: ^^!.
- Het dakje (accent circonflexe) dient nóg een keer ge-escaped te worden: ^^^^.

Output commando:
<^| B7E3 & 47075 |%>

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

Xidel commando Unix --> Windows in Bash:

$ xidel -se 'let $a:=file:read-text-lines("xivid_notes.txt") return (replace($a[810],"&apos;","^&quot;")||"^",$a[position() = 811 to 816] ! (replace(replace(replace(replace(replace(.,"%","%%"),"&quot;","&apos;"),"\^","^^"),"!","^!"),"([&amp;<>^|])","^$1")||"^"),replace($a[817],"&apos;","&quot;"))'

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

Xidel commando Unix --> Windows in Batch:

xidel -se "let $a:=file:read-text-lines('xivid_notes.txt') return (replace($a[810],'&apos;','^&quot;')||'^',$a[position() = 811 to 816] ! (replace(replace(replace(replace(replace(.,'%','%%'),'&quot;','&apos;'),'\^','^^'),'!','^!'),'([&amp;<>^|])','^$1')||'^'),replace($a[817],'&apos;','&quot;'))"

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

Xidel commando Windows --> Windows in Batch:

xidel -se "let $a:=file:read-text-lines('xivid_notes.txt') return (replace($a[821],'&quot;','^&quot;')||'^',$a[position() = 822 to 827] ! (replace(replace(replace(replace(.,'%','%%'),'\^','^^'),'!','^!'),'([&amp;<>^|])','^$1')||'^'),$a[828])"

------------------------------------------------------------------------------------------------

Commando in FOR loop:

SET "var=11 7 14 3"
FOR /F "delims=" %%A IN ('ECHO %var% ^| xidel -s -
-e ^"
  let $a:^=string-join^(
        tokenize^($raw^) ! x:integer-to-base^(.^,16^)
      ^)^,
      $b:^=x:integer^($a^,16^)
  return
  var:^=concat^('^<^^^| '^,$a^,' ^& '^,$b^,' ^|%%^>'^)
^" --output-format^=cmd') DO %%A
ECHO %var%

- Naast de escape characters, % & < > ^ |, dienen ook de delimiters, , ; = én " ( ) ge-escaped te worden.
- Het hele rijtje wordt dus: % & < > ^ | , ; = " ( ).
- Het einde van een regel hoeft niet ge-escaped te worden.

Output commando:
SET var=^<^^^| B7E3 ^& 47075 ^|%^>
ECHO <^| B7E3 & 47075 |%>

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

Xidel commando Unix --> Windows in Bash:

$ xidel -se 'let $a:=file:read-text-lines("xivid_notes.txt") return (replace($a[810],"&apos;","^&quot;"),$a[position() = 811 to 816] ! replace(replace(replace(.,"%","%%"),"&quot;","&apos;"),"([&amp;<>^|,;=()])","^$1"),replace($a[817],"&apos;","^&quot;"))'

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

Xidel commando Unix --> Windows in Batch:

xidel -se "let $a:=file:read-text-lines('xivid_notes.txt') return (replace($a[810],'&apos;','^&quot;'),$a[position() = 811 to 816] ! replace(replace(replace(.,'%','%%'),'&quot;','&apos;'),'([&amp;<>^|,;=()])','^$1'),replace($a[817],'&apos;','^&quot;'))"

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

Xidel commando Windows --> Windows in Batch:

xidel -se "let $a:=file:read-text-lines('xivid_notes.txt') return (replace($a[821],'&quot;','^&quot;'),$a[position() = 822 to 827] ! replace(replace(.,'%','%%'),'([&amp;<>^|,;=()])','^$1'),replace($a[828],'&quot;','^&quot;'))"

================================================================================================

[xivid -i, video informatie optie]

$ var='{"name":"NOS Journaal: STOP! Verkeerslicht voor telefoonverslaafde","date":"2017-02-14T12:00:00Z","duration":"PT1M5S","start":"PT9M2S","end":"PT10M7S","formats":[{"id":"sub-1","format":"vtt","language":"nl","label":"Nederlands","url":null},{"id":"hls-0","format":"m3u8[manifest]","url":null},{"id":"hls-1","format":"m3u8[aac]","resolution":null,"bitrate":"64kbps","url":null},{"id":"hls-2","format":"m3u8[aac]","resolution":null,"bitrate":"128kbps","url":null},{"id":"hls-3","format":"m3u8[h264+aac]","resolution":"480x270","bitrate":"209|64kbps","url":null},{"id":"hls-4","format":"m3u8[h264+aac]","resolution":"640x360","bitrate":"517|128kbps","url":null},{"id":"hls-5","format":"m3u8[h264+aac]","resolution":"768x432","bitrate":"721|128kbps","url":null},{"id":"hls-6","format":"m3u8[h264+aac]","resolution":"1024x576","bitrate":"1027|128kbps","url":null}]}'

Alle attribuut-namen:

$ xidel -s "$var" -e '$json()'
name
date
duration
start
end
formats

Vertaalslag van JSON-attribuut naar Nederlandse string:

$ xidel -s "$var" -e 'let $lbl:={"name":"Naam:","date":"Datum:","duration":"Tijdsduur:","start":"Begin:","end":"Einde:","expdate":"Gratis tot:","formats":"Formaten:"} return $json() ! $lbl(.)'
Naam:
Datum:
Tijdsduur:
Begin:
Einde:
Formaten:

Aantal tekens string:

$ xidel -s "$var" -e 'let $lbl:={"name":"Naam:","date":"Datum:","duration":"Tijdsduur:","start":"Begin:","end":"Einde:","expdate":"Gratis tot:","formats":"Formaten:"} return $json() ! string-length($lbl(.))'
5
6
10
6
6
9

String + spaties tot lengte van langste string + 1 spatie speling:

$ xidel -s "$var" -e 'let $lbl:={"name":"Naam:","date":"Datum:","duration":"Tijdsduur:","start":"Begin:","end":"Einde:","expdate":"Gratis tot:","formats":"Formaten:"},$len:=$json() ! string-length($lbl(.)) for $x at $i in $json() return concat($lbl($x),string-join((1 to max($len) - $len[$i] + 1) ! "-"))'
Naam:------   # 10 - 5 + 1 = 6 spaties
Datum:-----   # 10 - 6 + 1 = 5 spaties
Tijdsduur:-   # etc.
Begin:-----
Einde:-----
Formaten:--

Met de attribuut-waarden erbij (en daadwerkelijk spaties):

$ xidel -s "$var" -e 'let $lbl:={"name":"Naam:","date":"Datum:","duration":"Tijdsduur:","start":"Begin:","end":"Einde:","expdate":"Gratis tot:","formats":"Formaten:"},$len:=$json() ! string-length($lbl(.)) for $x at $i in $json() return concat($lbl($x),string-join((1 to max($len) - $len[$i] + 1) ! " "),if ($x="formats") then () else $json($x))'
Naam:      NOS Journaal: STOP! Verkeerslicht voor telefoonverslaafde
Datum:     2017-02-14T12:00:00Z
Tijdsduur: PT1M5S
Begin:     PT9M2S
Einde:     PT10M7S
Formaten:

De UTC tijd geconverteerd naar lokale tijd in aangepast formaat en tijdsduur geconverteerd naar tijd:

$ xidel -s "$var" --module=xivid.xqm -e 'let $lbl:={"name":"Naam:","date":"Datum:","duration":"Tijdsduur:","start":"Begin:","end":"Einde:","expdate":"Gratis tot:","formats":"Formaten:"},$len:=$json() ! string-length($lbl(.)) for $x at $i in $json() return concat($lbl($x),string-join((1 to max($len) - $len[$i] + 1) ! " "),if ($x="formats") then () else if ($x=("date","expdate")) then format-dateTime(xivid:adjust-dateTime-to-dst($json($x)),"[D01]-[M01]-[Y] [H01]:[m01]:[s01]") else if ($x=("duration","start","end")) then duration($json($x)) + time("00:00:00") else $json($x))'
Naam:      NOS Journaal: STOP! Verkeerslicht voor telefoonverslaafde
Datum:     14-02-2017 13:00:00
Tijdsduur: 00:01:05
Begin:     00:09:02
Einde:     00:10:07
Formaten:

------------------------------------------------------------------------------------------------

De unieke attribuut-namen in alle objecten in de "formats"-array:

$ xidel -s "$var" -e 'distinct-values($json/(formats)()())'
id
format
language
label
url
resolution
bitrate

Vertaalslag van specifieke op volgorde gezette JSON-attributen naar Nederlandse string:

$ xidel -se 'let $fmts:=array{{"id":"id","format":"formaat","language":"taal","resolution":"resolutie","samplerate":"frequentie","bitrate":"bitrate"}} return $fmts(1)()'
id
format
language
resolution
samplerate
bitrate

Van dit object met kolom-titels en alle objecten in de "formats"-array maak ik één array voor het makkelijker achterhalen van de langste string per te vormen kolom.
Alle kolom-titels die in die volgorde in alle objecten van de "formats"-array aanwezig zijn:

$ xidel -s "$var" -e 'let $fmts:=array{{"id":"id","format":"formaat","language":"taal","resolution":"resolutie","samplerate":"frequentie","bitrate":"bitrate"},$json/(formats)()} return $fmts(1)() ! distinct-values(for $x in $fmts()[position() gt 1] return .[$x(.)])'
id
format
language
resolution
bitrate

Per attribuut-naam / kolom (behalve de laatste) het aantal tekens van de langste string:

$ xidel -s "$var" -e 'let $fmts:=array{{"id":"id","format":"formaat","language":"taal","resolution":"resolutie","samplerate":"frequentie","bitrate":"bitrate"},$json/(formats)()},$f_lbl:=$fmts(1)() ! distinct-values(for $x in $fmts()[position() gt 1] return .[$x(.)]) return $f_lbl[position() lt last()] ! max($fmts()(.) ! string-length())'
5
14
4
9

Per object in $fmts van alle attributen in $f_lbl de waardes achter elkaar:

$ xidel -s "$var" -e 'let $fmts:=array{{"id":"id","format":"formaat","language":"taal","resolution":"resolutie","samplerate":"frequentie","bitrate":"bitrate"},$json/(formats)()},$f_lbl:=$fmts(1)() ! distinct-values(for $x in $fmts()[position() gt 1] return .[$x(.)]) return $fmts() ! join(for $x in $f_lbl return .($x))'
id formaat taal resolutie bitrate
sub-1 vtt nl
hls-0 m3u8[manifest]
hls-1 m3u8[aac] 64kbps
hls-2 m3u8[aac] 128kbps
hls-3 m3u8[h264+aac] 480x270 209|64kbps
hls-4 m3u8[h264+aac] 640x360 517|128kbps
hls-5 m3u8[h264+aac] 768x432 721|128kbps
hls-6 m3u8[h264+aac] 1024x576 1027|128kbps

Met de spaties erbij:
kolom-titels als voorbeeld;
"id", 5 - 2 + 2 spaties, "formaat", 14 - 7 + 2 spaties, "taal", 4 - 4 + 2 spaties, "resolutie", 9 - 9 + 2 spaties, "bitrate".

$ xidel -s "$var" -e 'let $fmts:=array{{"id":"id","format":"formaat","language":"taal","resolution":"resolutie","samplerate":"frequentie","bitrate":"bitrate"},$json/(formats)()},$f_lbl:=$fmts(1)() ! distinct-values(for $x in $fmts()[position() gt 1] return .[$x(.)]),$f_len:=$f_lbl[position() lt last()] ! max($fmts()(.) ! string-length()) return $fmts() ! string-join(for $x at $i in $f_lbl return (.($x),(1 to $f_len[$i] - string-length(.($x)) + 2) ! "-"))'
id-----formaat---------taal--resolutie--bitrate
sub-1--vtt-------------nl---------------
hls-0--m3u8[manifest]-------------------
hls-1--m3u8[aac]------------------------64kbps
hls-2--m3u8[aac]------------------------128kbps
hls-3--m3u8[h264+aac]--------480x270----209|64kbps
hls-4--m3u8[h264+aac]--------640x360----517|128kbps
hls-5--m3u8[h264+aac]--------768x432----721|128kbps
hls-6--m3u8[h264+aac]--------1024x576---1027|128kbps

------------------------------------------------------------------------------------------------

$ xidel -s "$var" -e '$json[start]/(start,duration)'
PT9M2S   # Begin.
PT1M5S   # Tijdsduur.

$ xidel -s "$var" -e '$json[start]/(start,duration) ! (dayTimeDuration(.) div dayTimeDuration("PT1S"))'
542   # Begin in sec.
65    # Tijdsduur in sec.

$ xidel -s "$var" -e '$json[start]/(let $dur:=(start,duration) ! (dayTimeDuration(.) div dayTimeDuration("PT1S")),$ss:=($dur[1] - $dur[1] mod 30,$dur[1] mod 30) return ($ss,$dur[2]))'
540   # Begin op 30 sec nauwkeurig.
2     # Begin restant.
65    # Tijdsduur.

$ xidel -s "$var" -e '$json[start]/(let $dur:=(start,duration) ! (dayTimeDuration(.) div dayTimeDuration("PT1S")),$ss:=($dur[1] - $dur[1] mod 30,$dur[1] mod 30) return x"Download: ffmpeg -ss {$ss[1]} -i <url> -ss {$ss[2]} -t {$dur[2]} -c copy <bestandsnaam>")'
Download: ffmpeg -ss 540 -i <url> -ss 2 -t 65 -c copy <bestandsnaam>

Begin PT29S:

$ xidel -s '{"duration":"PT10S","start":"PT29S"}' -e '$json[start]/(let $dur:=(start,duration) ! (dayTimeDuration(.) div dayTimeDuration("PT1S")),$ss:=($dur[1] - $dur[1] mod 30,$dur[1] mod 30) return concat("Download: ffmpeg ",$ss[1][. gt 0] ! x"-ss {.} ",x"-i <url> -ss {$ss[2]} -t {$dur[2]} <bestandsnaam>"))'
Download: ffmpeg -i <url> -ss 29 -t 10 -c copy <bestandsnaam>

Begin PT30S:

$ xidel -s '{"duration":"PT10S","start":"PT30S"}' -e '$json[start]/(let $dur:=(start,duration) ! (dayTimeDuration(.) div dayTimeDuration("PT1S")),$ss:=($dur[1] - $dur[1] mod 30,$dur[1] mod 30) return concat("Download: ffmpeg ",$ss[1][. gt 0] ! x"-ss {.} ","-i <url> ",$ss[2][. gt 0] ! x"-ss {.} ",x"-t {$dur[2]} <bestandsnaam>"))'
Download: ffmpeg -ss 30 -i <url> -t 10 -c copy <bestandsnaam>

PT29S --> ffmpeg -i <url> -ss 29 -t 10 -c copy <bestandsnaam>
PT30S --> ffmpeg -ss 30 -i <url> -t 10 -c copy <bestandsnaam>
PT31S --> ffmpeg -ss 30 -i <url> -ss 1 -t 10 -c copy <bestandsnaam>

------------------------------------------------------------------------------------------------

Alles bij elkaar:

$ xidel -s "$var" --module=xivid.xqm -e 'let $lbl:={"name":"Naam:","date":"Datum:","duration":"Tijdsduur:","start":"Begin:","end":"Einde:","expdate":"Gratis tot:","formats":"Formaten:"},$len:=$json() ! string-length($lbl(.)),$fmts:=array{{"id":"id","format":"formaat","language":"taal","resolution":"resolutie","samplerate":"frequentie","bitrate":"bitrate"},$json/(formats)()},$f_lbl:=$fmts(1)() ! distinct-values(for $x in $fmts()[position() gt 1] return .[$x(.)]),$f_len:=$f_lbl[position() lt last()] ! max($fmts()(.) ! string-length()) for $x at $i in $json() return concat($lbl($x),string-join((1 to max($len) - $len[$i] + 1) ! "-"),if ($x="formats") then join($fmts() ! string-join(for $x at $i in $f_lbl return (.($x),(1 to $f_len[$i] - string-length(.($x)) + 2) ! "-")),"&#10;"||(1 to max($len) + 1) ! "-") else if ($x=("date","expdate")) then format-dateTime(xivid:adjust-dateTime-to-dst($json($x)),"[D01]-[M01]-[Y] [H01]:[m01]:[s01]") else if ($x=("duration","start","end")) then duration($json($x)) + time("00:00:00") else $json($x))'
Naam:------NOS Journaal: STOP! Verkeerslicht voor telefoonverslaafde
Datum:-----14-02-2017 13:00:00
Tijdsduur:-00:01:05
Begin:-----00:09:02
Einde:-----00:10:07
Formaten:--id-----formaat---------taal--resolutie--bitrate
-----------sub-1--vtt-------------nl---------------               # "&#10;"||(1 to max($len) + 1) ! "-" --> line feed, 11 spaties.
-----------hls-0--m3u8[manifest]-------------------
-----------hls-1--m3u8[aac]------------------------64kbps
-----------hls-2--m3u8[aac]------------------------128kbps
-----------hls-3--m3u8[h264+aac]--------480x270----209|64kbps
-----------hls-4--m3u8[h264+aac]--------640x360----517|128kbps
-----------hls-5--m3u8[h264+aac]--------768x432----721|128kbps
-----------hls-6--m3u8[h264+aac]--------1024x576---1027|128kbps

Plak " (best)" achter de waarde van het laatste attribuut van het laatste object + de FFmpeg commando (en daadwerkelijk spaties):

$ xidel -s "$var" --module=xivid.xqm -e 'let $lbl:={"name":"Naam:","date":"Datum:","duration":"Tijdsduur:","start":"Begin:","end":"Einde:","expdate":"Gratis tot:","formats":"Formaten:"},$len:=$json() ! string-length($lbl(.)),$fmts:=array{{"id":"id","format":"formaat","language":"taal","resolution":"resolutie","samplerate":"frequentie","bitrate":"bitrate"},$json/(formats)()},$f_lbl:=$fmts(1)() ! distinct-values(for $x in $fmts()[position() gt 1] return .[$x(.)]),$f_len:=$f_lbl[position() lt last()] ! max($fmts()(.) ! string-length()),$dur:=$json[start]/(start,duration) ! (dayTimeDuration(.) div dayTimeDuration("PT1S")),$ss:=($dur[1] - $dur[1] mod 30,$dur[1] mod 30) return (for $x at $i in $json() return concat($lbl($x),string-join((1 to max($len) - $len[$i] + 1) ! " "),if ($x="formats") then join($fmts() ! string-join(for $x at $i in $f_lbl return (if (position() eq count($fmts()) and $i eq count($f_lbl)) then .($x)||" (best)" else .($x),(1 to $f_len[$i] - string-length(.($x)) + 2) ! " ")),"&#10;"||(1 to max($len) + 1) ! " ") else if ($x=("date","expdate")) then format-dateTime(xivid:adjust-dateTime-to-dst($json($x)),"[D01]-[M01]-[Y] [H01]:[m01]:[s01]") else if ($x=("duration","start","end")) then duration($json($x)) + time("00:00:00") else $json($x)),concat(x"Download:{string-join((1 to max($len) - 9 + 1) ! " ")}ffmpeg ",$ss[1][. gt 0] ! x"-ss {.} ","-i <url> ",$ss[2][. gt 0] ! x"-ss {.} ",x"-t {$dur[2]} -c copy <bestandsnaam>")[exists($dur)])'
Naam:      NOS Journaal: STOP! Verkeerslicht voor telefoonverslaafde
Datum:     14-02-2017 13:00:00
Tijdsduur: 00:01:05
Begin:     00:09:02
Einde:     00:10:07
Formaten:  id     formaat         taal  resolutie  bitrate
           sub-1  vtt             nl
           hls-0  m3u8[manifest]
           hls-1  m3u8[aac]                        64kbps
           hls-2  m3u8[aac]                        128kbps
           hls-3  m3u8[h264+aac]        480x270    209|64kbps
           hls-4  m3u8[h264+aac]        640x360    517|128kbps
           hls-5  m3u8[h264+aac]        768x432    721|128kbps
           hls-6  m3u8[h264+aac]        1024x576   1027|128kbps (best)
Download:  ffmpeg -ss 540 -i <url> -ss 2 -t 65 -c copy <bestandsnaam>

------------------------------------------------------------------------------------------------

declare function xivid:info($json as object()) as string* {
  let $lbl:={
        "name":"Naam:","date":"Datum:","duration":"Tijdsduur:",
        "start":"Begin:","end":"Einde:","expdate":"Gratis tot:",
        "formats":"Formaten:"
      },
      $len:=$json() ! string-length($lbl(.)),
      $fmts:=array{
        {
          "id":"id","format":"formaat",
          "language":"taal","resolution":"resolutie",
          "samplerate":"frequentie","bitrate":"bitrate"
        },
        $json/(formats)()
      },
      $f_lbl:=$fmts(1)() ! distinct-values(
        for $x in $fmts()[position() gt 1] return .[$x(.)]
      ),
      $f_len:=$f_lbl[position() lt last()] ! max(
        $fmts()(.) ! string-length()
      ),
      $dur:=$json[start]/(start,duration) ! (
        dayTimeDuration(.) div dayTimeDuration("PT1S")
      ),
      $ss:=($dur[1] - $dur[1] mod 30,$dur[1] mod 30)
  return (
    for $x at $i in $json() return
    concat(
      $lbl($x),
      string-join((1 to max($len) - $len[$i] + 1) ! " "),
      if ($x="formats") then
        join(
          $fmts() ! string-join(
            for $x at $i in $f_lbl return (
              if (position() eq count($fmts()) and $i eq count($f_lbl)) then
                .($x)||" (best)"
              else
                .($x),
              (1 to $f_len[$i] - string-length(.($x)) + 2) ! " "
            )
          ),
          "&#10;"||(1 to max($len) + 1) ! " "
        )
      else if ($x=("date","expdate")) then
        format-dateTime(
          xivid:adjust-dateTime-to-dst($json($x)),
          "[D01]-[M01]-[Y] [H01]:[m01]:[s01]"
        )
      else if ($x=("duration","start","end")) then
        duration($json($x)) + time("00:00:00")
      else
        $json($x)
    ),
    concat(
      x"Download:{string-join((1 to max($len) - 9 + 1) ! " ")}ffmpeg ",
      $ss[1][. gt 0] ! x"-ss {.} ",
      "-i <url> ",
      $ss[2][. gt 0] ! x"-ss {.} ",
      x"-t {$dur[2]} -c copy <bestandsnaam>"
    )[exists($dur)]
  )
};

================================================================================================

[HLS master playlist ontleding]

'rtl_6beababa-dadb-3506-ac9c-c9ee2701f05c.m3u8':

#EXTM3U
#EXT-X-VERSION:1
## Created with Unified Streaming Platform(version=1.6.6)
#EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=1245963,CODECS="mp4a.40.2,avc1.77.31",RESOLUTION=711x400
http://manifest.us.rtl.nl/[...]/6beababa-dadb-3506-ac9c-c9ee2701f05c-audio=125437-video=1050000.m3u8
#EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=2489343,CODECS="mp4a.40.2,avc1.100.41",RESOLUTION=912x512
http://manifest.us.rtl.nl/[...]/6beababa-dadb-3506-ac9c-c9ee2701f05c-audio=125437-video=2223000.m3u8
#EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=4386743,CODECS="mp4a.40.2,avc1.100.41",RESOLUTION=1280x720
http://manifest.us.rtl.nl/[...]/6beababa-dadb-3506-ac9c-c9ee2701f05c-audio=125437-video=4013000.m3u8
#EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=132963,CODECS="mp4a.40.2"
http://manifest.us.rtl.nl/[...]/6beababa-dadb-3506-ac9c-c9ee2701f05c-audio=125437.m3u8

$ xidel -s rtl_6beababa-dadb-3506-ac9c-c9ee2701f05c.m3u8 -e 'for $x at $i in extract($raw,"#EXT-X-STREAM-INF.+?m3u8",0,"s*") order by extract($x,"BANDWIDTH=(\d+)",1) count $i return ($i,$x)'
1
#EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=132963,CODECS="mp4a.40.2"
http://manifest.us.rtl.nl/[...]/6beababa-dadb-3506-ac9c-c9ee2701f05c-audio=125437.m3u8
2
#EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=1245963,CODECS="mp4a.40.2,avc1.77.31",RESOLUTION=711x400
http://manifest.us.rtl.nl/[...]/6beababa-dadb-3506-ac9c-c9ee2701f05c-audio=125437-video=1050000.m3u8
3
#EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=2489343,CODECS="mp4a.40.2,avc1.100.41",RESOLUTION=912x512
http://manifest.us.rtl.nl/[...]/6beababa-dadb-3506-ac9c-c9ee2701f05c-audio=125437-video=2223000.m3u8
4
#EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=4386743,CODECS="mp4a.40.2,avc1.100.41",RESOLUTION=1280x720
http://manifest.us.rtl.nl/[...]/6beababa-dadb-3506-ac9c-c9ee2701f05c-audio=125437-video=4013000.m3u8

$ xidel -s rtl_6beababa-dadb-3506-ac9c-c9ee2701f05c.m3u8 -e 'let $url:="http://manifest.us.rtl.nl/[...]/6beababa-dadb-3506-ac9c-c9ee2701f05c.m3u8" return array{{"id":"hls-0","format":"m3u8[manifest]","url":$url},for $x at $i in extract($raw,"#EXT-X-STREAM-INF.+?m3u8",0,"s*") let $br:=extract($x,"BANDWIDTH=(\d+)",1),$br2:=extract($x,"audio.+?(\d+)(?:-video.+?(\d+))?",(1,2))[.] order by $br count $i return {"id":"hls-"||$i,"format":if (contains($x,"avc1")) then "m3u8[h264+aac]" else "m3u8[aac]","resolution"?:extract($x,"RESOLUTION=([\dx]+)",1)[.],"bitrate":(if ($br2[1]) then join((round($br2[2] div 1000),round($br2[1] div 1000)),"|") else round($br div 1000)) ! concat(.,"kbps"),"url":extract($x,".+m3u8")}}'
[
  {
    "id": "hls-0",
    "format": "m3u8[manifest]",
    "url": "http://manifest.us.rtl.nl/[...]/6beababa-dadb-3506-ac9c-c9ee2701f05c.m3u8"
  },
  {
    "id": "hls-1",
    "format": "m3u8[aac]",
    "bitrate": "125kbps",
    "url": "http://manifest.us.rtl.nl/[...]/6beababa-dadb-3506-ac9c-c9ee2701f05c-audio=125437.m3u8"
  },
  [...]
  {
    "id": "hls-4",
    "format": "m3u8[h264+aac]",
    "resolution": "1280x720",
    "bitrate": "4013|125kbps",
    "url": "http://manifest.us.rtl.nl/[...]/6beababa-dadb-3506-ac9c-c9ee2701f05c-audio=125437-video=4013000.m3u8"
  }
]

------------------------------------------------------------------------------------------------

'kijk_zCoXEMbeJeD.m3u8':

#EXTM3U
#EXT-X-VERSION:1
## Created with Unified Streaming Platform (version=1.10.18-20255)

# variants
#EXT-X-STREAM-INF:BANDWIDTH=563000,CODECS="mp4a.40.2,avc1.77.30",RESOLUTION=448x252,FRAME-RATE=25,VIDEO-RANGE=SDR
zCoXEMbeJeD-index-audio=160000-video=370236.m3u8
#EXT-X-STREAM-INF:BANDWIDTH=955000,CODECS="mp4a.40.2,avc1.77.30",RESOLUTION=640x360,FRAME-RATE=25,VIDEO-RANGE=SDR
zCoXEMbeJeD-index-audio=160000-video=740168.m3u8
#EXT-X-STREAM-INF:BANDWIDTH=1782000,CODECS="mp4a.40.2,avc1.77.30",RESOLUTION=768x432,FRAME-RATE=25,VIDEO-RANGE=SDR
zCoXEMbeJeD-index-audio=160000-video=1520499.m3u8
#EXT-X-STREAM-INF:BANDWIDTH=3392000,CODECS="mp4a.40.2,avc1.77.31",RESOLUTION=1280x720,FRAME-RATE=25,VIDEO-RANGE=SDR
zCoXEMbeJeD-index-audio=160000-video=3039252.m3u8

# variants
#EXT-X-STREAM-INF:BANDWIDTH=170000,CODECS="mp4a.40.2"
zCoXEMbeJeD-index-audio=160000.m3u8

$ xidel -s kijk_zCoXEMbeJeD.m3u8 -e 'let $url:="https://vod-kijk2-prod.talpatvcdn.nl/[...]/zCoXEMbeJeD.m3u8?filter=(systemBitrate%3C3500000)" return array{{"id":"hls-0","format":"m3u8[manifest]","url":$url},for $x at $i in extract($raw,"#EXT-X-STREAM-INF.+?m3u8",0,"s*") let $br:=extract($x,"BANDWIDTH=(\d+)",1),$br2:=extract($x,"audio.+?(\d+)(?:-video.+?(\d+))?",(1,2))[.] order by $br count $i return {"id":"hls-"||$i,"format":if (contains($x,"avc1")) then "m3u8[h264+aac]" else "m3u8[aac]","resolution"?:concat(extract($x,"RESOLUTION=([\dx]+)",1)[.],extract($x,"FRAME-RATE=(\d+)",1)[.] ! concat("@",.,"fps"))[.],"bitrate":(if ($br2[1]) then join((round($br2[2] div 1000),round($br2[1] div 1000)),"|") else round($br div 1000)) ! concat(.,"kbps"),"url":resolve-uri(extract($x,".+m3u8"),$url)}}'
[
  {
    "id": "hls-0",
    "format": "m3u8[manifest]",
    "url": "https://vod-kijk2-prod.talpatvcdn.nl/[...]/zCoXEMbeJeD.m3u8?filter=(systemBitrate%3C3500000)"
  },
  {
    "id": "hls-1",
    "format": "m3u8[aac]",
    "bitrate": "160kbps",
    "url": "https://vod-kijk2-prod.talpatvcdn.nl/[...]/zCoXEMbeJeD-index-audio=160000.m3u8"
  },
  [...]
  {
    "id": "hls-5",
    "format": "m3u8[h264+aac]",
    "resolution": "1280x720@25fps",
    "bitrate": "3039|160kbps",
    "url": "https://vod-kijk2-prod.talpatvcdn.nl/[...]/zCoXEMbeJeD-index-audio=160000-video=3039252.m3u8"
  }
]

------------------------------------------------------------------------------------------------

'ofr-live_01082020.m3u8':

#EXTM3U
#EXT-X-VERSION:3


#EXT-X-STREAM-INF:BANDWIDTH=2418592,CODECS="avc1.64001f,mp4a.40.2",RESOLUTION=1280x720,FRAME-RATE=25.000
720p/prog_index.m3u8
#EXT-X-STREAM-INF:BANDWIDTH=1526776,CODECS="avc1.64001e,mp4a.40.2",RESOLUTION=854x480,FRAME-RATE=25.000
540p/prog_index.m3u8
#EXT-X-STREAM-INF:BANDWIDTH=636608,CODECS="avc1.640015,mp4a.40.2",RESOLUTION=426x240,FRAME-RATE=25.000
270p/prog_index.m3u8

#EXT-X-I-FRAME-STREAM-INF:BANDWIDTH=2000000,CODECS="avc1.64001f",RESOLUTION=1280x720,URI="720p/iframe_prog_index.m3u8"
#EXT-X-I-FRAME-STREAM-INF:BANDWIDTH=1200000,CODECS="avc1.64001e",RESOLUTION=854x480,URI="540p/iframe_prog_index.m3u8"
#EXT-X-I-FRAME-STREAM-INF:BANDWIDTH=400000,CODECS="avc1.640015",RESOLUTION=426x240,URI="270p/iframe_prog_index.m3u8"

$ xidel -se '(25,23.976,25.000) ! round-half-to-even(.,3)'
25
23.976
25

$ xidel -s ofr-live_01082020.m3u8 -e 'let $url:="https://d3pvma9xb2775h.cloudfront.net/live/omropfryslan/stream04/index.m3u8" return array{{"id":"hls-0","format":"m3u8[manifest]","url":$url},for $x at $i in extract($raw,"#EXT-X-STREAM-INF.+?m3u8",0,"s*") let $br:=extract($x,"BANDWIDTH=(\d+)",1),$br2:=extract($x,"audio.+?(\d+)(?:-video.+?(\d+))?",(1,2))[.] order by $br count $i return {"id":"hls-"||$i,"format":if (contains($x,"avc1")) then "m3u8[h264+aac]" else "m3u8[aac]","resolution"?:concat(extract($x,"RESOLUTION=([\dx]+)",1)[.],extract($x,"FRAME-RATE=([\d\.]+)",1)[.] ! concat("@",round-half-to-even(.,3),"fps"))[.],"bitrate":(if ($br2[1]) then join((round($br2[2] div 1000),round($br2[1] div 1000)),"|") else round($br div 1000)) ! concat(.,"kbps"),"url":resolve-uri(extract($x,".+m3u8"),$url)}}'
[
  {
    "id": "hls-0",
    "format": "m3u8[manifest]",
    "url": "https://d3pvma9xb2775h.cloudfront.net/live/omropfryslan/stream04/index.m3u8"
  },
  {
    "id": "hls-1",
    "format": "m3u8[h264+aac]",
    "resolution": "426x240@25fps",
    "bitrate": "637kbps",
    "url": "https://d3pvma9xb2775h.cloudfront.net/live/omropfryslan/stream04/270p/prog_index.m3u8"
  },
  [...]
  {
    "id": "hls-3",
    "format": "m3u8[h264+aac]",
    "resolution": "1280x720@25fps",
    "bitrate": "2419kbps",
    "url": "https://d3pvma9xb2775h.cloudfront.net/live/omropfryslan/stream04/720p/prog_index.m3u8"
  }
]

------------------------------------------------------------------------------------------------

'npo_POW_03373320.m3u8':

#EXTM3U
#EXT-X-VERSION:4
## Created with Unified Streaming Platform(version=1.7.25)

# AUDIO groups
#EXT-X-MEDIA:TYPE=AUDIO,GROUP-ID="audio-aacl-64",NAME="audio",AUTOSELECT=YES,DEFAULT=YES,CHANNELS="2"
#EXT-X-MEDIA:TYPE=AUDIO,GROUP-ID="audio-aacl-128",NAME="audio",AUTOSELECT=YES,DEFAULT=YES,CHANNELS="2"

# variants
#EXT-X-STREAM-INF:BANDWIDTH=290000,CODECS="mp4a.40.2,avc1.42C01E",RESOLUTION=480x270,AUDIO="audio-aacl-64",CLOSED-CAPTIONS=NONE
POW_03373320_v4-audio=64000-video=209000.m3u8
#EXT-X-STREAM-INF:BANDWIDTH=684000,CODECS="mp4a.40.2,avc1.42C01E",RESOLUTION=640x360,AUDIO="audio-aacl-128",CLOSED-CAPTIONS=NONE
POW_03373320_v4-audio=128000-video=517000.m3u8
#EXT-X-STREAM-INF:BANDWIDTH=900000,CODECS="mp4a.40.2,avc1.42C01F",RESOLUTION=768x432,AUDIO="audio-aacl-128",CLOSED-CAPTIONS=NONE
POW_03373320_v4-audio=128000-video=721000.m3u8
#EXT-X-STREAM-INF:BANDWIDTH=1225000,CODECS="mp4a.40.2,avc1.42C029",RESOLUTION=1024x576,AUDIO="audio-aacl-128",CLOSED-CAPTIONS=NONE
POW_03373320_v4-audio=128000-video=1027000.m3u8

# variants
#EXT-X-STREAM-INF:BANDWIDTH=68000,CODECS="mp4a.40.2",AUDIO="audio-aacl-64"
POW_03373320_v4-audio=64000.m3u8
#EXT-X-STREAM-INF:BANDWIDTH=136000,CODECS="mp4a.40.2",AUDIO="audio-aacl-128"
POW_03373320_v4-audio=128000.m3u8

# keyframes
#EXT-X-I-FRAME-STREAM-INF:BANDWIDTH=28000,CODECS="avc1.42C01E",RESOLUTION=480x270,URI="keyframes/POW_03373320_v4-video=209000.m3u8"
#EXT-X-I-FRAME-STREAM-INF:BANDWIDTH=69000,CODECS="avc1.42C01E",RESOLUTION=640x360,URI="keyframes/POW_03373320_v4-video=517000.m3u8"
#EXT-X-I-FRAME-STREAM-INF:BANDWIDTH=96000,CODECS="avc1.42C01F",RESOLUTION=768x432,URI="keyframes/POW_03373320_v4-video=721000.m3u8"
#EXT-X-I-FRAME-STREAM-INF:BANDWIDTH=137000,CODECS="avc1.42C029",RESOLUTION=1024x576,URI="keyframes/POW_03373320_v4-video=1027000.m3u8"

$ xidel -s npo_POW_03373320.m3u8 -e 'let $url:="https://npo.prd.cdn.bcms.kpn.com/[...]/playlist.m3u8" return array{{"id":"hls-0","format":"m3u8[manifest]","url":$url},for $x at $i in extract($raw,"#EXT-X-STREAM-INF.+?m3u8",0,"s*") let $br:=extract($x,"BANDWIDTH=(\d+)",1),$br2:=extract($x,"audio.*?=(\d+)(?:-video.*?=(\d+))?",(1,2))[.] order by $br count $i return {"id":"hls-"||$i,"format":if (contains($x,"avc1")) then "m3u8[h264+aac]" else "m3u8[aac]","resolution"?:concat(extract($x,"RESOLUTION=([\dx]+)",1)[.],extract($x,"FRAME-RATE=([\d\.]+)",1)[.] ! concat("@",round-half-to-even(.,3),"fps"))[.],"bitrate":(if ($br2[1]) then join((round($br2[2] div 1000),round($br2[1] div 1000)),"|") else round($br div 1000)) ! concat(.,"kbps"),"url":resolve-uri(extract($x,".+m3u8"),$url)}}'
[
  {
    "id": "hls-0",
    "format": "m3u8[manifest]",
    "url": "https://npo.prd.cdn.bcms.kpn.com/[...]/playlist.m3u8"
  },
  {
    "id": "hls-1",
    "format": "m3u8[aac]",
    "bitrate": "64kbps",
    "url": "https://npo.prd.cdn.bcms.kpn.com/[...]/POW_03373320_v4-audio=64000.m3u8"
  },
  [...]
  {
    "id": "hls-6",
    "format": "m3u8[h264+aac]",
    "resolution": "1024x576",
    "bitrate": "1027|128kbps",
    "url": "https://npo.prd.cdn.bcms.kpn.com/[...]/POW_03373320_v4-audio=128000-video=1027000.m3u8"
  }
]

------------------------------------------------------------------------------------------------

'ad_10065499.m3u8':

#EXTM3U
#EXT-X-INDEPENDENT-SEGMENTS
#EXT-X-STREAM-INF:BANDWIDTH=2510000,FRAME-RATE=30,RESOLUTION=1280x720,AVERAGE-BANDWIDTH=2360000,CODECS="mp4a.40.2, avc1.64001f"
https://dcs-vod.apis.anvato.net/vod/p/2510000/prog.m3u8?i=i177995803-n1a98e8e5-00aa-4252-9c7e-c3e23ea87ea0&anvtrid=97c39460bebcfff373ceade45edacbe3
#EXT-X-STREAM-INF:BANDWIDTH=1775000,FRAME-RATE=30,RESOLUTION=1280x720,AVERAGE-BANDWIDTH=1660000,CODECS="mp4a.40.2, avc1.64001f"
https://dcs-vod.apis.anvato.net/vod/p/1775000/prog.m3u8?i=i177995803-n1a98e8e5-00aa-4252-9c7e-c3e23ea87ea0&anvtrid=97c39460bebcfff373ceade45edacbe3
#EXT-X-STREAM-INF:BANDWIDTH=1145000,FRAME-RATE=30,RESOLUTION=640x360,AVERAGE-BANDWIDTH=1060000,CODECS="mp4a.40.2, avc1.64001e"
https://dcs-vod.apis.anvato.net/vod/p/1145000/prog.m3u8?i=i177995803-n1a98e8e5-00aa-4252-9c7e-c3e23ea87ea0&anvtrid=97c39460bebcfff373ceade45edacbe3
#EXT-X-STREAM-INF:BANDWIDTH=796400,FRAME-RATE=30,RESOLUTION=640x360,AVERAGE-BANDWIDTH=728000,CODECS="mp4a.40.2, avc1.64001e"
https://dcs-vod.apis.anvato.net/vod/p/796400/prog.m3u8?i=i177995803-n1a98e8e5-00aa-4252-9c7e-c3e23ea87ea0&anvtrid=97c39460bebcfff373ceade45edacbe3
#EXT-X-STREAM-INF:BANDWIDTH=481400,FRAME-RATE=30,RESOLUTION=320x180,AVERAGE-BANDWIDTH=428000,CODECS="mp4a.40.2, avc1.64000d"
https://dcs-vod.apis.anvato.net/vod/p/481400/prog.m3u8?i=i177995803-n1a98e8e5-00aa-4252-9c7e-c3e23ea87ea0&anvtrid=97c39460bebcfff373ceade45edacbe3
#EXT-X-I-FRAME-STREAM-INF:BANDWIDTH=2360000,RESOLUTION=1280x720,CODECS="avc1.64001f",URI="https://dcs-vod.apis.anvato.net/vod/p/2360000/iframes.m3u8?i=i177995803-n1a98e8e5-00aa-4252-9c7e-c3e23ea87ea0"
#EXT-X-I-FRAME-STREAM-INF:BANDWIDTH=1660000,RESOLUTION=1280x720,CODECS="avc1.64001f",URI="https://dcs-vod.apis.anvato.net/vod/p/1660000/iframes.m3u8?i=i177995803-n1a98e8e5-00aa-4252-9c7e-c3e23ea87ea0"
#EXT-X-I-FRAME-STREAM-INF:BANDWIDTH=1060000,RESOLUTION=640x360,CODECS="avc1.64001e",URI="https://dcs-vod.apis.anvato.net/vod/p/1060000/iframes.m3u8?i=i177995803-n1a98e8e5-00aa-4252-9c7e-c3e23ea87ea0"
#EXT-X-I-FRAME-STREAM-INF:BANDWIDTH=728000,RESOLUTION=640x360,CODECS="avc1.64001e",URI="https://dcs-vod.apis.anvato.net/vod/p/728000/iframes.m3u8?i=i177995803-n1a98e8e5-00aa-4252-9c7e-c3e23ea87ea0"
#EXT-X-I-FRAME-STREAM-INF:BANDWIDTH=428000,RESOLUTION=320x180,CODECS="avc1.64000d",URI="https://dcs-vod.apis.anvato.net/vod/p/428000/iframes.m3u8?i=i177995803-n1a98e8e5-00aa-4252-9c7e-c3e23ea87ea0"

$ xidel -s ad_10065499.m3u8 -e 'for $x at $i in extract($raw,"#EXT-X-STREAM-INF.+?m3u8.*?$",0,"ms*") order by extract($x,"BANDWIDTH=(\d+)",1) count $i return ($i,$x)'
1
#EXT-X-STREAM-INF:BANDWIDTH=481400,FRAME-RATE=30,RESOLUTION=320x180,AVERAGE-BANDWIDTH=428000,CODECS="mp4a.40.2, avc1.64000d"
https://dcs-vod.apis.anvato.net/vod/p/481400/prog.m3u8?i=i177995803-n1a98e8e5-00aa-4252-9c7e-c3e23ea87ea0&anvtrid=97c39460bebcfff373ceade45edacbe3
2
#EXT-X-STREAM-INF:BANDWIDTH=796400,FRAME-RATE=30,RESOLUTION=640x360,AVERAGE-BANDWIDTH=728000,CODECS="mp4a.40.2, avc1.64001e"
https://dcs-vod.apis.anvato.net/vod/p/796400/prog.m3u8?i=i177995803-n1a98e8e5-00aa-4252-9c7e-c3e23ea87ea0&anvtrid=97c39460bebcfff373ceade45edacbe3
3
#EXT-X-STREAM-INF:BANDWIDTH=1145000,FRAME-RATE=30,RESOLUTION=640x360,AVERAGE-BANDWIDTH=1060000,CODECS="mp4a.40.2, avc1.64001e"
https://dcs-vod.apis.anvato.net/vod/p/1145000/prog.m3u8?i=i177995803-n1a98e8e5-00aa-4252-9c7e-c3e23ea87ea0&anvtrid=97c39460bebcfff373ceade45edacbe3
4
#EXT-X-STREAM-INF:BANDWIDTH=1775000,FRAME-RATE=30,RESOLUTION=1280x720,AVERAGE-BANDWIDTH=1660000,CODECS="mp4a.40.2, avc1.64001f"
https://dcs-vod.apis.anvato.net/vod/p/1775000/prog.m3u8?i=i177995803-n1a98e8e5-00aa-4252-9c7e-c3e23ea87ea0&anvtrid=97c39460bebcfff373ceade45edacbe3
5
#EXT-X-STREAM-INF:BANDWIDTH=2510000,FRAME-RATE=30,RESOLUTION=1280x720,AVERAGE-BANDWIDTH=2360000,CODECS="mp4a.40.2, avc1.64001f"
https://dcs-vod.apis.anvato.net/vod/p/2510000/prog.m3u8?i=i177995803-n1a98e8e5-00aa-4252-9c7e-c3e23ea87ea0&anvtrid=97c39460bebcfff373ceade45edacbe3

$ xidel -s ad_10065499.m3u8 -e 'let $url:="https://tkx.apis.anvato.net/rest/v2/mcp/video/10065499~~syv8ed1JI0T0eA/master.m3u8?anvack=yjqOEWaqi37WK2u26oMesa6LMGiJNeZl" return array{{"id":"hls-0","format":"m3u8[manifest]","url":$url},for $x at $i in extract($raw,"#EXT-X-STREAM-INF.+?m3u8.*?$",0,"ms*") let $br:=extract($x,"BANDWIDTH=(\d+)",1),$br2:=extract($x,"audio.*?=(\d+)(?:-video.*?=(\d+))?",(1,2))[.] order by $br count $i return {"id":"hls-"||$i,"format":if (contains($x,"avc1")) then "m3u8[h264+aac]" else "m3u8[aac]","resolution"?:concat(extract($x,"RESOLUTION=([\dx]+)",1)[.],extract($x,"FRAME-RATE=([\d\.]+)",1)[.] ! concat("@",round-half-to-even(.,3),"fps"))[.],"bitrate":(if ($br2[1]) then join((round($br2[2] div 1000),round($br2[1] div 1000)),"|") else round($br div 1000)) ! concat(.,"kbps"),"url":resolve-uri(extract($x,".+m3u8.*?$","m"),$url)}}'
[
  {
    "id": "hls-0",
    "format": "m3u8[manifest]",
    "url": "https://tkx.apis.anvato.net/rest/v2/mcp/video/10065499~~syv8ed1JI0T0eA/master.m3u8?anvack=yjqOEWaqi37WK2u26oMesa6LMGiJNeZl"
  },
  {
    "id": "hls-1",
    "format": "m3u8[h264+aac]",
    "resolution": "320x180@30fps",
    "bitrate": "481kbps",
    "url": "https://dcs-vod.apis.anvato.net/vod/p/481400/prog.m3u8?i=i177995803-n1a98e8e5-00aa-4252-9c7e-c3e23ea87ea0&anvtrid=97c39460bebcfff373ceade45edacbe3"
  },
  [...]
  {
    "id": "hls-5",
    "format": "m3u8[h264+aac]",
    "resolution": "1280x720@30fps",
    "bitrate": "2510kbps",
    "url": "https://dcs-vod.apis.anvato.net/vod/p/2510000/prog.m3u8?i=i177995803-n1a98e8e5-00aa-4252-9c7e-c3e23ea87ea0&anvtrid=97c39460bebcfff373ceade45edacbe3"
  }
]

------------------------------------------------------------------------------------------------

'npo_POW_04059460.m3u8':

#EXTM3U
#EXT-X-VERSION:4
## Created with Unified Streaming Platform(version=1.7.18) - generated by HMG

# AUDIO groups
#EXT-X-MEDIA:TYPE=AUDIO,GROUP-ID="audio-aacl-128",LANGUAGE="en",NAME="English",DEFAULT=YES,AUTOSELECT=YES,URI="a1/a1.m3u8"

# variants
#EXT-X-STREAM-INF:BANDWIDTH=1526000,AVERAGE-BANDWIDTH=1398000,CODECS="avc1.42C01E,mp4a.40.2",RESOLUTION=768x432,AUDIO="audio-aacl-128",CLOSED-CAPTIONS=NONE
v4/v4.m3u8
#EXT-X-STREAM-INF:BANDWIDTH=707000,AVERAGE-BANDWIDTH=658000,CODECS="avc1.4D401F,mp4a.40.2",RESOLUTION=480x270,AUDIO="audio-aacl-128",CLOSED-CAPTIONS=NONE
v5/v5.m3u8
#EXT-X-STREAM-INF:BANDWIDTH=882000,AVERAGE-BANDWIDTH=815000,CODECS="avc1.42C01E,mp4a.40.2",RESOLUTION=480x270,AUDIO="audio-aacl-128",CLOSED-CAPTIONS=NONE
v6/v6.m3u8
#EXT-X-STREAM-INF:BANDWIDTH=446000,AVERAGE-BANDWIDTH=412000,CODECS="avc1.42C01E,mp4a.40.2",RESOLUTION=320x180,AUDIO="audio-aacl-128",CLOSED-CAPTIONS=NONE
v7/v7.m3u8

# keyframes
#EXT-X-I-FRAME-STREAM-INF:BANDWIDTH=439000,AVERAGE-BANDWIDTH=197000,CODECS="avc1.42C01E",RESOLUTION=768x432,URI="v4/iframe_index.m3u8"
#EXT-X-I-FRAME-STREAM-INF:BANDWIDTH=227000,AVERAGE-BANDWIDTH=102000,CODECS="avc1.4D401F",RESOLUTION=480x270,URI="v5/iframe_index.m3u8"
#EXT-X-I-FRAME-STREAM-INF:BANDWIDTH=312000,AVERAGE-BANDWIDTH=106000,CODECS="avc1.42C01E",RESOLUTION=480x270,URI="v6/iframe_index.m3u8"
#EXT-X-I-FRAME-STREAM-INF:BANDWIDTH=134000,AVERAGE-BANDWIDTH=48000,CODECS="avc1.42C01E",RESOLUTION=320x180,URI="v7/iframe_index.m3u8"

$ xidel -s npo_POW_04059460.m3u8 -e 'for $x at $i in extract($raw,"#EXT-X-(?:MEDIA:TYPE=AUDIO|STREAM-INF).+?m3u8.*?$",0,"ms*") order by extract($x,"BANDWIDTH=(\d+)",1) count $i return ($i,$x)'
1
#EXT-X-MEDIA:TYPE=AUDIO,GROUP-ID="audio-aacl-128",LANGUAGE="en",NAME="English",DEFAULT=YES,AUTOSELECT=YES,URI="a1/a1.m3u8"
2
#EXT-X-STREAM-INF:BANDWIDTH=446000,AVERAGE-BANDWIDTH=412000,CODECS="avc1.42C01E,mp4a.40.2",RESOLUTION=320x180,AUDIO="audio-aacl-128",CLOSED-CAPTIONS=NONE
v7/v7.m3u8
3
#EXT-X-STREAM-INF:BANDWIDTH=707000,AVERAGE-BANDWIDTH=658000,CODECS="avc1.4D401F,mp4a.40.2",RESOLUTION=480x270,AUDIO="audio-aacl-128",CLOSED-CAPTIONS=NONE
v5/v5.m3u8
4
#EXT-X-STREAM-INF:BANDWIDTH=882000,AVERAGE-BANDWIDTH=815000,CODECS="avc1.42C01E,mp4a.40.2",RESOLUTION=480x270,AUDIO="audio-aacl-128",CLOSED-CAPTIONS=NONE
v6/v6.m3u8
5
#EXT-X-STREAM-INF:BANDWIDTH=1526000,AVERAGE-BANDWIDTH=1398000,CODECS="avc1.42C01E,mp4a.40.2",RESOLUTION=768x432,AUDIO="audio-aacl-128",CLOSED-CAPTIONS=NONE
v4/v4.m3u8

$ xidel -s npo_POW_04059460.m3u8 -e 'for $x at $i in extract($raw,"#EXT-X-(?:MEDIA:TYPE=AUDIO|STREAM-INF).+?m3u8.*?$",0,"ms*") let $br:=extract($x,"BANDWIDTH=(\d+)",1),$br2:=extract($x,"GROUP-ID=.+?-(\d+)",1)[.],$br3:=extract($x,"audio.*?=(\d+)(?:-video.*?=(\d+))?",(1,2))[.] order by $br count $i return join(((if ($br3[1]) then join((round($br3[2] div 1000),round($br3[1] div 1000)),"|") else ($br2,round($br div 1000))[1]) ! concat(.,"kbps"),if (contains($x,"URI=")) then extract($x,"URI=&quot;(.+)&quot;",1) else x:lines($x)[last()]))'
128kbps a1/a1.m3u8
446kbps v7/v7.m3u8
707kbps v5/v5.m3u8
882kbps v6/v6.m3u8
1526kbps v4/v4.m3u8

$ xidel -s npo_POW_04059460.m3u8 -e 'let $url:="https://nl-ams-p22-am3.cdn.streamgate.nl/[...]/POW_04059460_v1563215505/playlist.m3u8" return array{{"id":"hls-0","format":"m3u8[manifest]","url":$url},for $x at $i in extract($raw,"#EXT-X-(?:MEDIA:TYPE=AUDIO|STREAM-INF).+?m3u8.*?$",0,"ms*") let $br:=extract($x,"BANDWIDTH=(\d+)",1),$br2:=extract($x,"GROUP-ID=.+?-(\d+)",1)[.],$br3:=extract($x,"audio.*?=(\d+)(?:-video.*?=(\d+))?",(1,2))[.] order by $br count $i return {"id":"hls-"||$i,"format":if (contains($x,"avc1")) then "m3u8[h264+aac]" else "m3u8[aac]","resolution"?:concat(extract($x,"RESOLUTION=([\dx]+)",1)[.],extract($x,"FRAME-RATE=([\d\.]+)",1)[.] ! concat("@",round-half-to-even(.,3),"fps"))[.],"bitrate":(if ($br3[1]) then join((round($br3[2] div 1000),round($br3[1] div 1000)),"|") else ($br2,round($br div 1000))[1]) ! concat(.,"kbps"),"url":resolve-uri(if (contains($x,"URI=")) then extract($x,"URI=&quot;(.+)&quot;",1) else x:lines($x)[last()],$url)}}'
[
  {
    "id": "hls-0",
    "format": "m3u8[manifest]",
    "url": "https://nl-ams-p22-am3.cdn.streamgate.nl/[...]/POW_04059460_v1563215505/playlist.m3u8"
  },
  {
    "id": "hls-1",
    "format": "m3u8[aac]",
    "bitrate": "128kbps",
    "url": "https://nl-ams-p22-am3.cdn.streamgate.nl/[...]/POW_04059460_v1563215505/a1/a1.m3u8"
  },
  [...]
  {
    "id": "hls-5",
    "format": "m3u8[h264+aac]",
    "resolution": "768x432",
    "bitrate": "1526kbps",
    "url": "https://nl-ams-p22-am3.cdn.streamgate.nl/[...]/POW_04059460_v1563215505/v4/v4.m3u8"
  }
]

------------------------------------------------------------------------------------------------

'twitch_esl_csgo.m3u8':

#EXTM3U
#EXT-X-TWITCH-INFO:NODE="video-edge-c55efc.ams02",MANIFEST-NODE-TYPE="weaver_cluster",MANIFEST-NODE="video-weaver.ams02",SUPPRESS="true",SERVER-TIME="1573922640.92",TRANSCODESTACK="2017TranscodeEvent_V2",USER-IP="x.x.x.x",SERVING-ID="c1a092ae8e644510873ee3fac41e41e2",CLUSTER="ams02",ABS="false",VIDEO-SESSION-ID="3757567538117581635",BROADCAST-ID="178058097",STREAM-TIME="2064.919954",B="false",USER-COUNTRY="NL",MANIFEST-CLUSTER="ams02"
#EXT-X-MEDIA:TYPE=VIDEO,GROUP-ID="chunked",NAME="1080p60 (source)",AUTOSELECT=YES,DEFAULT=YES
#EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=6964137,RESOLUTION=1920x1080,CODECS="avc1.4D402A,mp4a.40.2",VIDEO="chunked"
https://video-weaver.ams02.hls.ttvnw.net/v1/playlist/[...].m3u8
#EXT-X-MEDIA:TYPE=VIDEO,GROUP-ID="720p60",NAME="720p60",AUTOSELECT=YES,DEFAULT=YES
#EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=3459825,RESOLUTION=1280x720,CODECS="avc1.4D401F,mp4a.40.2",VIDEO="720p60"
https://video-weaver.ams02.hls.ttvnw.net/v1/playlist/[...].m3u8
#EXT-X-MEDIA:TYPE=VIDEO,GROUP-ID="720p30",NAME="720p",AUTOSELECT=YES,DEFAULT=YES
#EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=2409825,RESOLUTION=1280x720,CODECS="avc1.4D401F,mp4a.40.2",VIDEO="720p30"
https://video-weaver.ams02.hls.ttvnw.net/v1/playlist/[...].m3u8
#EXT-X-MEDIA:TYPE=VIDEO,GROUP-ID="480p30",NAME="480p",AUTOSELECT=YES,DEFAULT=YES
#EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=1464825,RESOLUTION=852x480,CODECS="avc1.4D401F,mp4a.40.2",VIDEO="480p30"
https://video-weaver.ams02.hls.ttvnw.net/v1/playlist/[...].m3u8
#EXT-X-MEDIA:TYPE=VIDEO,GROUP-ID="360p30",NAME="360p",AUTOSELECT=YES,DEFAULT=YES
#EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=630000,RESOLUTION=640x360,CODECS="avc1.4D401F,mp4a.40.2",VIDEO="360p30"
https://video-weaver.ams02.hls.ttvnw.net/v1/playlist/[...].m3u8
#EXT-X-MEDIA:TYPE=VIDEO,GROUP-ID="160p30",NAME="160p",AUTOSELECT=YES,DEFAULT=YES
#EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=230000,RESOLUTION=284x160,CODECS="avc1.4D401F,mp4a.40.2",VIDEO="160p30"
https://video-weaver.ams02.hls.ttvnw.net/v1/playlist/[...].m3u8
#EXT-X-MEDIA:TYPE=VIDEO,GROUP-ID="audio_only",NAME="audio_only",AUTOSELECT=NO,DEFAULT=NO
#EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=195072,CODECS="mp4a.40.2",VIDEO="audio_only"
https://video-weaver.ams02.hls.ttvnw.net/v1/playlist/[...].m3u8

$ xidel -s twitch_esl_csgo.m3u8 -e 'for $x at $i in extract($raw,"#EXT-X-(?:MEDIA:TYPE=(?:AUDIO|VIDEO)|STREAM-INF).+?m3u8.*?$",0,"ms*") order by extract($x,"BANDWIDTH=(\d+)",1) count $i return ($i,$x)'
1
#EXT-X-MEDIA:TYPE=VIDEO,GROUP-ID="audio_only",NAME="audio_only",AUTOSELECT=NO,DEFAULT=NO
#EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=195072,CODECS="mp4a.40.2",VIDEO="audio_only"
https://video-weaver.ams02.hls.ttvnw.net/v1/playlist/[...].m3u8
2
#EXT-X-MEDIA:TYPE=VIDEO,GROUP-ID="160p30",NAME="160p",AUTOSELECT=YES,DEFAULT=YES
#EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=230000,RESOLUTION=284x160,CODECS="avc1.4D401F,mp4a.40.2",VIDEO="160p30"
https://video-weaver.ams02.hls.ttvnw.net/v1/playlist/[...].m3u8
3
#EXT-X-MEDIA:TYPE=VIDEO,GROUP-ID="360p30",NAME="360p",AUTOSELECT=YES,DEFAULT=YES
#EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=630000,RESOLUTION=640x360,CODECS="avc1.4D401F,mp4a.40.2",VIDEO="360p30"
https://video-weaver.ams02.hls.ttvnw.net/v1/playlist/[...].m3u8
4
#EXT-X-MEDIA:TYPE=VIDEO,GROUP-ID="480p30",NAME="480p",AUTOSELECT=YES,DEFAULT=YES
#EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=1464825,RESOLUTION=852x480,CODECS="avc1.4D401F,mp4a.40.2",VIDEO="480p30"
https://video-weaver.ams02.hls.ttvnw.net/v1/playlist/[...].m3u8
5
#EXT-X-MEDIA:TYPE=VIDEO,GROUP-ID="720p30",NAME="720p",AUTOSELECT=YES,DEFAULT=YES
#EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=2409825,RESOLUTION=1280x720,CODECS="avc1.4D401F,mp4a.40.2",VIDEO="720p30"
https://video-weaver.ams02.hls.ttvnw.net/v1/playlist/[...].m3u8
6
#EXT-X-MEDIA:TYPE=VIDEO,GROUP-ID="720p60",NAME="720p60",AUTOSELECT=YES,DEFAULT=YES
#EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=3459825,RESOLUTION=1280x720,CODECS="avc1.4D401F,mp4a.40.2",VIDEO="720p60"
https://video-weaver.ams02.hls.ttvnw.net/v1/playlist/[...].m3u8
7
#EXT-X-MEDIA:TYPE=VIDEO,GROUP-ID="chunked",NAME="1080p60 (source)",AUTOSELECT=YES,DEFAULT=YES
#EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=6964137,RESOLUTION=1920x1080,CODECS="avc1.4D402A,mp4a.40.2",VIDEO="chunked"
https://video-weaver.ams02.hls.ttvnw.net/v1/playlist/[...].m3u8

$ xidel -s twitch_esl_csgo.m3u8 -e 'let $url:="https://usher.ttvnw.net/api/channel/hls/esl_csgo.m3u8?[...]" return array{{"id":"hls-0","format":"m3u8[manifest]","url":$url},for $x at $i in extract($raw,"#EXT-X-(?:MEDIA|STREAM-INF).+?m3u8.*?$",0,"ms*") let $br:=extract($x,"BANDWIDTH=(\d+)",1),$br2:=extract($x,"GROUP-ID=.+?-(\d+)",1)[.],$br3:=extract($x,"audio.*?=(\d+)(?:-video.*?=(\d+))?",(1,2))[.] order by $br count $i return {"id":"hls-"||$i,"format":if (contains($x,"avc1")) then "m3u8[h264+aac]" else "m3u8[aac]","resolution"?:concat(extract($x,"RESOLUTION=([\dx]+)",1)[.],extract($x,"(?:FRAME-RATE=|GROUP-ID.+?\d{3}p)([\d\.]+)",1)[.] ! concat("@",round-half-to-even(.,3),"fps"))[.],"bitrate":(if ($br3[1]) then join((round($br3[2] div 1000),round($br3[1] div 1000)),"|") else ($br2,round($br div 1000))[1]) ! concat(.,"kbps"),"url":resolve-uri(if (contains($x,"URI=")) then extract($x,"URI=&quot;(.+)&quot;",1) else x:lines($x)[last()],$url)}}'
[
  {
    "id": "hls-0",
    "format": "m3u8[manifest]",
    "url": "https://usher.ttvnw.net/api/channel/hls/esl_csgo.m3u8?[...]"
  },
  {
    "id": "hls-1",
    "format": "m3u8[aac]",
    "bitrate": "195kbps",
    "url": "https://video-weaver.ams02.hls.ttvnw.net/v1/playlist/[...].m3u8"
  },
  [...]
  {
    "id": "hls-7",
    "format": "m3u8[h264+aac]",
    "resolution": "1920x1080@60fps",
    "bitrate": "6964kbps",
    "url": "https://video-weaver.ams02.hls.ttvnw.net/v1/playlist/[...].m3u8"
  }
]

------------------------------------------------------------------------------------------------

'tw_1188986316194635777.m3u8':

#EXTM3U
#EXT-X-INDEPENDENT-SEGMENTS
#EXT-X-MEDIA:TYPE=SUBTITLES,GROUP-ID="subs",NAME="en",DEFAULT=NO,FORCED=NO,URI="/amplify_video/1188974444523315201/pl/s0/3sjE70yJdGgqp0g1.m3u8",LANGUAGE="en",AUTOSELECT=YES,CHARACTERISTICS="twitter.show-text-when-muted"
#EXT-X-STREAM-INF:BANDWIDTH=288000,RESOLUTION=648x270,CODECS="mp4a.40.2,avc1.4d001f",SUBTITLES="subs"
/amplify_video/1188974444523315201/pl/648x270/O7Yd4NsLa4hRURCX.m3u8
#EXT-X-STREAM-INF:BANDWIDTH=832000,RESOLUTION=866x360,CODECS="mp4a.40.2,avc1.4d001f",SUBTITLES="subs"
/amplify_video/1188974444523315201/pl/866x360/ExSrz_uR9F_iO7O_.m3u8
#EXT-X-STREAM-INF:BANDWIDTH=2176000,RESOLUTION=1732x720,CODECS="mp4a.40.2,avc1.64002a",SUBTITLES="subs"
/amplify_video/1188974444523315201/pl/1732x720/yG0_asM0v9yBC-Xd.m3u8

$ xidel -s tw_1188986316194635777.m3u8 -e 'extract($raw,"#EXT-X-MEDIA:TYPE=SUBTITLES.+")'
#EXT-X-MEDIA:TYPE=SUBTITLES,GROUP-ID="subs",NAME="en",DEFAULT=NO,FORCED=NO,URI="/amplify_video/1188974444523315201/pl/s0/3sjE70yJdGgqp0g1.m3u8",LANGUAGE="en",AUTOSELECT=YES,CHARACTERISTICS="twitter.show-text-when-muted"

$ xidel -s tw_1188986316194635777.m3u8 -e 'for $x at $i in extract($raw,"#EXT-X-(?:MEDIA:TYPE=(?:AUDIO|VIDEO)|STREAM-INF).+?m3u8.*?$",0,"ms*") order by extract($x,"BANDWIDTH=(\d+)",1) count $i return ($i,$x)'
1
#EXT-X-STREAM-INF:BANDWIDTH=288000,RESOLUTION=648x270,CODECS="mp4a.40.2,avc1.4d001f",SUBTITLES="subs"
/amplify_video/1188974444523315201/pl/648x270/O7Yd4NsLa4hRURCX.m3u8
2
#EXT-X-STREAM-INF:BANDWIDTH=832000,RESOLUTION=866x360,CODECS="mp4a.40.2,avc1.4d001f",SUBTITLES="subs"
/amplify_video/1188974444523315201/pl/866x360/ExSrz_uR9F_iO7O_.m3u8
3
#EXT-X-STREAM-INF:BANDWIDTH=2176000,RESOLUTION=1732x720,CODECS="mp4a.40.2,avc1.64002a",SUBTITLES="subs"
/amplify_video/1188974444523315201/pl/1732x720/yG0_asM0v9yBC-Xd.m3u8

$ xidel -s tw_1188986316194635777.m3u8 -e 'let $url:="https://video.twimg.com/amplify_video/1188974444523315201/pl/OTSOTGtTUnYMAVnX.m3u8?tag=13" return array{extract($raw,"#EXT-X-MEDIA:TYPE=SUBTITLES.+")[.] ! {"id":"sub-1","format":"m3u8[vtt]","language":extract(.,"LANGUAGE=&quot;(.+?)&quot;",1),"url":resolve-uri(extract(.,"URI=&quot;(.+?)&quot;",1),$url)},{"id":"hls-0","format":"m3u8[manifest]","url":$url},for $x at $i in extract($raw,"#EXT-X-(?:MEDIA:TYPE=(?:AUDIO|VIDEO)|STREAM-INF).+?m3u8.*?$",0,"ms*") let $br:=extract($x,"BANDWIDTH=(\d+)",1),$br2:=extract($x,"GROUP-ID=.+?-(\d+)",1)[.],$br3:=extract($x,"audio.*?=(\d+)(?:-video.*?=(\d+))?",(1,2))[.] order by $br count $i return {"id":"hls-"||$i,"format":if (contains($x,"avc1")) then "m3u8[h264+aac]" else "m3u8[aac]","resolution"?:concat(extract($x,"RESOLUTION=([\dx]+)",1)[.],extract($x,"(?:FRAME-RATE=|GROUP-ID.+?\d{3}p)([\d\.]+)",1)[.] ! concat("@",round-half-to-even(.,3),"fps"))[.],"bitrate":(if ($br3[1]) then join((round($br3[2] div 1000),round($br3[1] div 1000)),"|") else ($br2,round($br div 1000))[1]) ! concat(.,"kbps"),"url":resolve-uri(if (contains($x,"URI=")) then extract($x,"URI=&quot;(.+)&quot;",1) else x:lines($x)[last()],$url)}}'
[
  {
    "id": "sub-1",
    "format": "m3u8[vtt]",
    "language": "en",
    "url": "https://video.twimg.com/amplify_video/1188974444523315201/pl/s0/3sjE70yJdGgqp0g1.m3u8"
  },
  {
    "id": "hls-0",
    "format": "m3u8[manifest]",
    "url": "https://video.twimg.com/amplify_video/1188974444523315201/pl/OTSOTGtTUnYMAVnX.m3u8?tag=13"
  },
  {
    "id": "hls-1",
    "format": "m3u8[h264+aac]",
    "resolution": "648x270",
    "bitrate": "288kbps",
    "url": "https://video.twimg.com/amplify_video/1188974444523315201/pl/648x270/O7Yd4NsLa4hRURCX.m3u8"
  },
  [...]
  {
    "id": "hls-3",
    "format": "m3u8[h264+aac]",
    "resolution": "1732x720",
    "bitrate": "2176kbps",
    "url": "https://video.twimg.com/amplify_video/1188974444523315201/pl/1732x720/yG0_asM0v9yBC-Xd.m3u8"
  }
]

------------------------------------------------------------------------------------------------

'dm_x5aa1uc.m3u8':

#EXTM3U
#EXT-X-STREAM-INF:BANDWIDTH=246440,CODECS="mp4a.40.5,avc1.42000d",RESOLUTION=320x184,NAME="240",PROGRESSIVE-URI="https://proxy-019.dc3.dailymotion.com/[...]/319595988_mp4_h264_aac_ld_1.mp4#cell=core&qos_part=1&qos_stail=1"
https://proxy-019.dc3.dailymotion.com/[...]/319595988_mp4_h264_aac_ld_1.m3u8#cell=core&qos_part=1&qos_stail=1
#EXT-X-STREAM-INF:BANDWIDTH=246440,CODECS="mp4a.40.5,avc1.42000d",RESOLUTION=320x184,NAME="240",PROGRESSIVE-URI="https://proxy-022.dc3.dailymotion.com/[...]/319595988_mp4_h264_aac_ld_1.mp4#cell=core&qos_part=1&qos_stail=1"
https://proxy-022.dc3.dailymotion.com/[...]/319595988_mp4_h264_aac_ld_1.m3u8#cell=core&qos_part=1&qos_stail=1
#EXT-X-STREAM-INF:BANDWIDTH=105040,CODECS="mp4a.40.5,avc1.42000b",RESOLUTION=192x112,NAME="144",PROGRESSIVE-URI="https://proxy-019.dc3.dailymotion.com/[...]/319595988_mp4_h264_aac_l2_1.mp4#cell=core&qos_part=1&qos_stail=1"
https://proxy-019.dc3.dailymotion.com/[...]/319595988_mp4_h264_aac_l2_1.m3u8#cell=core&qos_part=1&qos_stail=1
#EXT-X-STREAM-INF:BANDWIDTH=105040,CODECS="mp4a.40.5,avc1.42000b",RESOLUTION=192x112,NAME="144",PROGRESSIVE-URI="https://proxy-022.dc3.dailymotion.com/[...]/319595988_mp4_h264_aac_l2_1.mp4#cell=core&qos_part=1&qos_stail=1"
https://proxy-022.dc3.dailymotion.com/[...]/319595988_mp4_h264_aac_l2_1.m3u8#cell=core&qos_part=1&qos_stail=1
#EXT-X-STREAM-INF:BANDWIDTH=460560,CODECS="mp4a.40.5,avc1.420016",RESOLUTION=512x288,NAME="380",PROGRESSIVE-URI="https://proxy-019.dc3.dailymotion.com/[...]/319595988_mp4_h264_aac_1.mp4#cell=core&qos_part=1&qos_stail=1"
https://proxy-019.dc3.dailymotion.com/[...]/319595988_mp4_h264_aac_1.m3u8#cell=core&qos_part=1&qos_stail=1
#EXT-X-STREAM-INF:BANDWIDTH=460560,CODECS="mp4a.40.5,avc1.420016",RESOLUTION=512x288,NAME="380",PROGRESSIVE-URI="https://proxy-022.dc3.dailymotion.com/[...]/319595988_mp4_h264_aac_1.mp4#cell=core&qos_part=1&qos_stail=1"
https://proxy-022.dc3.dailymotion.com/[...]/319595988_mp4_h264_aac_1.m3u8#cell=core&qos_part=1&qos_stail=1
#EXT-X-STREAM-INF:BANDWIDTH=836280,CODECS="mp4a.40.2,avc1.64001f",RESOLUTION=640x360,NAME="480",PROGRESSIVE-URI="https://proxy-019.dc3.dailymotion.com/[...]/319595988_mp4_h264_aac_hq_1.mp4#cell=core&qos_part=1&qos_stail=1"
https://proxy-019.dc3.dailymotion.com/[...]/319595988_mp4_h264_aac_hq_1.m3u8#cell=core&qos_part=1&qos_stail=1
#EXT-X-STREAM-INF:BANDWIDTH=836280,CODECS="mp4a.40.2,avc1.64001f",RESOLUTION=640x360,NAME="480",PROGRESSIVE-URI="https://proxy-022.dc3.dailymotion.com/[...]/319595988_mp4_h264_aac_hq_1.mp4#cell=core&qos_part=1&qos_stail=1"
https://proxy-022.dc3.dailymotion.com/[...]/319595988_mp4_h264_aac_hq_1.m3u8#cell=core&qos_part=1&qos_stail=1

$ xidel -s dm_x5aa1uc.m3u8 -e 'let $streams:=extract($raw,"#EXT-X-(?:MEDIA:TYPE=(?:AUDIO|VIDEO)|STREAM-INF).+?m3u8.*?$",0,"ms*") return array{for $x at $i in $streams[contains(.,"PROGRESSIVE-URI")] let $br:=extract($x,"BANDWIDTH=(\d+)",1) order by $br count $i return {"id":"pg-"||$i,"format":"mp4[h264+aac]","resolution":extract($x,"RESOLUTION=([\dx]+)",1),"bitrate":round($br div 1000)||"kbps","url":extract($x,"URI=&quot;(.+mp4)(?:#.+)?&quot;",1)}}'
[
  {
    "id": "pg-1",
    "format": "mp4[h264+aac]",
    "resolution": "192x112",
    "bitrate": "105kbps",
    "url": "https://proxy-019.dc3.dailymotion.com/[...]/319595988_mp4_h264_aac_l2_1.mp4"
  },
  [...]
  {
    "id": "pg-8",
    "format": "mp4[h264+aac]",
    "resolution": "640x360",
    "bitrate": "836kbps",
    "url": "https://proxy-022.dc3.dailymotion.com/[...]/319595988_mp4_h264_aac_hq_1.mp4"
  }
]

$ xidel -s dm_x5aa1uc.m3u8 -e 'let $url:="https://www.dailymotion.com/cdn/manifest/video/x5aa1uc.m3u8?sec=eyMNx4dh_i1GpAS8KZdvuLpv_OYPeXseQRrYAtoqvsjKaTEW2g4-03MeQmu4oIC1",$streams:=extract($raw,"#EXT-X-(?:MEDIA:TYPE=(?:AUDIO|VIDEO)|STREAM-INF).+?m3u8.*?$",0,"ms*") return array{extract($raw,"#EXT-X-MEDIA:TYPE=SUBTITLES.+")[.] ! {"id":"sub-1","format":"m3u8[vtt]","language":extract(.,"LANGUAGE=&quot;(.+?)&quot;",1),"url":resolve-uri(extract(.,"URI=&quot;(.+?)&quot;",1),$url)},for $x at $i in $streams[contains(.,"PROGRESSIVE-URI")] let $br:=extract($x,"BANDWIDTH=(\d+)",1) order by $br count $i return {"id":"pg-"||$i,"format":"mp4[h264+aac]","resolution":extract($x,"RESOLUTION=([\dx]+)",1),"bitrate":round($br div 1000)||"kbps","url":extract($x,"URI=&quot;(.+mp4)(?:#.+)?&quot;",1)},{"id":"hls-0","format":"m3u8[manifest]","url":$url},for $x at $i in $streams let $br:=extract($x,"BANDWIDTH=(\d+)",1),$br2:=extract($x,"GROUP-ID=.+?-(\d+)",1)[.],$br3:=extract($x,"audio.*?=(\d+)(?:-video.*?=(\d+))?",(1,2))[.] order by $br count $i return {"id":"hls-"||$i,"format":if (contains($x,"avc1")) then "m3u8[h264+aac]" else "m3u8[aac]","resolution"?:concat(extract($x,"RESOLUTION=([\dx]+)",1)[.],extract($x,"(?:FRAME-RATE=|GROUP-ID.+?\d{3}p)([\d\.]+)",1)[.] ! concat("@",round-half-to-even(.,3),"fps"))[.],"bitrate":(if ($br3[1]) then join((round($br3[2] div 1000),round($br3[1] div 1000)),"|") else ($br2,round($br div 1000))[1]) ! concat(.,"kbps"),"url":resolve-uri(x:lines($x)[last()] ! (if (contains(.,"URI=")) then extract($x,"URI=&quot;(.+)&quot;",1) else replace(.,"#.+","")),$url)}}'
[
  {
    "id": "pg-1",
    "format": "mp4[h264+aac]",
    "resolution": "192x112",
    "bitrate": "105kbps",
    "url": "https://proxy-019.dc3.dailymotion.com/[...]/319595988_mp4_h264_aac_l2_1.mp4"
  },
  [...]
  {
    "id": "pg-8",
    "format": "mp4[h264+aac]",
    "resolution": "640x360",
    "bitrate": "836kbps",
    "url": "https://proxy-022.dc3.dailymotion.com/[...]/319595988_mp4_h264_aac_hq_1.mp4"
  },
  {
    "id": "hls-0",
    "format": "m3u8[manifest]",
    "url": "https://www.dailymotion.com/cdn/manifest/video/x5aa1uc.m3u8?sec=eyMNx4dh_i1GpAS8KZdvuLpv_OYPeXseQRrYAtoqvsjKaTEW2g4-03MeQmu4oIC1"
  },
  {
    "id": "hls-1",
    "format": "m3u8[h264+aac]",
    "resolution": "192x112",
    "bitrate": "105kbps",
    "url": "https://proxy-019.dc3.dailymotion.com/[...]/319595988_mp4_h264_aac_l2_1.m3u8"
  },
  [...]
  {
    "id": "hls-8",
    "format": "m3u8[h264+aac]",
    "resolution": "640x360",
    "bitrate": "836kbps",
    "url": "https://proxy-022.dc3.dailymotion.com/[...]/319595988_mp4_h264_aac_hq_1.m3u8"
  }
]

------------------------------------------------------------------------------------------------

'vimeo_238924796.m3u8':

#EXTM3U
#EXT-X-INDEPENDENT-SEGMENTS
#EXT-X-MEDIA:TYPE=AUDIO,GROUP-ID="audio-medium",NAME="audio",AUTOSELECT=YES,DEFAULT=YES,CHANNELS="2",URI="../../audio/853938837/playlist.m3u8"
#EXT-X-MEDIA:TYPE=AUDIO,GROUP-ID="audio-high",NAME="audio",AUTOSELECT=YES,DEFAULT=YES,CHANNELS="2",URI="../../audio/853938829/playlist.m3u8"

#EXT-X-STREAM-INF:CLOSED-CAPTIONS=NONE,BANDWIDTH=657686,AVERAGE-BANDWIDTH=485000,RESOLUTION=640x360,FRAME-RATE=25.000,CODECS="avc1.64001E,mp4a.40.2",AUDIO="audio-medium"
../853938837/playlist.m3u8
#EXT-X-STREAM-INF:CLOSED-CAPTIONS=NONE,BANDWIDTH=996877,AVERAGE-BANDWIDTH=624000,RESOLUTION=704x396,FRAME-RATE=25.000,CODECS="avc1.64001F,mp4a.40.2",AUDIO="audio-medium"
../853938829/playlist.m3u8

$ xidel -s vimeo_238924796.m3u8 -e 'let $streams:=extract($raw,"#EXT-X-(?:MEDIA:TYPE=(?:AUDIO|VIDEO)|STREAM-INF).+?m3u8.*?$",0,"ms*") for $x at $i in $streams let $br:=extract($x,"BANDWIDTH=(\d+)",1),$br2:=extract($x,"GROUP-ID=.+?-(\d+)",1)[.],$br3:=extract($x,"audio.*?=(\d+)(?:-video.*?=(\d+))?",(1,2))[.] order by $br count $i return (if ($br3[1]) then join((round($br3[2] div 1000),round($br3[1] div 1000)),"|") else ($br2,round($br[.] div 1000))[1]) ! concat(.,"kbps")'
658kbps
997kbps

$ xidel -s vimeo_238924796.m3u8 -e 'let $url:="https://197vod-adaptive.akamaized.net/exp=1606676297~acl=%2F238924796%2F%2A~hmac=02b379efe1250180b199bb4d6270271972a767a81e976b9442d92c76d178aa06/238924796/sep/video/853938837,853938829/master.m3u8",$streams:=extract($raw,"#EXT-X-(?:MEDIA:TYPE=(?:AUDIO|VIDEO)|STREAM-INF).+?m3u8.*?$",0,"ms*") return array{extract($raw,"#EXT-X-MEDIA:TYPE=SUBTITLES.+")[.] ! {"id":"sub-1","format":"m3u8[vtt]","language":extract(.,"LANGUAGE=&quot;(.+?)&quot;",1),"url":resolve-uri(extract(.,"URI=&quot;(.+?)&quot;",1),$url)},for $x at $i in $streams[contains(.,"PROGRESSIVE-URI")] let $br:=extract($x,"BANDWIDTH=(\d+)",1) order by $br count $i return {"id":"pg-"||$i,"format":"mp4[h264+aac]","resolution":extract($x,"RESOLUTION=([\dx]+)",1),"bitrate":round($br div 1000)||"kbps","url":extract($x,"URI=&quot;(.+mp4)(?:#.+)?&quot;",1)},{"id":"hls-0","format":"m3u8[manifest]","url":$url},for $x at $i in $streams let $br:=extract($x,"BANDWIDTH=(\d+)",1),$br2:=extract($x,"GROUP-ID=.+?-(\d+)",1)[.],$br3:=extract($x,"audio.*?=(\d+)(?:-video.*?=(\d+))?",(1,2))[.] order by $br count $i return {"id":"hls-"||$i,"format":if (contains($x,"avc1")) then "m3u8[h264+aac]" else "m3u8[aac]","resolution"?:concat(extract($x,"RESOLUTION=([\dx]+)",1)[.],extract($x,"(?:FRAME-RATE=|GROUP-ID.+?\d{3}p)([\d\.]+)",1)[.] ! concat("@",round-half-to-even(.,3),"fps"))[.],"bitrate"?:(if ($br3[1]) then join((round($br3[2] div 1000),round($br3[1] div 1000)),"|") else ($br2,round($br[.] div 1000))[1]) ! concat(.,"kbps"),"url":resolve-uri(x:lines($x)[last()] ! (if (contains(.,"URI=")) then extract($x,"URI=&quot;(.+)&quot;",1) else replace(.,"#.+","")),$url)}}'
[
  {
    "id": "hls-0",
    "format": "m3u8[manifest]",
    "url": "https://197vod-adaptive.akamaized.net/[...]/853938837,853938829/master.m3u8"
  },
  {
    "id": "hls-1",
    "format": "m3u8[aac]",
    "url": "https://197vod-adaptive.akamaized.net/[...]/853938837/playlist.m3u8"
  },
  [...]
  {
    "id": "hls-4",
    "format": "m3u8[h264+aac]",
    "resolution": "704x396@25fps",
    "bitrate": "997kbps",
    "url": "https://197vod-adaptive.akamaized.net/[...]/853938829/playlist.m3u8"
  }
]

------------------------------------------------------------------------------------------------

'nhnieuws_live.m3u8':

#EXTM3U
#EXT-X-VERSION:3
#EXT-X-STREAM-INF:BANDWIDTH=1153433,RESOLUTION=640x360
https://ngx.cr2.streamzilla.xlcdn.com/session/5f846bc4dafa168ea170d645fd5c892e/sz/nhnieuws/wowza4/live/live.smil/chunklist_b1048576.m3u8
#EXT-X-STREAM-INF:BANDWIDTH=2306867,RESOLUTION=1280x720
https://ngx.cr2.streamzilla.xlcdn.com/session/5f846bc4dafa168ea170d645fd5c892e/sz/nhnieuws/wowza4/live/live.smil/chunklist_b2097152.m3u8
#EXT-X-STREAM-INF:BANDWIDTH=3487334,RESOLUTION=1920x1080
https://ngx.cr2.streamzilla.xlcdn.com/session/5f846bc4dafa168ea170d645fd5c892e/sz/nhnieuws/wowza4/live/live.smil/chunklist_b3170304.m3u8

$ xidel -s nhnieuws_live.m3u8 -e 'let $url:="https://ngx.cr2.streamzilla.xlcdn.com/session/5f846bc4dafa168ea170d645fd5c892e/sz/nhnieuws/wowza4/live/live.smil/playlist.m3u8?token=UgzahPavoxmi-u_WRJaG9g&amp;time=1606692116",$streams:=extract($raw,"#EXT-X-(?:MEDIA:TYPE=(?:AUDIO|VIDEO)|STREAM-INF).+?m3u8.*?$",0,"ms*") return array{extract($raw,"#EXT-X-MEDIA:TYPE=SUBTITLES.+")[.] ! {"id":"sub-1","format":"m3u8[vtt]","language":extract(.,"LANGUAGE=&quot;(.+?)&quot;",1),"url":resolve-uri(extract(.,"URI=&quot;(.+?)&quot;",1),$url)},for $x at $i in $streams[contains(.,"PROGRESSIVE-URI")] let $br:=extract($x,"BANDWIDTH=(\d+)",1) order by $br count $i return {"id":"pg-"||$i,"format":"mp4[h264+aac]","resolution":extract($x,"RESOLUTION=([\dx]+)",1),"bitrate":round($br div 1000)||"kbps","url":extract($x,"URI=&quot;(.+mp4)(?:#.+)?&quot;",1)},{"id":"hls-0","format":"m3u8[manifest]","url":$url},for $x at $i in $streams let $br:=extract($x,"BANDWIDTH=(\d+)",1),$br2:=extract($x,"GROUP-ID=.+?-(\d+)",1)[.],$br3:=extract($x,"audio.*?=(\d+)(?:-video.*?=(\d+))?",(1,2))[.] order by $br count $i return {"id":"hls-"||$i,"format":if (contains($x,"avc1") or contains($x,"RESOLUTION")) then "m3u8[h264+aac]" else "m3u8[aac]","resolution"?:concat(extract($x,"RESOLUTION=([\dx]+)",1)[.],extract($x,"(?:FRAME-RATE=|GROUP-ID.+?\d{3}p)([\d\.]+)",1)[.] ! concat("@",round-half-to-even(.,3),"fps"))[.],"bitrate"?:(if ($br3[1]) then join((round($br3[2] div 1000),round($br3[1] div 1000)),"|") else ($br2,round($br[.] div 1000))[1]) ! concat(.,"kbps"),"url":resolve-uri(x:lines($x)[last()] ! (if (contains(.,"URI=")) then extract($x,"URI=&quot;(.+)&quot;",1) else replace(.,"#.+","")),$url)}}'
[
  {
    "id": "hls-0",
    "format": "m3u8[manifest]",
    "url": "https://ngx.cr2.streamzilla.xlcdn.com/[...]/playlist.m3u8?token=UgzahPavoxmi-u_WRJaG9g&time=1606692116"
  },
  {
    "id": "hls-1",
    "format": "m3u8[h264+aac]",
    "resolution": "640x360",
    "bitrate": "1153kbps",
    "url": "https://ngx.cr2.streamzilla.xlcdn.com/[...]/chunklist_b1048576.m3u8"
  },
  [...]
  {
    "id": "hls-3",
    "format": "m3u8[h264+aac]",
    "resolution": "1920x1080",
    "bitrate": "3487kbps",
    "url": "https://ngx.cr2.streamzilla.xlcdn.com/[...]/chunklist_b3170304.m3u8"
  }
]

------------------------------------------------------------------------------------------------

'rtl_37f2e7ec-5a27-3084-981b-1f77bd06732d.m3u8':

#EXTM3U
#EXT-X-VERSION:4
#EXT-X-MEDIA:TYPE=AUDIO,GROUP-ID="audio",NAME="audioname",DEFAULT=YES,URI="QualityLevels(125437)/Manifest(audioname,format=m3u8-aapl,filter=Quality,encryption=cbc)"
#EXT-X-STREAM-INF:BANDWIDTH=517546,RESOLUTION=336x192,CODECS="avc1.4d401f,mp4a.40.2",AUDIO="audio"
QualityLevels(365000)/Manifest(video,format=m3u8-aapl,filter=Quality,encryption=cbc)
#EXT-X-I-FRAME-STREAM-INF:BANDWIDTH=517546,RESOLUTION=336x192,CODECS="avc1.4d401f",URI="QualityLevels(365000)/Manifest(video,format=m3u8-aapl,filter=Quality,type=keyframes,encryption=cbc)"
#EXT-X-STREAM-INF:BANDWIDTH=737276,RESOLUTION=512x288,CODECS="avc1.4d401f,mp4a.40.2",AUDIO="audio"
QualityLevels(580000)/Manifest(video,format=m3u8-aapl,filter=Quality,encryption=cbc)
#EXT-X-I-FRAME-STREAM-INF:BANDWIDTH=737276,RESOLUTION=512x288,CODECS="avc1.4d401f",URI="QualityLevels(580000)/Manifest(video,format=m3u8-aapl,filter=Quality,type=keyframes,encryption=cbc)"
#EXT-X-STREAM-INF:BANDWIDTH=1140966,RESOLUTION=704x400,CODECS="avc1.4d401f,mp4a.40.2",AUDIO="audio"
QualityLevels(975000)/Manifest(video,format=m3u8-aapl,filter=Quality,encryption=cbc)
#EXT-X-I-FRAME-STREAM-INF:BANDWIDTH=1140966,RESOLUTION=704x400,CODECS="avc1.4d401f",URI="QualityLevels(975000)/Manifest(video,format=m3u8-aapl,filter=Quality,type=keyframes,encryption=cbc)"
#EXT-X-STREAM-INF:BANDWIDTH=2435840,RESOLUTION=912x512,CODECS="avc1.640029,mp4a.40.2",AUDIO="audio"
QualityLevels(2242000)/Manifest(video,format=m3u8-aapl,filter=Quality,encryption=cbc)
#EXT-X-I-FRAME-STREAM-INF:BANDWIDTH=2435840,RESOLUTION=912x512,CODECS="avc1.640029",URI="QualityLevels(2242000)/Manifest(video,format=m3u8-aapl,filter=Quality,type=keyframes,encryption=cbc)"
#EXT-X-STREAM-INF:BANDWIDTH=4356178,RESOLUTION=1280x720,CODECS="avc1.640029,mp4a.40.2",AUDIO="audio"
QualityLevels(4121000)/Manifest(video,format=m3u8-aapl,filter=Quality,encryption=cbc)
#EXT-X-I-FRAME-STREAM-INF:BANDWIDTH=4356178,RESOLUTION=1280x720,CODECS="avc1.640029",URI="QualityLevels(4121000)/Manifest(video,format=m3u8-aapl,filter=Quality,type=keyframes,encryption=cbc)"
#EXT-X-STREAM-INF:BANDWIDTH=136356,CODECS="mp4a.40.2",AUDIO="audio"
QualityLevels(125437)/Manifest(audioname,format=m3u8-aapl,filter=Quality,encryption=cbc)

$ xidel -s rtl_37f2e7ec-5a27-3084-981b-1f77bd06732d.m3u8 -e 'for $x at $i in extract($raw,"#EXT-X-(?:MEDIA:TYPE=(?:AUDIO|VIDEO)|STREAM-INF).+?m3u8.*?$",0,"ms*") order by extract($x,"BANDWIDTH=(\d+)",1) count $i return ($i,$x)'
1
#EXT-X-MEDIA:TYPE=AUDIO,GROUP-ID="audio",NAME="audioname",DEFAULT=YES,URI="QualityLevels(125437)/Manifest(audioname,format=m3u8-aapl,filter=Quality,encryption=cbc)"
2
#EXT-X-STREAM-INF:BANDWIDTH=136356,CODECS="mp4a.40.2",AUDIO="audio"
QualityLevels(125437)/Manifest(audioname,format=m3u8-aapl,filter=Quality,encryption=cbc)   # Twee keer dezelfde audiostream.
3
#EXT-X-STREAM-INF:BANDWIDTH=517546,RESOLUTION=336x192,CODECS="avc1.4d401f,mp4a.40.2",AUDIO="audio"
QualityLevels(365000)/Manifest(video,format=m3u8-aapl,filter=Quality,encryption=cbc)
4
#EXT-X-STREAM-INF:BANDWIDTH=737276,RESOLUTION=512x288,CODECS="avc1.4d401f,mp4a.40.2",AUDIO="audio"
QualityLevels(580000)/Manifest(video,format=m3u8-aapl,filter=Quality,encryption=cbc)
5
#EXT-X-STREAM-INF:BANDWIDTH=1140966,RESOLUTION=704x400,CODECS="avc1.4d401f,mp4a.40.2",AUDIO="audio"
QualityLevels(975000)/Manifest(video,format=m3u8-aapl,filter=Quality,encryption=cbc)
6
#EXT-X-STREAM-INF:BANDWIDTH=2435840,RESOLUTION=912x512,CODECS="avc1.640029,mp4a.40.2",AUDIO="audio"
QualityLevels(2242000)/Manifest(video,format=m3u8-aapl,filter=Quality,encryption=cbc)
7
#EXT-X-STREAM-INF:BANDWIDTH=4356178,RESOLUTION=1280x720,CODECS="avc1.640029,mp4a.40.2",AUDIO="audio"
QualityLevels(4121000)/Manifest(video,format=m3u8-aapl,filter=Quality,encryption=cbc)

$ xidel -s rtl_37f2e7ec-5a27-3084-981b-1f77bd06732d.m3u8 -e 'for $x at $i in extract($raw,"#EXT-X-(?:MEDIA:TYPE=(?:AUDIO|VIDEO)|STREAM-INF).+?m3u8.*?$",0,"ms*") group by $path:=x:lines($x)[last()] ! (if (contains(.,"URI=")) then extract($x,"URI=&quot;(.+)&quot;",1) else .) let $br:=extract($x,"BANDWIDTH=(\d+)",1) order by $br count $i return ($i,$x[last()])'
1
#EXT-X-STREAM-INF:BANDWIDTH=136356,CODECS="mp4a.40.2",AUDIO="audio"
QualityLevels(125437)/Manifest(audioname,format=m3u8-aapl,filter=Quality,encryption=cbc)
2
#EXT-X-STREAM-INF:BANDWIDTH=517546,RESOLUTION=336x192,CODECS="avc1.4d401f,mp4a.40.2",AUDIO="audio"
QualityLevels(365000)/Manifest(video,format=m3u8-aapl,filter=Quality,encryption=cbc)
3
#EXT-X-STREAM-INF:BANDWIDTH=737276,RESOLUTION=512x288,CODECS="avc1.4d401f,mp4a.40.2",AUDIO="audio"
QualityLevels(580000)/Manifest(video,format=m3u8-aapl,filter=Quality,encryption=cbc)
4
#EXT-X-STREAM-INF:BANDWIDTH=1140966,RESOLUTION=704x400,CODECS="avc1.4d401f,mp4a.40.2",AUDIO="audio"
QualityLevels(975000)/Manifest(video,format=m3u8-aapl,filter=Quality,encryption=cbc)
5
#EXT-X-STREAM-INF:BANDWIDTH=2435840,RESOLUTION=912x512,CODECS="avc1.640029,mp4a.40.2",AUDIO="audio"
QualityLevels(2242000)/Manifest(video,format=m3u8-aapl,filter=Quality,encryption=cbc)
6
#EXT-X-STREAM-INF:BANDWIDTH=4356178,RESOLUTION=1280x720,CODECS="avc1.640029,mp4a.40.2",AUDIO="audio"
QualityLevels(4121000)/Manifest(video,format=m3u8-aapl,filter=Quality,encryption=cbc)

$ xidel -s rtl_37f2e7ec-5a27-3084-981b-1f77bd06732d.m3u8 -e 'let $url:="https://cdn-rtlvod-h9.akamaized.net/[...]/manifest(format=m3u8-aapl,encryption=cbc,Filter=Quality).m3u8",$streams:=extract($raw,"#EXT-X-(?:MEDIA:TYPE=(?:AUDIO|VIDEO)|STREAM-INF).+?m3u8.*?$",0,"ms*") return array{extract($raw,"#EXT-X-MEDIA:TYPE=SUBTITLES.+")[.] ! {"id":"sub-1","format":"m3u8[vtt]","language":extract(.,"LANGUAGE=&quot;(.+?)&quot;",1),"url":resolve-uri(extract(.,"URI=&quot;(.+?)&quot;",1),$url)},for $x at $i in $streams[contains(.,"PROGRESSIVE-URI")] let $br:=extract($x,"BANDWIDTH=(\d+)",1) order by $br count $i return {"id":"pg-"||$i,"format":"mp4[h264+aac]","resolution":extract($x,"RESOLUTION=([\dx]+)",1),"bitrate":round($br div 1000)||"kbps","url":extract($x,"URI=&quot;(.+mp4)(?:#.+)?&quot;",1)},{"id":"hls-0","format":"m3u8[manifest]","url":$url},for $x at $i in $streams group by $path:=x:lines($x)[last()] ! (if (contains(.,"URI=")) then extract($x,"URI=&quot;(.+)&quot;",1) else replace(.,"#.+","")) let $br:=extract($x[last()],"BANDWIDTH=(\d+)",1),$br2:=extract($x,"GROUP-ID=.+?-(\d+)",1)[.],$br3:=extract($x,"audio.*?=(\d+)(?:-video.*?=(\d+))?",(1,2))[.] order by $br count $i return {"id":"hls-"||$i,"format":if (contains($x,"avc1") or contains($x,"RESOLUTION")) then "m3u8[h264+aac]" else "m3u8[aac]","resolution"?:concat(extract($x,"RESOLUTION=([\dx]+)",1)[.],extract($x,"(?:FRAME-RATE=|GROUP-ID.+?\d{3}p)([\d\.]+)",1)[.] ! concat("@",round-half-to-even(.,3),"fps"))[.],"bitrate"?:(if ($br3[1]) then join((round($br3[2] div 1000),round($br3[1] div 1000)),"|") else ($br2,round($br[.] div 1000))[1]) ! concat(.,"kbps"),"url":resolve-uri($path,$url)}}'
[
  {
    "id": "hls-0",
    "format": "m3u8[manifest]",
    "url": "https://cdn-rtlvod-h9.akamaized.net/[...]/manifest(format=m3u8-aapl,encryption=cbc,Filter=Quality).m3u8"
  },
  {
    "id": "hls-1",
    "format": "m3u8[aac]",
    "bitrate": "136kbps",
    "url": "https://cdn-rtlvod-h9.akamaized.net/[...]/QualityLevels(125437)/Manifest(audioname,format=m3u8-aapl,filter=Quality,encryption=cbc)"
  },
  [...]
  {
    "id": "hls-6",
    "format": "m3u8[h264+aac]",
    "resolution": "1280x720",
    "bitrate": "4356kbps",
    "url": "https://cdn-rtlvod-h9.akamaized.net/[...]/QualityLevels(4121000)/Manifest(video,format=m3u8-aapl,filter=Quality,encryption=cbc)"
  }
]

------------------------------------------------------------------------------------------------

'ogl_live.m3u8':

#EXTM3U
#EXT-X-VERSION:3
#EXT-X-MEDIA-SEQUENCE:10141
#EXT-X-TARGETDURATION:8
#EXTINF:5.000,
5476820400.ts
#EXTINF:6.720,
5477270400.ts
#EXTINF:8.360,
5477875200.ts
#EXTINF:2.440,
5478627600.ts
#EXTINF:6.040,
5478847200.ts

$ xidel -s ogl_live.m3u8 -e 'let $url:="https://d2od87akyl46nm.cloudfront.net/live/omroepgelderland/tvlive/index.m3u8",$streams:=extract($raw,"#EXT-X-(?:MEDIA:TYPE=(?:AUDIO|VIDEO)|STREAM-INF).+?m3u8.*?$",0,"ms*") return if (not(exists($streams))) then array{{"id":"hls-1","format":"m3u8[h264+aac]","url":$url}} else ()'
[
  {
    "id": "hls-1",
    "format": "m3u8[h264+aac]",
    "url": "https://d2od87akyl46nm.cloudfront.net/live/omroepgelderland/tvlive/index.m3u8"
  }
]

------------------------------------------------------------------------------------------------

$ xidel -se 'x:request({"url":"https://streams.rtvoost.nl/video/tv/hls.m3u8","error-handling":"4xx=accept"})/url'
https://mediacdn.rtvoost.nl/live/rtvoost/tv-oost/index.m3u8

$ xidel -se 'x:request({"url":"https://tkx.apis.anvato.net/rest/v2/mcp/video/10065499~~syv8ed1JI0T0eA/master.m3u8?anvack=yjqOEWaqi37WK2u26oMesa6LMGiJNeZl","error-handling":"4xx=accept"})/url'
https://dcs-vod.apis.anvato.net/vod/p/master.m3u8?encp=i57yUPHvLu2RUlFLg_QKoA:2VA_PSLbbNUp302PxtXXfQENkIA4s9mOL2qycWG-NZbrTMfVlwL05yCZg3q5VcghXoYLrAHSl9xn0eHZBymWIjmtnJpc005GKCimwfnYHEoEJFeuwBPwdMe5Qmb-OvhlSoUTRA6xZt2HSmFnt8wb8ayty9Wt2XQb9mL_arnk0OEQ7XOn7dUNXsLRg1RIjWVf18vhZOSNhMBrN3-hEIcJKb75fwIYhqdAD9w85IexSrYAJqcYmenrqAoyUZGeuCN3Hlc3PJgs6jV_qw_-wOen6neNGZBT8CFmNma85Vfdw7bt8y3-DtDkx70xjb8bhOmOESzetf7Aels7NghNP-WhI0iYyc7pL14p2pyJYoyW_QV_CxpktikfJ8GJ5BOghLBueYwcSiGwIkkt2z2TCTghCnHuRimM03xi292D4mp62uqM_7-iRlRHhztQVPlCu3jV4aSKNUNCo40I3c-mB2A2Nyr-hIJMmbThTIe-Hp1hMq2EX5BDKKGCdaqfjg4KYa7X_ERbjJNGcQ1cMmyMswvXY-uY8H9wBcEPQvuoEPXy5gRzFdORfgJiYRZJBk_DOjufq1Dxiy_55Bhmw-Bw2hRnMoHFz2j1eZ_UyIolJ76Xz1nsOjOt_AxY0eineGSHmmSF-kEUKGLRetXgEhuvR0UoX31Y3vtMG0v8PI-XPvgKATdBHc7jj9di2fZyQhukmjnQC1sEu9MM3nnHOqrSmbkvQtADsfFcuyTcfdJlnhcufU9QgdzjWsS3-EKq9-kcvf3TtqNQX1yWDLQPSfSjHEzkdZDAccx6FmXESQkfMeRluufUitGistOucgu89xRLty9--SlGxMpvvZs_uw_4hVC6ba7-vUsLO0bB4cP66tKb809uM9uqy2dVHwoBLSnYKGKti0RvRVkotgPpo1SsYBA49fq9IBTnFiBqKQMlm2IsNQthun1fM4WdI3MhePl68upVzm61qcCpwKIYEF55Bb3bzA&anvtrid=2c422506e010d9c092ad6564d06c7c9a&anvauth=tb=0~te=1570918109~sgn=422231fded672998b6d2cc3f7031c8a08349df211a8c303c79b28d44a3c441a4&t=1570918019

- Creëer de JSON met de redirected-url door 'x:request()' toe te voegen, maar gebruik de initiële url als de redirected-url vreselijk lang is, bijv. door een lang token.

'kijk_4KH25s3dZRH.m3u8'   # Met de nieuwe "theplatform" api wordt het helaas bij de HLS playlist pas duidelijk dat de video beveiligd is met DRM.

#EXTM3U
#EXT-X-VERSION:4
## Created with Unified Streaming Platform (version=1.10.18-20255)
#EXT-X-SESSION-KEY:METHOD=SAMPLE-AES,URI="skd://fairplay.entitlement.theplatform.eu/fpls/web/FairPlay",KEYFORMAT="com.apple.streamingkeydelivery",KEYFORMATVERSIONS="1"
[...]

- Filter deze in de 'x:request()' er al uit met 'not(contains(.,"#EXT-X-SESSION-KEY:METHOD=SAMPLE-AES"))'.

- Creëer een m3u8-to-json functie van deze query.

$ xidel -se 'declare function local:m3u8-to-json($url as string?) as array() {let $m3u8:=x:request({"url":$url,"error-handling":"4xx=accept"}[url])[raw[not(contains(.,"#EXT-X-SESSION-KEY:METHOD=SAMPLE-AES"))]],$m3u8Url:=if (string-length($m3u8/url) lt 512) then $m3u8/url else $url,$streams:=extract($m3u8/raw,"#EXT-X-(?:MEDIA:TYPE=(?:AUDIO|VIDEO)|STREAM-INF).+?m3u8.*?$",0,"ms*") return if (exists($m3u8) and not(exists($streams))) then array{{"id":"hls-1","format":"m3u8[h264+aac]","url":$m3u8Url}} else array{extract($m3u8/raw,"#EXT-X-MEDIA:TYPE=SUBTITLES.+")[.] ! {"id":"sub-1","format":"m3u8[vtt]","language":extract(.,"LANGUAGE=&quot;(.+?)&quot;",1),"url":resolve-uri(extract(.,"URI=&quot;(.+?)&quot;",1),$m3u8Url)},for $x at $i in $streams[contains(.,"PROGRESSIVE-URI")] let $br:=extract($x,"BANDWIDTH=(\d+)",1) order by $br count $i return {"id":"pg-"||$i,"format":"mp4[h264+aac]","resolution":extract($x,"RESOLUTION=([\dx]+)",1),"bitrate":round($br div 1000)||"kbps","url":extract($x,"URI=&quot;(.+mp4)(?:#.+)?&quot;",1)},{"id":"hls-0","format":"m3u8[manifest]","url":$m3u8Url}[url],for $x at $i in $streams group by $path:=x:lines($x)[last()] ! (if (contains(.,"URI=")) then extract($x,"URI=&quot;(.+)&quot;",1) else replace(.,"#.+","")) let $br:=extract($x[last()],"BANDWIDTH=(\d+)",1),$br2:=extract($x,"GROUP-ID=.+?-(\d+)",1)[.],$br3:=extract($x,"audio.*?=(\d+)(?:-video.*?=(\d+))?",(1,2))[.] order by $br count $i return {"id":"hls-"||$i,"format":if (contains($x,"avc1") or contains($x,"RESOLUTION")) then "m3u8[h264+aac]" else "m3u8[aac]","resolution"?:concat(extract($x,"RESOLUTION=([\dx]+)",1)[.],extract($x,"(?:FRAME-RATE=|GROUP-ID.+?\d{3}p)([\d\.]+)",1)[.] ! concat("@",round-half-to-even(.,3),"fps"))[.],"bitrate"?:(if ($br3[1]) then join((round($br3[2] div 1000),round($br3[1] div 1000)),"|") else ($br2,round($br[.] div 1000))[1]) ! concat(.,"kbps"),"url":resolve-uri($path,$m3u8Url)}}}; local:m3u8-to-json(<url>)'

string    # Een string.
string+   # Eén of meerdere strings.
string*   # Nul of meerdere strings.
string?   # Nul of één string.

------------------------------------------------------------------------------------------------

declare function xivid:m3u8-to-json($url as string?) as array() {
  let $m3u8:=x:request(
        {"url":$url,"error-handling":"4xx=accept"}[url]
      )[raw[not(contains(.,"#EXT-X-SESSION-KEY:METHOD=SAMPLE-AES"))]],
      $m3u8Url:=if (string-length($m3u8/url) lt 512) then $m3u8/url else $url,
      $streams:=extract(
        $m3u8/raw,
        "#EXT-X-(?:MEDIA:TYPE=(?:AUDIO|VIDEO)|STREAM-INF).+?m3u8.*?$",
        0,"ms*"
      )
  return
  if (exists($m3u8) and not(exists($streams))) then array{
    {
      "id":"hls-1",
      "format":"m3u8[h264+aac]",
      "url":$m3u8Url
    }
  } else array{
    extract($m3u8/raw,"#EXT-X-MEDIA:TYPE=SUBTITLES.+")[.] ! {
      "id":"sub-1",
      "format":"m3u8[vtt]",
      "language":extract(.,"LANGUAGE=&quot;(.+?)&quot;",1),
      "url":resolve-uri(
        extract(.,"URI=&quot;(.+?)&quot;",1),
        $m3u8Url
      )
    },
    for $x at $i in $streams[contains(.,"PROGRESSIVE-URI")]
    let $br:=extract($x,"BANDWIDTH=(\d+)",1)
    order by $br
    count $i
    return {
      "id":"pg-"||$i,
      "format":"mp4[h264+aac]",
      "resolution":extract($x,"RESOLUTION=([\dx]+)",1),
      "bitrate":round($br div 1000)||"kbps",
      "url":extract($x,"URI=&quot;(.+mp4)(?:#.+)?&quot;",1)
    },
    {
      "id":"hls-0",
      "format":"m3u8[manifest]",
      "url":$m3u8Url
    }[url],
    for $x at $i in $streams
    group by $path:=x:lines($x)[last()] ! (
      if (contains(.,"URI=")) then
        extract($x,"URI=&quot;(.+)&quot;",1)
      else
        replace(.,"#.+","")
    )
    let $br:=extract($x[last()],"BANDWIDTH=(\d+)",1),
        $br2:=extract($x,"GROUP-ID=.+?-(\d+)",1)[.],
        $br3:=extract($x,"audio.*?=(\d+)(?:-video.*?=(\d+))?",(1,2))[.]
    order by $br
    count $i
    return {
      "id":"hls-"||$i,
      "format":if (contains($x,"avc1") or contains($x,"RESOLUTION")) then
        "m3u8[h264+aac]"
      else
        "m3u8[aac]",
      "resolution"?:concat(
        extract($x,"RESOLUTION=([\dx]+)",1)[.],
        extract($x,"(?:FRAME-RATE=|GROUP-ID.+?\d{3}p)([\d\.]+)",1)[.] !
          concat("@",round-half-to-even(.,3),"fps")
      )[.],
      "bitrate"?:(
        if ($br3[1]) then
          join((round($br3[2] div 1000),round($br3[1] div 1000)),"|")
        else 
          ($br2,round($br[.] div 1000))[1]
      ) ! concat(.,"kbps"),
      "url":resolve-uri($path,$m3u8Url)
    }
  }
};

================================================================================================

[DASH mpd ontleding]

'https://www.youtube.com/watch?v=nG_LtCRRZ20'   # DASH manifest als url.

$ xidel -se 'request-decode("?"||unparsed-text("https://www.youtube.com/get_video_info?video_id=nG_LtCRRZ20"))/params/parse-json(player_response)/streamingData/(dashManifestUrl,unparsed-text(dashManifestUrl))'
https://manifest.googlevideo.com/api/manifest/dash/[...]
<?xml version="1.0" encoding="UTF-8"?>
<MPD xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="urn:mpeg:DASH:schema:MPD:2011" xmlns:yt="http://youtube.com/yt/2012/10/10" xsi:schemaLocation="urn:mpeg:DASH:schema:MPD:2011 DASH-MPD.xsd" minBufferTime="PT1.500S" profiles="urn:mpeg:dash:profile:isoff-main:2011" type="static" mediaPresentationDuration="PT20.154S"><Period><AdaptationSet id="0" mimeType="audio/mp4" subsegmentAlignment="true"><Role schemeIdUri="urn:mpeg:DASH:role:2011" value="main"/><SegmentList startNumber="0" timescale="1000"><SegmentTimeline><S d="9985"/><S d="9984"/><S d="186"/></SegmentTimeline></SegmentList><Representation id="139" codecs="mp4a.40.5" audioSamplingRate="22050" startWithSAP="1" bandwidth="49875"><AudioChannelConfiguration schemeIdUri="urn:mpeg:dash:23003:3:audio_channel_configuration:2011" value="2"/><BaseURL>https://r3---sn-mn4vg5aa-5hnl.googlevideo.com/videoplayback/[...]/itag/139/[...]</BaseURL><SegmentList><Initialization sourceURL="range/0-664"/><SegmentURL media="range/733-62250"/><SegmentURL media="range/62251-123088"/><SegmentURL media="range/123089-124115"/></SegmentList></Representation><Representation id="140" codecs="mp4a.40.2" audioSamplingRate="44100" startWithSAP="1" bandwidth="130406"><AudioChannelConfiguration schemeIdUri="urn:mpeg:dash:23003:3:audio_channel_configuration:2011" value="2"/><BaseURL>https://r3---sn-mn4vg5aa-5hnl.googlevideo.com/videoplayback/[...]/itag/140/[...]</BaseURL><SegmentList><Initialization sourceURL="range/0-655"/><SegmentURL media="range/724-162763"/><SegmentURL media="range/162764-324286"/><SegmentURL media="range/324287-325964"/></SegmentList></Representation></AdaptationSet><AdaptationSet id="1" mimeType="audio/webm" subsegmentAlignment="true">[...]</AdaptationSet><AdaptationSet id="2" mimeType="video/mp4" subsegmentAlignment="true">[...]</AdaptationSet><AdaptationSet id="3" mimeType="video/webm" subsegmentAlignment="true">[...]</AdaptationSet></Period></MPD>

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

XML prettification:

$ xidel -se '[...]/("<?xml version=""1.0"" encoding=""UTF-8""?>",serialize(unparsed-text(dashManifestUrl),{"indent":true()}))'
$ xidel -se '[...]/serialize(unparsed-text(dashManifestUrl),{"indent":true()})' --output-declaration='<?xml version="1.0" encoding="UTF-8"?>'
$ xidel -se '[...]/serialize(unparsed-text(dashManifestUrl),{"indent":true(),"omit-xml-declaration":false()})'
<?xml version="1.0" encoding="UTF-8"?>
<MPD xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="urn:mpeg:DASH:schema:MPD:2011" xmlns:yt="http://youtube.com/yt/2012/10/10" xsi:schemaLocation="urn:mpeg:DASH:schema:MPD:2011 DASH-MPD.xsd" minBufferTime="PT1.500S" profiles="urn:mpeg:dash:profile:isoff-main:2011" type="static" mediaPresentationDuration="PT1092.684S">
  <Period>
    <AdaptationSet id="0" mimeType="audio/mp4" subsegmentAlignment="true">
      <Role schemeIdUri="urn:mpeg:DASH:role:2011" value="main"/>
      <SegmentList startNumber="0" timescale="1000">
        <SegmentTimeline>
          <S d="9985"/>
          <S d="9984"/>
          <S d="9985"/>
          [...]
        </SegmentTimeline>
      </SegmentList>
      <Representation id="139" codecs="mp4a.40.5" audioSamplingRate="22050" startWithSAP="1" bandwidth="50954">
        <AudioChannelConfiguration schemeIdUri="urn:mpeg:dash:23003:3:audio_channel_configuration:2011" value="2"/>
        <BaseURL>https://r6---sn-mn4vg5aa-5hns.googlevideo.com/videoplayback/[...]</BaseURL>
        <SegmentList>
          <Initialization sourceURL="range/0-664"/>
          <SegmentURL media="range/2017-63597"/>
          <SegmentURL media="range/63598-124537"/>
          <SegmentURL media="range/124538-185422"/>
          [...]
        </SegmentList>
      </Representation>
      [...]
    </AdaptationSet>
    [...]
  </Period>
</MPD>

$ xidel -s manifest.mpd -e 'file:write("manifest_pretty.mpd",.,{"indent":true(),"omit-xml-declaration":false()})'

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

$ xidel -se 'declare function local:mpd-to-json($mpd) as array() {array{{"id":"dash-0","format":"mpd[manifest]","url":$mpd},for $x at $i in doc($mpd)//Representation order by boolean($x/@width),$x/@bandwidth count $i return {"id":"dash-"||$i,"format":concat(substring-after($x/../@mimeType,"/"),"[",tokenize($x/@codecs,"\.")[1] ! (if (.="mp4a") then "aac" else if (.="avc1") then "h264" else .),"]"),"resolution"?:$x/@width ! concat(.,"x",$x/@height,"@",$x/@frameRate,"fps"),"samplerate"?:$x/@audioSamplingRate ! concat(. div 1000,"kHz"),"bitrate":round($x/@bandwidth div 1000)||"kbps","url":$x/BaseUrl}}}; local:mpd-to-json("https://manifest.googlevideo.com/api/manifest/dash/[...]")'
[
  {
    "id": "dash-0",
    "format": "mpd[manifest]",
    "url": "https://manifest.googlevideo.com/api/manifest/dash/[...]"
  },
  {
    "id": "dash-1",
    "format": "mp4[aac]",
    "samplerate": "22.05kHz",
    "bitrate": "51kbps",
    "url": "https://r6---sn-mn4vg5aa-5hns.googlevideo.com/videoplayback/[...]/itag/139/[...]"
  },
  [...]
  {
    "id": "dash-15",
    "format": "mp4[h264]",
    "resolution": "1280x720@50fps",
    "bitrate": "2866kbps",
    "url": "https://r6---sn-mn4vg5aa-5hns.googlevideo.com/videoplayback/[...]/itag/298/[...]"
  }
]

------------------------------------------------------------------------------------------------

'https://www.facebook.com/watch/?v=374747990176575'   # DASH manifest als document-node.

$ xidel -se 'x:request({"headers":"User-Agent: Mozilla/5.0 Firefox/84.0","url":"https://www.facebook.com/watch/?v=374747990176575"})/doc/parse-json(replace(//script/extract(.,"onPageletArrive\((.+?)\);",1)[contains(.,"videoData")],"\\\x","\\\u00"),{"liberal":true()})//dash_manifest'
<?xml version="1.0"?>
<MPD xmlns="urn:mpeg:dash:schema:mpd:2011" minBufferTime="PT1.500S" type="static" mediaPresentationDuration="PT0H1M7.008S" maxSegmentDuration="PT0H0M5.000S" profiles="urn:mpeg:dash:profile:isoff-on-demand:2011,http://dashif.org/guidelines/dash264" FBTagsetUsed="v4_5secgop"><Period duration="PT0H1M7.008S"><AdaptationSet segmentAlignment="true" maxWidth="720" maxHeight="900" maxFrameRate="25" par="512:640" lang="eng" subsegmentAlignment="true" subsegmentStartsWithSAP="1"><Representation id="388357695712707v" mimeType="video/mp4" codecs="avc1.4D401F" width="512" height="640" frameRate="25" sar="1:1" startWithSAP="1" bandwidth="226389" [...]><BaseURL>https://video.fams1-1.fna.fbcdn.net/v/t39.25447-2/121592073_338211253915421_5657026045253466176_n.mp4?[...]</BaseURL><SegmentBase indexRangeExact="true" indexRange="971-1170" FBFirstSegmentRange="1171-111278"><Initialization range="0-970"/></SegmentBase></Representation>[...]</AdaptationSet><AdaptationSet segmentAlignment="true" lang="eng" subsegmentAlignment="true" subsegmentStartsWithSAP="1"><Representation id="405461810413399a" mimeType="audio/mp4" codecs="mp4a.40.5" audioSamplingRate="48000" startWithSAP="1" bandwidth="65445" [...]><AudioChannelConfiguration schemeIdUri="urn:mpeg:dash:23003:3:audio_channel_configuration:2011" value="2"/><BaseURL>https://video.fams1-1.fna.fbcdn.net/v/t42.1790-2/109281327_405461813746732_178858496964516997_n.mp4?[...]</BaseURL><SegmentBase indexRangeExact="true" indexRange="930-1369" FBFirstSegmentRange="1370-17883"><Initialization range="0-929"/></SegmentBase></Representation></AdaptationSet></Period></MPD>

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

XML prettification:

$ xidel -se '[...]/serialize(parse-xml(.//dash_manifest),{"indent":true()})' --output-declaration='<?xml version="1.0"?>'
$ xidel -se '[...]/serialize(parse-xml(.//dash_manifest),{"indent":true(),"omit-xml-declaration":false()})'   # Deze optie geeft standaard <?xml version="1.0" encoding="UTF-8"?> als (nieuwe) declaratie. Zou een bestaande declaratie met rust moeten laten imo.
<?xml version="1.0"?>
<MPD xmlns="urn:mpeg:dash:schema:mpd:2011" minBufferTime="PT1.500S" type="static" mediaPresentationDuration="PT0H1M7.008S" maxSegmentDuration="PT0H0M5.000S" profiles="urn:mpeg:dash:profile:isoff-on-demand:2011,http://dashif.org/guidelines/dash264" FBTagsetUsed="v4_5secgop">
  <Period duration="PT0H1M7.008S">
    <AdaptationSet segmentAlignment="true" maxWidth="720" maxHeight="900" maxFrameRate="25" par="512:640" lang="eng" subsegmentAlignment="true" subsegmentStartsWithSAP="1">
      <Representation id="388357695712707v" mimeType="video/mp4" codecs="avc1.4D401F" width="512" height="640" frameRate="25" sar="1:1" startWithSAP="1" bandwidth="226389" [...]>
        <BaseURL>https://video.fams1-1.fna.fbcdn.net/v/t39.25447-2/121592073_338211253915421_5657026045253466176_n.mp4?[...]</BaseURL>
        <SegmentBase indexRangeExact="true" indexRange="971-1170" FBFirstSegmentRange="1171-111278">
          <Initialization range="0-970"/>
        </SegmentBase>
      </Representation>
      [...]
    </AdaptationSet>
    <AdaptationSet segmentAlignment="true" lang="eng" subsegmentAlignment="true" subsegmentStartsWithSAP="1">
      <Representation id="405461810413399a" mimeType="audio/mp4" codecs="mp4a.40.5" audioSamplingRate="48000" startWithSAP="1" bandwidth="65445" [...]>
        <AudioChannelConfiguration schemeIdUri="urn:mpeg:dash:23003:3:audio_channel_configuration:2011" value="2"/>
        <BaseURL>https://video.fams1-1.fna.fbcdn.net/v/t42.1790-2/109281327_405461813746732_178858496964516997_n.mp4?[...]</BaseURL>
        <SegmentBase indexRangeExact="true" indexRange="930-1369" FBFirstSegmentRange="1370-17883">
          <Initialization range="0-929"/>
        </SegmentBase>
      </Representation>
    </AdaptationSet>
  </Period>
</MPD>

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

$ xidel -s --xmlns:xivid="https://github.com/Reino17/xivid/" -e 'declare function xivid:mpd-to-json($mpd) as array() {array{{"id":"dash-0","format":"mpd[manifest]","url":$mpd[. instance of string]}[url],for $x at $i in (if ($mpd instance of node()) then $mpd else doc($mpd))//Representation order by boolean($x/@width),$x/@bandwidth count $i return {"id":"dash-"||$i,"format":concat(substring-after($x/(.,..)/@mimeType,"/"),"[",tokenize($x/@codecs,"\.")[1] ! (if (.="mp4a") then "aac" else if (.="avc1") then "h264" else .),"]"),"resolution"?:$x/@width ! concat(.,"x",$x/@height,"@",$x/@frameRate,"fps"),"samplerate"?:$x/@audioSamplingRate ! concat(. div 1000,"kHz"),"bitrate":round($x/@bandwidth div 1000)||"kbps","url":$x/BaseUrl}}}; x:request({"headers":"User-Agent: Mozilla/5.0 Firefox/84.0","url":"https://www.facebook.com/watch/?v=374747990176575"})/doc/parse-json(replace(//script/extract(.,"onPageletArrive\((.+?)\);",1)[contains(.,"videoData")],"\\\x","\\\u00"),{"liberal":true()})/xivid:mpd-to-json(parse-xml(.//dash_manifest))'
[
  {
    "id": "dash-1",
    "format": "mp4[aac]",
    "samplerate": "48kHz",
    "bitrate": "65kbps",
    "url": "https://video.fams1-1.fna.fbcdn.net/v/t42.1790-2/109281327_405461813746732_178858496964516997_n.mp4?[...]"
  },
  [...]
  {
    "id": "dash-5",
    "format": "mp4[h264]",
    "resolution": "720x900@25fps",
    "bitrate": "378kbps",
    "url": "https://video.fams1-1.fna.fbcdn.net/v/t39.25447-2/121418431_154480879657509_7493886390368626002_n.mp4?[...]"
  }
]

------------------------------------------------------------------------------------------------

'https://www.facebook.com/AFV/videos/3868462086560598'   # Framerate als breuk.

$ xidel -se 'x:request({"headers":"User-Agent: Mozilla/5.0 Firefox/84.0","url":"https://www.facebook.com/AFV/videos/3868462086560598"})/doc/parse-json(replace(//script/extract(.,"onPageletArrive\((.+?)\);",1)[contains(.,"videoData")],"\\\x","\\\u00"),{"liberal":true()})/serialize(parse-xml(.//dash_manifest),{"indent":true()})' --output-declaration='<?xml version="1.0"?>'
<?xml version="1.0"?>
<MPD xmlns="urn:mpeg:dash:schema:mpd:2011" minBufferTime="PT1.500S" type="static" mediaPresentationDuration="PT0H3M3.253S" maxSegmentDuration="PT0H0M5.005S" profiles="urn:mpeg:dash:profile:isoff-on-demand:2011,http://dashif.org/guidelines/dash264" FBTagsetUsed="v4_5secgop">
  <Period duration="PT0H3M3.253S">
    <AdaptationSet segmentAlignment="true" maxWidth="1080" maxHeight="1080" maxFrameRate="11988/400" par="1:1" lang="eng" subsegmentAlignment="true" subsegmentStartsWithSAP="1">
      <Representation id="686583002042085v" mimeType="video/mp4" codecs="avc1.4D401E" width="426" height="426" frameRate="11988/400" sar="1:1" startWithSAP="1" bandwidth="495243" [...]>
        <BaseURL>https://video.fams1-1.fna.fbcdn.net/v/t39.25447-2/10000000_211002737316506_3401323434707970907_n.mp4?[...]</BaseURL>
        <SegmentBase indexRangeExact="true" indexRange="970-1445" FBFirstSegmentRange="1446-363121">
          <Initialization range="0-969"/>
        </SegmentBase>
      </Representation>
      [...]
    </AdaptationSet>
    [...]
  </Period>
</MPD>

$ xidel -se 'declare namespace xivid = "https://github.com/Reino17/xivid/"; declare function xivid:mpd-to-json($mpd) as array() {array{{"id":"dash-0","format":"mpd[manifest]","url":$mpd[. instance of string]}[url],for $x at $i in (if ($mpd instance of node()) then $mpd else doc($mpd))//Representation order by boolean($x/@width),$x/@bandwidth count $i return {"id":"dash-"||$i,"format":concat(substring-after($x/(.,..)/@mimeType,"/"),"[",tokenize($x/@codecs,"\.")[1] ! (if (.="mp4a") then "aac" else if (.="avc1") then "h264" else .),"]"),"resolution"?:$x/@width ! concat(.,"x",$x/@height,"@",eval(replace($x/@frameRate,"/"," div ")),"fps"),"samplerate"?:$x/@audioSamplingRate ! concat(. div 1000,"kHz"),"bitrate":round($x/@bandwidth div 1000)||"kbps","url":$x/BaseUrl}}}; x:request({"headers":"User-Agent: Mozilla/5.0 Firefox/84.0","url":"https://www.facebook.com/AFV/videos/3868462086560598"})/doc/parse-json(replace(//script/extract(.,"onPageletArrive\((.+?)\);",1)[contains(.,"videoData")],"\\\x","\\\u00"),{"liberal":true()})/xivid:mpd-to-json(parse-xml(.//dash_manifest))'
[
  {
    "id": "dash-1",
    "format": "mp4[aac]",
    "samplerate": "48kHz",
    "bitrate": "65kbps",
    "url": "https://video.fams1-1.fna.fbcdn.net/v/t42.1790-2/101540421_3072634259510939_7405909952142770176_n.mp4?[...]"
  },
  [...]
  {
    "id": "dash-5",
    "format": "mp4[h264]",
    "resolution": "1080x1080@29.97fps",
    "bitrate": "3269kbps",
    "url": "https://video.fams1-1.fna.fbcdn.net/v/t39.25447-2/10000000_373951763866207_2053968370854114061_n.mp4?[...]"
  }
]

------------------------------------------------------------------------------------------------

declare function xivid:mpd-to-json($mpd) as array() {
  array{
    {
      "id":"dash-0",
      "format":"mpd[manifest]",
      "url":$mpd[. instance of string]
    }[url],
    for $x at $i in (
      if ($mpd instance of node()) then $mpd else doc($mpd)
    )//Representation
    order by boolean($x/@width),$x/@bandwidth
    count $i
    return {
      "id":"dash-"||$i,
      "format":concat(
        substring-after($x/(.,..)/@mimeType,"/"),
        "[",
        tokenize($x/@codecs,"\.")[1] ! (
          if (.="mp4a") then "aac" else
          if (.="avc1") then "h264" else .
        ),
        "]"
      ),
      "resolution"?:$x/@width ! concat(
        .,"x",$x/@height,"@",eval(replace($x/@frameRate,"/"," div ")),"fps"
      ),
      "samplerate"?:$x/@audioSamplingRate ! concat(. div 1000,"kHz"),
      "bitrate":round($x/@bandwidth div 1000)||"kbps",
      "url":$x/BaseUrl
    }
  }
};

================================================================================================

[Blue Billywig]

$ url=https://ndc.bbvms.com/p/lc_videoplayer_v2/c/3892522.json   # Leeuwarder Courant

$ xidel -se 'json-doc("'$url'")/(clipData,parse-json(clipData/s3Info),publicationData)'
{
  "id": "3892522",
  [...]
  "sourcetype": "on_demand",
  "originalfilename": "FBVERSIEBOMEN.mp4",
  "length": "102",
  "sourceid": "",
  "title": "Enorme belangstelling voor gratis perenbomen in Heerenveen",
  [...]
  "publisheddate": "2020-08-22T10:03:48Z",
  [...]
  "originalWidth": 1920,
  "originalHeight": 1080,
  [...]
  "assets": [
    {
      "mediatype": "MP4_MAIN",
      "id": "1598093328914448",
      "status": "active",
      "src": "/ndc/media/2020/08/22/asset-3892522-1598093328914448.mp4",
      "length": "102",
      "exactlength": "102379",
      "width": "1280",
      "height": "720",
      "bandwidth": "2000",
      "jobdefid": "mp4_main-1280x720-2000",
      "jobqid": "mp4_main-1280x720-2000"
    },
    {
      "mediatype": "MP4_MAIN",
      "id": "1598093329066746",
      "status": "active",
      "src": "/ndc/media/2020/08/22/asset-3892522-1598093329066746.mp4",
      "length": "102",
      "exactlength": "102379",
      "width": "768",
      "height": "432",
      "bandwidth": "1600",
      "jobdefid": "mp4_main-768x432-1600",
      "jobqid": "mp4_main-768x432-1600"
    },
    [...]
  ],
  [...]
  "publication": "lc",
  "source": "lc",
  "isPrefetch": "true",
  "s3Info": "[...]{\"filename\": \"https://s3.eu-west-1.amazonaws.com/mm.ndc.bbvms.com/upload/ndc/2020/08/22/58d8c9860156bf19f0bf4ae6160297fc/58d8c9860156bf19f0bf4ae6160297fc.mp4\"[...]",
  [...]
}
{
  [...]
  "format": {
    "filename": "https://s3.eu-west-1.amazonaws.com/mm.ndc.bbvms.com/upload/ndc/2020/08/22/58d8c9860156bf19f0bf4ae6160297fc/58d8c9860156bf19f0bf4ae6160297fc.mp4",
    "nb_streams": 2,
    "nb_programs": 0,
    "format_name": "mov,mp4,m4a,3gp,3g2,mj2",
    "format_long_name": "QuickTime / MOV",
    "start_time": "0:00:00.000000",
    "duration": "0:01:42.293333",
    "size": "122.606459 Mibyte",
    "bit_rate": "10.054394 Mbit/s",
    "probe_score": 100,
    "tags": {
      "major_brand": "mp42",
      "minor_version": "0",
      "compatible_brands": "mp42mp41",
      "creation_time": "2020-08-22T10:29:23.000000Z"
    }
  },
  [...]
}
{
  [...]
  "name": "ndc",
  "label": "NDC",
  [...]
  "defaultMediaAssetPath": "https://d3jbi46382yahz.cloudfront.net",
  [...]
}

In veel gevallen zijn de gegevens in de "Blue Billywig"-json veel te ontbetrouwbaar om de naam hier uit te halen, omdat ze lang niet altijd aanwezig zijn.
Daarom de optionele 2e parameter voor een naam. Niet gespecificeerd, dan de naam uit de "Blue Billywig"-json.

$ xidel -se 'declare function local:bbvms($url as string?,$publ as string?,$title as string?) as object()? {let $json:=json-doc($url),$host:=$json/publicationData/defaultMediaAssetPath,$orig:=parse-json($json/clipData/s3Info) return $json/clipData/{"name":join((if ($publ) then $publ else $json/publicationData/label,if ($title) then $title else title),": "),"date":publisheddate,"duration":length * duration("PT1S"),"formats":array{for $x at $i in (assets)() order by $x/bandwidth count $i return $x/{"id":"pg-"||$i,"format":"mp4[h264+aac]","resolution":concat(width,"x",height),"bitrate":bandwidth||"kbps","url":resolve-uri(src,$host)},{"id":"pg-"||count((assets)()) + 1,"format":"mp4[h264+aac]","resolution":concat(originalWidth,"x",originalHeight),"bitrate":round(tokenize($orig/format/bit_rate)[1] * 1024)||"kbps","url":$orig/format/filename}[url]}}}; local:bbvms("'$url'","Leeuwarder Courant",())'
{
  "name": "Leeuwarder Courant: Enorme belangstelling voor gratis perenbomen in Heerenveen",
  "date": "2020-08-22T10:03:48Z",
  "duration": "PT1M42S",
  "formats": [
    {
      "id": "pg-1",
      "format": "mp4[h264+aac]",
      "resolution": "512x288",
      "bitrate": "400kbps",
      "url": "https://d3jbi46382yahz.cloudfront.net/ndc/media/2020/08/22/asset-3892522-1598093329299560.mp4"
    },
    [...]
    {
      "id": "pg-6",
      "format": "mp4[h264+aac]",
      "resolution": "1920x1080",
      "bitrate": "3000kbps",
      "url": "https://d3jbi46382yahz.cloudfront.net/ndc/media/2020/08/22/asset-3892522-1598093329696575.mp4"
    },
    {
      "id": "pg-7",
      "format": "mp4[h264+aac]",
      "resolution": "1920x1080",
      "bitrate": "10296kbps",
      "url": "https://s3.eu-west-1.amazonaws.com/mm.ndc.bbvms.com/upload/ndc/2020/08/22/58d8c9860156bf19f0bf4ae6160297fc/58d8c9860156bf19f0bf4ae6160297fc.mp4"
    }
  ]
}

------------------------------------------------------------------------------------------------

$ url=https://omropfryslan.bbvms.com/p/omrop_frysl_n_live_stream_4/c/3748627.json   # Omrop Fryslân

$ xidel -se 'json-doc("'$url'")/clipData'
{
  [...]
  "sourcetype": "live",
  "originalfilename": "",
  "length": null,
  "sourceid": "live_api_04b3d44d-40d1-424e-bf97-72a913daf431",
  "title": "Omrop Fryslân Live TV",
  [...]
  "publisheddate": "2020-05-25T21:18:15Z",
  [...]
  "assets": [
    {
      "mediatype": "MP4_MAIN",
      "id": "1590440881090348",
      "status": "active",
      "src": "https://d3pvma9xb2775h.cloudfront.net/live/omropfryslan/stream04/index.m3u8",
      "length": "",
      "exactlength": "",
      "width": "1920",
      "height": "1080",
      "bandwidth": "1000"
    }
  ],
  [...]
}

$ xidel -s --module=xivid.xqm -e 'declare function local:bbvms($url as string?,$publ as string?,$title as string?) as object()? {let $json:=json-doc($url),$host:=$json/publicationData/defaultMediaAssetPath,$orig:=parse-json($json/clipData/s3Info) return $json/clipData/map:merge(({"name":join((if ($publ) then $publ else $json/publicationData/label,if ($title) then $title else title),": ")},if (sourcetype="live") then {"date":substring(adjust-dateTime-to-timezone(current-dateTime() + duration("PT0.5S"),duration("PT0S")),1,19)||"Z"} else {"date":publisheddate,"duration":length * duration("PT1S")},{"formats":array{xivid:m3u8-to-json((assets)()[ends-with(src,"m3u8")]/src)(),for $x at $i in (assets)()[ends-with(src,"mp4")] order by $x/bandwidth count $i return $x/{"id":"pg-"||$i,"format":"mp4[h264+aac]","resolution":concat(width,"x",height),"bitrate":bandwidth||"kbps","url":resolve-uri(src,$host)},{"id":"pg-"||count((assets)()) + 1,"format":"mp4[h264+aac]","resolution":concat(originalWidth,"x",originalHeight),"bitrate":round(tokenize($orig/format/bit_rate)[1] * 1024)||"kbps","url":$orig/format/filename}[url]}}))}; local:bbvms("'$url'","Omrop Fryslân","Livestream")'
{
  "name": "Omrop Fryslân: Livestream",
  "date": "2020-12-18T20:18:36Z",
  "formats": [
    {
      "id": "hls-0",
      "format": "m3u8[manifest]",
      "url": "https://d3pvma9xb2775h.cloudfront.net/live/omropfryslan/stream04/index.m3u8"
    },
    {
      "id": "hls-1",
      "format": "m3u8[h264+aac]",
      "resolution": "426x240@25fps",
      "bitrate": "637kbps",
      "url": "https://d3pvma9xb2775h.cloudfront.net/live/omropfryslan/stream04/270p/prog_index.m3u8"
    },
    [...]
    {
      "id": "hls-4",
      "format": "m3u8[h264+aac]",
      "resolution": "1920x1080@25fps",
      "bitrate": "5760kbps",
      "url": "https://d3pvma9xb2775h.cloudfront.net/live/omropfryslan/stream04/1080p/prog_index.m3u8"
    }
  ]
}

------------------------------------------------------------------------------------------------

$ url=https://rtvutrecht.bbvms.com/p/rtv_utrecht_videoplayer_web/c/3911399.json   # RTV Utrecht

$ xidel -se 'json-doc("'$url'")/(clipData/(assets)()[ends-with(src,"m3u8")],parse-json(clipData/s3Info))'
{
  "mediatype": "MP4_HLS",
  "id": "1600381184068100",
  "status": "active",
  "src": "/on-demand/rtvutrecht/media/2020/09/16/asset-3911399-160027203,1930323,2549578,2793708,3014217,3233646,3742861,.mp4.urlset/master.m3u8",
  "length": "",
  "exactlength": "",
  "width": "auto",
  "height": "auto",
  "bandwidth": "auto",
  "jobdefid": "4536",
  "language-id": "",
  "language-name": "",
  "language-isocode": ""
}
{
  [...]
  "ContentType": "video/mpeg2",
  [...]
  "format": {
    "filename": "https://s3.eu-west-1.amazonaws.com/mm.rtvutrecht.bbvms.com/upload/rtvutrecht/RTVU_2676436_1080p.mxf",
    "nb_streams": 3,
    "nb_programs": 0,
    "format_name": "mxf",
    "format_long_name": "MXF (Material eXchange Format)",
    [...]
  },
  [...]
}

$ xidel -s --module=xivid.xqm -e 'declare function local:bbvms($url as string?,$publ as string?,$title as string?) as object()? {let $json:=json-doc($url),$host:=$json/publicationData/defaultMediaAssetPath,$orig:=parse-json($json/clipData/s3Info) return $json/clipData/map:merge(({"name":join((if ($publ) then $publ else $json/publicationData/label,if ($title) then $title else title),": ")},if (sourcetype="live") then {"date":substring(adjust-dateTime-to-timezone(current-dateTime() + duration("PT0.5S"),duration("PT0S")),1,19)||"Z"} else {"date":publisheddate,"duration":length * duration("PT1S")},{"formats":array{xivid:m3u8-to-json((assets)()[ends-with(src,"m3u8")]/resolve-uri(src,$host))(),for $x at $i in (assets)()[ends-with(src,"mp4")] order by $x/bandwidth count $i return $x/{"id":"pg-"||$i,"format":"mp4[h264+aac]","resolution":concat(width,"x",height),"bitrate":bandwidth||"kbps","url":resolve-uri(src,$host)},{"id":"pg-"||count((assets)()[ends-with(src,"mp4")]) + 1,"format":concat(extract(src,".+\.(.+)",1),if ($orig/ContentType="video/mpeg2") then "[mpeg2+pcm]" else "[h264+aac]"),"resolution":concat(originalWidth,"x",originalHeight),"bitrate":round(tokenize($orig/format/bit_rate)[1] * 1024)||"kbps","url":$orig/format/filename}[url]}}))}; local:bbvms("'$url'",(),())'
{
  "name": "RTV Utrecht: Toch geen auto's over fietspad Wolvenstraat Utrecht, andere omleidingsroute gevonden",
  "date": "2020-09-16T16:03:02Z",
  "duration": "PT1M18S",
  "formats": [
    {
      "id": "hls-0",
      "format": "m3u8[manifest]",
      "url": "https://d18rwjdhpr8dcw.cloudfront.net/on-demand/rtvutrecht/media/2020/09/16/asset-3911399-160027203,1930323,2549578,2793708,3014217,3233646,3742861,.mp4.urlset/master.m3u8"
    },
    {
      "id": "hls-1",
      "format": "m3u8[h264+aac]",
      "resolution": "512x288@25fps",
      "bitrate": "363kbps",
      "url": "https://d18rwjdhpr8dcw.cloudfront.net/on-demand/rtvutrecht/media/2020/09/16/asset-3911399-1600272031930323.mp4/index-v1-a1.m3u8"
    },
    [...]
    {
      "id": "hls-6",
      "format": "m3u8[h264+aac]",
      "resolution": "1920x1080@25fps",
      "bitrate": "2967kbps",
      "url": "https://d18rwjdhpr8dcw.cloudfront.net/on-demand/rtvutrecht/media/2020/09/16/asset-3911399-1600272033742861.mp4/index-v1-a1.m3u8"
    },
    {
      "id": "pg-1",
      "format": "mp4[h264+aac]",
      "resolution": "512x288",
      "bitrate": "400kbps",
      "url": "https://d18rwjdhpr8dcw.cloudfront.net/rtvutrecht/media/2020/09/16/asset-3911399-1600272031930323.mp4"
    },
    [...]
    {
      "id": "pg-6",
      "format": "mp4[h264+aac]",
      "resolution": "1920x1080",
      "bitrate": "3500kbps",
      "url": "https://d18rwjdhpr8dcw.cloudfront.net/rtvutrecht/media/2020/09/16/asset-3911399-1600272033742861.mp4"
    },
    {
      "id": "pg-7",
      "format": "mxf[mpeg2+pcm]",
      "resolution": "1920x1080",
      "bitrate": "53855kbps",
      "url": "https://s3.eu-west-1.amazonaws.com/mm.rtvutrecht.bbvms.com/upload/rtvutrecht/RTVU_2676436_1080p.mxf"
    }
  ]
}

------------------------------------------------------------------------------------------------

$ url=https://www.rtvnoord.nl/media/bluebillywigplayeroptions/static/Tv.json   # RTV Noord

$ xidel -se 'json-doc("'$url'")/clipData'
{
  [...]
  "sourcetype": "on_demand",          # Zou natuurlijk "live" moeten zijn. Laks!
  "originalfilename": "index.m3u8",
  "length": null,
  [...]
  "assets": [
    {
      "mediatype": "MP4_MAIN",
      "id": "Tv",
      "status": "active",
      "src": "/live/rtvnoord/tv/index.m3u8",   # De livestreams (van de regionale zenders) hebben wel (bijna) altijd "/live/" in de url.
      "length": null,
      "exactlength": null,
      "width": "720",
      "height": "400",
      "bandwidth": "1200",
      "jobdefid": null
    }
  ],
  [...]
}

$ xidel -s --module=xivid.xqm -e 'declare function local:bbvms($url as string?,$publ as string?,$title as string?) as object()? {let $json:=json-doc($url),$host:=$json/publicationData/defaultMediaAssetPath,$orig:=parse-json($json/clipData/s3Info) return $json/clipData/map:merge(({"name":join((if ($publ) then $publ else $json/publicationData/label,if ($title) then $title else title),": ")},if (sourcetype="live" or contains((assets)()[ends-with(src,"m3u8")]/src,"/live/")) then {"date":substring(adjust-dateTime-to-timezone(current-dateTime() + duration("PT0.5S"),duration("PT0S")),1,19)||"Z"} else {"date":publisheddate,"duration":length * duration("PT1S")},{"formats":array{xivid:m3u8-to-json((assets)()[ends-with(src,"m3u8")]/resolve-uri(src,$host))(),for $x at $i in (assets)()[ends-with(src,"mp4")] order by $x/bandwidth count $i return $x/{"id":"pg-"||$i,"format":"mp4[h264+aac]","resolution":concat(width,"x",height),"bitrate":bandwidth||"kbps","url":resolve-uri(src,$host)},{"id":"pg-"||count((assets)()[ends-with(src,"mp4")]) + 1,"format":concat(extract(src,".+\.(.+)",1),if ($orig/ContentType="video/mpeg2") then "[mpeg2+pcm]" else "[h264+aac]"),"resolution":concat(originalWidth,"x",originalHeight),"bitrate":round(tokenize($orig/format/bit_rate)[1] * 1024)||"kbps","url":$orig/format/filename}[url]}}))}; local:bbvms("'$url'","RTV Noord","Livestream")'
{
  "name": "RTV Noord: Livestream",
  "date": "2020-12-18T20:22:42Z",
  "formats": [
    {
      "id": "hls-0",
      "format": "m3u8[manifest]",
      "url": "https://media.rtvnoord.nl/live/rtvnoord/tv/index.m3u8"
    },
    {
      "id": "hls-1",
      "format": "m3u8[h264+aac]",
      "resolution": "640x360",
      "bitrate": "627kbps",
      "url": "https://media.rtvnoord.nl/live/rtvnoord/tv/6a46cbb2-57ee-4192-b55a-de7b4575b19b/index.m3u8"
    },
    [...]
    {
      "id": "hls-4",
      "format": "m3u8[h264+aac]",
      "resolution": "1920x1080",
      "bitrate": "6096kbps",
      "url": "https://media.rtvnoord.nl/live/rtvnoord/tv/3e8fe3c1-0868-49b0-b2f3-7dd6eb30651f/index.m3u8"
    }
  ]
}

------------------------------------------------------------------------------------------------

$ url=https://www.rtvoost.nl/media/bluebillywigplayeroptions/static/Tv.json   # RTV Oost

$ xidel -se 'json-doc("'$url'")/clipData/(assets)()[ends-with(src,"m3u8")]'
{
  "mediatype": "MP4_MAIN",
  "id": "Tv",
  "status": "active",
  "src": "/video/tv/hls.m3u8",
  "length": null,
  "exactlength": null,
  "width": "720",
  "height": "400",
  "bandwidth": "1200",
  "jobdefid": null
}

$ xidel -s --module=xivid.xqm -e 'declare function local:bbvms($url as string?,$publ as string?,$title as string?) as object()? {let $json:=json-doc($url),$host:=$json/publicationData/defaultMediaAssetPath,$orig:=parse-json($json/clipData/s3Info) return $json/clipData/map:merge(({"name":join((if ($publ) then $publ else $json/publicationData/label,if ($title) then $title else title),": ")},if (sourcetype="live" or contains((assets)()[ends-with(src,"m3u8")]/src,"/live/") or ends-with((assets)()[ends-with(src,"m3u8")]/src,"hls.m3u8")) then {"date":substring(adjust-dateTime-to-timezone(current-dateTime() + duration("PT0.5S"),duration("PT0S")),1,19)||"Z"} else {"date":publisheddate,"duration":length * duration("PT1S")},{"formats":array{xivid:m3u8-to-json((assets)()[ends-with(src,"m3u8")]/resolve-uri(src,$host))(),for $x at $i in (assets)()[ends-with(src,"mp4")] order by $x/bandwidth count $i return $x/{"id":"pg-"||$i,"format":"mp4[h264+aac]","resolution":concat(width,"x",height),"bitrate":bandwidth||"kbps","url":resolve-uri(src,$host)},{"id":"pg-"||count((assets)()[ends-with(src,"mp4")]) + 1,"format":concat(extract(src,".+\.(.+)",1),if ($orig/ContentType="video/mpeg2") then "[mpeg2+pcm]" else "[h264+aac]"),"resolution":concat(originalWidth,"x",originalHeight),"bitrate":round(tokenize($orig/format/bit_rate)[1] * 1024)||"kbps","url":$orig/format/filename}[url]}}))}; local:bbvms("'$url'","RTV Oost","Livestream")'
{
  "name": "RTV Oost: Livestream",
  "date": "2020-12-18T20:24:17Z",
  "formats": [
    {
      "id": "hls-0",
      "format": "m3u8[manifest]",
      "url": "https://mediacdn.rtvoost.nl/live/rtvoost/tv-oost/index.m3u8"
    },
    {
      "id": "hls-1",
      "format": "m3u8[h264+aac]",
      "resolution": "416x234",
      "bitrate": "613kbps",
      "url": "https://mediacdn.rtvoost.nl/live/rtvoost/tv-oost/e8a15a5f-a530-432e-a025-6dffc1426309/index.m3u8"
    },
    [...]
    {
      "id": "hls-3",
      "format": "m3u8[h264+aac]",
      "resolution": "1280x720",
      "bitrate": "2566kbps",
      "url": "https://mediacdn.rtvoost.nl/live/rtvoost/tv-oost/46ce631a-6155-4fcc-ac24-2b2e252f4f94/index.m3u8"
    }
  ]
}

------------------------------------------------------------------------------------------------

$ url=https://omroepwest.bbvms.com/p/regiogrid/c/2054317.json   # Omroep West

$ xidel -se 'json-doc("'$url'")/clipData/(assets)()'
{
  "mediatype": "MP4_MAIN",
  "id": "1347006347173657",
  "status": "active",
  "src": "//d2dslh4sd7yvc1.cloudfront.net/live/omroepwest/ngrp:tv-feed_all/playlist.m3u8",
  "length": "",
  "exactlength": "",
  "width": "1920",
  "height": "1080",
  "bandwidth": "4128"
}
{
  "mediatype": "MP4_IPOD",
  "id": "1347007455980753",
  "status": "active",
  "src": "//d2dslh4sd7yvc1.cloudfront.net/live/omroepwest/ngrp:tv-feed_mobile/playlist.m3u8",
  "length": "",
  "exactlength": "",
  "width": "480",
  "height": "270",
  "bandwidth": "400"
}

$ xidel -s --module=xivid.xqm -e 'declare function local:bbvms($url as string?,$publ as string?,$title as string?) as object()? {let $json:=json-doc($url),$host:=$json/publicationData/defaultMediaAssetPath,$orig:=parse-json($json/clipData/s3Info) return $json/clipData/map:merge(({"name":join((if ($publ) then $publ else $json/publicationData/label,if ($title) then $title else title),": ")},if (sourcetype="live" or contains((assets)()[ends-with(src,"m3u8")]/src,"/live/") or ends-with((assets)()[ends-with(src,"m3u8")]/src,"hls.m3u8")) then {"date":substring(adjust-dateTime-to-timezone(current-dateTime() + duration("PT0.5S"),duration("PT0S")),1,19)||"Z"} else {"date":publisheddate,"duration":length * duration("PT1S")},{"formats":array{xivid:m3u8-to-json((assets)()[ends-with(src,"m3u8")][1]/resolve-uri(src,$host))(),for $x at $i in (assets)()[ends-with(src,"mp4")] order by $x/bandwidth count $i return $x/{"id":"pg-"||$i,"format":"mp4[h264+aac]","resolution":concat(width,"x",height),"bitrate":bandwidth||"kbps","url":resolve-uri(src,$host)},{"id":"pg-"||count((assets)()[ends-with(src,"mp4")]) + 1,"format":concat(extract(src,".+\.(.+)",1),if ($orig/ContentType="video/mpeg2") then "[mpeg2+pcm]" else "[h264+aac]"),"resolution":concat(originalWidth,"x",originalHeight),"bitrate":round(tokenize($orig/format/bit_rate)[1] * 1024)||"kbps","url":$orig/format/filename}[url]}}))}; local:bbvms("'$url'","Omroep West","Livestream")'
{
  "name": "Omroep West: Livestream",
  "date": "2020-12-18T20:25:02Z",
  "formats": [
    {
      "id": "hls-0",
      "format": "m3u8[manifest]",
      "url": "https://d2dslh4sd7yvc1.cloudfront.net/live/omroepwest/ngrp:tv-feed_all/playlist.m3u8"
    },
    {
      "id": "hls-1",
      "format": "m3u8[h264+aac]",
      "resolution": "712x400",
      "bitrate": "571kbps",
      "url": "https://d2dslh4sd7yvc1.cloudfront.net/live/omroepwest/ngrp:tv-feed_all/chunklist_b531072.m3u8"
    },
    [...]
    {
      "id": "hls-3",
      "format": "m3u8[h264+aac]",
      "resolution": "1920x1080",
      "bitrate": "4227kbps",
      "url": "https://d2dslh4sd7yvc1.cloudfront.net/live/omroepwest/ngrp:tv-feed_all/chunklist_b4227072.m3u8"
    }
  ]
}

------------------------------------------------------------------------------------------------

$ url=https://www.rtvnoord.nl/media/bluebillywigplayeroptions/rtv/Tv/35117.json   # RTV Noord

$ xidel -se 'json-doc("'$url'")/clipData'
{
  [...]
  "length": null,     # Bij verscheidene regionale zenders is het eerder regel dan uitzondering dat de tijdsduur niet beschikbaar is.
  "sourceid": null,
  "title": null,      # Het zelfde geldt voor de titel.
  [...]
  "publisheddate": "2020-10-02T18:00:00",
  [...]
  "src": "/video/2020/201002/201002_NVREC_XHQ.mp4",
  [...]
  "assets": [
    {
      "mediatype": "MP4_MAIN",
      "id": "037D37ACC8055AEFC12585D2004418AE",
      "status": "active",
      "src": "/video/2020/201002/201002_NVREC_XHQ.mp4",
      "length": null,
      "exactlength": null,
      "width": "720",   # De daadwerkelijke resolutie van deze video blijkt 1920x1080 te zijn, dus ook deze informatie klopt niet.
      "height": "400",
      "bandwidth": "1200",
      "jobdefid": null
    }
  ],
  [...]
}

$ xidel -s --module=xivid.xqm -e 'json-doc("'$url'")/clipData/xivid:adjust-dateTime-to-dst(publisheddate)'
2020-10-02T18:00:00+02:00

$ xidel -s --module=xivid.xqm -e 'declare function local:bbvms($url as string?,$publ as string?,$title as string?) as object()? {let $json:=json-doc($url),$host:=$json/publicationData/defaultMediaAssetPath,$orig:=parse-json($json/clipData/s3Info) return $json/clipData/map:merge(({"name":join((if ($publ) then $publ else $json/publicationData/label,if ($title) then $title else .[title]/title),": ")},if (sourcetype="live" or contains((assets)()[ends-with(src,"m3u8")]/src,"/live/") or ends-with((assets)()[ends-with(src,"m3u8")]/src,"hls.m3u8")) then {"date":substring(adjust-dateTime-to-timezone(current-dateTime() + duration("PT0.5S"),duration("PT0S")),1,19)||"Z"} else {"date":adjust-dateTime-to-timezone(xivid:adjust-dateTime-to-dst(publisheddate),duration("PT0S")),"duration"?:length * duration("PT1S")},{"formats":array{xivid:m3u8-to-json((assets)()[ends-with(src,"m3u8")][1]/resolve-uri(src,$host))(),for $x at $i in (assets)()[ends-with(src,"mp4")] order by $x/bandwidth count $i return $x/{"id":"pg-"||$i,"format":"mp4[h264+aac]","resolution":concat(width,"x",height),"bitrate":bandwidth||"kbps","url":resolve-uri(src,$host)},{"id":"pg-"||count((assets)()[ends-with(src,"mp4")]) + 1,"format":concat(extract(src,".+\.(.+)",1),if ($orig/ContentType="video/mpeg2") then "[mpeg2+pcm]" else "[h264+aac]"),"resolution":concat(originalWidth,"x",originalHeight),"bitrate":round(tokenize($orig/format/bit_rate)[1] * 1024)||"kbps","url":$orig/format/filename}[url]}}))}; local:bbvms("'$url'",(),())'
{
  "name": "RTV Noord",
  "date": "2020-10-02T16:00:00Z",
  "formats": [
    {
      "id": "pg-1",
      "format": "mp4[h264+aac]",
      "resolution": "720x400",
      "bitrate": "1200kbps",
      "url": "https://media.rtvnoord.nl/video/2020/201002/201002_NVREC_XHQ.mp4"
    }
  ]
}

------------------------------------------------------------------------------------------------

$ url=https://rijnmond.bbvms.com/p/regiogrid_16-9_responsive/q/sourceid_string:9097D24729832965C12585DD00421C42.json   # RTV Rijnmond

$ xidel -se 'json-doc("'$url'")'
{
  "previewMode": null,
  "protocol": "https://",
  [...]
  "publicationData": {
    [...]
    "defaultMediaAssetPath": "//dcur8bjarl5c2.cloudfront.net",
    [...]
  }
  [...]
}

$ xidel -s --module=xivid.xqm -e 'declare function local:bbvms($url as string?,$publ as string?,$title as string?) as object()? {let $json:=json-doc($url),$host:=$json/resolve-uri(publicationData/defaultMediaAssetPath,protocol),$orig:=parse-json($json/clipData/s3Info) return $json/clipData/map:merge(({"name":join((if ($publ) then $publ else $json/publicationData/label,if ($title) then $title else .[title]/title),": ")},if (sourcetype="live" or contains((assets)()[ends-with(src,"m3u8")]/src,"/live/") or ends-with((assets)()[ends-with(src,"m3u8")]/src,"hls.m3u8")) then {"date":substring(adjust-dateTime-to-timezone(current-dateTime() + duration("PT0.5S"),duration("PT0S")),1,19)||"Z"} else {"date":if (ends-with(publisheddate,"Z")) then publisheddate else adjust-dateTime-to-timezone(xivid:adjust-dateTime-to-dst(publisheddate),duration("PT0S")),"duration"?:length * duration("PT1S")},{"formats":array{xivid:m3u8-to-json((assets)()[ends-with(src,"m3u8")][1]/resolve-uri(src,$host))(),for $x at $i in (assets)()[ends-with(src,"mp4")] order by $x/bandwidth count $i return $x/{"id":"pg-"||$i,"format":"mp4[h264+aac]","resolution":concat(width,"x",height),"bitrate":bandwidth||"kbps","url":resolve-uri(src,$host)},{"id":"pg-"||count((assets)()[ends-with(src,"mp4")]) + 1,"format":concat(extract(src,".+\.(.+)",1),if ($orig/ContentType="video/mpeg2") then "[mpeg2+pcm]" else "[h264+aac]"),"resolution":concat(originalWidth,"x",originalHeight),"bitrate":round(tokenize($orig/format/bit_rate)[1] * 1024)||"kbps","url":$orig/format/filename}[url]}}))}; local:bbvms("'$url'",(),())'
{
  "name": "RTV Rijnmond: Welkom bij Rijnmond",
  "date": "2020-10-04T15:55:06Z",
  "duration": "PT10M21S",
  "formats": [
    {
      "id": "pg-1",
      "format": "mp4[h264+aac]",
      "resolution": "640x360",
      "bitrate": "600kbps",
      "url": "https://dcur8bjarl5c2.cloudfront.net/2020/video/nwszo041020_vlq.mp4"
    },
    {
      "id": "pg-2",
      "format": "mp4[h264+aac]",
      "resolution": "1920x1080",
      "bitrate": "3602kbps",
      "url": "https://dcur8bjarl5c2.cloudfront.net/rijnmond/media/2020/10/04/3931211.mp4"
    }
  ]
}

------------------------------------------------------------------------------------------------

$ url=https://omroepgelderland.bbvms.com/p/default/q/sourceid_string:SREGIOOG_43332.json   # Omroep Gelderland

$ xidel -se 'json-doc("'$url'")/(clipData,publicationData)'
{
  [...]
  "length": null,
  [...]
  "assets": [
    {
      "mediatype": "MP4_MAIN",
      "id": "1601824877194122",
      "status": "active",
      "src": "/epg/prod/media/videos/8Y7vw33Qv4W.mp4",
      "length": "",
      "exactlength": "",
      "width": "",
      "height": "",
      "bandwidth": "",
      "jobdefid": "mp4_main-x-",
      "jobqid": "mp4_main-x-"
    }
  ],
  "hasJobs": false,
  "subtitles": [
    {
      "languageid": "1541",
      "languagename": "Nederlands",
      "id": "63808",
      "name": "",
      "default": "true",
      "isocode": "nl",
      "status": "published"
    }
  ],
  [...]
}
{
  [...]
  "baseurl": "https://omroepgelderland.bbvms.com",
  [...]
}

$ xidel -se 'let $json:=json("'$url'") return $json/clipData/(subtitles)()/concat($json/publicationData/baseurl,"/subtitle/",id,".srt")'
https://omroepgelderland.bbvms.com/subtitle/63808.srt

$ xidel -s --module=xivid.xqm -e 'declare function local:bbvms($url as string?,$publ as string?,$title as string?) as object()? {let $json:=json-doc($url),$host:=$json/resolve-uri(publicationData/defaultMediaAssetPath,protocol),$orig:=parse-json($json/clipData/s3Info) return $json/clipData/map:merge(({"name":join((if ($publ) then $publ else $json/publicationData/label,if ($title) then $title else .[title]/title),": ")},if (sourcetype="live" or contains((assets)()[ends-with(src,"m3u8")]/src,"/live/") or ends-with((assets)()[ends-with(src,"m3u8")]/src,"hls.m3u8")) then {"date":substring(adjust-dateTime-to-timezone(current-dateTime() + duration("PT0.5S"),duration("PT0S")),1,19)||"Z"} else {"date":if (ends-with(publisheddate,"Z")) then publisheddate else adjust-dateTime-to-timezone(xivid:adjust-dateTime-to-dst(publisheddate),duration("PT0S")),"duration"?:length * duration("PT1S")},{"formats":array{(subtitles)()/{"id":"sub-1","format":"srt","language":isocode,"label":languagename,"url":concat($json/publicationData/baseurl,"/subtitle/",id,".srt")},xivid:m3u8-to-json((assets)()[ends-with(src,"m3u8")][1]/resolve-uri(src,$host))(),for $x at $i in (assets)()[ends-with(src,"mp4")] order by $x/bandwidth count $i return $x/{"id":"pg-"||$i,"format":"mp4[h264+aac]","resolution"?:.[width]/concat(width,"x",height),"bitrate"?:.[bandwidth]/concat(bandwidth,"kbps"),"url":resolve-uri(src,$host)},{"id":"pg-"||count((assets)()[ends-with(src,"mp4")]) + 1,"format":concat(extract(src,".+\.(.+)",1),if ($orig/ContentType="video/mpeg2") then "[mpeg2+pcm]" else "[h264+aac]"),"resolution":concat(originalWidth,"x",originalHeight),"bitrate":round(tokenize($orig/format/bit_rate)[1] * 1024)||"kbps","url":$orig/format/filename}[url]}}))}; local:bbvms("'$url'",(),())'
{
  "name": "Omroep Gelderland: GLD Nieuws",
  "date": "2020-10-04T15:21:16Z",
  "formats": [
    {
      "id": "sub-1",
      "format": "srt",
      "language": "nl",
      "label": "Nederlands",
      "url": "https://omroepgelderland.bbvms.com/subtitle/63808.srt"
    },
    {
      "id": "pg-1",
      "format": "mp4[h264+aac]",
      "url": "https://d2od87akyl46nm.cloudfront.net/epg/prod/media/videos/8Y7vw33Qv4W.mp4"
    }
  ]
}

------------------------------------------------------------------------------------------------

$ url=https://www.omroepzeeland.nl/media/bluebillywigplayeroptions/rtv/Tv/370236927.json   # Omroep Zeeland

$ xidel -se 'json-doc("'$url'")/clipData/(assets)()'
{
  [...]
  "src": "/custom/getDownload?sourceid=370236927-Zeeland-Nu-04-10-2020-ZNB201002NG",
  [...]
}

$ xidel -se 'json-doc("'$url'")/resolve-uri(clipData/(assets)()[not(ends-with(src,"m3u8"))]/src,publicationData/defaultMediaAssetPath) ! (.,x:request({"method":"HEAD","url":.})/url)'
https://omroepzeeland.bbvms.com/custom/getDownload?sourceid=370236927-Zeeland-Nu-04-10-2020-ZNB201002NG
https://d3isaxd2t6q8zm.cloudfront.net/omroepzeeland/media/2020/10/04/Asset_HD_370236927-Zeeland-Nu-04-10-2020-ZNB201002NG.mp4

$ xidel -s --module=xivid.xqm -e 'declare function local:bbvms($url as string?,$publ as string?,$title as string?) as object()? {let $json:=json-doc($url),$host:=$json/resolve-uri(publicationData/defaultMediaAssetPath,protocol),$orig:=parse-json($json/clipData/s3Info) return $json/clipData/map:merge(({"name":join((if ($publ) then $publ else $json/publicationData/label,if ($title) then $title else .[title]/title),": ")},if (sourcetype="live" or contains((assets)()[ends-with(src,"m3u8")]/src,"/live/") or ends-with((assets)()[ends-with(src,"m3u8")]/src,"hls.m3u8")) then {"date":substring(adjust-dateTime-to-timezone(current-dateTime() + duration("PT0.5S"),duration("PT0S")),1,19)||"Z"} else {"date":if (ends-with(publisheddate,"Z")) then publisheddate else adjust-dateTime-to-timezone(xivid:adjust-dateTime-to-dst(publisheddate),duration("PT0S")),"duration"?:length * duration("PT1S")},{"formats":array{(subtitles)()/{"id":"sub-1","format":"srt","language":isocode,"label":languagename,"url":concat($json/publicationData/baseurl,"/subtitle/",id,".srt")},xivid:m3u8-to-json((assets)()[ends-with(src,"m3u8")][1]/resolve-uri(src,$host))(),for $x at $i in (assets)()[not(ends-with(src,"m3u8"))] order by $x/bandwidth count $i return $x/{"id":"pg-"||$i,"format":"mp4[h264+aac]","resolution"?:.[width]/concat(width,"x",height),"bitrate"?:.[bandwidth]/concat(bandwidth,"kbps"),"url":resolve-uri(src,$host) ! (if (ends-with(.,"mp4")) then . else x:request({"method":"HEAD","url":.})/url)},{"id":"pg-"||count((assets)()[not(ends-with(src,"m3u8"))]) + 1,"format":concat(extract(src,".+\.(.+)",1),if ($orig/ContentType="video/mpeg2") then "[mpeg2+pcm]" else "[h264+aac]"),"resolution":concat(originalWidth,"x",originalHeight),"bitrate":round(tokenize($orig/format/bit_rate)[1] * 1024)||"kbps","url":$orig/format/filename}[url]}}))}; local:bbvms("'$url'",(),())'
{
  "name": "Omroep Zeeland",
  "date": "2020-10-04T16:00:00Z",
  "formats": [
    {
      "id": "pg-1",
      "format": "mp4[h264+aac]",
      "resolution": "720x400",
      "bitrate": "1200kbps",
      "url": "https://d3isaxd2t6q8zm.cloudfront.net/omroepzeeland/media/2020/10/04/Asset_HD_370236927-Zeeland-Nu-04-10-2020-ZNB201002NG.mp4"
    }
  ]
}

------------------------------------------------------------------------------------------------

$ url=https://autoblog.bbvms.com/p/autoblog_yt/c/3679822.json

$ xidel -se 'json-doc("'$url'")/clipData'
{
  [...]
  "src": "/autoblog/media/2020/03/15/3679822.mkv",
  [...]
}

$ xidel -s --module=xivid.xqm -e 'declare function local:bbvms($url as string?,$publ as string?,$title as string?) as object()? {let $json:=json-doc($url),$host:=$json/resolve-uri(publicationData/defaultMediaAssetPath,protocol),$orig:=parse-json($json/clipData/s3Info) return $json/clipData/map:merge(({"name":join((if ($publ) then $publ else $json/publicationData/label,if ($title) then $title else .[title]/title),": ")},if (sourcetype="live" or contains((assets)()[ends-with(src,"m3u8")]/src,"/live/") or ends-with((assets)()[ends-with(src,"m3u8")]/src,"hls.m3u8")) then {"date":substring(adjust-dateTime-to-timezone(current-dateTime() + duration("PT0.5S"),duration("PT0S")),1,19)||"Z"} else {"date":if (ends-with(publisheddate,"Z")) then publisheddate else adjust-dateTime-to-timezone(xivid:adjust-dateTime-to-dst(publisheddate),duration("PT0S")),"duration"?:length * duration("PT1S")},{"formats":array{(subtitles)()/{"id":"sub-1","format":"srt","language":isocode,"label":languagename,"url":concat($json/publicationData/baseurl,"/subtitle/",id,".srt")},xivid:m3u8-to-json((assets)()[ends-with(src,"m3u8")][1]/resolve-uri(src,$host))(),for $x at $i in (assets)()[not(ends-with(src,"m3u8"))] order by $x/bandwidth count $i return $x/{"id":"pg-"||$i,"format":"mp4[h264+aac]","resolution"?:.[width]/concat(width,"x",height),"bitrate"?:.[bandwidth]/concat(bandwidth,"kbps"),"url":resolve-uri(src,$host) ! (if (ends-with(.,"mp4")) then . else x:request({"method":"HEAD","url":.})/url)},{"id":"pg-"||count((assets)()[not(ends-with(src,"m3u8"))]) + 1,"format":extract(src,".+\.(.+)",1) ! concat(.,if ($orig/ContentType="video/mpeg2") then "[mpeg2+pcm]" else if (.="mkv") then "[h264+opus]" else "[h264+aac]"),"resolution":concat(originalWidth,"x",originalHeight),"bitrate":$orig/format/concat(round(tokenize(bit_rate)[1] * 1024),"kbps"),"url":if (exists($orig)) then $orig/format/filename else resolve-uri(.[not((assets)()/src = src)]/src,$host)}[url]}}))}; local:bbvms("'$url'",(),())'
{
  "name": "Autoblog: Brute Richmond (Jeep Wrangler) rijtest",
  "date": "2020-03-15T09:51:01Z",
  "duration": "PT15M45S",
  "formats": [
    {
      "id": "pg-1",
      "format": "mp4[h264+aac]",
      "resolution": "512x288",
      "bitrate": "400kbps",
      "url": "https://d2bbsl4gakrtjf.cloudfront.net/autoblog/media/2020/03/15/asset-3679822-1584265633439393.mp4"
    },
    [...]
    {
      "id": "pg-6",
      "format": "mp4[h264+aac]",
      "resolution": "1920x1080",
      "bitrate": "3000kbps",
      "url": "https://d2bbsl4gakrtjf.cloudfront.net/autoblog/media/2020/03/15/asset-3679822-1584265634228029.mp4"
    },
    {
      "id": "pg-7",
      "format": "mkv[h264+opus]",
      "resolution": "1920x1080",
      "bitrate": null,
      "url": "https://d2bbsl4gakrtjf.cloudfront.net/autoblog/media/2020/03/15/3679822.mkv"
    }
  ]
}

------------------------------------------------------------------------------------------------

$ url=https://autoblog.bbvms.com/p/autoblog_yt/c/4141066.json

$ xidel -se 'json-doc("'$url'")/clipData'
{
  [...]
  "src": "/autoblog/media/2021/02/28/4141066.mp4",
  [...]
  "assets": [
    [...]
    {
      "mediatype": "MP4_MAIN",
      "id": "4141066",
      "status": "active",
      "src": "/autoblog/media/2021/02/28/4141066.mp4",
      "length": "22",
      "exactlength": "",
      "width": "590",
      "height": "432",
      "bandwidth": "852",
      "jobdefid": "mp4_main-590x432-852",
      "isSource": true,
      "jobqid": "mp4_main-590x432-852"
    }
  ],
  [...]
}

$ xidel -s --module=xivid.xqm -e 'declare function local:bbvms($url as string?,$publ as string?,$title as string?) as object()? {let $json:=json-doc($url),$host:=$json/resolve-uri(publicationData/defaultMediaAssetPath,protocol),$orig:=parse-json($json/clipData/s3Info) return $json/clipData/map:merge(({"name":join((if ($publ) then $publ else $json/publicationData/label,if ($title) then $title else .[title]/title),": ")},if (sourcetype="live" or contains((assets)()[ends-with(src,"m3u8")]/src,"/live/") or ends-with((assets)()[ends-with(src,"m3u8")]/src,"hls.m3u8")) then {"date":substring(adjust-dateTime-to-timezone(current-dateTime() + duration("PT0.5S"),duration("PT0S")),1,19)||"Z"} else {"date":if (ends-with(publisheddate,"Z")) then publisheddate else adjust-dateTime-to-timezone(xivid:adjust-dateTime-to-dst(publisheddate),duration("PT0S")),"duration"?:length * duration("PT1S")},{"formats":array{(subtitles)()/{"id":"sub-1","format":"srt","language":isocode,"label":languagename,"url":concat($json/publicationData/baseurl,"/subtitle/",id,".srt")},xivid:m3u8-to-json((assets)()[ends-with(src,"m3u8")][1]/resolve-uri(src,$host))(),for $x at $i in (assets)()[not(ends-with(src,"m3u8"))] order by exists($x/isSource),$x/bandwidth count $i return $x/{"id":"pg-"||$i,"format":"mp4[h264+aac]","resolution"?:.[width]/concat(width,"x",height),"bitrate"?:.[bandwidth]/concat(bandwidth,"kbps"),"url":resolve-uri(src,$host) ! (if (ends-with(.,"mp4")) then . else x:request({"method":"HEAD","url":.})/url)},{"id":"pg-"||count((assets)()[not(ends-with(src,"m3u8"))]) + 1,"format":extract(src,".+\.(.+)",1) ! concat(.,if ($orig/ContentType="video/mpeg2") then "[mpeg2+pcm]" else if (.="mkv") then "[h264+opus]" else "[h264+aac]"),"resolution":concat(originalWidth,"x",originalHeight),"bitrate":$orig/format/concat(round(tokenize(bit_rate)[1] * 1024),"kbps"),"url":if (exists($orig)) then $orig/format/filename else resolve-uri(.[not((assets)()/src = src)]/src,$host)}[url]}}))}; local:bbvms("'$url'",(),())'
{
  "name": "Autoblog: Door rood rijden met juten achter je",
  "date": "2021-02-28T10:26:41Z",
  "duration": "PT22S",
  "formats": [
    {
      "id": "pg-1",
      "format": "mp4[h264+aac]",
      "resolution": "512x374",
      "bitrate": "400kbps",
      "url": "https://d2bbsl4gakrtjf.cloudfront.net/autoblog/media/2021/02/28/asset-4141066-1614508006643328.mp4"
    },
    {
      "id": "pg-2",
      "format": "mp4[h264+aac]",
      "resolution": "768x562",
      "bitrate": "600kbps",
      "url": "https://d2bbsl4gakrtjf.cloudfront.net/autoblog/media/2021/02/28/asset-4141066-1614508006799572.mp4"
    },
    {
      "id": "pg-3",
      "format": "mp4[h264+aac]",
      "resolution": "768x562",
      "bitrate": "800kbps",
      "url": "https://d2bbsl4gakrtjf.cloudfront.net/autoblog/media/2021/02/28/asset-4141066-1614508006953761.mp4"
    },
    {
      "id": "pg-4",
      "format": "mp4[h264+aac]",
      "resolution": "768x562",
      "bitrate": "1600kbps",
      "url": "https://d2bbsl4gakrtjf.cloudfront.net/autoblog/media/2021/02/28/asset-4141066-1614508006349151.mp4"
    },
    {
      "id": "pg-5",
      "format": "mp4[h264+aac]",
      "resolution": "590x432",
      "bitrate": "852kbps",
      "url": "https://d2bbsl4gakrtjf.cloudfront.net/autoblog/media/2021/02/28/4141066.mp4"
    }
  ]
}

------------------------------------------------------------------------------------------------

$ url=https://autoblog.bbvms.com/p/autojunk_standard/c/2895330.json

$ xidel -se 'json-doc("'$url'")/clipData'
{
  [...]
  "src": "",
  [...]
}

$ xidel -s --module=xivid.xqm -e 'declare function local:bbvms($url as string?,$publ as string?,$title as string?) as object()? {let $json:=json-doc($url),$host:=$json/resolve-uri(publicationData/defaultMediaAssetPath,protocol),$orig:=parse-json($json/clipData/s3Info) return $json/clipData/map:merge(({"name":join((if ($publ) then $publ else $json/publicationData/label,if ($title) then $title else .[title]/title),": ")},if (sourcetype="live" or contains((assets)()[ends-with(src,"m3u8")]/src,"/live/") or ends-with((assets)()[ends-with(src,"m3u8")]/src,"hls.m3u8")) then {"date":substring(adjust-dateTime-to-timezone(current-dateTime() + duration("PT0.5S"),duration("PT0S")),1,19)||"Z"} else {"date":if (ends-with(publisheddate,"Z")) then publisheddate else adjust-dateTime-to-timezone(xivid:adjust-dateTime-to-dst(publisheddate),duration("PT0S")),"duration"?:length * duration("PT1S")},{"formats"?:array{(subtitles)()/{"id":"sub-1","format":"srt","language":isocode,"label":languagename,"url":concat($json/publicationData/baseurl,"/subtitle/",id,".srt")},xivid:m3u8-to-json((assets)()[ends-with(src,"m3u8")][1]/resolve-uri(src,$host))(),for $x at $i in (assets)()[not(ends-with(src,"m3u8"))] order by exists($x/isSource),$x/bandwidth count $i return $x/{"id":"pg-"||$i,"format":"mp4[h264+aac]","resolution"?:.[width]/concat(width,"x",height),"bitrate"?:.[bandwidth]/concat(bandwidth,"kbps"),"url":resolve-uri(src,$host) ! (if (ends-with(.,"mp4")) then . else x:request({"method":"HEAD","url":.})/url)},{"id":"pg-"||count((assets)()[not(ends-with(src,"m3u8"))]) + 1,"format":extract(src,".+\.(.+)",1) ! concat(.,if ($orig/ContentType="video/mpeg2") then "[mpeg2+pcm]" else if (.="mkv") then "[h264+opus]" else "[h264+aac]"),"resolution":concat(originalWidth,"x",originalHeight),"bitrate":$orig/format/concat(round(tokenize(bit_rate)[1] * 1024),"kbps"),"url":if (exists($orig)) then $orig/format/filename else resolve-uri(.[not((assets)()/src = src) and src != ""]/src,$host)}[url]}[exists(.())]}))}; local:bbvms("'$url'",(),())'
{
  "name": "Autoblog: Placeholder clip",
  "date": "2018-01-19T10:13:59Z"
}

------------------------------------------------------------------------------------------------

declare function xivid:bbvms(
  $url as string?, $publ as string?, $title as string?
) as object()? {
  let $json:=json-doc($url),
      $host:=$json/resolve-uri(
        publicationData/defaultMediaAssetPath,
        protocol
      ),
      $orig:=parse-json($json/clipData/s3Info)
  return
  $json/clipData/map:merge((
    {
      "name":join(
        (
          if ($publ) then $publ else $json/publicationData/label,
          if ($title) then $title else .[title]/title
        ),
        ": "
      )
    },
    if (
      sourcetype="live" or
      contains((assets)()[ends-with(src,"m3u8")]/src,"/live/") or
      ends-with((assets)()[ends-with(src,"m3u8")]/src,"hls.m3u8")
    ) then {
      "date":substring(
        adjust-dateTime-to-timezone(
          current-dateTime() + duration("PT0.5S"),
          duration("PT0S")
        ),
        1,19
      )||"Z"
    } else {
      "date":if (ends-with(publisheddate,"Z")) then
        publisheddate
      else
        adjust-dateTime-to-timezone(
          xivid:adjust-dateTime-to-dst(publisheddate),
          duration("PT0S")
        ),
      "duration"?:length * duration("PT1S")
    },
    {
      "formats"?:array{
        (subtitles)()/{
          "id":"sub-1",
          "format":"srt",
          "language":isocode,
          "label":languagename,
          "url":concat($json/publicationData/baseurl,"/subtitle/",id,".srt")
        },
        xivid:m3u8-to-json(
          (assets)()[ends-with(src,"m3u8")][1]/resolve-uri(src,$host)
        )(),
        for $x at $i in (assets)()[not(ends-with(src,"m3u8"))]
        order by exists($x/isSource),$x/bandwidth
        count $i
        return
        $x/{
          "id":"pg-"||$i,
          "format":"mp4[h264+aac]",
          "resolution"?:.[width]/concat(width,"x",height),
          "bitrate"?:.[bandwidth]/concat(bandwidth,"kbps"),
          "url":resolve-uri(src,$host) ! (
            if (ends-with(.,"mp4")) then .
            else x:request({"method":"HEAD","url":.})/url
          )
        },
        {
          "id":"pg-"||count((assets)()[not(ends-with(src,"m3u8"))]) + 1,
          "format":extract(src,".+\.(.+)",1) ! concat(
            .,
            if ($orig/ContentType="video/mpeg2") then "[mpeg2+pcm]"
            else if (.="mkv") then "[h264+opus]"
            else "[h264+aac]"
          ),
          "resolution":concat(originalWidth,"x",originalHeight),
          "bitrate":$orig/format/concat(round(tokenize(bit_rate)[1] * 1024),"kbps"),
          "url":if (exists($orig)) then
            $orig/format/filename
          else
            resolve-uri(.[not((assets)()/src = src) and src != ""]/src,$host)
        }[url]
      }[exists(.())]
    }
  ))
};

================================================================================================

[TTML naar SRT]

https://en.wikipedia.org/wiki/Timed_Text_Markup_Language
https://trac.ffmpeg.org/ticket/4859

TTML, of "Timed Text Markup Language", wordt (nog) niet door FFmpeg ondersteund.
Het is een op XML gebaseerd formaat waardoor Xidel bij uitstek geschikt is voor een conversie naar SRT.

O.a. Youtube gebruikt dit formaat voor haar video's. Dit is een (ingekort) voorbeeld:
----------------------------------------------------------------
<?xml version="1.0" encoding="utf-8" ?><transcript><text start="49.76" dur="4.28">Ik geloof dat ik voor een paar
dagen de stad moet ontvluchten.</text><text start="56.36" dur="1.84">Het heeft niets met
[...]
niets over in de mainstream media?</text><text start="5114.4" dur="3.88">Je vraag is je antwoord!</text><text start="5182.68" dur="1.72">Daar sta ik dan...</text><text start="5184.56" dur="3.2">…net zo slim als toen ik begon.</text></transcript>
----------------------------------------------------------------

$ xidel -s "<TTML-url>" -e '//text[contains(.,"&")][1]'
&#39;s avonds ben ik ook erg
aan mijn bed toe.

$ xidel -s "<TTML-url>" -e '//text[contains(.,"&")][1] ! parse-xml(.)'
's avonds ben ik ook erg
aan mijn bed toe.

$ xidel -s "<TTML-url>" -e '
  for $x at $i in //text
  return (
    $i,
    concat(
      format-time(
        $x/@start * duration("PT1S"),
        "[H01]:[m01]:[s01],[f001]"
      ),
      " --> ",
      format-time(
        $x/(@start + @dur) * duration("PT1S"),
        "[H01]:[m01]:[s01],[f001]"
      )
    ),
    parse-xml($x),
    ""
  )
'
1
00:00:49,760 --> 00:00:54,040
Ik geloof dat ik voor een paar
dagen de stad moet ontvluchten.

2
00:00:56,360 --> 00:00:58,200
Het heeft niets met
geld of tijd te maken.

[...]

896
01:26:24,560 --> 01:26:27,760
…net zo slim als toen ik begon.

================================================================================================

[npo-live]

https://www.npostart.nl/live/npo-1 (huidige API)

$ xidel -s -H "X-Requested-With: XMLHttpRequest" "https://www.npostart.nl/api/token" -e '$json'
of
$ xidel -se 'x:request({"header":"X-Requested-With: XMLHttpRequest","url":"https://www.npostart.nl/api/token"})/json'
{
  "token": "dXbagD2EBAsa43aAQ1lEDMp1ZvUpQbHs0SEPAByt"
}

$ xidel -s "https://www.npostart.nl/live/npo-1" -e 'let $a:=//npo-player/@media-id return x:request({"header":"X-Requested-With: XMLHttpRequest","url":"https://www.npostart.nl/api/token"})/json/x:request({"post":"_token="||token,"url":"https://www.npostart.nl/player/"||$a})/json'
{
  "token": "eyJ0eXA[...]5i_G9mk",
  "embedUrl": "https://start-player.npo.nl/embed/eyJ0eXA[...]5i_G9mk",
  "embedCode": "<script>var urlForIframe = \"https://start-player.npo.nl/embed/eyJ0eXA[...]5i_G9mk\"; var elementId = \"player-LI_NL1_4188102\"; var mediaId = \"LI_NL1_4188102\";</script><script src=\"https://start-player.npo.nl/js/embed.js\"></script>"
}

$ xidel -s "https://www.npostart.nl/live/npo-1" -e 'let $a:=//npo-player/@media-id return x:request({"header":"X-Requested-With: XMLHttpRequest","url":"https://www.npostart.nl/api/token"})/json/x:request({"post":"_token="||token,"url":"https://www.npostart.nl/player/"||$a})/json/parse-json(doc(embedUrl)//script/extract(.,"var video =(.+);",1)[.])'
{
  "id": "LI_NL1_4188102",
  "type": "livetv",
  "title": "NPO 1",
  "subtitles": [],
  "episodeTitle": "",
  "franchiseTitle": "",
  "description": "",
  "duration": null,
  "age_rating": null,
  "still_image_url": "https://www-assets.npo.nl/uploads/tv_channel/263/guide_highlight/regular_2018_-_NPO1_IDENT_-_PAUW.jpg",
  "orig_image_url": "https://www-assets.npo.nl/uploads/tv_channel/263/logo/logo-npo1.png",
  "post_play_url": "https://www-assets.npo.nl/uploads/tv_channel/263/guide_highlight/regular_2018_-_NPO1_IDENT_-_PAUW.jpg",
  "share_text": "Bekijk NPO 1 op https://www.npostart.nl/LI_NL1_4188102",
  "share_url": "https://www.npostart.nl/LI_NL1_4188102",
  "broadcasters": [],
  "broadcastDate": "2019-03-15T15:44:20Z",
  "nextAsset": null,
  "qualityOptions": [
    {
      "bitrate": "0",
      "label": "Hoogste",
      "resolution": "1080p",
      "platform": "npo"
    },
    {
      "bitrate": "643000",
      "label": "Hoog",
      "resolution": "720p",
      "platform": "npo"
    },
    {
      "bitrate": "491000",
      "label": "Medium",
      "resolution": "576p",
      "platform": "npo"
    },
    {
      "bitrate": "248000",
      "label": "Laag",
      "resolution": "360p",
      "platform": "npo"
    }
  ],
  "visualRadio": null,
  "episodeNumber": null,
  "seriesId": null,
  "net": null,
  "genres": "",
  "ster": {
    "uri": "https://adconfig.ster.nl/adurl/$$identifier$$?ncc=$$ncc$$&cust_params=1%3D1%26programma_titel%3D%26afleverings_titel%3Dnpo1%26genre%3D%26subgenre%3D%26video_duur%3D0%26prid%3DLI_NL1_4188102%26srid%3D%26net%3D%26omroep%3D%26os%3D$$os$$%26osversion%3D$$osversion$$%26player%3D$$player$$%26playerversion%3D$$playerversion$$%26site%3D$$site$$%26ai%3D$$ai$$%26referrer_url%3D$$referrer_url$$%26description_url%3D$$description_url$$",
    "customParameters": {
      "prid": "LI_NL1_4188102",
      "srid": null
    },
    "placeholderValues": {
      "$$netwerk_id$$": "9233",
      "$$genre$$": null,
      "$$subgenre$$": "",
      "$$video_duur$$": 0,
      "$$net$$": null,
      "$$omroep$$": "",
      "$$programma_titel$$": "",
      "$$programmanaam$$": "",
      "$$stationid$$": "npo",
      "$$afleverings_titel$$": "npo1"
    }
  },
  "recommender": "ts-base",
  "startAt": null,
  "parentId": null,
  "channel": null
}

https://start-player.npo.nl/js/app.js:
[...]
var n = {
        "com.apple.fps.1_0": "hls",
        "com.widevine.alpha": "dash-widevine",
        "com.microsoft.playready": "dash-playready",
        silverlight: "smooth"
    },
[...]

$ xidel -s "https://www.npostart.nl/live/npo-1" -e 'let $a:=//npo-player/@media-id return x:request({"header":"X-Requested-With: XMLHttpRequest","url":"https://www.npostart.nl/api/token"})/json/x:request({"post":"_token="||token,"url":"https://www.npostart.nl/player/"||$a})/json/json-doc(concat("https://start-player.npo.nl/video/",$a,"/streams?profile=hls&quality=npo&tokenId=",token))'
{
  "stream": {
    "src": "https://pedgewarer28a.video.kpnstreaming.nl/session/7c2dbe1c-4735-11e9-8e3b-1458d0420170/ywkf3i/hls/live/nponep/live/npo/u/npo/drm/hls_fairplay/npo-1/0/0/0/npo-1.isml/playlist.m3u8?token=9dd8d1315b7d124fb4584a64922f5c29_1552749465_1552749465",
    "type": "application/vnd.apple.mpegurl",
    "protection": {
      "keySystem": "com.apple.fps.1_0",
      "certificateUrl": "https://s3-eu-west-1.amazonaws.com/24i-npo-stream/fairplay.cer",
      "licenseUrl": "https://npo-drm-gateway.samgcloud.nepworldwide.nl/authentication?custom_data=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJucG8iLCJpYXQiOjE1NTI2NjMwNTUsImRybV90eXBlIjoiZmFpcnBsYXkiLCJsaWNlbnNlX3Byb2ZpbGUiOiJ3ZWIiLCJjbGllbnRfaXAiOiI4MC4xMDEuNDkuNSJ9.MrJkJRhFG4lww9Nz7BOJ3NiVb7DyoprVGT4qyMkaFNw"
    }
  },
  "catchupAvailable": true
}

$ xidel -s "https://www.npostart.nl/live/npo-1" -f 'let $a:=//npo-player/@media-id return x:request({"header":"X-Requested-With: XMLHttpRequest","url":"https://www.npostart.nl/api/token"})/json/x:request({"post":"_token="||token,"url":"https://www.npostart.nl/player/"||$a})/json/json-doc(concat("https://start-player.npo.nl/video/",$a,"/streams?profile=hls&quality=npo&tokenId=",token))/stream/src' -e '$raw'
[...]
#EXT-X-SESSION-KEY:METHOD=SAMPLE-AES,URI="skd://60f29d98-6526-e8e6-02cd-1a6cc037f599",KEYFORMAT="com.apple.streamingkeydelivery",KEYFORMATVERSIONS="1"
[...]

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

$ xidel -s --module=xivid.xqm "https://www.npostart.nl/live/npo-1" -e 'let $a:=//npo-player/@media-id return x:request({"header":"X-Requested-With: XMLHttpRequest","url":"https://www.npostart.nl/api/token"})/json/x:request({"post":"_token="||token,"url":"https://www.npostart.nl/player/"||$a})/json/json-doc(concat("https://start-player.npo.nl/video/",$a,"/streams?profile=hls&amp;quality=npo&amp;tokenId=",token))/stream/xivid:m3u8-to-json(src)'
[
  {
    "id": "hls-0",
    "format": "m3u8[manifest]",
    "url": "https://pedgewarea28b.video.kpnstreaming.nl/session/054a4216-473a-11e9-b728-1458d0426038/p8ijhp/hls/live/nponep/live/npo/u/npo/drm/hls_fairplay/npo-1/0/0/0/npo-1.isml/playlist.m3u8?token=ee2a3e8377aa5c6670c36cecbaa4d0c8_1552751413_1552751413"
  },
  {
    "id": "hls-1",
    "format": "m3u8[aac]",
    "bitrate": "128kbps",
    "url": "https://pedgewarea28b.video.kpnstreaming.nl/session/054a4216-473a-11e9-b728-1458d0426038/p8ijhp/hls/live/nponep/live/npo/u/npo/drm/hls_fairplay/npo-1/0/0/0/npo-1.isml/npo-1-audio_nld=128000.m3u8"
  },
  [...]
  {
    "id": "hls-5",
    "format": "m3u8[h264+aac]",
    "resolution": "1024x576",
    "bitrate": "1800|128kbps",
    "url": "https://pedgewarea28b.video.kpnstreaming.nl/session/054a4216-473a-11e9-b728-1458d0426038/p8ijhp/hls/live/nponep/live/npo/u/npo/drm/hls_fairplay/npo-1/0/0/0/npo-1.isml/npo-1-audio_nld=128000-video=1800000.m3u8"
  }
]

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

$ ffmpeg -hide_banner -i "https://pedgewarea28b.video.kpnstreaming.nl/session/054a4216-473a-11e9-b728-1458d0426038/p8ijhp/hls/live/nponep/live/npo/u/npo/drm/hls_fairplay/npo-1/0/0/0/npo-1.isml/npo-1-audio_nld=128000-video=1800000.m3u8"
[https @ 057cf540] Opening 'https://pedgewarea28b.video.kpnstreaming.nl/session/054a4216-473a-11e9-b728-1458d0426038/p8ijhp/hls/live/nponep/live/npo/u/npo/drm/hls_fairplay/npo-1/0/0/0/npo-1.isml/npo-1-audio_nld=128000-video=1800000.m3u8' for reading
[hls,applehttp @ 051494c0] SAMPLE-AES encryption is not supported yet
[hls,applehttp @ 051494c0] Failed to open segment 194083138 of playlist 0
[hls,applehttp @ 051494c0] SAMPLE-AES encryption is not supported yet
[hls,applehttp @ 051494c0] Failed to open segment 194083139 of playlist 0
[hls,applehttp @ 051494c0] SAMPLE-AES encryption is not supported yet
[hls,applehttp @ 051494c0] Failed to open segment 194083140 of playlist 0
[...]
[hls,applehttp @ 051494c0] Error when loading first segment 'https://pedgewarea28b.video.kpnstreaming.nl/session/054a4216-473a-11e9-b728-1458d0426038/p8ijhp/hls/live/nponep/live/npo/u/npo/drm/hls_fairplay/npo-1/0/0/0/npo-1.isml/npo-1-audio_nld=128000-video=1800000-194083139.ts'

(https://github.com/e2iplayer/hlsdl/releases)
$ hlsdl "https://pedgewarea28b.video.kpnstreaming.nl/session/054a4216-473a-11e9-b728-1458d0426038/p8ijhp/hls/live/nponep/live/npo/u/npo/drm/hls_fairplay/npo-1/0/0/0/npo-1.isml/npo-1-audio_nld=128000-video=1800000.m3u8" -v
> START media_playlist_get_links
> END media_playlist_get_links
HLS Stream is SAMPLE-AES encrypted.
Media Playlist parsed successfully.
{"d_t":"live"}
DownloUpdate thread started
ading part 194092232
Error: Getting key-file [https://pedgewarea28b.video.kpnstreaming.nl/session/054a4216-473a-11e9-b728-1458d0426038/p8ijhp/hls/live/nponep/live/npo/u/npo/drm/hls_fairplay/npo-1/0/0/0/npo-1.isml/npo-1-audio_nld=128000-video=1800000.m3u8/../skd://60f29d98-6526-e8e6-02cd-1a6cc037f599] failed http_code[502].
{"t_d":32,"d_d":7,"d_s":1896544}
Downloading part 194092233
Error: Getting key-file [https://pedgewarea28b.video.kpnstreaming.nl/session/054a4216-473a-11e9-b728-1458d0426038/p8ijhp/hls/live/nponep/live/npo/u/npo/drm/hls_fairplay/npo-1/0/0/0/npo-1.isml/npo-1-audio_nld=128000-video=1800000.m3u8/../skd://60f29d98-6526-e8e6-02cd-1a6cc037f599] failed http_code[502].
{"t_d":32,"d_d":15,"d_s":3760564}
Downloading part 194092234
Error: Getting key-file [https://pedgewarea28b.video.kpnstreaming.nl/session/054a4216-473a-11e9-b728-1458d0426038/p8ijhp/hls/live/nponep/live/npo/u/npo/drm/hls_fairplay/npo-1/0/0/0/npo-1.isml/npo-1-audio_nld=128000-video=1800000.m3u8/../skd://60f29d98-6526-e8e6-02cd-1a6cc037f599] failed http_code[502].
[...]

------------------------------------------------------------------------------------------------

https://www.npostart.nl/live/npo-1 (oude API)

$ xidel -s "http://ida.omroep.nl/app.php/auth" -e '$json'
{
  "token": "6qm1ivpj8q4vm6c4s4fs4cb7i2"
}

$ xidel -s "https://www.npostart.nl/live/npo-1" -e 'json-doc(concat("http://ida.omroep.nl/app.php/",//npo-player/@media-id,"?token=",json-doc("http://ida.omroep.nl/app.php/auth")/token))'
{
  "limited": false,
  "site": null,
  "items": [
    [
      {
        "label": "Live",
        "contentType": "live",
        "url": "https://livestreams.omroep.nl/live/npo/tvlive/npo1/npo1.isml/npo1.m3u8?hash=dfd2fbbc1487ca2af5fb88419e178759&token=3e47c7ec3116134d97460ef058cac2ab&type=jsonp&protection=url",
        "format": "hls"
      }
    ]
  ]
}

$ xidel -s "https://www.npostart.nl/live/npo-1" -e 'json-doc(concat("http://ida.omroep.nl/app.php/",//npo-player/@media-id,"?token=",json-doc("http://ida.omroep.nl/app.php/auth")/token))/json-doc(replace(.//url,"jsonp","json"))'
https://smoote2a.omroep.nl/urishieldv2/l2fm69153f3570e8b83a005c8ce825000000.fee9019baad2e00387eb856a885cd3c8/live/npo/tvlive/npo1/npo1.isml/npo1.m3u8

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

https://www.npostart.nl/live/npo-1-extra

$ xidel -s "https://www.npostart.nl/live/npo-1-extra" -e 'json-doc(concat("http://ida.omroep.nl/app.php/",//npo-player/@media-id,"?token=",json-doc("http://ida.omroep.nl/app.php/auth")/token))/json-doc(replace(.//url,"jsonp","json"))'
Error:
err:FODC0002: Internet/HTTP Error: 404
when talking to: https://livestreams.omroep.nl/live/npo/thematv/101tv/101tv.isml/101tv.m3u8?hash=cdfe301d72cedc0452845b56c413f99c&token=a6a9cc4f8699d6f410749a9fe984a984&type=json&protection=url

$ xidel -s "https://www.npostart.nl/live/npo-1-extra" -e 'json-doc(concat("http://ida.omroep.nl/app.php/",//npo-player/@media-id,"?token=",json-doc("http://ida.omroep.nl/app.php/auth")/token))/x:request({"url":replace(.//url,"jsonp","json"),"error-handling":"4xx=accept"})'
{
  "url": "https://livestreams.omroep.nl/live/npo/thematv/101tv/101tv.isml/101tv.m3u8?hash=0b20e3bd652dd5b1c856d20e8db432a1&token=fd1013ba8bdcfa3ab1a8d2c864472745&type=json&protection=url",
  "type": "text/html; charset=UTF-8",
  "headers": [
    "HTTP/1.1 404 Not Found",
    "Date: Sat, 16 Mar 2019 13:19:14 GMT",
    "Content-Type: text/html; charset=UTF-8",
    "Transfer-Encoding: chunked",
    "Vary: Accept-Encoding",
    "Server: nginx",
    "Vary: Accept-Encoding",
    "X-stream-message: flow_valid_livestream: 0: 'Livestream not found in cache or configured as not-available'",
    "Via: 1.1 google",
    ""
  ],
  "raw": "",
  "doc": null
}

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

$ xidel -s "https://www.npostart.nl/live/npo-1" -e 'json-doc(concat("http://ida.omroep.nl/app.php/",//npo-player/@media-id,"?token=",json-doc("http://ida.omroep.nl/app.php/auth")/token))/x:request({"url":replace(.//url,"jsonp","json"),"error-handling":"4xx=accept"})[json]'
{
  "url": "https://livestreams.omroep.nl/live/npo/tvlive/npo1/npo1.isml/npo1.m3u8?hash=7b77c52239cc1a95354ce79e4e639993&token=8e1c0abf06439fd6ce84f7305fd0d972&type=json&protection=url",
  "type": "application/json",
  "headers": [
    "HTTP/1.1 200 OK",
    "Date: Sat, 16 Mar 2019 23:58:11 GMT",
    "Content-Type: application/json",
    "Transfer-Encoding: chunked",
    "Vary: Accept-Encoding",
    "Server: nginx",
    "Vary: Accept-Encoding",
    "X-stream-message: flow_cluster_instance: 0: 'Success. Used the default NPO cluster'",
    "Via: 1.1 google",
    ""
  ],
  "raw": "\"https:\\/\\/smoote2h.omroep.nl\\/urishieldv2\\/l2fm7efa778b39f993a2005c8d8d93000000.058fc1c4f40aaffb538624957b900806\\/live\\/npo\\/tvlive\\/npo1\\/npo1.isml\\/npo1.m3u8\"",
  "json": "https://smoote2h.omroep.nl/urishieldv2/l2fm7efa778b39f993a2005c8d8d93000000.058fc1c4f40aaffb538624957b900806/live/npo/tvlive/npo1/npo1.isml/npo1.m3u8"
}

$ xidel -s --module=xivid.xqm "https://www.npostart.nl/live/npo-1" -e '{"name":replace(//title," - Live tv",": Livestream"),"date":format-date(current-date(),"[D01]-[M01]-[Y]"),"formats":json-doc(concat("http://ida.omroep.nl/app.php/",//npo-player/@media-id,"?token=",json-doc("http://ida.omroep.nl/app.php/auth")/token))/x:request({"url":replace(.//url,"jsonp","json"),"error-handling":"4xx=accept"})[json]/xivid:m3u8-to-json(json)}'
{
  "name": "NPO 1: Livestream",
  "date": "16-03-2019",
  "formats": [
    {
      "id": "hls-0",
      "format": "m3u8[manifest]",
      "url": "https://smoote2d.omroep.nl/urishieldv2/l2fm3a9a3af15007ec5f005c8d0822000000.a5e79cf6973549e2d3d7ea1527f32029/live/npo/tvlive/npo1/npo1.isml/npo1.m3u8"
    },
    {
      "id": "hls-1",
      "format": "m3u8[aac]",
      "bitrate": "128kbps",
      "url": "https://smoote2d.omroep.nl/urishieldv2/l2fm3a9a3af15007ec5f005c8d0822000000.a5e79cf6973549e2d3d7ea1527f32029/live/npo/tvlive/npo1/npo1.isml/npo1-audio=128000.m3u8"
    },
    [...]
    {
      "id": "hls-4",
      "format": "m3u8[h264+aac]",
      "resolution": "1024x576",
      "bitrate": "1800|128kbps",
      "url": "https://smoote2d.omroep.nl/urishieldv2/l2fm3a9a3af15007ec5f005c8d0822000000.a5e79cf6973549e2d3d7ea1527f32029/live/npo/tvlive/npo1/npo1.isml/npo1-audio=128000-video=1800000.m3u8"
    }
  ]
}

$ xidel -s "https://www.npostart.nl/live/npo-1-extra" -e '[...]'
{
  "name": "NPO 1 extra: Livestream",
  "date": "16-03-2019",
  "formats": null
}

Update 08-04-2019: Werkt inmiddels niet meer.

$ xidel -s "https://www.npostart.nl/live/npo-1" -e 'json-doc(concat("http://ida.omroep.nl/app.php/",//npo-player/@media-id,"?token=",json-doc("http://ida.omroep.nl/app.php/auth")/token))'
Error:
err:FODC0002: Internet/HTTP Error: 500
when talking to: http://ida.omroep.nl/app.php/LI_NL1_4188102?token=3r9d72h0opmhc1invqm9a58hl0
[...]

================================================================================================

[npo] (oude API, per 28-02-2019)

https://www.npostart.nl/nos-journaal/15-03-2019/POW_04059374

$ xidel -se 'json-doc(concat("http://ida.omroep.nl/app.php/POW_04059374?token=",json-doc("http://ida.omroep.nl/app.php/auth")/token))'
{
  "limited": false,
  "site": null,
  "items": [
    [
      {
        "label": "Adaptive",
        "contentType": "odi",
        "url": "https://odis.omroep.nl/video/ida/adaptive/a40fc245d68bbd6ade6fee8b87006187/5c8d0c0b/POW_04059374/1?extension=m3u8&type=jsonp&callback=?",
        "format": "hls"
      },
      {
        "label": "Hoog",
        "contentType": "odi",
        "url": "https://odis.omroep.nl/video/ida/h264_std/2f7433794cbff513f772501b34b71b3b/5c8d0c0b/POW_04059374/1?type=jsonp&callback=?",
        "format": "mp4"
      },
      {
        "label": "Normaal",
        "contentType": "odi",
        "url": "https://odis.omroep.nl/video/ida/h264_bb/ef0a10051d3de9560e78ecccd83bb38c/5c8d0c0b/POW_04059374/1?type=jsonp&callback=?",
        "format": "mp4"
      },
      {
        "label": "Laag",
        "contentType": "odi",
        "url": "https://odis.omroep.nl/video/ida/h264_sb/dd0bbb0bfa1194b20513f311e34c84f9/5c8d0c0b/POW_04059374/1?type=jsonp&callback=?",
        "format": "mp4"
      }
    ]
  ]
}

$ xidel -se 'json-doc(concat("http://ida.omroep.nl/app.php/POW_04059374?token=",json-doc("http://ida.omroep.nl/app.php/auth")/token))//url ! json-doc(replace(.,"jsonp","json"))/url'
https://content.omroep.nl/streams/doeg/vodnotavailable.m4v?odiredirecturl=/video/ida/adaptive/2b39f51e5a4d9e865fe7c95340ffd0af/5c8d0c98/POW_04059374/1?extension=m3u8&type=json&callback=?
https://content.omroep.nl/streams/doeg/vodnotavailable.m4v?odiredirecturl=/video/ida/h264_std/6d301b8d73b7e8ef4eab42845f536eff/5c8d0c98/POW_04059374/1?type=json&callback=?
https://content.omroep.nl/streams/doeg/vodnotavailable.m4v?odiredirecturl=/video/ida/h264_bb/6ce7a8fe765d62925943cd3ba8d0dcc2/5c8d0c98/POW_04059374/1?type=json&callback=?
https://content.omroep.nl/streams/doeg/vodnotavailable.m4v?odiredirecturl=/video/ida/h264_sb/25e8a3d0cd41c7e396b368b0dcd3d424/5c8d0c98/POW_04059374/1?type=json&callback=?

================================================================================================

[npo] (huidige API)

$ url=https://www.npostart.nl/nos-journaal/28-02-2017/POW_03375558 (laatste NOS Journaal 20:00 zonder DRM)

$ xidel -se 'let $prid:=extract("'$url'","[A-Z\d_]+$"),$token:=x:request({"header":"X-Requested-With: XMLHttpRequest","url":"https://www.npostart.nl/api/token"})/json/token return x:request({"post":"_token="||$token,"url":"https://www.npostart.nl/player/"||$prid})/json'
{
  "token": "eyJ0eXA[...]fFLtQQU",
  "embedUrl": "https://start-player.npo.nl/embed/eyJ0eXA[...]fFLtQQU",
  "embedCode": "<script async>if (typeof(NPOFrame) === \"function\") { NPOFrame('player-POW_03375558',  'https://start-player.npo.nl/embed/eyJ0eXA[...]fFLtQQU', 'POW_03375558'); } else { var el = document.createElement('script'); el.src = 'https://start-player.npo.nl/js/embed.min.js'; el.onload = function(){NPOFrame('player-POW_03375558',  'https://start-player.npo.nl/embed/eyJ0eXA[...]fFLtQQU', 'POW_03375558');};document.getElementById('player-POW_03375558').appendChild(el);}</script>"
}

$ xidel -se 'let $prid:=extract("'$url'","[A-Z\d_]+$"),$token:=x:request({"header":"X-Requested-With: XMLHttpRequest","url":"https://www.npostart.nl/api/token"})/json/token,$token2:=x:request({"post":"_token="||$token,"url":"https://www.npostart.nl/player/"||$prid})/json return parse-json(doc($token2/embedUrl)//script/extract(.,"var video =(.+);",1)[.])'
{
  "id": "POW_03375558",
  "type": "broadcast",
  "title": "NOS Journaal",
  "subtitles": [
    {
      "label": "Nederlands",
      "default": false,
      "language": "nl",
      "src": "https://assetscdn.npostart.nl/subtitles/original/nl/POW_03375558.vtt"
    }
  ],
  "seasonNumber": 44,
  "episodeTitle": "NOS Journaal",
  "franchiseTitle": "NOS Journaal 20.00 uur",
  "description": "Met het laatste nieuws, gebeurtenissen van nationaal en internationaal belang en de weersverwachting voor de avond en komende dagen.",
  "duration": 1537,
  [...]
  "broadcastDate": "2017-02-28T19:00:00Z",
  [...]
}

$ xidel -se 'let $prid:=extract("'$url'","[A-Z\d_]+$"),$token:=x:request({"header":"X-Requested-With: XMLHttpRequest","url":"https://www.npostart.nl/api/token"})/json/token,$token2:=x:request({"post":"_token="||$token,"url":"https://www.npostart.nl/player/"||$prid})/json return request-combine(x"https://start-player.npo.nl/video/{$prid}/streams",{"profile":"hls","quality":"npo","tokenId":$token2/token})'
{
  "url": "https://start-player.npo.nl/video/POW_03375558/streams?profile=hls&quality=npo&tokenId=eyJ0eXA[...]fFLtQQU"
}

$ xidel -se 'let $prid:=extract("'$url'","[A-Z\d_]+$"),$token:=x:request({"header":"X-Requested-With: XMLHttpRequest","url":"https://www.npostart.nl/api/token"})/json/token,$token2:=x:request({"post":"_token="||$token,"url":"https://www.npostart.nl/player/"||$prid})/json return json-doc(request-combine(x"https://start-player.npo.nl/video/{$prid}/streams",{"profile":"hls","quality":"npo","tokenId":$token2/token})/url)'
{
  "metadata": {
    "live": false,
    "supportSeeking": true,
    "catchupAvailable": false,
    "hasPremiumSubscription": false
  },
  "stream": {
    "src": "https://npo.prd.cdn.bcms.kpn.com/[...]/playlist.m3u8",
    "type": "application/vnd.apple.mpegurl"
  },
  "selectedQuality": "npo",
  "debug": {
    "skipCatalog": false,
    "skipAds": false,
    "selectedQuality": "npo",
    "profile": "hls",
    "stream": "https://npo.prd.cdn.bcms.kpn.com/[...]/playlist.m3u8",
    "streamType": "hls_unencrypted"
  }
}

$ xidel -s --module=xivid.xqm -e 'let $prid:=extract("'$url'","[A-Z\d_]+$"),$token:=x:request({"header":"X-Requested-With: XMLHttpRequest","url":"https://www.npostart.nl/api/token"})/json/token,$token2:=x:request({"post":"_token="||$token,"url":"https://www.npostart.nl/player/"||$prid})/json,$info:=parse-json(doc($token2/embedUrl)//script/extract(.,"var video =(.+);",1)[.]) return $info/{"name":concat(franchiseTitle,if (contains(franchiseTitle,title)) then () else ": "||title),"date":broadcastDate,"duration":duration * duration("PT1S"),"formats":array{(subtitles)()/{"id":"sub-1","format":"vtt","language":language,"label":label,"url":src},xivid:m3u8-to-json(json-doc(request-combine(x"https://start-player.npo.nl/video/{$prid}/streams",{"profile":"hls","quality":"npo","tokenId":$token2/token})/url)/stream/src)()}}'
{
  "name": "NOS Journaal 20.00 uur",
  "date": "2017-02-28T19:00:00Z",
  "duration": "PT25M37S",
  "formats": [
    {
      "id": "sub-1",
      "format": "vtt",
      "language": "nl",
      "label": "Nederlands",
      "url": "https://assetscdn.npostart.nl/subtitles/original/nl/POW_03375558.vtt"
    },
    {
      "id": "hls-0",
      "format": "m3u8[manifest]",
      "url": "https://npo.prd.cdn.bcms.kpn.com/[...]/playlist.m3u8"
    },
    {
      "id": "hls-1",
      "format": "m3u8[aac]",
      "bitrate": "64kbps",
      "url": "https://npo.prd.cdn.bcms.kpn.com/[...]/POW_03375558_v4-audio=64000.m3u8"
    },
    [...]
    {
      "id": "hls-6",
      "format": "m3u8[h264+aac]",
      "resolution": "1024x576",
      "bitrate": "1109|128kbps",
      "url": "https://npo.prd.cdn.bcms.kpn.com/[...]/POW_03375558_v4-audio=128000-video=1109000.m3u8"
    }
  ]
}

------------------------------------------------------------------------------------------------

$ url=https://www.npostart.nl/nos-journaal/24-04-2021/POW_04820347 (video met DRM)

$ xidel -se 'let $prid:=extract("'$url'","[A-Z\d_]+$"),$token:=x:request({"header":"X-Requested-With: XMLHttpRequest","url":"https://www.npostart.nl/api/token"})/json/token,$token2:=x:request({"post":"_token="||$token,"url":"https://www.npostart.nl/player/"||$prid})/json return json-doc(request-combine(x"https://start-player.npo.nl/video/{$prid}/streams",{"profile":"hls","quality":"npo","tokenId":$token2/token})/url)'
{
  "metadata": {
    "live": false,
    "supportSeeking": true,
    "catchupAvailable": false,
    "hasPremiumSubscription": false
  },
  "stream": {
    "src": "https://npo.prd.cdn.bcms.kpn.com/[...]/playlist.m3u8",
    "type": "application/vnd.apple.mpegurl",
    "protection": {
      "keySystem": "com.apple.fps.1_0",
      "certificateUrl": "https://s3-eu-west-1.amazonaws.com/24i-npo-stream/fairplay.cer",
      "licenseUrl": "https://npo-drm-gateway.samgcloud.nepworldwide.nl/authentication?custom_data=eyJ0eXA[...]_eEOSDA"
    }
  },
  "selectedQuality": "npo",
  "debug": {
    "skipCatalog": false,
    "skipAds": false,
    "selectedQuality": "npo",
    "profile": "hls",
    "stream": "https://npo.prd.cdn.bcms.kpn.com/[...]/playlist.m3u8",
    "streamType": "hls_fairplay"
  }
}

$ xidel -s --module=xivid.xqm -e 'let $prid:=extract("'$url'","[A-Z\d_]+$"),$token:=x:request({"header":"X-Requested-With: XMLHttpRequest","url":"https://www.npostart.nl/api/token"})/json/token,$token2:=x:request({"post":"_token="||$token,"url":"https://www.npostart.nl/player/"||$prid})/json,$info:=parse-json(doc($token2/embedUrl)//script/extract(.,"var video =(.+);",1)[.]) return $info/{"name":concat(franchiseTitle,if (contains(franchiseTitle,title)) then () else ": "||title),"date":broadcastDate,"duration":duration * duration("PT1S"),"formats":array{(subtitles)()/{"id":"sub-1","format":"vtt","language":language,"label":label,"url":src},xivid:m3u8-to-json(json-doc(request-combine(x"https://start-player.npo.nl/video/{$prid}/streams",{"profile":"hls","quality":"npo","tokenId":$token2/token})/url)/stream/src)()}}'
{
  "name": "NOS Journaal 2000",
  "date": "2021-04-24T18:00:00Z",
  "duration": "PT20M30S",
  "formats": [
    {
      "id": "sub-1",
      "format": "vtt",
      "language": "nl",
      "label": "Nederlands",
      "url": "https://assetscdn.npostart.nl/subtitles/original/nl/POW_04820347.vtt"
    },
    {
      "id": "hls-0",
      "format": "m3u8[manifest]",
      "url": "https://npo.prd.cdn.bcms.kpn.com/[...]/playlist.m3u8"
    },
    {
      "id": "hls-1",
      "format": "m3u8[aac]",
      "bitrate": "128kbps",
      "url": "https://npo.prd.cdn.bcms.kpn.com/[...]/a1/a1.m3u8"
    },
    [...]
    {
      "id": "hls-3",
      "format": "m3u8[h264+aac]",
      "resolution": "960x540",
      "bitrate": "2287kbps",
      "url": "https://npo.prd.cdn.bcms.kpn.com/[...]/v4/v4.m3u8"
    }
  ]
}

$ ffmpeg -hide_banner -i "https://npo.prd.cdn.bcms.kpn.com/c08e19b92b2c44140b9ff126919d965a_1619446556/vod/npo/fps/TEST/npo/hls/POW_04820347_v1619288893/v4/v4.m3u8"
[hls @ 05018cc0] Skip ('#EXT-X-VERSION:5')
[hls @ 05018cc0] Skip ('## Created with Unified Streaming Platform(version=1.7.18)')
[hls @ 05018cc0] Skip ('#EXT-X-INDEPENDENT-SEGMENTS')
[hls @ 05018cc0] Skip ('#USP-X-MEDIA:BANDWIDTH=2155000,AVERAGE-BANDWIDTH=1960000,TYPE=VIDEO,GROUP-ID="video-avc1-1891",LANGUAGE="en",NAME="English",AUTOSELECT=YES,CODECS="avc1.4D401F",RESOLUTION=960x540')
[hls @ 05018cc0] SAMPLE-AES encryption is not supported yet
[hls @ 05018cc0] Failed to open segment 0 of playlist 0
[hls @ 05018cc0] SAMPLE-AES encryption is not supported yet
[hls @ 05018cc0] Failed to open segment 1 of playlist 0
[...]
[hls @ 05018cc0] SAMPLE-AES encryption is not supported yet
[hls @ 05018cc0] Failed to open segment 153 of playlist 0
[hls @ 05018cc0] Error when loading first segment 'https://npo.prd.cdn.bcms.kpn.com/c08e19b92b2c44140b9ff126919d965a_1619446556/vod/npo/fps/TEST/npo/hls/POW_04820347_v1619288893/v4/v4.ts'

In de praktijk wordt SAMPLE-AES alleen voor DRM gebruikt, dus de FFmpeg community zal dit nooit toevoegen.

Controleer in het "stream"-object op de aanwezigheid van het "protection"-object om beveiligde/versleutelde video's er uit te filteren:
-e "[...]$c:=[...]/stream[not(exists(protection))]/src
                         ^~~~~~~~~~~~~~~~~~~~~~~~~

$ xidel -s --module=xivid.xqm -e 'let $prid:=extract("'$url'","[A-Z\d_]+$"),$token:=x:request({"header":"X-Requested-With: XMLHttpRequest","url":"https://www.npostart.nl/api/token"})/json/token,$token2:=x:request({"post":"_token="||$token,"url":"https://www.npostart.nl/player/"||$prid})/json,$info:=parse-json(doc($token2/embedUrl)//script/extract(.,"var video =(.+);",1)[.]) return $info/{"name":concat(franchiseTitle,if (contains(franchiseTitle,title)) then () else ": "||title),"date":broadcastDate,"duration":duration * duration("PT1S"),"formats":array{(subtitles)()/{"id":"sub-1","format":"vtt","language":language,"label":label,"url":src},xivid:m3u8-to-json(json-doc(request-combine(x"https://start-player.npo.nl/video/{$prid}/streams",{"profile":"hls","quality":"npo","tokenId":$token2/token})/url)/stream[not(exists(protection))]/src)()}}'
{
  "name": "NOS Journaal 2000",
  "date": "2021-04-24T18:00:00Z",
  "duration": "PT20M30S",
  "formats": [
    {
      "id": "sub-1",
      "format": "vtt",
      "language": "nl",
      "label": "Nederlands",
      "url": "https://assetscdn.npostart.nl/subtitles/original/nl/POW_04820347.vtt"
    }
  ]
}

------------------------------------------------------------------------------------------------

$ url=https://www.npostart.nl/stop-verkeerslicht-voor-telefoonverslaafde/14-02-2017/POMS_NOS_7332477 (videofragment)

$ xidel -se 'let $prid:=extract("'$url'","[A-Z\d_]+$"),$token:=x:request({"header":"X-Requested-With: XMLHttpRequest","url":"https://www.npostart.nl/api/token"})/json/token,$token2:=x:request({"post":"_token="||$token,"url":"https://www.npostart.nl/player/"||$prid})/json return parse-json(doc($token2/embedUrl)//script/extract(.,"var video =(.+);",1)[.])'
{
  "id": "POMS_NOS_7332477",
  "type": "fragment",
  "title": "STOP! Verkeerslicht voor telefoonverslaafde",
  "subtitles": [],
  "seasonNumber": null,
  "episodeTitle": "",
  "franchiseTitle": "NOS Journaal",
  "description": "Een verkeerslicht in de stoep, om zo voetgangers die in gedachten verzonken op hun smartphone zitten te kijken extra te waarschuwen.",
  "duration": 65,
  [...]
  "broadcastDate": "2017-02-14T12:00:00Z",
  [...]
  "startAt": 542,
  "parentId": "POW_03373320",
  [...]
}

$ xidel -s --module=xivid.xqm -e 'let $prid:=extract("'$url'","[A-Z\d_]+$"),$token:=x:request({"header":"X-Requested-With: XMLHttpRequest","url":"https://www.npostart.nl/api/token"})/json/token,$token2:=x:request({"post":"_token="||$token,"url":"https://www.npostart.nl/player/"||$prid})/json,$info:=parse-json(doc($token2/embedUrl)//script/extract(.,"var video =(.+);",1)[.]) return $info/{"name":concat(franchiseTitle,if (contains(franchiseTitle,title)) then () else ": "||title),"date":broadcastDate,"duration":duration * duration("PT1S"),"start":startAt * duration("PT1S"),"end":(startAt + duration) * duration("PT1S"),"formats":array{(if (not(exists((subtitles)())) and parentId) then parse-json(doc(x:request({"post":"_token="||$token,"url":"https://www.npostart.nl/player/"||parentId})/json/embedUrl)//script/extract(.,"var video =(.+);",1)[.]) else .)/(subtitles)()/{"id":"sub-1","format":"vtt","language":language,"label":label,"url":src},xivid:m3u8-to-json(json-doc(request-combine(x"https://start-player.npo.nl/video/{$prid}/streams",{"profile":"hls","quality":"npo","tokenId":$token2/token})/url)/stream[not(exists(protection))]/src)()}}'
{
  "name": "NOS Journaal: STOP! Verkeerslicht voor telefoonverslaafde",
  "date": "2017-02-14T12:00:00Z",
  "duration": "PT1M5S",
  "start": "PT9M2S",
  "end": "PT10M7S",
  "formats": [
    {
      "id": "sub-1",
      "format": "vtt",
      "language": "nl",
      "label": "Nederlands",
      "url": "https://assetscdn.npostart.nl/subtitles/original/nl/POW_03373320.vtt"
    },
    {
      "id": "hls-0",
      "format": "m3u8[manifest]",
      "url": "https://npo.prd.cdn.bcms.kpn.com/[...]/playlist.m3u8"
    },
    {
      "id": "hls-1",
      "format": "m3u8[aac]",
      "bitrate": "64kbps",
      "url": "https://npo.prd.cdn.bcms.kpn.com/[...]/POW_03373320_v4-audio=64000.m3u8"
    },
    [...]
    {
      "id": "hls-6",
      "format": "m3u8[h264+aac]",
      "resolution": "1024x576",
      "bitrate": "1027|128kbps",
      "url": "https://npo.prd.cdn.bcms.kpn.com/[...]/POW_03373320_v4-audio=128000-video=1027000.m3u8"
    }
  ]
}

------------------------------------------------------------------------------------------------

$ url=https://www.npostart.nl/flikken-maastricht/01-03-2019/AT_2105037

$ xidel -se 'let $prid:=extract("'$url'","[A-Z\d_]+$"),$token:=x:request({"header":"X-Requested-With: XMLHttpRequest","url":"https://www.npostart.nl/api/token"})/json/token,$token2:=x:request({"post":"_token="||$token,"url":"https://www.npostart.nl/player/"||$prid})/json return unparsed-text($token2/embedUrl)'
<!DOCTYPE html>
<html>
<head>
    <title>Flikken Maastricht</title>
    <link href="/styles/video-js.css" rel="stylesheet">
    <link href="/styles/main.css" rel="stylesheet">
            <link href="https://www.npostart.nl/styles/player.css" rel="stylesheet">
    </head>

<body>
<div class="npo-player-overlay" id="npo-player-exclusive" style="background-image: url('https://images.npo.nl/tile/1280x720/1195341.jpg');" >
    <div class="npo-player-overlay-bg"></div>
    <div class="npo-player-overlay-message">
                    <p class="code-41">Dit programma is alleen te zien met een NPO Plus account (41).</p>


                <p></p>
    </div>
</div>
[...]
</body>
</html>

Geen JSON en dus geen enkele video-informatie (van deze DRM video). De hoofdpagina heeft die wel.

$ xidel -s --module=xivid.xqm -e 'let $prid:=extract("'$url'","[A-Z\d_]+$"),$token:=x:request({"header":"X-Requested-With: XMLHttpRequest","url":"https://www.npostart.nl/api/token"})/json/token,$token2:=x:request({"post":"_token="||$token,"url":"https://www.npostart.nl/player/"||$prid})/json,$info:=parse-json(doc($token2/embedUrl)//script/extract(.,"var video =(.+);",1)[.]) return map:merge((if (exists($info)) then $info/{"name":concat(franchiseTitle,if (contains(franchiseTitle,title)) then () else ": "||title),"date":broadcastDate,"duration":duration * duration("PT1S"),"start":startAt * duration("PT1S"),"end":(startAt + duration) * duration("PT1S")} else doc("https://www.npostart.nl/"||$prid)/(let $info:=parse-json((//script[@type="application/ld+json"])[1]) return {"name"://npo-player-header/concat(@main-title,": ",@share-title),"date":adjust-dateTime-to-timezone(dateTime($info/uploadDate),duration("PT0S")),"duration":$info/duration}),{"formats"?:array{(if (not(exists($info/(subtitles)())) and $info/parentId) then parse-json(doc(x:request({"post":"_token="||$token,"url":"https://www.npostart.nl/player/"||$info/parentId})/json/embedUrl)//script/extract(.,"var video =(.+);",1)[.]) else $info)/(subtitles)()/{"id":"sub-1","format":"vtt","language":language,"label":label,"url":src},xivid:m3u8-to-json(json-doc(request-combine(x"https://start-player.npo.nl/video/{$prid}/streams",{"profile":"hls","quality":"npo","tokenId":$token2/token})/url)/stream[not(exists(protection))]/src)()}[exists(.())]}))'
{
  "name": "Flikken Maastricht: Virtus et justitia",
  "date": "2019-03-01T19:35:00Z",
  "duration": "PT47M27S"
}

------------------------------------------------------------------------------------------------

$ url=https://www.npostart.nl/live/npo-1

$ xidel -se 'let $prid:=if (contains("'$url'","/live/")) then doc("'$url'")//npo-player/@media-id else extract("'$url'","[A-Z\d_]+$"),$token:=x:request({"header":"X-Requested-With: XMLHttpRequest","url":"https://www.npostart.nl/api/token"})/json/token,$token2:=x:request({"post":"_token="||$token,"url":"https://www.npostart.nl/player/"||$prid})/json return parse-json(doc($token2/embedUrl)//script/extract(.,"var video =(.+);",1)[.])'
{
  "id": "LI_NL1_4188102",
  "type": "livetv",
  "title": "NPO 1",
  [...]
}

$ xidel -s --module=xivid.xqm -e 'let $prid:=if (contains("'$url'","/live/")) then doc("'$url'")//npo-player/@media-id else extract("'$url'","[A-Z\d_]+$"),$token:=x:request({"header":"X-Requested-With: XMLHttpRequest","url":"https://www.npostart.nl/api/token"})/json/token,$token2:=x:request({"post":"_token="||$token,"url":"https://www.npostart.nl/player/"||$prid})/json,$info:=parse-json(doc($token2/embedUrl)//script/extract(.,"var video =(.+);",1)[.]) return map:merge((if (exists($info)) then $info/{"name":if (type="livetv") then concat(title,": Livestream") else concat(franchiseTitle,if (contains(franchiseTitle,title)) then () else ": "||title),"date":broadcastDate,"duration"?:duration * duration("PT1S"),"start"?:startAt * duration("PT1S"),"end"?:(startAt + duration) * duration("PT1S")} else doc("https://www.npostart.nl/"||$prid)/(let $info:=parse-json((//script[@type="application/ld+json"])[1]) return {"name"://npo-player-header/concat(@main-title,": ",@share-title),"date":adjust-dateTime-to-timezone(dateTime($info/uploadDate),duration("PT0S")),"duration":$info/duration}),{"formats"?:array{(if (not(exists($info/(subtitles)())) and $info/parentId) then parse-json(doc(x:request({"post":"_token="||$token,"url":"https://www.npostart.nl/player/"||$info/parentId})/json/embedUrl)//script/extract(.,"var video =(.+);",1)[.]) else $info)/(subtitles)()/{"id":"sub-1","format":"vtt","language":language,"label":label,"url":src},xivid:m3u8-to-json(json-doc(request-combine(x"https://start-player.npo.nl/video/{$prid}/streams",{"profile":"hls","quality":"npo","tokenId":$token2/token})/url)/stream[not(exists(protection))]/src)()}[exists(.())]}))'
{
  "name": "NPO 1: Livestream",
  "date": "2021-04-25T15:36:55Z"
}

------------------------------------------------------------------------------------------------

declare function xivid:npo($url as string) as object()? {
  let $prid:=if (contains($url,"/live/")) then
        doc($url)//npo-player/@media-id
      else
        extract($url,"[A-Z\d_]+$"),
      $token:=x:request({
        "header":"X-Requested-With: XMLHttpRequest",
        "url":"https://www.npostart.nl/api/token"
      })/json/token,
      $token2:=x:request({
        "post":"_token="||$token,
        "url":"https://www.npostart.nl/player/"||$prid
      })/json,
      $info:=parse-json(
        doc($token2/embedUrl)//script/extract(.,"var video =(.+);",1)[.]
      )
  return
  map:merge((
    if (exists($info)) then $info/{
      "name":if (type="livetv") then
        concat(title,": Livestream")
      else
        concat(
          franchiseTitle,
          if (contains(franchiseTitle,title)) then () else ": "||title
        ),
      "date":broadcastDate,
      "duration"?:duration * duration("PT1S"),
      "start"?:startAt * duration("PT1S"),
      "end"?:(startAt + duration) * duration("PT1S")
    } else
      doc("https://www.npostart.nl/"||$prid)/(
        let $info:=parse-json((//script[@type="application/ld+json"])[1]) return {
          "name"://npo-player-header/concat(@main-title,": ",@share-title),
          "date":adjust-dateTime-to-timezone(
            dateTime($info/uploadDate),duration("PT0S")
          ),
          "duration":$info/duration
        }
      ),
    {
      "formats"?:array{
        (
          if (not(exists($info/(subtitles)())) and $info/parentId) then
            parse-json(
              doc(
                x:request({
                  "post":"_token="||$token,
                  "url":"https://www.npostart.nl/player/"||$info/parentId
                })/json/embedUrl
              )//script/extract(.,"var video =(.+);",1)[.]
            )
          else
            $info
        )/(subtitles)()/{
          "id":"sub-1",
          "format":"vtt",
          "language":language,
          "label":label,
          "url":src
        },
        xivid:m3u8-to-json(
          json-doc(
            request-combine(
              x"https://start-player.npo.nl/video/{$prid}/streams",
              {"profile":"hls","quality":"npo","tokenId":$token2/token}
            )/url
          )/stream[not(exists(protection))]/src
        )()
      }[exists(.())]
    }
  ))
};

================================================================================================

[rtl]

$ url=https://www.rtlxl.nl/programma/rtl-nieuws/37f2e7ec-5a27-3084-981b-1f77bd06732d   # RTL Nieuws van 15-01-2020 19:30)

$ xidel -se 'parse-json(doc("'$url'")//script[@type="application/json"])//video'
{
  "series": {
    "slug": "rtl-nieuws",
    "source": "rtlnieuws",
    "id": "132237",
    "title": "RTL Nieuws",
    "type": "Series"
  },
  "broadcastDateTime": "2021-01-15T18:30:00Z",
  "scheduleDate": "2021-01-15",
  "duration": 1227,
  "channel": {
    "name": "RTL4"
  },
  "rights": {
    "model": "AVOD",
    "audience": "DRM"
  },
  "rating": {
    "nicam": {
      "ageRecommendation": "AllAges",
      "reasons": []
    }
  },
  "id": "37f2e7ec-5a27-3084-981b-1f77bd06732d",
  "title": "RTL Nieuws - 19:30 uur",
  "synopsis": "Dagelijks het laatste nieuws uit binnen- en buitenland. Voor nog meer nieuws kunt u ook gebruikmaken van onze mobiele apps.",
  "assets": [
    {
      "id": "37f2e7ec-5a27-3084-981b-1f77bd06732d",
      "url": "https://api.rtl.nl/watch/play/api/play/xl/37f2e7ec-5a27-3084-981b-1f77bd06732d",
      "type": "Video"
    },
    {
      "id": "37f2e7ec-5a27-3084-981b-1f77bd06732d",
      "url": "https://covers.rtl.nl/cover/p/pc/37f2e7ec-5a27-3084-981b-1f77bd06732d",
      "type": "Cover"
    },
    {
      "id": "37f2e7ec-5a27-3084-981b-1f77bd06732d",
      "url": "https://covers.rtl.nl/cover/l/pc/37f2e7ec-5a27-3084-981b-1f77bd06732d",
      "type": "Poster"
    },
    {
      "id": "37f2e7ec-5a27-3084-981b-1f77bd06732d",
      "url": "https://screenshots.rtl.nl/screenshot/l/720x404/37f2e7ec-5a27-3084-981b-1f77bd06732d.jpg",
      "type": "Still"
    }
  ],
  "type": "Episode"
}

$ xidel -se 'parse-json(doc("'$url'")//script[@type="application/json"])//video/(assets)()[type="Video"]/request-combine(url,{"device":"web","format":"hls"})/url'
https://api.rtl.nl/watch/play/api/play/xl/37f2e7ec-5a27-3084-981b-1f77bd06732d?device=web&format=hls

$ xidel -se 'parse-json(doc("'$url'")//script[@type="application/json"])//video/(assets)()[type="Video"]/request-combine(url,{"device":"web","format":"hls"})/json-doc(url)'
{
  "id": "37f2e7ec-5a27-3084-981b-1f77bd06732d",
  "canPlay": false,
  "manifest": "https://cdn-rtlvod-h3.akamaized.net/7c21a9b6-2905-480f-bf4c-43421b20b5ca/37f2e7ec-5a27-3084-981b-1f77bd06732d.ism/manifest(format=m3u8-aapl,encryption=cbc,Filter=Quality).m3u8",
  "kid": "3de697d6-0e4c-415b-bc16-46549df7853f",
  "licenseUrl": "https://api.rtl.nl/watch/license/aes/?kid=3de697d6-0e4c-415b-bc16-46549df7853f",
  "error": {
    "code": "Entitlement",
    "description": "Only authorized users can access entitlement service (Unauthorized): Unauthorized"
  }
}

$ xidel -s --module=xivid.xqm -e 'parse-json(doc("'$url'")//script[@type="application/json"])//video/{"name":x"RTL: {series/title} - {title}","date":broadcastDateTime,"duration":duration * duration("PT1S"),"formats":xivid:m3u8-to-json((assets)()[type="Video"]/request-combine(url,{"device":"web","format":"hls"})/json-doc(url)/manifest)}'
{
  "name": "RTL: RTL Nieuws - RTL Nieuws - 19:30 uur",
  "date": "2021-01-15T18:30:00Z",
  "duration": "PT20M27S",
  "formats": [
    {
      "id": "hls-0",
      "format": "m3u8[manifest]",
      "url": "https://cdn-rtlvod-h3.akamaized.net/[...]/manifest(format=m3u8-aapl,encryption=cbc,Filter=Quality).m3u8"
    },
    {
      "id": "hls-1",
      "format": "m3u8[aac]",
      "url": "https://cdn-rtlvod-h3.akamaized.net/[...]/QualityLevels(125437)/Manifest(audioname,format=m3u8-aapl,filter=Quality,encryption=cbc)"
    },
    [...]
    {
      "id": "hls-7",
      "format": "m3u8[h264+aac]",
      "resolution": "1280x720",
      "bitrate": "4356kbps",
      "url": "https://cdn-rtlvod-h3.akamaized.net/[...]/QualityLevels(4121000)/Manifest(video,format=m3u8-aapl,filter=Quality,encryption=cbc)"
    }
  ]
}

------------------------------------------------------------------------------------------------

$ url=https://www.rtlnieuws.nl/video/uitzendingen/video/5208952/rtl-nieuws-1930-uur   # Hetzelfde RTL Nieuws van 15-01-2020 19:30)

$ xidel -se 'doc("'$url'")//div[@class="rtl-player__fallback-overlay"]/a/@href'
https://www.rtlxl.nl/video/37f2e7ec-5a27-3084-981b-1f77bd06732d

$ xidel -s --module=xivid.xqm -e 'parse-json(doc(if (contains("'$url'","rtlnieuws.nl")) then doc("'$url'")//div[@class="rtl-player__fallback-overlay"]/a/@href else "'$url'")//script[@type="application/json"])//video/{"name":x"RTL: {series/title} - {title}","date":broadcastDateTime,"duration":duration * duration("PT1S"),"formats":xivid:m3u8-to-json((assets)()[type="Video"]/request-combine(url,{"device":"web","format":"hls"})/json-doc(url)/manifest)}'
{
  "name": "RTL: RTL Nieuws - RTL Nieuws - 19:30 uur",
  "date": "2021-01-15T18:30:00Z",
  "duration": "PT20M27S",
  "formats": [...]
}

------------------------------------------------------------------------------------------------

$ url=https://www.rtl.nl/gemist?nodeId=5250814

$ xidel -se 'parse-json(doc("'$url'")//script/substring-after(.,"APOLLO_STATE__ = "))/*[__typename="Video"]/uuid'
52f257a9-0e61-3f33-b011-7fc1c338f77f

$ xidel -s --module=xivid.xqm -e 'parse-json(doc(if (contains("'$url'","rtlnieuws.nl")) then doc("'$url'")//div[@class="rtl-player__fallback-overlay"]/a/@href else if (contains("'$url'","rtl.nl")) then "https://www.rtlxl.nl/video/"||parse-json(doc("'$url'")//script/substring-after(.,"APOLLO_STATE__ = "))/*[__typename="Video"]/uuid else "'$url'")//script[@type="application/json"])//video/{"name":x"RTL: {series/title} - {title}","date":broadcastDateTime,"duration":duration * duration("PT1S"),"formats":xivid:m3u8-to-json((assets)()[type="Video"]/request-combine(url,{"device":"web","format":"hls"})/json-doc(url)/manifest)}'
{
  "name": "RTL: Ninja Warrior Australië - Afl. 6",
  "date": "2021-08-28T16:25:00Z",
  "duration": "PT1H12M24S",
  "formats": [
    {
      "id": "hls-0",
      "format": "m3u8[manifest]",
      "url": "https://cdn-rtlvod-h5.akamaized.net/[...]/manifest(format=m3u8-aapl,encryption=cbc,Filter=Quality).m3u8"
    },
    {
      "id": "hls-1",
      "format": "m3u8[aac]",
      "bitrate": "136kbps",
      "url": "https://cdn-rtlvod-h5.akamaized.net/[...]/QualityLevels(125436)/Manifest(audioname,format=m3u8-aapl,filter=Quality,encryption=cbc)"
    },
    [...]
    {
      "id": "hls-6",
      "format": "m3u8[h264+aac]",
      "resolution": "1280x720",
      "bitrate": "4407kbps",
      "url": "https://cdn-rtlvod-h5.akamaized.net/[...]/QualityLevels(4171000)/Manifest(video,format=m3u8-aapl,filter=Quality,encryption=cbc)"
    }
  ]
}
------------------------------------------------------------------------------------------------

declare function xivid:rtl($url as string) as object()? {
  parse-json(
    doc(
      if (contains($url,"rtlnieuws.nl")) then
        doc($url)//div[@class="rtl-player__fallback-overlay"]/a/@href
      else if (contains($url,"rtl.nl")) then
        "https://www.rtlxl.nl/video/"||parse-json(
          doc($url)//script/substring-after(.,"APOLLO_STATE__ = ")
        )/*[__typename="Video"]/uuid
      else
        $url
    )//script[@type="application/json"]
  )//video/{
    "name":x"RTL: {series/title} - {title}",
    "date":broadcastDateTime,
    "duration":duration * duration("PT1S"),
    "formats":xivid:m3u8-to-json(
      (assets)()[type="Video"]/request-combine(
        url,{"device":"web","format":"hls"}
      )/json-doc(url)/manifest
    )
  }
};

================================================================================================

[kijk]

$ url=https://www.kijk.nl/programmas/wegmisbruikers/C5IYffeeRR8/seizoen/122814504378/afleveringen/video/empty_episode-wegmisbruikers-s25-e10-2020-03-22/p6jYhd96olD

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

https://graph.kijk.nl/graphql   # "GraphQL Playground" in browser.

query {
  programs(guid: "p6jYhd96olD") {
    items{
      __typename,
      type,
      guid,
      title,
      duration,
      tvSeasonEpisodeNumber,
      seriesEpisodeNumber,
      seasonNumber,
      media{
        mediaContent{
          assetTypes,
          sourceUrl,
          type
        },
        availableDate,
        expirationDate,
        availabilityState
      },
      series{
        guid,
        title
      }
    }
  }
}

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

$ xidel -se 'concat("query{programs(guid:&quot;",extract("'$url'","\w+$"),"&quot;){items{__typename,type,guid,title,duration,tvSeasonEpisodeNumber,seriesEpisodeNumber,seasonNumber,media{mediaContent{assetTypes,sourceUrl,type},availableDate,expirationDate,availabilityState},series{guid,title}}}}")'
query{programs(guid:"p6jYhd96olD"){items{__typename,type,guid,title,duration,tvSeasonEpisodeNumber,seriesEpisodeNumber,seasonNumber,media{mediaContent{assetTypes,sourceUrl,type},availableDate,expirationDate,availabilityState},series{guid,title}}}}

$ xidel -se '"https://graph.kijk.nl/graphql?query="||uri-encode(concat("query{programs(guid:&quot;",extract("'$url'","\w+$"),"&quot;){items{__typename,type,guid,title,duration,tvSeasonEpisodeNumber,seriesEpisodeNumber,seasonNumber,media{mediaContent{assetTypes,sourceUrl,type},availableDate,expirationDate,availabilityState},series{guid,title}}}}"))'
https://graph.kijk.nl/graphql?query=query%7Bprograms%28guid%3A%22p6jYhd96olD%22%29%7Bitems%7B__typename%2Ctype%2Cguid%2Ctitle%2Cduration%2CtvSeasonEpisodeNumber%2CseriesEpisodeNumber%2CseasonNumber%2Cmedia%7BmediaContent%7BassetTypes%2CsourceUrl%2Ctype%7D%2CavailableDate%2CexpirationDate%2CavailabilityState%7D%2Cseries%7Bguid%2Ctitle%7D%7D%7D%7D

$ xidel -se 'x:request({"headers":"Accept: application/json","url":"https://graph.kijk.nl/graphql?query="||uri-encode(concat("query{programs(guid:&quot;",extract("'$url'","\w+$"),"&quot;){items{__typename,type,guid,title,duration,tvSeasonEpisodeNumber,seriesEpisodeNumber,seasonNumber,media{mediaContent{assetTypes,sourceUrl,type},availableDate,expirationDate,availabilityState},series{guid,title}}}}"))})/(json//items)()'
{
  "__typename": "Program",
  "type": "EPISODE",
  "guid": "p6jYhd96olD",
  "title": null,
  "duration": 2380.96,
  "tvSeasonEpisodeNumber": 10,
  "seriesEpisodeNumber": 434,
  "seasonNumber": 25,
  "media": [
    {
      "mediaContent": [
        {
          "assetTypes": ["Packager Output: MPEG DASH Manifest public"],
          "sourceUrl": "https://vod-kijk2-prod.talpatvcdn.nl/p6jYhd96olD/ffc9e6f7-f998-0b73-2838-eb18a27226e6/p6jYhd96olD-index.ism/p6jYhd96olD.mpd",
          "type": "dash"
        },
        {
          "assetTypes": ["Packager Output: Smooth Manifest public"],
          "sourceUrl": "https://vod-kijk2-prod.talpatvcdn.nl/p6jYhd96olD/ffc9e6f7-f998-0b73-2838-eb18a27226e6/p6jYhd96olD-index.ism/p6jYhd96olD.ismc",
          "type": "ism"
        },
        {
          "assetTypes": ["Packager Output: HLS Manifest public"],
          "sourceUrl": "https://vod-kijk2-prod.talpatvcdn.nl/p6jYhd96olD/ffc9e6f7-f998-0b73-2838-eb18a27226e6/p6jYhd96olD-index.ism/p6jYhd96olD.m3u8",
          "type": "m3u8"
        },
        {
          "assetTypes": ["Closed Caption: Nederlands"],
          "sourceUrl": "https://vod-kijk2-prod.talpatvcdn.nl/webvtt/772248E1.vtt",
          "type": "webvtt"
        },
        {
          "assetTypes": ["Closed Caption: Doven en Slechthorenden"],
          "sourceUrl": "https://vod-kijk2-prod.talpatvcdn.nl/webvtt/772248E1OPE.vtt",
          "type": "webvtt"
        }
      ],
      "availableDate": "1584905400000",
      "expirationDate": "1647980666000",
      "availabilityState": true
    }
  ],
  "series": {
    "guid": "C5IYffeeRR8",
    "title": "Wegmisbruikers"
  }
}

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

$ xidel -se '{"query":concat("query{programs(guid:&quot;",extract("'$url'","\w+$"),"&quot;){items{__typename,type,guid,title,duration,tvSeasonEpisodeNumber,seriesEpisodeNumber,seasonNumber,media{mediaContent{assetTypes,sourceUrl,type},availableDate,expirationDate,availabilityState},series{guid,title}}}}")}'
{
  "query": "query{programs(guid:\"p6jYhd96olD\"){items{__typename,type,guid,title,duration,tvSeasonEpisodeNumber,seriesEpisodeNumber,seasonNumber,media{mediaContent{assetTypes,sourceUrl,type},availableDate,expirationDate,availabilityState},series{guid,title}}}}"
}

$ xidel -se 'request-combine("https://graph.kijk.nl/graphql",{"query":concat("query{programs(guid:&quot;",extract("'$url'","\w+$"),"&quot;){items{__typename,type,guid,title,duration,tvSeasonEpisodeNumber,seriesEpisodeNumber,seasonNumber,media{mediaContent{assetTypes,sourceUrl,type},availableDate,expirationDate,availabilityState},series{guid,title}}}}")})'
{
  "url": "https://graph.kijk.nl/graphql?query=query%7Bprograms%28guid%3A%22p6jYhd96olD%22%29%7Bitems%7B__typename%2Ctype%2Cguid%2Ctitle%2Cduration%2CtvSeasonEpisodeNumber%2CseriesEpisodeNumber%2CseasonNumber%2Cmedia%7BmediaContent%7BassetTypes%2CsourceUrl%2Ctype%7D%2CavailableDate%2CexpirationDate%2CavailabilityState%7D%2Cseries%7Bguid%2Ctitle%7D%7D%7D%7D"
}

$ xidel -se 'x:request({"headers":"Accept: application/json","url":request-combine("https://graph.kijk.nl/graphql",{"query":concat("query{programs(guid:&quot;",extract("'$url'","\w+$"),"&quot;){items{__typename,type,guid,title,duration,tvSeasonEpisodeNumber,seriesEpisodeNumber,seasonNumber,media{mediaContent{assetTypes,sourceUrl,type},availableDate,expirationDate,availabilityState},series{guid,title}}}}")})/url})/(json//items)()'
{
  "__typename": "Program",
  "type": "EPISODE",
  "guid": "p6jYhd96olD",
  "title": null,
  "duration": 2380.96,
  "tvSeasonEpisodeNumber": 10,
  "seriesEpisodeNumber": 434,
  "seasonNumber": 25,
  "media": [
    {
      "mediaContent": [
        {
          "assetTypes": ["Packager Output: MPEG DASH Manifest public"],
          "sourceUrl": "https://vod-kijk2-prod.talpatvcdn.nl/p6jYhd96olD/ffc9e6f7-f998-0b73-2838-eb18a27226e6/p6jYhd96olD-index.ism/p6jYhd96olD.mpd",
          "type": "dash"
        },
        {
          "assetTypes": ["Packager Output: Smooth Manifest public"],
          "sourceUrl": "https://vod-kijk2-prod.talpatvcdn.nl/p6jYhd96olD/ffc9e6f7-f998-0b73-2838-eb18a27226e6/p6jYhd96olD-index.ism/p6jYhd96olD.ismc",
          "type": "ism"
        },
        {
          "assetTypes": ["Packager Output: HLS Manifest public"],
          "sourceUrl": "https://vod-kijk2-prod.talpatvcdn.nl/p6jYhd96olD/ffc9e6f7-f998-0b73-2838-eb18a27226e6/p6jYhd96olD-index.ism/p6jYhd96olD.m3u8",
          "type": "m3u8"
        },
        {
          "assetTypes": ["Closed Caption: Nederlands"],
          "sourceUrl": "https://vod-kijk2-prod.talpatvcdn.nl/webvtt/772248E1.vtt",
          "type": "webvtt"
        },
        {
          "assetTypes": ["Closed Caption: Doven en Slechthorenden"],
          "sourceUrl": "https://vod-kijk2-prod.talpatvcdn.nl/webvtt/772248E1OPE.vtt",
          "type": "webvtt"
        }
      ],
      "availableDate": "1584905400000",
      "expirationDate": "1647980666000",
      "availabilityState": true
    }
  ],
  "series": {
    "guid": "C5IYffeeRR8",
    "title": "Wegmisbruikers"
  }
}

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

$ xidel -s --module=xivid.xqm -e 'x:request({"headers":"Accept: application/json","url":request-combine("https://graph.kijk.nl/graphql",{"query":concat("query{programs(guid:&quot;",extract("'$url'","\w+$"),"&quot;){items{__typename,type,guid,title,duration,tvSeasonEpisodeNumber,seriesEpisodeNumber,seasonNumber,media{mediaContent{assetTypes,sourceUrl,type},availableDate,expirationDate,availabilityState},series{guid,title}}}}")})/url})/(json//items)()/{"name":concat("Kijk: ",series/title," S",format-integer(seasonNumber,"00"),"E",format-integer(tvSeasonEpisodeNumber,"00")),"date":.//availableDate div 1000 * duration("PT1S") + dateTime("1970-01-01T00:00:00Z"),"duration":round(duration) * duration("PT1S"),"expdate":.//expirationDate div 1000 * duration("PT1S") + dateTime("1970-01-01T00:00:00Z"),"formats":array{(.//mediaContent)()[type="webvtt"]/{"id":"sub-"||position(),"format":"vtt","language":"nl","label":substring((assetTypes)(),17),"url":sourceUrl},xivid:m3u8-to-json((.//mediaContent)()[type="m3u8"]/sourceUrl)()}}'
{
  "name": "Kijk: Wegmisbruikers S25E10",
  "date": "2020-03-22T19:30:00Z",
  "duration": "PT39M41S",
  "expdate": "2022-03-22T20:24:26Z",
  "formats": [
    {
      "id": "sub-1",
      "format": "vtt",
      "language": "nl",
      "label": "Nederlands",
      "url": "https://vod-kijk2-prod.talpatvcdn.nl/webvtt/772248E1.vtt"
    },
    {
      "id": "sub-2",
      "format": "vtt",
      "language": "nl",
      "label": "Doven en Slechthorenden",
      "url": "https://vod-kijk2-prod.talpatvcdn.nl/webvtt/772248E1OPE.vtt"
    },
    {
      "id": "hls-0",
      "format": "m3u8[manifest]",
      "url": "https://vod-kijk2-prod.talpatvcdn.nl/p6jYhd96olD/ffc9e6f7-f998-0b73-2838-eb18a27226e6/p6jYhd96olD-index.ism/p6jYhd96olD.m3u8"
    },
    {
      "id": "hls-1",
      "format": "m3u8[aac]",
      "bitrate": "160kbps",
      "url": "https://vod-kijk2-prod.talpatvcdn.nl/p6jYhd96olD/ffc9e6f7-f998-0b73-2838-eb18a27226e6/p6jYhd96olD-index.ism/p6jYhd96olD-index-audio=160000.m3u8"
    },
    [...]
    {
      "id": "hls-7",
      "format": "m3u8[h264+aac]",
      "resolution": "1920x1080@25fps",
      "bitrate": "6077|160kbps",
      "url": "https://vod-kijk2-prod.talpatvcdn.nl/p6jYhd96olD/ffc9e6f7-f998-0b73-2838-eb18a27226e6/p6jYhd96olD-index.ism/p6jYhd96olD-index-audio=160000-video=6077279.m3u8"
    }
  ]
}

------------------------------------------------------------------------------------------------

$ url=https://www.kijk.nl/films/video/bridge-of-spies/AgvoU4AJTpy

$ xidel -se 'x:request({"headers":"Accept: application/json","url":request-combine("https://graph.kijk.nl/graphql",{"query":concat("query{programs(guid:&quot;",extract("'$url'","\w+$"),"&quot;){items{__typename,type,guid,title,duration,tvSeasonEpisodeNumber,seriesEpisodeNumber,seasonNumber,media{mediaContent{assetTypes,sourceUrl,type},availableDate,expirationDate,availabilityState},series{guid,title}}}}")})/url})/(json//items)()'
{
  "__typename": "Program",
  "type": "MOVIE",
  "guid": "AgvoU4AJTpy",
  "title": "Bridge of Spies",
  "duration": 7677.88,
  "tvSeasonEpisodeNumber": null,
  "seriesEpisodeNumber": null,
  "seasonNumber": null,
  "media": [
    {
      "mediaContent": [
        {
          "assetTypes": ["Closed Caption: Nederlands"],
          "sourceUrl": "https://vod-kijk2-prod.talpatvcdn.nl/webvtt/708837E1.vtt",
          "type": "webvtt"
        },
        {
          "assetTypes": ["Packager Output: HLS Manifest public"],
          "sourceUrl": "https://vod-kijk2-prod.talpatvcdn.nl/AgvoU4AJTpy/43852cbb-df70-caae-d4e6-e0e9563057cd/AgvoU4AJTpy-index.ism/AgvoU4AJTpy.m3u8",
          "type": "m3u8"
        },
        {
          "assetTypes": ["Packager Output: Smooth Manifest public"],
          "sourceUrl": "https://vod-kijk2-prod.talpatvcdn.nl/AgvoU4AJTpy/43852cbb-df70-caae-d4e6-e0e9563057cd/AgvoU4AJTpy-index.ism/AgvoU4AJTpy.ismc",
          "type": "ism"
        },
        {
          "assetTypes": ["Packager Output: MPEG DASH Manifest public"],
          "sourceUrl": "https://vod-kijk2-prod.talpatvcdn.nl/AgvoU4AJTpy/43852cbb-df70-caae-d4e6-e0e9563057cd/AgvoU4AJTpy-index.ism/AgvoU4AJTpy.mpd",
          "type": "dash"
        }
      ],
      "availableDate": "1610749122000",
      "expirationDate": "1611353922000",
      "availabilityState": true
    }
  ],
  "series": null
}

$ xidel -s --module=xivid.xqm -e 'x:request({"headers":"Accept: application/json","url":request-combine("https://graph.kijk.nl/graphql",{"query":concat("query{programs(guid:&quot;",extract("'$url'","\w+$"),"&quot;){items{__typename,type,guid,title,duration,tvSeasonEpisodeNumber,seriesEpisodeNumber,seasonNumber,media{mediaContent{assetTypes,sourceUrl,type},availableDate,expirationDate,availabilityState},series{guid,title}}}}")})/url})/(json//items)()/{"name":concat("Kijk: ",(series/title,title),.[exists(seasonNumber)]/concat(" S",format-integer(seasonNumber,"00"),"E",format-integer(tvSeasonEpisodeNumber,"00"))),"date":.//availableDate div 1000 * duration("PT1S") + dateTime("1970-01-01T00:00:00Z"),"duration":round(duration) * duration("PT1S"),"expdate":.//expirationDate div 1000 * duration("PT1S") + dateTime("1970-01-01T00:00:00Z"),"formats":array{(.//mediaContent)()[type="webvtt"]/{"id":"sub-"||position(),"format":"vtt","language":"nl","label":substring((assetTypes)(),17),"url":sourceUrl},xivid:m3u8-to-json((.//mediaContent)()[type="m3u8"]/sourceUrl)()}}'
{
  "name": "Kijk: Bridge of Spies",
  "date": "2021-01-15T22:18:42Z",
  "duration": "PT2H7M58S",
  "expdate": "2021-01-22T22:18:42Z",
  "formats": [
    {
      "id": "sub-1",
      "format": "vtt",
      "language": "nl",
      "label": "Nederlands",
      "url": "https://vod-kijk2-prod.talpatvcdn.nl/webvtt/708837E1.vtt"
    },
    {
      "id": "hls-0",
      "format": "m3u8[manifest]",
      "url": "https://vod-kijk2-prod.talpatvcdn.nl/AgvoU4AJTpy/43852cbb-df70-caae-d4e6-e0e9563057cd/AgvoU4AJTpy-index.ism/AgvoU4AJTpy.m3u8"
    },
    {
      "id": "hls-1",
      "format": "m3u8[aac]",
      "bitrate": "160kbps",
      "url": "https://vod-kijk2-prod.talpatvcdn.nl/AgvoU4AJTpy/43852cbb-df70-caae-d4e6-e0e9563057cd/AgvoU4AJTpy-index.ism/AgvoU4AJTpy-index-audio=160000.m3u8"
    },
    [...]
    {
      "id": "hls-7",
      "format": "m3u8[h264+aac]",
      "resolution": "1920x1080@25fps",
      "bitrate": "6072|160kbps",
      "url": "https://vod-kijk2-prod.talpatvcdn.nl/AgvoU4AJTpy/43852cbb-df70-caae-d4e6-e0e9563057cd/AgvoU4AJTpy-index.ism/AgvoU4AJTpy-index-audio=160000-video=6072306.m3u8"
    }
  ]
}

------------------------------------------------------------------------------------------------

$ url=https://www.kijk.nl/films/video/gone-baby-gone/yOgHMQhZwkp   # Video met DRM.

$ xidel -se 'x:request({"headers":"Accept: application/json","url":request-combine("https://graph.kijk.nl/graphql",{"query":concat("query{programs(guid:&quot;",extract("'$url'","\w+$"),"&quot;){items{__typename,type,guid,title,duration,tvSeasonEpisodeNumber,seriesEpisodeNumber,seasonNumber,media{mediaContent{assetTypes,sourceUrl,type},availableDate,expirationDate,availabilityState},series{guid,title}}}}")})/url})/(json//items)()'
{
  "__typename": "Program",
  "type": "MOVIE",
  "guid": "yOgHMQhZwkp",
  "title": "Gone Baby Gone",
  "duration": 6262.56,
  "tvSeasonEpisodeNumber": null,
  "seriesEpisodeNumber": null,
  "seasonNumber": null,
  "media": [
    {
      "mediaContent": [
        {
          "assetTypes": ["Closed Caption: Nederlands"],
          "sourceUrl": "https://vod-kijk2-prod.talpatvcdn.nl/webvtt/260003E1.vtt",
          "type": "webvtt"
        },
        {
          "assetTypes": ["Packager Output: Smooth PlayReady Manifest"],
          "sourceUrl": "https://vod-kijk2-prod.talpatvcdn.nl/yOgHMQhZwkp/87e9e98d-7d21-a91b-2ccd-4e2f16377d11/yOgHMQhZwkp_1611142394009.ism/Manifest",
          "type": "ism"
        },
        {
          "assetTypes": ["Packager Output: HLS FairPlay Manifest"],
          "sourceUrl": "https://vod-kijk2-prod.talpatvcdn.nl/yOgHMQhZwkp/87e9e98d-7d21-a91b-2ccd-4e2f16377d11/yOgHMQhZwkp_1611142394009.ism/master.m3u8",
          "type": "m3u8"
        },
        {
          "assetTypes": ["Packager Output: MPEG DASH Widevine Manifest"],
          "sourceUrl": "https://vod-kijk2-prod.talpatvcdn.nl/yOgHMQhZwkp/87e9e98d-7d21-a91b-2ccd-4e2f16377d11/yOgHMQhZwkp_1611142394009.ism/index.mpd",
          "type": "dash"
        },
        {
          "assetTypes": ["Packager Output: DASH PlayReady Manifest"],
          "sourceUrl": "https://vod-kijk2-prod.talpatvcdn.nl/yOgHMQhZwkp/87e9e98d-7d21-a91b-2ccd-4e2f16377d11/yOgHMQhZwkp_1611142394009.ism/index.mpd",
          "type": "dash"
        }
      ],
      "availableDate": "1611084692000",
      "expirationDate": "1611697602000",
      "availabilityState": true
    }
  ],
  "series": null
}

$ xidel -s --module=xivid.xqm -e 'x:request({"headers":"Accept: application/json","url":request-combine("https://graph.kijk.nl/graphql",{"query":concat("query{programs(guid:&quot;",extract("'$url'","\w+$"),"&quot;){items{__typename,type,guid,title,duration,tvSeasonEpisodeNumber,seriesEpisodeNumber,seasonNumber,media{mediaContent{assetTypes,sourceUrl,type},availableDate,expirationDate,availabilityState},series{guid,title}}}}")})/url})/(json//items)()/{"name":concat("Kijk: ",(series/title,title),.[exists(seasonNumber)]/concat(" S",format-integer(seasonNumber,"00"),"E",format-integer(tvSeasonEpisodeNumber,"00"))),"date":.//availableDate div 1000 * duration("PT1S") + dateTime("1970-01-01T00:00:00Z"),"duration":round(duration) * duration("PT1S"),"expdate":.//expirationDate div 1000 * duration("PT1S") + dateTime("1970-01-01T00:00:00Z"),"formats":array{(.//mediaContent)()[type="webvtt"]/{"id":"sub-"||position(),"format":"vtt","language":"nl","label":substring((assetTypes)(),17),"url":sourceUrl},xivid:m3u8-to-json((.//mediaContent)()[type="m3u8" and ends-with((assetTypes)(),"public")]/sourceUrl)()}}'
{
  "name": "Kijk: Gone Baby Gone",
  "date": "2021-01-19T19:31:32Z",
  "duration": "PT1H44M23S",
  "expdate": "2021-01-26T21:46:42Z",
  "formats": [
    {
      "id": "sub-1",
      "format": "vtt",
      "language": "nl",
      "label": "Nederlands",
      "url": "https://vod-kijk2-prod.talpatvcdn.nl/webvtt/260003E1.vtt"
    }
  ]
}

------------------------------------------------------------------------------------------------

$ url=https://kijk.nl/programmas/mr-frank-visser-doet-uitspraak/ZMeF6bC3vW1/seizoen/188344360278/afleveringen/video/bezem-door-de-straat/7CFHn2lEXDW

$ xidel -se 'x:request({"headers":"Accept: application/json","url":request-combine("https://graph.kijk.nl/graphql",{"query":concat("query{programs(guid:&quot;",extract("'$url'","\w+$"),"&quot;){items{__typename,type,guid,title,duration,tvSeasonEpisodeNumber,seriesEpisodeNumber,seasonNumber,media{mediaContent{assetTypes,sourceUrl,type},availableDate,expirationDate,availabilityState},series{guid,title}}}}")})/url})/(json//items)()'
{
  "__typename": "Program",
  "type": "EPISODE",
  "guid": "7CFHn2lEXDW",
  "title": "Bezem door de straat",
  "duration": 2517.32,
  "tvSeasonEpisodeNumber": 3,
  "seriesEpisodeNumber": 106,
  "seasonNumber": 6,
  "media": [
    {
      "mediaContent": [
        {
          "assetTypes": ["Packager Output: MPEG DASH Manifest public"],
          "sourceUrl": "https://vod-nl.prd.talpatvcdn.nl/962fcfa7b0484656bf334e98d6624110/2cdfa1514ece4b428e9aeccee697d7ee/f35833b7b818457581c444ccf1a10fb7/index.mpd",
          "type": "dash"
        },
        {
          "assetTypes": ["Packager Output: HLS Manifest public"],
          "sourceUrl": "https://vod-nl.prd.talpatvcdn.nl/962fcfa7b0484656bf334e98d6624110/5fb4f1bcca634f7ebbeaa9eda36f2702/118d72f49ada4963a86a677fc4a7024a/index.m3u8",
          "type": "m3u8"
        },
        {
          "assetTypes": ["Packager Output: Smooth Manifest public"],
          "sourceUrl": "https://vod-nl.prd.talpatvcdn.nl/962fcfa7b0484656bf334e98d6624110/d4f12e9f8d4d4f839f2db87a426a9260/91da1977fd6840e3ab30a620d3021eeb/index.ism/Manifest",
          "type": "ism"
        },
        {
          "assetTypes": ["Closed Caption: Doven en Slechthorenden"],
          "sourceUrl": "https://vod-kijk2-prod.talpatvcdn.nl/webvtt/806141E1OPE.vtt",
          "type": "webvtt"
        },
        {
          "assetTypes": ["Closed Caption: Nederlands"],
          "sourceUrl": "https://vod-kijk2-prod.talpatvcdn.nl/webvtt/806141E1.vtt",
          "type": "webvtt"
        }
      ],
      "availableDate": "1616708064000",
      "expirationDate": "1774474464000",
      "availabilityState": true
    }
  ],
  "series": {
    "guid": "ZMeF6bC3vW1",
    "title": "Mr. Frank Visser doet uitspraak"
  }
}

$ xidel -s --module=xivid.xqm -e 'x:request({"headers":"Accept: application/json","url":request-combine("https://graph.kijk.nl/graphql",{"query":concat("query{programs(guid:&quot;",extract("'$url'","\w+$"),"&quot;){items{__typename,type,guid,title,duration,tvSeasonEpisodeNumber,seriesEpisodeNumber,seasonNumber,media{mediaContent{assetTypes,sourceUrl,type},availableDate,expirationDate,availabilityState},series{guid,title}}}}")})/url})/(json//items)()/{"name":concat("Kijk: ",join((series/title,title)," - "),.[exists(seasonNumber)]/concat(" S",format-integer(seasonNumber,"00"),"E",format-integer(tvSeasonEpisodeNumber,"00"))),"date":.//availableDate div 1000 * duration("PT1S") + dateTime("1970-01-01T00:00:00Z"),"duration":round(duration) * duration("PT1S"),"expdate":.//expirationDate div 1000 * duration("PT1S") + dateTime("1970-01-01T00:00:00Z"),"formats":array{for $x at $i in (.//mediaContent)()[type="webvtt"] order by $x/sourceUrl count $i return $x/{"id":"sub-"||$i,"format":"vtt","language":"nl","label":substring((assetTypes)(),17),"url":sourceUrl},xivid:m3u8-to-json((.//mediaContent)()[type="m3u8" and ends-with((assetTypes)(),"public")]/sourceUrl)()}}'
{
  "name": "Kijk: Mr. Frank Visser doet uitspraak - Bezem door de straat S06E03",
  "date": "2021-03-25T21:34:24Z",
  "duration": "PT41M57S",
  "expdate": "2026-03-25T21:34:24Z",
  "formats": [
    {
      "id": "sub-1",
      "format": "vtt",
      "language": "nl",
      "label": "Nederlands",
      "url": "https://vod-kijk2-prod.talpatvcdn.nl/webvtt/806141E1.vtt"
    },
    {
      "id": "sub-2",
      "format": "vtt",
      "language": "nl",
      "label": "Doven en Slechthorenden",
      "url": "https://vod-kijk2-prod.talpatvcdn.nl/webvtt/806141E1OPE.vtt"
    },
    {
      "id": "hls-0",
      "format": "m3u8[manifest]",
      "url": "https://vod-nl.prd.talpatvcdn.nl/[...]/index.m3u8"
    },
    {
      "id": "hls-1",
      "format": "m3u8[h264+aac]",
      "resolution": "448x252@25fps",
      "bitrate": "507kbps",
      "url": "https://vod-nl.prd.talpatvcdn.nl/[...]/index_6.m3u8"
    },
    [...]
    {
      "id": "hls-6",
      "format": "m3u8[h264+aac]",
      "resolution": "1920x1080@25fps",
      "bitrate": "6776kbps",
      "url": "https://vod-nl.prd.talpatvcdn.nl/[...]/index_1.m3u8"
    }
  ]
}
------------------------------------------------------------------------------------------------

declare function xivid:kijk($url as string) as object()? {
  x:request({
    "headers":"Accept: application/json",
    "url":request-combine(
      "https://graph.kijk.nl/graphql",
      {
        "query":concat(
          "query{programs(guid:&quot;",
          extract($url,"\w+$"),
          "&quot;){items{__typename,type,guid,title,duration,tvSeasonEpisodeNumber,",
          "seriesEpisodeNumber,seasonNumber,media{mediaContent{assetTypes,sourceUrl,",
          "type},availableDate,expirationDate,availabilityState},series{guid,title}}}}"
        )
      }
    )/url
  })/(json//items)()/{
    "name":concat(
      "Kijk: ",
      join((series/title,title)," - "),
      .[exists(seasonNumber)]/concat(
        " S",
        format-integer(seasonNumber,"00"),
        "E",
        format-integer(tvSeasonEpisodeNumber,"00")
      )
    ),
    "date":.//availableDate div 1000 *
      duration("PT1S") + dateTime("1970-01-01T00:00:00Z"),
    "duration":round(duration) * duration("PT1S"),
    "expdate":.//expirationDate div 1000 *
      duration("PT1S") + dateTime("1970-01-01T00:00:00Z"),
    "formats":array{
      for $x at $i in (.//mediaContent)()[type="webvtt"]
      order by $x/sourceUrl
      count $i
      return
      $x/{
        "id":"sub-"||$i,
        "format":"vtt",
        "language":"nl",
        "label":substring((assetTypes)(),17),
        "url":sourceUrl
      },
      xivid:m3u8-to-json(
        (.//mediaContent)()[type="m3u8" and ends-with((assetTypes)(),"public")]/sourceUrl
      )()
    }
  }
};

================================================================================================

[tvblik,uitzendinggemist]

$ xidel -se '
  for $x in (
    "https://tvblik.nl/nos-journaal/21-augustus-2020",
    "https://tvblik.nl/rtl-nieuws/0630-uur-545",
    "https://tvblik.nl/hart-van-nederland/21-augustus-2020"
  ) return
  doc($x)//div[@id="embed-player"]/(@data-episode,a/@href)
'
//www.npostart.nl/embed/nos-journaal/21-08-2020/POW_04508799
http://www.rtlxl.nl/#!/_rtl-nieuws-132237/c061ef9a-1fb9-356d-87b0-df9ca473ca7c?utm_medium=refferal&utm_source=tvblik
//embed.kijk.nl/?width=640&height=360&video=rik02l1H0Fl&autoplay=1

$ xidel -se '
  for $x in (
    "https://www.uitzendinggemist.net/aflevering/526238/Nos_Journaal.html",
    "https://www.uitzendinggemist.net/aflevering/526267/Rtl_Nieuws_1930_Uur.html",
    "https://www.uitzendinggemist.net/aflevering/521164/Hart_Van_Nederland.html"
  ) return
  doc($x)//(div[@class="video_thumb"]//@onclick,iframe[@class="sbsEmbed"]/@src)
'
window.open('http://www.npo.nl/aa-aa/01-01-2015/POW_04508799','winname',"directories=0,titlebar=0,toolbar=0,location=0,status=0,menubar=0,scrollbars=yes,resizable=no,width=760,height=600");
window.open('http://www.rtlxl.nl/#!/zzzz/7b0ef07f-359f-3c3c-a784-47398a3dab25','winname',"directories=0,titlebar=0,toolbar=0,location=0,status=0,menubar=0,scrollbars=yes,resizable=no,width=840,height=600");
https://embed.kijk.nl/?width=720&height=410&video=NFH6Mbjln35

$ xidel -se '
  for $x in (
    "https://tvblik.nl/nos-journaal/21-augustus-2020",
    "https://tvblik.nl/rtl-nieuws/0630-uur-545",
    "https://tvblik.nl/hart-van-nederland/21-augustus-2020",
    "https://www.uitzendinggemist.net/aflevering/526238/Nos_Journaal.html",
    "https://www.uitzendinggemist.net/aflevering/526267/Rtl_Nieuws_1930_Uur.html",
    "https://www.uitzendinggemist.net/aflevering/521164/Hart_Van_Nederland.html"
  ) return
  join(
    extract(
      doc($x)//(
        div[@id="embed-player"]/(@data-episode,a/@href),
        div[@class="video_thumb"]//@onclick,
        iframe[@class="sbsEmbed"]/@src
      ),
      "(npo|rtl|kijk).+(?:/|video=)([\w-]+)",(1,2)
    )
  )
'
npo POW_04508799
rtl c061ef9a-1fb9-356d-87b0-df9ca473ca7c
kijk rik02l1H0Fl
npo POW_04508799
rtl 7b0ef07f-359f-3c3c-a784-47398a3dab25
kijk NFH6Mbjln35

$ xidel -se '
  for $x in (
    "https://tvblik.nl/nos-journaal/21-augustus-2020",
    "https://tvblik.nl/rtl-nieuws/0630-uur-545",
    "https://tvblik.nl/hart-van-nederland/21-augustus-2020",
    "https://www.uitzendinggemist.net/aflevering/526238/Nos_Journaal.html",
    "https://www.uitzendinggemist.net/aflevering/526267/Rtl_Nieuws_1930_Uur.html",
    "https://www.uitzendinggemist.net/aflevering/521164/Hart_Van_Nederland.html"
  )
  let $host:=extract(
    doc($x)//(
      div[@id="embed-player"]/(@data-episode,a/@href),
      div[@class="video_thumb"]//@onclick,
      iframe[@class="sbsEmbed"]/@src
    ),
    "(npo|rtl|kijk).+(?:/|video=)([\w-]+)",(1,2)
  )
  return
  if ($host[1]="npo") then
    "xivid:npo(""https://www.npostart.nl/"||$host[2]||""")"
  else if ($host[1]="rtl") then
    "xivid:rtl(""https://www.rtlxl.nl/video/"||$host[2]||""")"
  else
    "xivid:kijk(""https://kijk.nl/video/"||$host[2]||""")"
'
xivid:npo("https://www.npostart.nl/POW_04508799")
xivid:rtl("https://www.rtlxl.nl/video/c061ef9a-1fb9-356d-87b0-df9ca473ca7c")
xivid:kijk("https://kijk.nl/video/rik02l1H0Fl")
xivid:npo("https://www.npostart.nl/POW_04508799")
xivid:rtl("https://www.rtlxl.nl/video/7b0ef07f-359f-3c3c-a784-47398a3dab25")
xivid:kijk("https://kijk.nl/video/NFH6Mbjln35")

------------------------------------------------------------------------------------------------

declare function xivid:tvblik($url as string) as object()? {
  let $host:=extract(
    doc($url)//(
      div[@id="embed-player"]/(@data-episode,a/@href),
      div[@class="video_thumb"]//@onclick,
      iframe[@class="sbsEmbed"]/@src
    ),
    "(npo|rtl|kijk).+(?:/|video=)([\w-]+)",(1,2)
  ) return
  if ($host[1]="npo") then
    xivid:npo("https://www.npostart.nl/"||$host[2])
  else if ($host[1]="rtl") then
    xivid:rtl("https://www.rtlxl.nl/video/"||$host[2])
  else
    xivid:kijk("https://kijk.nl/video/"||$host[2])
};

================================================================================================

[youtube]

$ url=https://www.youtube.com/watch?v=nG_LtCRRZ20   # Normaal toegankelijke video.

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

$ xidel -s -H "Cookie: YES+cb.20210518-05-p0.nl+F+224" "https://www.youtube.com/watch?v=nG_LtCRRZ20" -e 'parse-json(//script/extract(.,"ytInitialPlayerResponse = (.+);",1)[.])'

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

API call met een JSON met alle info als resultaat:

$ xidel -se '{"context":{"client":{"clientName":"WEB","clientVersion":"2.20210520.09.00"}},"videoId":extract("'$url'","\w+$")}'   # Werkt ook voor "https://youtu.be/nG_LtCRRZ20".
{
  "context": {
    "client": {
      "clientName": "WEB",
      "clientVersion": "2.20210520.09.00"
    }
  },
  "videoId": "nG_LtCRRZ20"
}

$ xidel -se 'x:request({"headers":"Content-Type: application/json","post":serialize({"context":{"client":{"clientName":"WEB","clientVersion":"2.20210520.09.00"}},"videoId":extract("'$url'","\w+$")},{"method":"json"}),"url":request-combine("https://www.youtube.com/youtubei/v1/player",{"key":"AIzaSyAO_FJ2SlqU8Q4STEHLGCilw_Y9_11qcW8"})/url})/json'

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

$ xidel -se 'x:request({"headers":"Content-Type: application/json","post":serialize({"context":{"client":{"clientName":"WEB","clientVersion":"2.20210520.09.00"}},"videoId":extract("'$url'","\w+$")},{"method":"json"}),"url":request-combine("https://www.youtube.com/youtubei/v1/player",{"key":"AIzaSyAO_FJ2SlqU8Q4STEHLGCilw_Y9_11qcW8"})/url})/json/(videoDetails,microformat/playerMicroformatRenderer)'
{
  "videoId": "nG_LtCRRZ20",
  "title": "Delta Impuls 2 - Delta Impuls 3 (regionale 1e klasse tafeltennis, 18-01-2019)",
  "lengthSeconds": "1093",
  [...]
}
{
  [...]
  "publishDate": "2019-02-01",
  "ownerChannelName": "Delta Impuls",
  "uploadDate": "2019-02-01"
}

$ xidel -se 'x:request({"headers":"Content-Type: application/json","post":serialize({"context":{"client":{"clientName":"WEB","clientVersion":"2.20210520.09.00"}},"videoId":extract("'$url'","\w+$")},{"method":"json"}),"url":request-combine("https://www.youtube.com/youtubei/v1/player",{"key":"AIzaSyAO_FJ2SlqU8Q4STEHLGCilw_Y9_11qcW8"})/url})/json/{"name":videoDetails/title,"date":dateTime(microformat/playerMicroformatRenderer/uploadDate||"T00:00:00Z"),"duration":videoDetails/lengthSeconds * duration("PT1S")}'
{
  "name": "Delta Impuls 2 - Delta Impuls 3 (regionale 1e klasse tafeltennis, 18-01-2019)",
  "date": "2019-02-01T00:00:00Z",
  "duration": "PT18M13S"
}

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

$ xidel -se 'x:request({"headers":"Content-Type: application/json","post":serialize({"context":{"client":{"clientName":"WEB","clientVersion":"2.20210520.09.00"}},"videoId":extract("'$url'","\w+$")},{"method":"json"}),"url":request-combine("https://www.youtube.com/youtubei/v1/player",{"key":"AIzaSyAO_FJ2SlqU8Q4STEHLGCilw_Y9_11qcW8"})/url})/json/streamingData'
{
  "expiresInSeconds": "21540",
  "formats": [
    {
      "itag": 18,
      "url": "https://r6---sn-mn4vg5aa-5hns.googlevideo.com/videoplayback?[...]itag=18[...]",
      "mimeType": "video/mp4; codecs=\"avc1.42001E, mp4a.40.2\"",
      "bitrate": 488787,
      "width": 640,
      "height": 360,
      "lastModified": "1548978609684393",
      "contentLength": "66756108",
      "quality": "medium",
      "fps": 25,
      "qualityLabel": "360p",
      "projectionType": "RECTANGULAR",
      "averageBitrate": 488759,
      "audioQuality": "AUDIO_QUALITY_LOW",
      "approxDurationMs": "1092661",
      "audioSampleRate": "44100",
      "audioChannels": 2
    },
    {
      "itag": 22,
      "url": "https://r6---sn-mn4vg5aa-5hns.googlevideo.com/videoplayback?[...]itag=22[...]",
      "mimeType": "video/mp4; codecs=\"avc1.64001F, mp4a.40.2\"",
      "bitrate": 1602845,
      "width": 1280,
      "height": 720,
      "lastModified": "1548979118812685",
      "quality": "hd720",
      "fps": 25,
      "qualityLabel": "720p",
      "projectionType": "RECTANGULAR",
      "audioQuality": "AUDIO_QUALITY_MEDIUM",
      "approxDurationMs": "1092638",
      "audioSampleRate": "44100",
      "audioChannels": 2
    }
  ],
  "adaptiveFormats": [
    {
      "itag": 136,
      "url": "https://r6---sn-mn4vg5aa-5hns.googlevideo.com/videoplayback?[...]itag=136[...]",
      "mimeType": "video/mp4; codecs=\"avc1.4d4016\"",
      "bitrate": 2310000,
      "width": 1280,
      "height": 720,
      "lastModified": "1548978905736975",
      "quality": "hd720",
      "fps": 25,
      "qualityLabel": "720p",
      "projectionType": "RECTANGULAR",
      "type": "FORMAT_STREAM_TYPE_OTF"
    },
    [...]
    {
      "itag": 251,
      "url": "https://r6---sn-mn4vg5aa-5hns.googlevideo.com/videoplayback?[...]itag=251[...]",
      "mimeType": "audio/webm; codecs=\"opus\"",
      "bitrate": 134216,
      "initRange": {
        "start": "0",
        "end": "258"
      },
      "indexRange": {
        "start": "259",
        "end": "2128"
      },
      "lastModified": "1564567160627721",
      "contentLength": "16950765",
      "quality": "tiny",
      "projectionType": "RECTANGULAR",
      "averageBitrate": 124106,
      "audioQuality": "AUDIO_QUALITY_MEDIUM",
      "approxDurationMs": "1092661",
      "audioSampleRate": "48000",
      "audioChannels": 2
    }
  ],
  "dashManifestUrl": "https://manifest.googlevideo.com/api/manifest/dash/[...]"
}

De progressive videostreams:

$ xidel -se 'x:request({"headers":"Content-Type: application/json","post":serialize({"context":{"client":{"clientName":"WEB","clientVersion":"2.20210520.09.00"}},"videoId":extract("'$url'","\w+$")},{"method":"json"}),"url":request-combine("https://www.youtube.com/youtubei/v1/player",{"key":"AIzaSyAO_FJ2SlqU8Q4STEHLGCilw_Y9_11qcW8"})/url})/json/streamingData/(formats)()/(let $mt:=tokenize(mimeType,";"),$c:=tokenize(extract($mt[2],"&quot;(.+)&quot;",1),", ") ! tokenize(.,"\.")[1] return join((substring-after($mt[1],"/"),$c)))'
mp4 avc1 mp4a
mp4 avc1 mp4a

$ xidel -se 'x:request({"headers":"Content-Type: application/json","post":serialize({"context":{"client":{"clientName":"WEB","clientVersion":"2.20210520.09.00"}},"videoId":extract("'$url'","\w+$")},{"method":"json"}),"url":request-combine("https://www.youtube.com/youtubei/v1/player",{"key":"AIzaSyAO_FJ2SlqU8Q4STEHLGCilw_Y9_11qcW8"})/url})/json/streamingData/(for $x at $i in (formats)() order by $x/width count $i return {"id":"pg-"||$i,"format":let $mt:=tokenize($x/mimeType,";"),$c:=tokenize(extract($mt[2],"&quot;(.+)&quot;",1),", ") ! tokenize(.,"\.")[1] return concat(substring-after($mt[1],"/"),"[",if ($c[1]="avc1") then "h264" else $c[1],"+",if ($c[2]="mp4a") then "aac" else $c[2],"]"),"resolution":concat($x/width,"x",$x/height,"@",$x/fps,"fps"),"bitrate":concat(round($x/bitrate div 1000),"kbps"),"url":$x/url})'
{
  "id": "pg-1",
  "format": "mp4[h264+aac]",
  "resolution": "640x360@25fps",
  "bitrate": "489kbps",
  "url": "https://r6---sn-mn4vg5aa-5hns.googlevideo.com/videoplayback?[...]itag=18[...]"
}
{
  "id": "pg-2",
  "format": "mp4[h264+aac]",
  "resolution": "1280x720@25fps",
  "bitrate": "1603kbps",
  "url": "https://r6---sn-mn4vg5aa-5hns.googlevideo.com/videoplayback?[...]itag=22[...]"
}

De adaptive videostreams:

$ xidel -se 'x:request({"headers":"Content-Type: application/json","post":serialize({"context":{"client":{"clientName":"WEB","clientVersion":"2.20210520.09.00"}},"videoId":extract("'$url'","\w+$")},{"method":"json"}),"url":request-combine("https://www.youtube.com/youtubei/v1/player",{"key":"AIzaSyAO_FJ2SlqU8Q4STEHLGCilw_Y9_11qcW8"})/url})/json/streamingData/(adaptiveFormats)()/(let $mt:=tokenize(mimeType,";"),$c:=extract($mt[2],"&quot;(\w+)",1) return join((substring-after($mt[1],"/"),$c)))'
mp4 avc1
webm vp9
[...]
webm opus

$ xidel -se 'x:request({"headers":"Content-Type: application/json","post":serialize({"context":{"client":{"clientName":"WEB","clientVersion":"2.20210520.09.00"}},"videoId":extract("'$url'","\w+$")},{"method":"json"}),"url":request-combine("https://www.youtube.com/youtubei/v1/player",{"key":"AIzaSyAO_FJ2SlqU8Q4STEHLGCilw_Y9_11qcW8"})/url})/json/streamingData/(for $x at $i in (adaptiveFormats)() order by boolean($x/width),$x/bitrate count $i return {"id":"dash-"||$i,"format":let $mt:=tokenize($x/mimeType,";"),$c:=extract($mt[2],"&quot;(\w+)",1) return concat(substring-after($mt[1],"/"),"[",if ($c="avc1") then "h264" else if ($c="mp4a") then "aac" else $c,"]"),"resolution"?:$x/width ! concat(.,"x",$x/height,"@",$x/fps,"fps"),"samplerate"?:$x/audioSampleRate ! concat(. div 1000,"kHz"),"bitrate":round($x/bitrate div 1000)||"kbps","url":$x/url})'
{
  "id": "dash-1",
  "format": "mp4[aac]",
  "samplerate": "44.1kHz",
  "bitrate": "131kbps",
  "url": "https://r6---sn-mn4vg5aa-5hns.googlevideo.com/videoplayback?[...]itag=140[...]"
}
{
  "id": "dash-2",
  "format": "webm[opus]",
  "samplerate": "48kHz",
  "bitrate": "134kbps",
  "url": "https://r6---sn-mn4vg5aa-5hns.googlevideo.com/videoplayback?[...]itag=251[...]"
}
[...]
{
  "id": "dash-14",
  "format": "mp4[h264]",
  "resolution": "1280x720@50fps",
  "bitrate": "2866kbps",
  "url": "https://r6---sn-mn4vg5aa-5hns.googlevideo.com/videoplayback?[...]itag=298[...]"
}

De meeste van deze urls blijken echter helemaal niet te werken:

$ xidel -se 'for $x in x:request({"headers":"Content-Type: application/json","post":serialize({"context":{"client":{"clientName":"WEB","clientVersion":"2.20210520.09.00"}},"videoId":extract("'$url'","\w+$")},{"method":"json"}),"url":request-combine("https://www.youtube.com/youtubei/v1/player",{"key":"AIzaSyAO_FJ2SlqU8Q4STEHLGCilw_Y9_11qcW8"})/url})/json/streamingData/(adaptiveFormats)() order by boolean($x/width),$x/bitrate return join(("itag="||$x/itag,let $mt:=tokenize($x/mimeType,";"),$c:=extract($mt[2],"&quot;(\w+)",1) return concat(substring-after($mt[1],"/"),"[",if ($c="avc1") then "h264" else if ($c="mp4a") then "aac" else $c,"]"),$x/audioSampleRate ! concat(. div 1000,"kHz"),$x/width ! concat(.,"x",$x/height,"@",$x/fps,"fps"),round($x/bitrate div 1000)||"kbps",x:request({"method":"HEAD","error-handling":"xxx=accept","url":$x/url})/headers[1]))'
itag=140 mp4[aac] 44.1kHz 131kbps HTTP/1.1 200 OK
itag=251 webm[opus] 48kHz 134kbps HTTP/1.1 200 OK
itag=278 webm[vp9] 256x144@25fps 95kbps HTTP/1.1 404 Not Found
itag=160 mp4[h264] 256x144@25fps 108kbps HTTP/1.1 404 Not Found
itag=242 webm[vp9] 426x240@25fps 221kbps HTTP/1.1 404 Not Found
itag=133 mp4[h264] 426x240@25fps 242kbps HTTP/1.1 404 Not Found
itag=243 webm[vp9] 640x360@25fps 406kbps HTTP/1.1 404 Not Found
itag=134 mp4[h264] 640x360@25fps 613kbps HTTP/1.1 200 OK
itag=244 webm[vp9] 854x480@25fps 753kbps HTTP/1.1 404 Not Found
itag=135 mp4[h264] 854x480@25fps 1155kbps HTTP/1.1 404 Not Found
itag=247 webm[vp9] 1280x720@25fps 1505kbps HTTP/1.1 404 Not Found
itag=136 mp4[h264] 1280x720@25fps 2310kbps HTTP/1.1 404 Not Found
itag=302 webm[vp9] 1280x720@50fps 2646kbps HTTP/1.1 404 Not Found
itag=298 mp4[h264] 1280x720@50fps 2866kbps HTTP/1.1 200 OK

Bij het DASH manifest hetzelfde verhaal:

$ xidel -se 'for $x in x:request({"headers":"Content-Type: application/json","post":serialize({"context":{"client":{"clientName":"WEB","clientVersion":"2.20210520.09.00"}},"videoId":extract("'$url'","\w+$")},{"method":"json"}),"url":request-combine("https://www.youtube.com/youtubei/v1/player",{"key":"AIzaSyAO_FJ2SlqU8Q4STEHLGCilw_Y9_11qcW8"})/url})/json/streamingData/doc(dashManifestUrl)//Representation order by boolean($x/@width),$x/@bandwidth return join(("itag/"||$x/@id,concat(substring-after($x/../@mimeType,"/"),"[",tokenize($x/@codecs,"\.")[1] ! (if (.="mp4a") then "aac" else if (.="avc1") then "h264" else .),"]"),$x/@audioSamplingRate ! concat(. div 1000,"kHz"),$x/@width ! concat(.,"x",$x/@height,"@",$x/@frameRate,"fps"),round($x/@bandwidth div 1000)||"kbps",x:request({"method":"HEAD","error-handling":"xxx=accept","url":$x/BaseUrl})/headers[1]))'
itag/139 mp4[aac] 22.05kHz 51kbps HTTP/1.1 200 OK
itag/140 mp4[aac] 44.1kHz 131kbps HTTP/1.1 200 OK
itag/251 webm[opus] 48kHz 134kbps HTTP/1.1 200 OK
itag/278 webm[vp9] 256x144@25fps 95kbps HTTP/1.1 404 Not Found
itag/160 mp4[h264] 256x144@25fps 108kbps HTTP/1.1 404 Not Found
itag/242 webm[vp9] 426x240@25fps 221kbps HTTP/1.1 404 Not Found
itag/133 mp4[h264] 426x240@25fps 242kbps HTTP/1.1 404 Not Found
itag/243 webm[vp9] 640x360@25fps 406kbps HTTP/1.1 404 Not Found
itag/134 mp4[h264] 640x360@25fps 613kbps HTTP/1.1 200 OK
itag/244 webm[vp9] 854x480@25fps 753kbps HTTP/1.1 404 Not Found
itag/135 mp4[h264] 854x480@25fps 1155kbps HTTP/1.1 404 Not Found
itag/247 webm[vp9] 1280x720@25fps 1505kbps HTTP/1.1 404 Not Found
itag/136 mp4[h264] 1280x720@25fps 2310kbps HTTP/1.1 404 Not Found
itag/302 webm[vp9] 1280x720@50fps 2646kbps HTTP/1.1 404 Not Found
itag/298 mp4[h264] 1280x720@50fps 2866kbps HTTP/1.1 200 OK

Het is wel vreemd dat de urls van de videostreams met itag 134 en 298 wél beschikbaar zijn en de rest niet. Ik houd me aanbevolen als iemand daar een verklaring voor heeft.

Bij youtube-dl ook hetzelfde verhaal:

$ youtube-dl -v -f 136 https://www.youtube.com/watch?v=nG_LtCRRZ20
[...]
[debug] Invoking downloader on 'https://manifest.googlevideo.com/api/manifest/dash/[...]'
[dashsegments] Total fragments: 215
[download] Destination: Delta Impuls 2 - Delta Impuls 3 (regionale 1e klasse tafeltennis, 18-01-2019)-nG_LtCRRZ20.mp4

$ youtube-dl -v -f 136 --youtube-skip-dash-manifest https://www.youtube.com/watch?v=nG_LtCRRZ20
ERROR: requested format not available
Traceback (most recent call last):
  File "C:\[...]\YoutubeDL.py", line 815, in wrapper
  File "C:\[...]\YoutubeDL.py", line 847, in __extract_info
  File "C:\[...]\YoutubeDL.py", line 881, in process_ie_result
  File "C:\[...]\YoutubeDL.py", line 1684, in process_video_result
youtube_dl.utils.ExtractorError: requested format not available

Youtube-dl raadpleegt zonder "--youtube-skip-dash-manifest" altijd het DASH manifest voor de desbetreffende stream.
Met "--youtube-skip-dash-manifest" probeert het de url uit de "adaptiveFormats"-array te downloaden, wat dus ook hier mislukt.

FFmpeg kan met het DASH manifest wel alle videostreams openen, dus alleen die dan maar.

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

$ xidel -se 'x:request({"headers":"Content-Type: application/json","post":serialize({"context":{"client":{"clientName":"WEB","clientVersion":"2.20210520.09.00"}},"videoId":extract("'$url'","\w+$")},{"method":"json"}),"url":request-combine("https://www.youtube.com/youtubei/v1/player",{"key":"AIzaSyAO_FJ2SlqU8Q4STEHLGCilw_Y9_11qcW8"})/url})/json/{"name":videoDetails/title,"date":dateTime(microformat/playerMicroformatRenderer/uploadDate||"T00:00:00Z"),"duration":videoDetails/lengthSeconds * duration("PT1S"),"formats":streamingData/array{for $x at $i in (formats)() order by $x/width count $i return {"id":"pg-"||$i,"format":let $mt:=tokenize($x/mimeType,";"),$c:=tokenize(extract($mt[2],"&quot;(.+)&quot;",1),", ") ! tokenize(.,"\.")[1] return concat(substring-after($mt[1],"/"),"[",if ($c[1]="avc1") then "h264" else $c[1],"+",if ($c[2]="mp4a") then "aac" else $c[2],"]"),"resolution":concat($x/width,"x",$x/height,"@",$x/fps,"fps"),"bitrate":concat(round($x/bitrate div 1000),"kbps"),"url":$x/url},{"id":"dash-0","format":"mpd[manifest]","url":dashManifestUrl}[url]}}'
{
  "name": "Delta Impuls 2 - Delta Impuls 3 (regionale 1e klasse tafeltennis, 18-01-2019)",
  "date": "2019-02-01T00:00:00Z",
  "duration": "PT18M13S",
  "formats": [
    {
      "id": "pg-1",
      "format": "mp4[h264+aac]",
      "resolution": "640x360@25fps",
      "bitrate": "489kbps",
      "url": "https://r6---sn-mn4vg5aa-5hns.googlevideo.com/videoplayback?[...]itag=18[...]"
    },
    {
      "id": "pg-2",
      "format": "mp4[h264+aac]",
      "resolution": "1280x720@25fps",
      "bitrate": "1603kbps",
      "url": "https://r6---sn-mn4vg5aa-5hns.googlevideo.com/videoplayback?[...]itag=22[...]"
    },
    {
      "id": "dash-0",
      "format": "mpd[manifest]",
      "url": "https://manifest.googlevideo.com/api/manifest/dash/[...]/itag/0/[...]"
    }
  ]
}

------------------------------------------------------------------------------------------------

$ url=https://www.youtube.com/watch?v=P1pUkhX4PKg   # Live videostream.

$ xidel -se 'x:request({"headers":"Content-Type: application/json","post":serialize({"context":{"client":{"clientName":"WEB","clientVersion":"2.20210520.09.00"}},"videoId":extract("'$url'","\w+$")},{"method":"json"}),"url":request-combine("https://www.youtube.com/youtubei/v1/player",{"key":"AIzaSyAO_FJ2SlqU8Q4STEHLGCilw_Y9_11qcW8"})/url})/json/(videoDetails,microformat/playerMicroformatRenderer,streamingData)'
{
  "videoId": "P1pUkhX4PKg",
  "title": "24/7 Live In-Stock Alerts RTX 3060/3060TI/3070/3080/3080TI/3090 RX 6700/6800/6900  Ryzen 5900x/5950x",
  "lengthSeconds": "0",
  "isLive": true,
  [...]
}
{
  [...]
  "publishDate": "2021-05-03",
  "ownerChannelName": "fixitfixitfixit",
  "liveBroadcastDetails": {
    "isLiveNow": true,
    "startTimestamp": "2021-05-04T04:51:49+00:00"
  },
  "uploadDate": "2021-05-03"
}
{
  [...]
  "dashManifestUrl": "https://manifest.googlevideo.com/api/manifest/dash/[...]/itag/0/[...]",
  "hlsManifestUrl": "https://manifest.googlevideo.com/api/manifest/hls_variant/[...]/itag/0/[...]/file/index.m3u8"
}

$ xidel -s --module=xivid.xqm -e 'x:request({"headers":"Content-Type: application/json","post":serialize({"context":{"client":{"clientName":"WEB","clientVersion":"2.20210520.09.00"}},"videoId":extract("'$url'","\w+$")},{"method":"json"}),"url":request-combine("https://www.youtube.com/youtubei/v1/player",{"key":"AIzaSyAO_FJ2SlqU8Q4STEHLGCilw_Y9_11qcW8"})/url})/json/{"name":videoDetails/title,"date":dateTime(microformat/playerMicroformatRenderer/(liveBroadcastDetails/startTimestamp,uploadDate||"T00:00:00Z")[1]),"duration"?:videoDetails[not(isLive)]/lengthSeconds * duration("PT1S"),"formats":streamingData/array{for $x at $i in (formats)() order by $x/width count $i return {"id":"pg-"||$i,"format":let $mt:=tokenize($x/mimeType,";"),$c:=tokenize(extract($mt[2],"&quot;(.+)&quot;",1),", ") ! tokenize(.,"\.")[1] return concat(substring-after($mt[1],"/"),"[",if ($c[1]="avc1") then "h264" else $c[1],"+",if ($c[2]="mp4a") then "aac" else $c[2],"]"),"resolution":concat($x/width,"x",$x/height,"@",$x/fps,"fps"),"bitrate":concat(round($x/bitrate div 1000),"kbps"),"url":$x/url},{"id":"dash-0","format":"mpd[manifest]","url":dashManifestUrl}[url],xivid:m3u8-to-json(hlsManifestUrl)()}}'
{
  "name": "24/7 Live In-Stock Alerts RTX 3060/3060TI/3070/3080/3080TI/3090 RX 6700/6800/6900  Ryzen 5900x/5950x",
  "date": "2021-05-04T04:51:49Z",
  "formats": [
    {
      "id": "dash-0",
      "format": "mpd[manifest]",
      "url": "https://manifest.googlevideo.com/api/manifest/dash/[...]/itag/0/[...]"
    },
    {
      "id": "hls-0",
      "format": "m3u8[manifest]",
      "url": "https://manifest.googlevideo.com/api/manifest/hls_variant/[...]/itag/0/[...]/file/index.m3u8"
    },
    {
      "id": "hls-1",
      "format": "m3u8[h264+aac]",
      "resolution": "256x144@30fps",
      "bitrate": "269kbps",
      "url": "https://manifest.googlevideo.com/api/manifest/hls_playlist/[...]/itag/91/[...]/playlist/index.m3u8"
    },
    [...]
    {
      "id": "hls-6",
      "format": "m3u8[h264+aac]",
      "resolution": "1920x1080@30fps",
      "bitrate": "4561kbps",
      "url": "https://manifest.googlevideo.com/api/manifest/hls_playlist/[...]/itag/96/[...]/playlist/index.m3u8"
    }
  ]
}

------------------------------------------------------------------------------------------------

$ url=https://www.youtube.com/watch?v=GuoxLggqI_g   # Video met ondertiteling én "signature".

$ xidel -se 'x:request({"headers":"Content-Type: application/json","post":serialize({"context":{"client":{"clientName":"WEB","clientVersion":"2.20210520.09.00"}},"videoId":extract("'$url'","\w+$")},{"method":"json"}),"url":request-combine("https://www.youtube.com/youtubei/v1/player",{"key":"AIzaSyAO_FJ2SlqU8Q4STEHLGCilw_Y9_11qcW8"})/url})/json/((.//captionTracks)()[languageCode=("nl","en")],streamingData/(formats)(2))'
{
  "baseUrl": "https://www.youtube.com/api/timedtext?[...]lang=en",
  "name": {
    "simpleText": "Engels"
  },
  "vssId": ".en",
  "languageCode": "en",
  "isTranslatable": true
}
{
  "itag": 22,
  "mimeType": "video/mp4; codecs=\"avc1.64001F, mp4a.40.2\"",
  "bitrate": 1578452,
  "width": 1280,
  "height": 720,
  [...]
  "signatureCipher": "s=PDAJL4DMXckzeWKpbglTvbcRw7dv6bhjZGGuOdmGiSEICo_KTqat_yYW9VHrABJClAXWZ9ibUlTyhGCi-pw-zfqPgIARw8JQ0qO6&sp=sig&url=https://[...]"
}

$ xidel -se '[...]/streamingData/(formats)(2)/tokenize(signatureCipher,"&")'
s=PDAJL4DMXckzeWKpbglTvbcRw7dv6bhjZGGuOdmGiSEICo_KTqat_yYW9VHrABJClAXWZ9ibUlTyhGCi-pw-zfqPgIARw8JQ0qO6
sp=sig
url=https://r2---sn-mn4vg5aa-5hns.googlevideo.com/videoplayback%3F[...]%26itag%3D22[...]

$ xidel -se 'let $sig:=[...]/streamingData/(formats)(2)/tokenize(signatureCipher,"&") ! substring-after(.,"=") return (uri-decode($sig[3]),x"&{$sig[2]}=",$sig[1])'
https://r2---sn-mn4vg5aa-5hns.googlevideo.com/videoplayback?[...]&itag=22[...]
&sig=
PDAJL4DMXckzeWKpbglTvbcRw7dv6bhjZGGuOdmGiSEICo_KTqat_yYW9VHrABJClAXWZ9ibUlTyhGCi-pw-zfqPgIARw8JQ0qO6

$ xidel -se 'let $a:=[...]/streamingData/(formats)(2)/tokenize(signatureCipher,"&") ! substring-after(.,"=") return x"{uri-decode($a[3])}&{$a[2]}={$a[1]}"'
https://r2---sn-mn4vg5aa-5hns.googlevideo.com/videoplayback?[...]&itag=22[...]&sig=PDAJL4DMXckzeWKpbglTvbcRw7dv6bhjZGGuOdmGiSEICo_KTqat_yYW9VHrABJClAXWZ9ibUlTyhGCi-pw-zfqPgIARw8JQ0qO6

Op deze "sig"-parameter moet echter nog een ingewikkeld algoritme worden los gelaten, b.v. draai string om,
verwissel tekens op die en die posities, enz.
Youtube-dl maakt gebruik van een of andere Javascript runtime, zonder de code te hoeven ontleden. Onmogelijk met Xidel, volgens mij.

Filter deze beveiligde video's eruit door bij de progressive videostreams het "url"-attribuut verplicht te stellen en omdat er in dit geval toch geen DASH manifest beschikbaar is, hoef ik de "adaptiveFormats"-array ook niet te benaderen:

$ xidel -s --module=xivid.xqm -e 'x:request({"headers":"Content-Type: application/json","post":serialize({"context":{"client":{"clientName":"WEB","clientVersion":"2.20210520.09.00"}},"videoId":extract("'$url'","\w+$")},{"method":"json"}),"url":request-combine("https://www.youtube.com/youtubei/v1/player",{"key":"AIzaSyAO_FJ2SlqU8Q4STEHLGCilw_Y9_11qcW8"})/url})/json/{"name":videoDetails/title,"date":dateTime(microformat/playerMicroformatRenderer/(liveBroadcastDetails/startTimestamp,uploadDate||"T00:00:00Z")[1]),"duration"?:videoDetails[not(isLive)]/lengthSeconds * duration("PT1S"),"formats":array{(.//captionTracks)()[languageCode=("nl","en")]/{"id":"sub-"||position(),"format":"ttml","language":languageCode,"label":name/simpleText,"url":baseUrl},for $x at $i in streamingData/(formats)()[url] order by $x/width count $i return {"id":"pg-"||$i,"format":let $mt:=tokenize($x/mimeType,";"),$c:=tokenize(extract($mt[2],"&quot;(.+)&quot;",1),", ") ! tokenize(.,"\.")[1] return concat(substring-after($mt[1],"/"),"[",if ($c[1]="avc1") then "h264" else $c[1],"+",if ($c[2]="mp4a") then "aac" else $c[2],"]"),"resolution":concat($x/width,"x",$x/height,"@",$x/fps,"fps"),"bitrate":concat(round($x/bitrate div 1000),"kbps"),"url":$x/url},{"id":"dash-0","format":"mpd[manifest]","url":streamingData/dashManifestUrl}[url],xivid:m3u8-to-json(streamingData/hlsManifestUrl)()}}'
{
  "name": "The Uncertainty Has Settled (Full film)",
  "date": "2018-11-07T00:00:00Z",
  "duration": "PT1H28M26S",
  "formats": [
    {
      "id": "sub-1",
      "format": "ttml",
      "language": "en",
      "label": "English",
      "url": "https://www.youtube.com/api/timedtext?[...]&lang=en"
    }
  ]
}

------------------------------------------------------------------------------------------------

declare function xivid:youtube($url as string) as object()? {
  x:request({
    "headers":"Content-Type: application/json",
    "post":serialize(
      {
        "context":{
          "client":{
            "clientName":"WEB",
            "clientVersion":"2.20210520.09.00"
          }
        },
        "videoId":extract($url,"\w+$")
      },
      {"method":"json"}
    ),
    "url":request-combine(
      "https://www.youtube.com/youtubei/v1/player",
      {"key":"AIzaSyAO_FJ2SlqU8Q4STEHLGCilw_Y9_11qcW8"}
    )/url
  })/json/{
    "name":videoDetails/title,
    "date":dateTime(
      microformat/playerMicroformatRenderer/(
        liveBroadcastDetails/startTimestamp,
        uploadDate||"T00:00:00Z"
      )[1]
    ),
    "duration"?:videoDetails[not(isLive)]/lengthSeconds * duration("PT1S"),
    "formats":array{
      (.//captionTracks)()[languageCode=("nl","en")]/{
        "id":"sub-"||position(),
        "format":"ttml",
        "language":languageCode,
        "label":name/simpleText,
        "url":baseUrl
      },
      for $x at $i in streamingData/(formats)()[url]
      order by $x/width
      count $i
      return {
        "id":"pg-"||$i,
        "format":let $mt:=tokenize($x/mimeType,";"),
            $c:=tokenize(
              extract($mt[2],"&quot;(.+)&quot;",1),
              ", "
            ) ! tokenize(.,"\.")[1]
        return
        concat(
          substring-after($mt[1],"/"),
          "[",
          if ($c[1]="avc1") then "h264" else $c[1],
          "+",
          if ($c[2]="mp4a") then "aac" else $c[2],
          "]"
        ),
        "resolution":concat($x/width,"x",$x/height,"@",$x/fps,"fps"),
        "bitrate":concat(round($x/bitrate div 1000),"kbps"),
        "url":$x/url
      },
      {
        "id":"dash-0",
        "format":"mpd[manifest]",
        "url":streamingData/dashManifestUrl
      }[url],
      xivid:m3u8-to-json(streamingData/hlsManifestUrl)()
    }
  }
};

================================================================================================

[vimeo]

$ url=https://vimeo.com/224661084

$ xidel -se 'parse-json(doc("'$url'")//script/extract(.,"clip_page_config = (.+);",1)[.])'
{
  "clip": {
    "id": 224661084,
    "title": "The Uncertainty has Settled-Now on demand",
    "description": "<p class=\"first\">The full length documentary [...] Are we doing the right thing?</p>",
    "uploaded_on": "2017-07-07 11:14:30",
    "uploaded_on_relative": "3 years ago",
    "uploaded_on_full": "Friday, July 7, 2017 at 11:14 AM EST",
    "is_spatial": false,
    "is_hdr": false,
    "privacy": {
      "is_public": true,
      "type": "anybody",
      "description": "Public"
    },
    "duration": {
      "raw": 117,
      "formatted": "01:57"
    },
    "is_liked": false,
    "is_unavailable": false,
    "likes_url": "/224661084/likes",
    "is_live": false,
    "unlisted_hash": null
  },
  "owner": {
    "id": 11716486,
    "display_name": "Marijn Poels",
    [...]
  },
  [...]
  "player": {
    "config_url": "https://player.vimeo.com/video/224661084/config?[...]",
    "player_url": "player.vimeo.com",
    "dimensions": {
      "height": 540,
      "width": 1290
    },
    "poster": {
      "url": "https://i.vimeocdn.com/video/660399389.jpg?mw=2000&mh=1080&q=70"
    }
  },
  [...]
}

$ xidel -se 'parse-json(doc("'$url'")//script/extract(.,"clip_page_config = (.+);",1)[.])/player/json-doc(config_url)'
{
  "cdn_url": "https://f.vimeocdn.com",
  "vimeo_api_url": "api.vimeo.com",
  "request": {
    "files": {
      "dash": {
        [...]
      },
      "hls": {
        "separate_av": true,
        "default_cdn": "akfire_interconnect_quic",
        "cdns": {
          "akfire_interconnect_quic": {
            "url": "https://85vod-adaptive.akamaized.net/[...]/787433688,787433686,787433685,787433684/master.m3u8",
            "origin": "gcs",
            "avc_url": [...]
          },
          "fastly_skyfire": {
            "url": "https://skyfire.vimeocdn.com/[...]/787433688,787433686,787433685,787433684/master.m3u8",
            "origin": "gcs",
            "avc_url": [...]
          }
        }
      },
      "progressive": [
        {
          "profile": 174,
          "width": 1366,
          "mime": "video/mp4",
          "fps": 25,
          "url": "https://vod-progressive.akamaized.net/[...]/787433688.mp4",
          "cdn": "akamai_interconnect",
          "quality": "720p",
          "id": 787433688,
          "origin": "gcs",
          "height": 572
        },
        [...]
        {
          "profile": 165,
          "width": 960,
          "mime": "video/mp4",
          "fps": 25,
          "url": "https://vod-progressive.akamaized.net/[...]/787433684.mp4",
          "cdn": "akamai_interconnect",
          "quality": "540p",
          "id": 787433684,
          "origin": "gcs",
          "height": 402
        }
      ]
    },
    [...]
  },
  [...]
}

$ xidel -se '
  parse-json(doc("'$url'")//script/extract(.,"clip_page_config = (.+);",1)[.])/clip/(
    uploaded_on,
    replace(uploaded_on,"\s","T"),
    dateTime(replace(uploaded_on,"\s","T")||"-05:00"),
    adjust-dateTime-to-timezone(dateTime(replace(uploaded_on,"\s","T")||"-05:00"),duration("PT0S"))
  )
'
2017-07-07 11:14:30
2017-07-07T11:14:30
2017-07-07T11:14:30-05:00   # Vimeo specificeert dateTime altijd als lokale tijd; Eastern Standard Time (EST), oftewel UTC-5.
2017-07-07T16:14:30Z

$ xidel -s --module=xivid.xqm -e 'parse-json(doc("'$url'")//script/extract(.,"clip_page_config = (.+);",1)[.])/{"name":concat(owner/display_name,": ",clip/title),"date":adjust-dateTime-to-timezone(dateTime(replace(clip/uploaded_on,"\s","T")||"-05:00"),duration("PT0S")),"duration":clip/duration/raw * duration("PT1S"),"formats":player/json-doc(config_url)//files/array{for $x at $i in (progressive)() order by $x/width count $i return $x/{"id":"pg-"||$i,"format":"mp4[h264+aac]","resolution":concat(width,"x",height,"@",fps,"fps"),"url":url},xivid:m3u8-to-json((hls//url)[1])()}}'
{
  "name": "Marijn Poels: The Uncertainty has Settled-Now on demand",
  "date": "2017-07-07T16:14:30Z",
  "duration": "PT1M57S",
  "formats": [
    {
      "id": "pg-1",
      "format": "mp4[h264+aac]",
      "resolution": "640x268@25fps",
      "url": "https://vod-progressive.akamaized.net/[...]/787433686.mp4"
    },
    [...]
    {
      "id": "pg-4",
      "format": "mp4[h264+aac]",
      "resolution": "1920x804@25fps",
      "url": "https://vod-progressive.akamaized.net/[...]/787433685.mp4"
    },
    {
      "id": "hls-0",
      "format": "m3u8[manifest]",
      "url": "https://85vod-adaptive.akamaized.net/[...]/787433688,787433686,787433685,787433684/master.m3u8"
    },
    {
      "id": "hls-1",
      "format": "m3u8[aac]",
      "url": "https://85vod-adaptive.akamaized.net/[...]/787433686/playlist.m3u8"
    },
    [...]
    {
      "id": "hls-6",
      "format": "m3u8[h264+aac]",
      "resolution": "1920x804@25fps",
      "bitrate": "6370kbps",
      "url": "https://85vod-adaptive.akamaized.net/[...]/787433685/playlist.m3u8"
    }
  ]
}

------------------------------------------------------------------------------------------------

$ url=https://player.vimeo.com/video/238924796

$ xidel -se 'parse-json(doc("'$url'")//script/extract(.,"config = (.+?);",1)[.])'
{
  "cdn_url": "https://f.vimeocdn.com",
  "vimeo_api_url": "api.vimeo.com",
  "request": {
    "files": {
      "dash": {
        [...]
      },
      "hls": {
        "separate_av": true,
        "default_cdn": "akfire_interconnect_quic",
        "cdns": {
          "akfire_interconnect_quic": {
            "url": "https://197vod-adaptive.akamaized.net/[...]/853938837,853938829/master.m3u8",
            "origin": "gcs",
            "avc_url": [...]
          },
          "fastly_skyfire": {
            "url": "https://skyfire.vimeocdn.com/[...]/853938837,853938829/master.m3u8",
            "origin": "gcs",
            "avc_url": [...]
          }
        }
      },
      "progressive": [
        {
          "profile": 164,
          "width": 640,
          "mime": "video/mp4",
          "fps": 25,
          "url": "https://vod-progressive.akamaized.net/[...]/853938837.mp4",
          "cdn": "akamai_interconnect",
          "quality": "360p",
          "id": 853938837,
          "origin": "gcs",
          "height": 360
        }
      ]
    },
    [...]
  },
  "player_url": "player.vimeo.com",
  "video": {
    [...]
    "duration": 85,
    [...]
    "owner": {
      "account_type": "pro",
      "name": "NTR internet & innovatie",
      "img": "https://i.vimeocdn.com/portrait/defaults-blue_60x60.png",
      "url": "https://vimeo.com/user60209025",
      "img_2x": "https://i.vimeocdn.com/portrait/defaults-blue_120x120.png",
      "id": 60209025
    },
    "id": 238924796,
    "embed_code": "<iframe title=\"vimeo-player\" src=\"https://player.vimeo.com/video/238924796\" width=\"640\" height=\"360\" frameborder=\"0\" allowfullscreen></iframe>",
    "title": "Waarom is zeewater zout?",
    "share_url": "https://vimeo.com/238924796",
    "width": 704,
    "embed_permission": "public",
    "fps": 25,
    [...]
  },
  [...]
}

$ xidel -s --module=xivid.xqm -e 'let $id:=extract("'$url'","\d+$") return parse-json(doc("https://player.vimeo.com/video/"||$id)//script/extract(.,"config = (.+?);",1)[.])/{"name":video/concat(owner/name,": ",title),"date"?:if (contains("'$url'","player.vimeo.com")) then () else parse-json(doc("'$url'")//script/extract(.,"clip_page_config = (.+);",1)[.])/adjust-dateTime-to-timezone(dateTime(replace(clip/uploaded_on,"\s","T")||"-05:00"),duration("PT0S")),"duration":video/duration * duration("PT1S") + time("00:00:00"),"formats":request/files/array{for $x at $i in (progressive)() order by $x/width count $i return $x/{"id":"pg-"||$i,"format":"mp4[h264+aac]","resolution":concat(width,"x",height,"@",fps,"fps"),"url":url},xivid:m3u8-to-json((hls//url)[1])()}}'
{
  "name": "NTR internet & innovatie - Waarom is zeewater zout?",
  "duration": "PT1M25S",
  "formats": [
    {
      "id": "pg-1",
      "format": "mp4[h264+aac]",
      "resolution": "640x360@25fps",
      "url": "https://vod-progressive.akamaized.net/[...]/853938837.mp4"
    },
    {
      "id": "hls-0",
      "format": "m3u8[manifest]",
      "url": "https://197vod-adaptive.akamaized.net/[...]/853938837,853938829/master.m3u8"
    },
    {
      "id": "hls-1",
      "format": "m3u8[aac]",
      "url": "https://197vod-adaptive.akamaized.net/[...]/853938837/playlist.m3u8"
    },
    [...]
    {
      "id": "hls-3",
      "format": "m3u8[h264+aac]",
      "resolution": "704x396@25fps",
      "bitrate": "997kbps",
      "url": "https://197vod-adaptive.akamaized.net/[...]/853938829/playlist.m3u8"
    }
  ]
}

------------------------------------------------------------------------------------------------

declare function xivid:vimeo($url as string) as object()? {
  let $id:=extract($url,"\d+$") return
  parse-json(
    doc("https://player.vimeo.com/video/"||$id)//script/extract(.,"config = (.+?);",1)[.]
  )/{
    "name":video/concat(owner/name,": ",title),
    "date"?:if (contains($url,"player.vimeo.com")) then
      ()
    else
      parse-json(
        doc($url)//script/extract(.,"clip_page_config = (.+);",1)[.]
      )/adjust-dateTime-to-timezone(
        dateTime(replace(clip/uploaded_on,"\s","T")||"-05:00"),
        duration("PT0S")
      ),
    "duration":video/duration * duration("PT1S"),
    "formats":request/files/array{
      for $x at $i in (progressive)()
      order by $x/width
      count $i
      return
      $x/{
        "id":"pg-"||$i,
        "format":"mp4[h264+aac]",
        "resolution":concat(width,"x",height,"@",fps,"fps"),
        "url":url
      },
      xivid:m3u8-to-json((hls//url)[1])()
    }
  }
};

================================================================================================

[nos]

$ url=https://nos.nl/collectie/13781/video/2385546-bekijk-de-samenvatting-van-nederland-oostenrijk-2-0

$ xidel -se 'parse-json(doc("'$url'")//main/script)/item'
{
  "id": 2385546,
  "title": "Bekijk de samenvatting van Nederland-Oostenrijk (2-0)",
  "description": "Een samenvatting van de tweede groepswedstrijd van het Nederlands elftal op het EK voetbal, tegen Oostenrijk.",
  "geoprotection": true,
  [...]
  "formats": [
    {
      "width": 640,
      "height": 360,
      "name": "360p",
      "label": "Laag - 360p",
      "mimetype": "application/vnd.apple.mpegurl",
      "url": {
        "mp4": "https://resolver.streaming.api.nos.nl/stream?stream=NOSC_9c340c66_2cb2_4bc3_8731_96152a38823d&profile=hls_unencrypted&policy=eyJ0eXA[...]7qnoHQg"
      }
    },
    {
      "width": 960,
      "height": 540,
      "name": "540p",
      "label": "Hoog - 540p",
      "mimetype": "application/vnd.apple.mpegurl",
      "url": {
        "mp4": "https://resolver.streaming.api.nos.nl/stream?stream=NOSC_9c340c66_2cb2_4bc3_8731_96152a38823d&profile=hls_unencrypted&policy=eyJ0eXA[...]7qnoHQg"
      }
    },
    {
      "width": 1280,
      "height": 720,
      "name": "720p",
      "label": "HD - 720p",
      "mimetype": "application/vnd.apple.mpegurl",
      "url": {
        "mp4": "https://resolver.streaming.api.nos.nl/stream?stream=NOSC_9c340c66_2cb2_4bc3_8731_96152a38823d&profile=hls_unencrypted&policy=eyJ0eXA[...]7qnoHQg"
      }
    },
    {
      "width": 848,
      "height": 480,
      "name": "480p",
      "label": "Normaal - 480p",
      "mimetype": "application/vnd.apple.mpegurl",
      "url": {
        "mp4": "https://resolver.streaming.api.nos.nl/stream?stream=NOSC_9c340c66_2cb2_4bc3_8731_96152a38823d&profile=hls_unencrypted&policy=eyJ0eXA[...]7qnoHQg"
      }
    }
  ],
  "aspect_ratios": {
    "ratio": "16:9",
    "profiles": [
      {
        "name": "hls_unencrypted",
        "mimetype": "application/vnd.apple.mpegurl",
        "url": "https://resolver.streaming.api.nos.nl/stream?stream=NOSC_9c340c66_2cb2_4bc3_8731_96152a38823d&profile=hls_unencrypted&policy=eyJ0eXA[...]7qnoHQg"
      },
      {
        "name": "smooth_unencrypted",
        "mimetype": "application/vnd.ms-sstr+xml",
        "url": "https://resolver.streaming.api.nos.nl/stream?stream=NOSC_9c340c66_2cb2_4bc3_8731_96152a38823d&profile=smooth_unencrypted&policy=eyJ0eXA[...]7qnoHQg"
      },
      {
        "name": "dash_unencrypted",
        "mimetype": "application/dash+xml",
        "url": "https://resolver.streaming.api.nos.nl/stream?stream=NOSC_9c340c66_2cb2_4bc3_8731_96152a38823d&profile=dash_unencrypted&policy=eyJ0eXA[...]7qnoHQg"
      }
    ]
  },
  [...]
  "published_at": "2021-06-17T23:06:27+0200",
  "duration": 307,
  [...]
  "modified_at": "2021-06-17T23:06:27+0200",
  [...]
}

Alle urls in (formats)()/url/mp4 zijn precies dezelfde als aspect_ratios/(profiles)()[name="hls_unencrypted"]/url.

$ xidel -s --module=xivid.xqm -e 'parse-json(doc("'$url'")//main/script)/item/{"name":"NOS: "||title,"date":adjust-dateTime-to-timezone(dateTime(substring(published_at,1,22)||":00"),duration("PT0S")),"duration":duration * duration("PT1S"),"formats":aspect_ratios/profiles/array{{"id":"dash-0","format":"mpd[manifest]","url":x:request({"method":"HEAD","url":.()[name="dash_unencrypted"]/url})/url},xivid:m3u8-to-json(.()[name="hls_unencrypted"]/url)()}}'
{
  "name": "NOS: Bekijk de samenvatting van Nederland-Oostenrijk (2-0)",
  "date": "2021-06-17T21:06:27Z",
  "duration": "PT5M7S",
  "formats": [
    {
      "id": "dash-0",
      "format": "mpd[manifest]",
      "url": "https://npo.prd.cdn.bcms.kpn.com/[...]/dash_unencrypted/[...]/stream.mpd"
    },
    {
      "id": "hls-0",
      "format": "m3u8[manifest]",
      "url": "https://npo.prd.cdn.bcms.kpn.com/[...]/hls_unencrypted/[...]/playlist.m3u8"
    },
    {
      "id": "hls-1",
      "format": "m3u8[h264+aac]",
      "resolution": "640x360@25fps",
      "bitrate": "355|128kbps",
      "url": "https://npo.prd.cdn.bcms.kpn.com/[...]/hls_unencrypted/[...]/NOSC_9c340c66_2cb2_4bc3_8731_96152a38823d_v1623964114-audio=128000-video=355156.m3u8"
    },
    {
      "id": "hls-2",
      "format": "m3u8[h264+aac]",
      "resolution": "960x540@25fps",
      "bitrate": "1170|128kbps",
      "url": "https://npo.prd.cdn.bcms.kpn.com/[...]/hls_unencrypted/[...]/NOSC_9c340c66_2cb2_4bc3_8731_96152a38823d_v1623964114-audio=128000-video=1170001.m3u8"
    },
    {
      "id": "hls-3",
      "format": "m3u8[h264+aac]",
      "resolution": "1280x720@25fps",
      "bitrate": "1635|128kbps",
      "url": "https://npo.prd.cdn.bcms.kpn.com/[...]/hls_unencrypted/[...]/NOSC_9c340c66_2cb2_4bc3_8731_96152a38823d_v1623964114-audio=128000-video=1634927.m3u8"
    },
    {
      "id": "hls-4",
      "format": "m3u8[h264+aac]",
      "resolution": "848x480@25fps",   # Och, och, och, NOS toch!
      "bitrate": "8413|128kbps",       # Een nul te veel in de bitrate?
      "url": "https://npo.prd.cdn.bcms.kpn.com/[...]/hls_unencrypted/[...]/NOSC_9c340c66_2cb2_4bc3_8731_96152a38823d_v1623964114-audio=128000-video=8412720.m3u8"
    }
  ]
}

------------------------------------------------------------------------------------------------

$ url=https://nos.nl/artikel/2378116-persvrijheid-in-eu-landen-in-gevaar-het-zijn-kleine-stapjes-die-je-niet-doorhebt.html

$ xidel -se 'parse-json(doc("'$url'")//main/script)/(item,.//video)'
{
  "id": 2341766,
  "title": "Protest tegen ontslag Hongaarse hoofdredacteur: 'Grootste nieuwssite geruïneerd'",
  "description": "In Boedapest zijn enkele duizenden betogers de straat opgegaan om te demonstreren tegen het ontslag van de hoofdredacteur van de nieuwssite index.hu, en om de medewerkers van de site die hierop zelf ontslag namen te steunen.",
  [...]
  "formats": [
    {
      "width": 848,
      "height": 480,
      "name": "480p",
      "label": "Normaal - 480p",
      "mimetype": "application/vnd.apple.mpegurl",
      "url": {
        "mp4": "https://resolver.streaming.api.nos.nl/adaptive?legacy=resolve.php&url=%2Fcontent%2Fvideo%2F2020%2F07%2F24%2F258706-1031d20fe5090b5bafa95a7f38c02153%2F258706-1031d20fe5090b5bafa95a7f38c02153.ism%2F258706-1031d20fe5090b5bafa95a7f38c02153.m3u8"
      }
    },
    {
      "width": 1280,
      "height": 720,
      "name": "720p",
      "label": "HD - 720p",
      "mimetype": "application/vnd.apple.mpegurl",
      "url": {
        "mp4": "https://resolver.streaming.api.nos.nl/adaptive?legacy=resolve.php&url=%2Fcontent%2Fvideo%2F2020%2F07%2F24%2F258706-1031d20fe5090b5bafa95a7f38c02153%2F258706-1031d20fe5090b5bafa95a7f38c02153.ism%2F258706-1031d20fe5090b5bafa95a7f38c02153.m3u8"
      }
    },
    {
      "width": 960,
      "height": 540,
      "name": "540p",
      "label": "Hoog - 540p",
      "mimetype": "application/vnd.apple.mpegurl",
      "url": {
        "mp4": "https://resolver.streaming.api.nos.nl/adaptive?legacy=resolve.php&url=%2Fcontent%2Fvideo%2F2020%2F07%2F24%2F258706-1031d20fe5090b5bafa95a7f38c02153%2F258706-1031d20fe5090b5bafa95a7f38c02153.ism%2F258706-1031d20fe5090b5bafa95a7f38c02153.m3u8"
      }
    },
    {
      "width": 640,
      "height": 360,
      "name": "360p",
      "label": "Laag - 360p",
      "mimetype": "application/vnd.apple.mpegurl",
      "url": {
        "mp4": "https://resolver.streaming.api.nos.nl/adaptive?legacy=resolve.php&url=%2Fcontent%2Fvideo%2F2020%2F07%2F24%2F258706-1031d20fe5090b5bafa95a7f38c02153%2F258706-1031d20fe5090b5bafa95a7f38c02153.ism%2F258706-1031d20fe5090b5bafa95a7f38c02153.m3u8"
      }
    }
  ],
  [...]
  "published_at": "2020-07-24T22:01:35+0200",
  "duration": 97,
  [...]
}

Geen "aspect_ratios"-object en ook hier weer zijn alle urls hetzelfde.

$ xidel -s --module=xivid.xqm -e 'parse-json(doc("'$url'")//main/script)/(item,.//video)/{"name":"NOS: "||title,"date":adjust-dateTime-to-timezone(dateTime(substring(published_at,1,22)||":00"),duration("PT0S")),"duration":duration * duration("PT1S"),"formats":array{{"id":"dash-0","format":"mpd[manifest]","url":x:request({"method":"HEAD","url":aspect_ratios/(profiles)()[name="dash_unencrypted"]/url}[url])/url}[url],xivid:m3u8-to-json((aspect_ratios/(profiles)()[name="hls_unencrypted"]/url,(formats)(1)/url/mp4)[1])()}}'
{
  "name": "NOS: Protest tegen ontslag Hongaarse hoofdredacteur: 'Grootste nieuwssite geruïneerd'",
  "date": "2020-07-24T20:01:35Z",
  "duration": "PT1M37S",
  "formats": [
    {
      "id": "hls-0",
      "format": "m3u8[manifest]",
      "url": "https://adaptive-e05c1c.npostreaming.nl/urishieldv2/[...]/258706-1031d20fe5090b5bafa95a7f38c02153.m3u8"
    },
    {
      "id": "hls-1",
      "format": "m3u8[h264+aac]",
      "resolution": "640x360",
      "bitrate": "400|128kbps",
      "url": "https://adaptive-e05c1c.npostreaming.nl/urishieldv2/[...]/258706-1031d20fe5090b5bafa95a7f38c02153-audio_eng=128000-video_eng=400000.m3u8"
    },
    [...]
    {
      "id": "hls-4",
      "format": "m3u8[h264+aac]",
      "resolution": "1280x720",
      "bitrate": "1799|128kbps",
      "url": "https://adaptive-e05c1c.npostreaming.nl/urishieldv2/[...]/258706-1031d20fe5090b5bafa95a7f38c02153-audio_eng=128000-video_eng=1799000.m3u8"
    }
  ]
}

------------------------------------------------------------------------------------------------

$ url=https://nos.nl/l/2011289

$ xidel -se 'parse-json(doc("'$url'")//main/script)/(item,.//video)'
{
  "id": 2011289,
  "title": "Samenvatting Spanje-Nederland WK 2014",
  "description": "Samenvatting van de inmiddels historische wedstrijd tussen Nederland en Spanje op het WK van 2014.",
  "geoprotection": true,
  [...]
  "formats": [
    {
      "width": 640,
      "height": 360,
      "name": "360p",
      "label": "Laag - 360p",
      "url": {
        "mp4": "https://resolver.streaming.api.nos.nl/video?legacy=resolve.php&url=https%3A%2F%2Fdownload.omroep.nl%2Fnos%2Fcontent%2Fvideo%2F2014%2F12%2F30%2F33641%2Fvod01.mp4"
      }
    },
    {
      "width": 848,
      "height": 480,
      "name": "480p",
      "label": "Normaal - 480p",
      "url": {
        "mp4": "https://resolver.streaming.api.nos.nl/video?legacy=resolve.php&url=https%3A%2F%2Fdownload.omroep.nl%2Fnos%2Fcontent%2Fvideo%2F2014%2F12%2F30%2F33641%2Fweb03.mp4"
      }
    }
  ],
  [...]
  "published_at": "2014-12-30T21:47:07+0100",
  "duration": 573,
  [...]
}

$ xidel -s --module=xivid.xqm -e 'parse-json(doc("'$url'")//main/script)/(item,.//video)/{"name":"NOS: "||title,"date":adjust-dateTime-to-timezone(dateTime(substring(published_at,1,22)||":00"),duration("PT0S")),"duration":duration * duration("PT1S"),"formats":array{(formats)()[ends-with(url/mp4,"mp4")]/{"id":"pg-"||position(),"format":"mp4[h264+aac]","resolution":x"{width}x{height}","url":url/mp4},{"id":"dash-0","format":"mpd[manifest]","url":x:request({"method":"HEAD","url":aspect_ratios/(profiles)()[name="dash_unencrypted"]/url}[url])/url}[url],xivid:m3u8-to-json((aspect_ratios/(profiles)()[name="hls_unencrypted"]/url,(formats)(1)[mimetype="application/vnd.apple.mpegurl"]/url/mp4)[1])()}}'
{
  "name": "NOS: Samenvatting Spanje-Nederland WK 2014",
  "date": "2014-12-30T20:47:07Z",
  "duration": "PT9M33S",
  "formats": [
    {
      "id": "pg-1",
      "format": "mp4[h264+aac]",
      "resolution": "640x360",
      "url": "https://resolver.streaming.api.nos.nl/video?legacy=resolve.php&url=https%3A%2F%2Fdownload.omroep.nl%2Fnos%2Fcontent%2Fvideo%2F2014%2F12%2F30%2F33641%2Fvod01.mp4"
    },
    {
      "id": "pg-2",
      "format": "mp4[h264+aac]",
      "resolution": "848x480",
      "url": "https://resolver.streaming.api.nos.nl/video?legacy=resolve.php&url=https%3A%2F%2Fdownload.omroep.nl%2Fnos%2Fcontent%2Fvideo%2F2014%2F12%2F30%2F33641%2Fweb03.mp4"
    }
  ]
}

------------------------------------------------------------------------------------------------

$ url=https://nos.nl/artikel/2372728-eerland-pakt-olympische-nominatie-voor-tokio-maar-hikt-tegen-eis-noc-nsf-aan

$ xidel -se 'parse-json(doc("'$url'")//main/script)/(item,.//video)'
{
  "id": 2372784,
  "title": "Eerland pakt olympische nominatie: 'Goed spelen op OKT was altijd challenge voor mij' ",
  [...]
}
{
  "id": 2373574,
  "title": "Eerland hoopt op NOC*NSF: 'Want voor mijn gevoel heb ik de Spelen al gehaald'",
  [...]
}

Meerdere video's. Vooralsnog pik ik alleen de eerste. Ondersteuning voor meerdere video's moet ik over nadenken.

$ xidel -s --module=xivid.xqm -e 'parse-json(doc("'$url'")//main/script)/(item,.//video)[1]/{"name":"NOS: "||title,"date":adjust-dateTime-to-timezone(dateTime(substring(published_at,1,22)||":00"),duration("PT0S")),"duration":duration * duration("PT1S"),"formats":array{(formats)()[ends-with(url/mp4,"mp4")]/{"id":"pg-"||position(),"format":"mp4[h264+aac]","resolution":x"{width}x{height}","url":url/mp4},{"id":"dash-0","format":"mpd[manifest]","url":x:request({"method":"HEAD","url":aspect_ratios/(profiles)()[name="dash_unencrypted"]/url}[url])/url}[url],xivid:m3u8-to-json((aspect_ratios/(profiles)()[name="hls_unencrypted"]/url,(formats)(1)[mimetype="application/vnd.apple.mpegurl"]/url/mp4)[1])()}}'
{
  "name": "NOS: Eerland pakt olympische nominatie: 'Goed spelen op OKT was altijd challenge voor mij
' ",
  "date": "2021-03-15T18:32:27Z",
  "duration": "PT1M18S",
  "formats": [
    {
      "id": "dash-0",
      "format": "mpd[manifest]",
      "url": "https://npo.prd.cdn.bcms.kpn.com/[...]/dash_unencrypted/[...]/stream.mpd"
    },
    {
      "id": "hls-0",
      "format": "m3u8[manifest]",
      "url": "https://npo.prd.cdn.bcms.kpn.com/[...]/hls_unencrypted/[...]/playlist.m3u8"
    },
    {
      "id": "hls-1",
      "format": "m3u8[h264+aac]",
      "resolution": "640x360@25fps",
      "bitrate": "370|128kbps",
      "url": "https://npo.prd.cdn.bcms.kpn.com/[...]/hls_unencrypted/[...]/NOSC_21f98521_e69d_4068_af2d_f16c46e0a138_v1615879196-audio=128000-video=370018.m3u8"
    },
    [...]
    {
      "id": "hls-4",
      "format": "m3u8[h264+aac]",
      "resolution": "848x480@25fps",
      "bitrate": "8861|128kbps",
      "url": "https://npo.prd.cdn.bcms.kpn.com/[...]/hls_unencrypted/[...]/NOSC_21f98521_e69d_4068_af2d_f16c46e0a138_v1615879196-audio=128000-video=8860784.m3u8"
    }
  ]
}

------------------------------------------------------------------------------------------------

declare function xivid:nos($url as string) as object()? {
  parse-json(doc($url)//main/script)/(item,.//video)[1]/{
    "name":"NOS: "||title,
    "date":adjust-dateTime-to-timezone(
      dateTime(substring(published_at,1,22)||":00"),
      duration("PT0S")
    ),
    "duration":duration * duration("PT1S"),
    "formats":array{
      (formats)()[ends-with(url/mp4,"mp4")]/{
        "id":"pg-"||position(),
        "format":"mp4[h264+aac]",
        "resolution":x"{width}x{height}",
        "url":url/mp4
      },
      {
        "id":"dash-0",
        "format":"mpd[manifest]",
        "url":x:request({
          "method":"HEAD",
          "url":aspect_ratios/(profiles)()[name="dash_unencrypted"]/url
        }[url])/url
      }[url],
      xivid:m3u8-to-json(
        (
          aspect_ratios/(profiles)()[name="hls_unencrypted"]/url,
          (formats)(1)[mimetype="application/vnd.apple.mpegurl"]/url/mp4
        )[1]
      )()
    }
  }
};

================================================================================================

[dumpert]

$ url=https://www.dumpert.nl/item/7971943_ce706a57

$ xidel -se 'doc("'$url'")//script/extract(.,"JSON\.parse\((.+)\)",1)[.]'
"{\"ads\":{\"kachingInstance\":null,\"kachingInitialized\":false,\"adsShowBlockerConsent\":true},\"items\":{\"item\":{\"item\":{\"date\":\"2020-08-22T10:22:56+02:00\",\"description\":\"Lekker begin van de dag ouwe\",\"id\":\"7971943_ce706a57\",[...]}"

$ xidel -se 'parse-json(doc("'$url'")//script/extract(.,"JSON\.parse\((.+)\)",1)[.])'
{"ads":{"kachingInstance":null,"kachingInitialized":false,"adsShowBlockerConsent":true},"items":{"item":{"item":{"date":"2020-08-22T10:22:56+02:00","description":"Lekker begin van de dag ouwe","id":"7971943_ce706a57",[...]}

$ xidel -se 'parse-json(parse-json(doc("'$url'")//script/extract(.,"JSON\.parse\((.+)\)",1)[.]))/items/item/item'
{
  "date": "2020-08-22T10:22:56+02:00",
  "description": "Lekker begin van de dag ouwe",
  "id": "7971943_ce706a57",
  "media": [
    {
      "description": "",
      "duration": 30,
      "mediatype": "VIDEO",
      "variants": [
        {
          "uri": "https://media.dumpert.nl/tablet/ce706a57_Fietser_Impact.mp4.mp4.mp4",
          "version": "tablet"
        },
        {
          "uri": "https://media.dumpert.nl/mobile/ce706a57_Fietser_Impact.mp4.mp4.mp4",
          "version": "mobile"
        },
        {
          "uri": "https://media.dumpert.nl/720p/ce706a57_Fietser_Impact.mp4.mp4.mp4",
          "version": "720p"
        }
      ]
    }
  ],
  [...]
  "title": "Telefoon checken tijdens het fietsen",
  [...]
}

Dumpert formaten van lage naar hoge resolutie: "mobile","tablet","720p","original", ook al zie je die laatste niet vaak.

$ xidel -se 'parse-json(parse-json(doc("'$url'")//script/extract(.,"JSON\.parse\((.+)\)",1)[.]))/items/item/item/{"name":"Dumpert: "||title,"date":adjust-dateTime-to-timezone(dateTime(date),duration("PT0S")),"duration":(media)()/duration * duration("PT1S"),"formats":array{for $x at $i in ("mobile","tablet","720p","original") return {"id":"pg-"||$i,"format":"mp4[h264+aac]","url":(.//variants)()[version=$x]/uri}[url]}}'
{
  "name": "Dumpert: Telefoon checken tijdens het fietsen",
  "date": "2020-08-22T08:22:56Z",
  "duration": "PT30S",
  "formats": [
    {
      "id": "pg-1",
      "format": "mp4[h264+aac]",
      "url": "https://media.dumpert.nl/mobile/ce706a57_Fietser_Impact.mp4.mp4.mp4"
    },
    {
      "id": "pg-2",
      "format": "mp4[h264+aac]",
      "url": "https://media.dumpert.nl/tablet/ce706a57_Fietser_Impact.mp4.mp4.mp4"
    },
    {
      "id": "pg-3",
      "format": "mp4[h264+aac]",
      "url": "https://media.dumpert.nl/720p/ce706a57_Fietser_Impact.mp4.mp4.mp4"
    }
  ]
}

------------------------------------------------------------------------------------------------

$ url=https://www.dumpert.nl/item/7971991_95a8ef78 (foto, geen video)

$ xidel -se 'parse-json(parse-json(doc("'$url'")//script/extract(.,"JSON\.parse\((.+)\)",1)[.]))/items/item/item'
{
  "date": "2020-08-22T11:47:46+02:00",
  "description": "FB gebruikert spotte ze veel <a href=\"https://www.dumpert.nl/item/7970941_6d833581\" target=\"_blank\">vaker</a>!",
  "id": "7971991_95a8ef78",
  "media": [
    {
      "description": "",
      "duration": 0,
      "mediatype": "FOTO",
      "variants": [
        {
          "uri": "https://media.dumpert.nl/foto/95a8ef78_Schermafbeelding_2020_08_22_om_11.43.19.png.png",
          "version": "foto"
        }
      ]
    }
  ],
  [...]
  "title": "Onschuldige dames zijn stiekem rellertjes",
  [...]
}

[(media)()[mediatype="VIDEO"]] om alleen de video's te ontleden.

------------------------------------------------------------------------------------------------

$ url=https://www.dumpert.nl/item/7944807_3df1ea7a (embedded youtube video)

$ xidel -se 'parse-json(parse-json(doc("'$url'")//script/extract(.,"JSON\.parse\((.+)\)",1)[.]))/items/item/item[exists((media)()[mediatype="VIDEO"])]'
{
  "date": "2020-08-03T17:00:39+02:00",
  "description": "Alle sadisten opgelet: er staat weer een nieuwe #FAIL-compilatie voor je klaar. Genieten!",
  "id": "7944807_3df1ea7a",
  "media": [
    {
      "description": "",
      "duration": 382,
      "mediatype": "VIDEO",
      "variants": [
        {
          "uri": "youtube:uF1ztwahGeA",
          "version": "embed"
        }
      ]
    }
  ],
  [...]
  "title": "Deze mensen kunnen echt helemaal niks! #FAIL (6) | Dumpert Tags",
  [...]
}

$ xidel -se 'parse-json(parse-json(doc("'$url'")//script/extract(.,"JSON\.parse\((.+)\)",1)[.]))/items/item/item[exists((media)()[mediatype="VIDEO"])]/{"name":"Dumpert: "||title,"date":adjust-dateTime-to-timezone(dateTime(date),duration("PT0S")),"duration":(media)()/duration * duration("PT1S"),"formats"?:array{for $x at $i in ("mobile","tablet","720p","original") return {"id":"pg-"||$i,"format":"mp4[h264+aac]","url":(.//variants)()[version=$x]/uri}[url]}[exists(.())]}'
{
  "name": "Dumpert: Deze mensen kunnen echt helemaal niks! #FAIL (6) | Dumpert Tags",
  "date": "2020-08-03T15:00:39Z",
  "duration": "PT6M22S"
}

$ url=https://www.dumpert.nl/item/7971823_1f7a4dfc (embedded twitter video)

$ xidel -se 'parse-json(parse-json(doc("'$url'")//script/extract(.,"JSON\.parse\((.+)\)",1)[.]))/items/item/item[(media)()[mediatype="VIDEO"]]'
{
  "date": "2020-08-21T21:43:10+02:00",
  "description": "Scoort zijn tweede in de finale",
  "id": "7971823_1f7a4dfc",
  "media": [
    {
      "description": "",
      "duration": 67,
      "mediatype": "VIDEO",
      "variants": [
        {
          "uri": "twitter:1296893972804247552",
          "version": "embed"
        }
      ]
    }
  ],
  [...]
  "title": "Kopbaas de Jong",
  [...]
}

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

Nog te doen: af laten handelen door xivid:youtube() en xivid:twitter() als die klaar zijn.

$ xidel -se 'parse-json(parse-json(doc("'$url'")//script/extract(.,"JSON\.parse\((.+)\)",1)[.]))/items/item/item[exists((media)()[mediatype="VIDEO"])]/(if ((.//variants)()/version="embed") then (.//variants)()/(if (starts-with(uri,"youtube")) then xivid:youtube(replace(uri,"youtube:","https://youtu.be/")) else xivid:twitter(replace(uri,"twitter:","https://twitter.com/i/status/"))) else {"name":"Dumpert: "||title,"date":adjust-dateTime-to-timezone(dateTime(date),duration("PT0S")),"duration":(media)()/duration * duration("PT1S"),"formats"?:array{for $x at $i in ("mobile","tablet","720p","original") return {"id":"pg-"||$i,"format":"mp4[h264+aac]","url":(.//variants)()[version=$x]/uri}[url]}[exists(.())]})'

------------------------------------------------------------------------------------------------

declare function xivid:dumpert($url as string) as object()? {
  parse-json(
    parse-json(
      doc($url)//script/extract(.,"JSON\.parse\((.+)\)",1)[.]
    )
  )/items/item/item[exists((media)()[mediatype="VIDEO"])]/{
    "name":"Dumpert: "||title,
    "date":adjust-dateTime-to-timezone(dateTime(date),duration("PT0S")),
    "duration":(media)()/duration * duration("PT1S"),
    "formats"?:array{
      for $x at $i in ("mobile","tablet","720p","original") return {
        "id":"pg-"||$i,
        "format":"mp4[h264+aac]",
        "url":(.//variants)()[version=$x]/uri
      }[url]
    }[exists(.())]
  }
};

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

Opsomming van alle Dumpert toppers video's, gewoon voor de fun:

$ xidel -s "https://www.dumpert.nl" -e 'parse-json(parse-json(//script/extract(.,"JSON\.parse\((.+)\)",1)[.]))//toppers/(list)()/(media)()[mediatype="VIDEO"]/(for $x in ("mobile","tablet","720p","original","embed") return (variants)()[version=$x]/(if (starts-with(uri,"youtube")) then replace(uri,"youtube:","https://youtu.be/") else if (starts-with(uri,"twitter")) then replace(uri,"twitter:","https://twitter.com/i/status/") else uri))[last()]'
https://media.dumpert.nl/tablet/2e296d00_IMG_4411.MP4.mp4.mp4
https://media.dumpert.nl/tablet/cfae0e8c_httpsadmin.dumpert.nlmediabaseoriginal035b620d_IMG_1850.MP4._online_video_cutter.com.mp4.mp4.mp4
https://media.dumpert.nl/tablet/cc620f7d_IMG_3907.MP4.mp4.mp4
https://media.dumpert.nl/720p/ce706a57_Fietser_Impact.mp4.mp4.mp4
https://media.dumpert.nl/tablet/112679e2_Gorilla_s_observeren_een_rups_Videoman.mp4.mp4.mp4
https://media.dumpert.nl/tablet/80225d59_Quand_vais_je_perdre_mon_pucelage_.mp4.mp4.mp4
https://media.dumpert.nl/tablet/c7a3a5d0_WhatsApp_Video_2020_08_21_at_00.38.28.mp4.mp4.mp4
https://media.dumpert.nl/tablet/8a4f1964_WhatsApp_Video_2020_08_21_at_18.46.30.mp4.mp4.mp4
https://youtu.be/NSuaUok-wTY
https://media.dumpert.nl/tablet/9e026ec0_Michael_Jackson_____pr0gramm.com_____Die_Datingplattform_fu__r_Kel.mp4.mp4.mp4
https://media.dumpert.nl/tablet/7cc27945_26a12e159420b0d25e2336840f1277fe.mp4.mp4.mp4
https://media.dumpert.nl/tablet/606bfb07_96596306_561359294796030_4278977649484383195_n.mp4.mp4.mp4
https://media.dumpert.nl/tablet/8ef9229a_Een_Formule_1_coureur_test_zijn_reflexen_voor_de_race_Videom.mp4.mp4.mp4
https://media.dumpert.nl/720p/393c40ad_Fooled_by_salt...or_a_nipple___Mario_Lopez_on_Penn___Teller_Fool_Us_.mp4.mp4.mp4
https://media.dumpert.nl/720p/6d833581_Icm_ETN7ZF_pb_ta.mp4.mp4.mp4
https://media.dumpert.nl/tablet/18b27a35_SC7T7uxg_wNS07at_online_video_cutter.com.mp4.mp4.mp4
https://media.dumpert.nl/tablet/b479e8c3_awww_____pr0gramm.com_____Die_Datingplattform_fu__r_Kellerkinder.mp4.mp4.mp4
https://media.dumpert.nl/tablet/6dd1846e_teenagestepmother_118247223_189511735880161_4429800162563342589_n.mp4.mp4.mp4
https://media.dumpert.nl/tablet/_79e3b6af_YTDL_1.mp4.mp4.mp4
https://twitter.com/i/status/1296893972804247552
https://media.dumpert.nl/tablet/30388844_De_ninjamoeder_Videoman.mp4.mp4.mp4
https://media.dumpert.nl/tablet/_9bfd3dc6_YTDL_1.mp4.mp4.mp4

================================================================================================

[Regionale zenders]

Blue Billywig livestreams:

$ xidel -se '
  doc("https://www.omropfryslan.nl/live/omrop-fryslan-tv")//div[starts-with(@class,"bluebillywig")]/script/@src,
  doc("https://www.rtvnoord.nl/televisie")//@data-media-url,
  doc("https://www.rtvdrenthe.nl/tv")//@data-media-url,
  doc("https://www.rtvoost.nl/tv")//@data-media-url,
  doc("https://www.omroepwest.nl/tv")//@data-media-url,
  doc("https://www.rijnmond.nl/tv")//div[starts-with(@class,"customhtml")]/script/@src,
  doc("https://www.rtvutrecht.nl/live/rtvutrecht")//article/iframe/@src,
  doc("https://www.omroepzeeland.nl/livetv")//div[starts-with(@class,"inlinemedia")]/iframe/@src,
  doc("https://www.omroepbrabant.nl/tv")/parse-json(//script[@id="__NEXT_DATA__"])/props/pageProps/props/concat(
    "https://omroepbrabant.bbvms.com/p/default/c/",integer(clip),".json"
  ),
  doc("https://l1.nl/live-l1-tv")//div[@class="bbwLive-player"]/script/@src
'
//omropfryslan.bbvms.com/p/omrop_frysl_n_live_stream_4/c/3748627.js?autoPlay=0&callback=bbwloaded&supportIABConsent=true
/media/bluebillywigplayeroptions/static/Tv.json
/media/bluebillywigplayeroptions/static/Tv.json
/media/bluebillywigplayeroptions/static/Tv.json
//omroepwest.bbvms.com/p/regiogrid/c/2054317.js
https://rijnmond.bbvms.com/p/rijnmond_live/c/1227908.js
https://rtvutrecht.bbvms.com/p/rtv_utrecht_videoplayer_web/c/3742011.html?inheritDimensions=true
https://omroepzeeland.bbvms.com/p/regiogridautoplay/l/1491828714434033.html
https://omroepbrabant.bbvms.com/p/default/c/1080520.json
//l1.bbvms.com/p/video_autoplay/c/3247576.js

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

$ xidel -se 'doc("https://www.omropfryslan.nl/live/omrop-fryslan-tv")//div[starts-with(@class,"bluebillywig")]/script ! (@src,static-base-uri(),resolve-uri(@src))'
//omropfryslan.bbvms.com/p/omrop_frysl_n_live_stream_4/c/3748627.js?autoPlay=0&callback=bbwloaded&supportIABConsent=true
https://www.omropfryslan.nl/live/omrop-fryslan-tv
https://omropfryslan.bbvms.com/p/omrop_frysl_n_live_stream_4/c/3748627.js?autoPlay=0&callback=bbwloaded&supportIABConsent=true   # Blue Billywig

https://www.w3.org/TR/xpath-functions-31/#func-resolve-uri:

  fn:resolve-uri($relative as xs:string?, $base as xs:string) as xs:anyURI?
  If the $base argument is not supplied, then:
    If the static base URI in the static context is not absent, it is used as the effective value of $base.

static-base-uri() hier boven staat gelijk aan $url, maar hier...

'test.xqm':

module namespace local = "127.0.0.1";

declare function local:test($url) {
  doc($url)//div[starts-with(@class,"bluebillywig")]/script ! (
    @src,
    static-base-uri(),
    resolve-uri(@src),
    resolve-uri(@src,base-uri()),
    resolve-uri(@src,$url)
  )
};

$ xidel -s --module=test.xqm -e 'local:test("'$url'")'
//omropfryslan.bbvms.com/p/omrop_frysl_n_live_stream_4/c/3748627.js?autoPlay=0&callback=bbwloaded&supportIABConsent=true
test.xqm
file://D:\\omropfryslan.bbvms.com\p\omrop_frysl_n_live_stream_4\c\3748627.js?autoPlay=0&callback=bbwloaded&supportIABConsent=true
https://omropfryslan.bbvms.com/p/omrop_frysl_n_live_stream_4/c/3748627.js?autoPlay=0&callback=bbwloaded&supportIABConsent=true
https://omropfryslan.bbvms.com/p/omrop_frysl_n_live_stream_4/c/3748627.js?autoPlay=0&callback=bbwloaded&supportIABConsent=true

...staat ie gelijk aan "test.xqm". In 'xivid.xqm' is dus base-uri() of $url nodig voor $base in resolve-uri().

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

https://www.omroepgelderland.nl/tv

$ xidel -se 'extract(unparsed-text("https://web.omroepgelderland.nl/epg/tv_vanavond/data/html/script.js"),"bbw_media_config_url = &apos;(.+)&apos;",1)'
https://omroepgelderland.bbvms.com/p/default/c/3651657.json

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

$ xidel -se '
  for $x in (
    "https://www.omropfryslan.nl/live/omrop-fryslan-tv",
    "https://www.rtvnoord.nl/televisie",
    "https://www.rtvdrenthe.nl/tv",
    "https://www.rtvoost.nl/tv",
    "https://www.omroepwest.nl/tv",
    "https://www.rijnmond.nl/tv",
    "https://www.rtvutrecht.nl/live/rtvutrecht",
    "https://www.omroepgelderland.nl/tv",
    "https://www.omroepzeeland.nl/livetv",
    "https://www.omroepbrabant.nl/tv",
    "https://l1.nl/live-l1-tv"
  ) return
  doc($x)/concat(
    resolve-uri(
      if ($x="https://www.omroepgelderland.nl/tv") then
        extract(
          unparsed-text("https://web.omroepgelderland.nl/epg/tv_vanavond/data/html/script.js"),
          "bbw_media_config_url = &apos;(.+)&apos;",1
        )
      else (
        //@data-media-url,                                                        (: RTV- Noord, Drenthe, Oost en Omroep West :)
        //article/iframe/@src,                                                    (: RTV Utrecht :)
        //div[
          starts-with(@class,"bluebillywig") or                                   (: Omrop Fryslân :)
          starts-with(@class,"customhtml") or                                     (: Rijnmond :)
          @class="bbwLive-player"                                                 (: L1 :)
        ]/script/@src,
        //div[starts-with(@class,"inlinemedia")]/iframe/@src,                     (: Omroep Zeeland :)
        parse-json(//script[@id="__NEXT_DATA__"])/props/pageProps/props/concat(   (: Omroep Brabant :)
          "https://omroepbrabant.bbvms.com/p/default/c/",integer(clip),".json"
        )
      ),
      $x
    ) ! extract(.,".+\.")||"json",
    " - ",
    //meta[@name="publisher" or @property="og:site_name"]/@content
  )
'
https://omropfryslan.bbvms.com/p/omrop_frysl_n_live_stream_4/c/3748627.json - Omrop Fryslân
https://www.rtvnoord.nl/media/bluebillywigplayeroptions/static/Tv.json - RTV Noord
https://www.rtvdrenthe.nl/media/bluebillywigplayeroptions/static/Tv.json - RTV Drenthe
https://www.rtvoost.nl/media/bluebillywigplayeroptions/static/Tv.json - RTV Oost
https://omroepwest.bbvms.com/p/regiogrid/c/2054317.json - Omroep West
https://rijnmond.bbvms.com/p/rijnmond_live/c/1227908.json - Rijnmond
https://rtvutrecht.bbvms.com/p/rtv_utrecht_videoplayer_web/c/3742011.json - RTV Utrecht
https://omroepgelderland.bbvms.com/p/default/c/3651657.json - Omroep Gelderland
https://omroepzeeland.bbvms.com/p/regiogridautoplay/l/1491828714434033.json - Omroep Zeeland
https://omroepbrabant.bbvms.com/p/default/c/1080520.json - Omroep Brabant
https://l1.bbvms.com/p/video_autoplay/c/3247576.json - L1

$ xidel -s --module=xivid.xqm -e '
  for $x in (
    "https://www.omropfryslan.nl/live/omrop-fryslan-tv",
    "https://www.rtvnoord.nl/televisie",
    "https://www.rtvdrenthe.nl/tv",
    "https://www.rtvoost.nl/tv",
    "https://www.omroepwest.nl/tv",
    "https://www.rijnmond.nl/tv",
    "https://www.rtvutrecht.nl/live/rtvutrecht",
    "https://www.omroepgelderland.nl/tv",
    "https://www.omroepzeeland.nl/livetv",
    "https://www.omroepbrabant.nl/tv",
    "https://l1.nl/live-l1-tv"
  )
  let $src:=doc($x),
      $script:=resolve-uri(
        if ($x="https://www.omroepgelderland.nl/tv") then
          extract(
            unparsed-text("https://web.omroepgelderland.nl/epg/tv_vanavond/data/html/script.js"),
            "bbw_media_config_url = &apos;(.+)&apos;",1
          )
        else
          $src/(
            //@data-media-url,
            //article/iframe/@src,
            //div[
              starts-with(@class,"bluebillywig") or
              starts-with(@class,"customhtml") or
              @class="bbwLive-player"
            ]/script/@src,
            //div[starts-with(@class,"inlinemedia")]/iframe/@src,
            parse-json(//script[@id="__NEXT_DATA__"])/props/pageProps/props/concat(
              "https://omroepbrabant.bbvms.com/p/default/c/",integer(clip),".json"
            )
          ),
        $x
      )
  return
  xivid:bbvms(
    extract($script,".+\.")||"json",
    concat(
      $src//meta[@name="publisher" or @property="og:site_name"]/@content,
      ": Livestream"
    )
  )
' --printed-json-format=compact
{"name": "Omrop Fryslân: Livestream", "date": "2020-12-20T15:08:59Z", "formats": [[...], {"id": "hls-4", "format": "m3u8[h264+aac]", "resolution": "1920x1080@25fps", "bitrate": "5760kbps", "url": "https://d3pvma9xb2775h.cloudfront.net/live/omropfryslan/stream04/1080p/prog_index.m3u8"}]}
{"name": "RTV Noord: Livestream", "date": "2020-12-20T15:08:59Z", "formats": [[...], {"id": "hls-4", "format": "m3u8[h264+aac]", "resolution": "1920x1080", "bitrate": "6096kbps", "url": "https://media.rtvnoord.nl/live/rtvnoord/tv/3e8fe3c1-0868-49b0-b2f3-7dd6eb30651f/index.m3u8"}]}
{"name": "RTV Drenthe: Livestream", "date": "2020-12-20T15:08:59Z", "formats": [[...], {"id": "hls-3", "format": "m3u8[h264+aac]", "resolution": "1920x1080@25fps", "bitrate": "5192kbps", "url": "https://cdn.rtvdrenthe.nl/live/rtvdrenthe/tv/1080p/prog_index.m3u8"}]}
{"name": "RTV Oost: Livestream", "date": "2020-12-20T15:08:59Z", "formats": [[...], {"id": "hls-3", "format": "m3u8[h264+aac]", "resolution": "1280x720", "bitrate": "2566kbps", "url": "https://mediacdn.rtvoost.nl/live/rtvoost/tv-oost/46ce631a-6155-4fcc-ac24-2b2e252f4f94/index.m3u8"}]}
{"name": "Omroep West: Livestream", "date": "2020-12-20T15:08:59Z", "formats": [[...], {"id": "hls-3", "format": "m3u8[h264+aac]", "resolution": "1920x1080", "bitrate": "4227kbps", "url": "https://d2dslh4sd7yvc1.cloudfront.net/live/omroepwest/ngrp:tv-feed_all/chunklist_b4227072.m3u8"}]}
{"name": "Rijnmond: Livestream", "date": "2020-12-20T15:08:59Z", "formats": [[...], {"id": "hls-4", "format": "m3u8[h264+aac]", "resolution": "1920x1080", "bitrate": "3817kbps", "url": "https://dcur8bjarl5c2.cloudfront.net/live/rijnmond/tv/1600067212-faster-1920-1080-3500000-index.m3u8"}]}
{"name": "RTV Utrecht: Livestream", "date": "2020-12-20T15:08:59Z", "formats": [[...], {"id": "hls-5", "format": "m3u8[h264+aac]", "resolution": "1920x1080", "bitrate": "3030kbps", "url": "https://d18rwjdhpr8dcw.cloudfront.net/live/rtvutrecht/rtvutrecht/1597825675-faster-1920-1080-2750000-index.m3u8"}]}
{"name": "Omroep Gelderland: Livestream", "date": "2020-12-20T15:08:59Z", "formats": [{"id": "hls-1", "format": "m3u8[h264+aac]", "url": "https://d2od87akyl46nm.cloudfront.net/live/omroepgelderland/tvlive/index.m3u8"}]}
{"name": "Omroep Zeeland: Livestream", "date": "2020-12-20T15:08:59Z", "formats": [[...], {"id": "hls-4", "format": "m3u8[h264+aac]", "resolution": "1920x1080", "bitrate": "5917kbps", "url":"https://d3isaxd2t6q8zm.cloudfront.net/live/omroepzeeland/tv/1594052133-fast-1920-1080-5500000-index.m3u8"}]}
{"name": "Omroep Brabant: Livestream", "date": "2020-12-20T15:08:59Z", "formats": [[...], {"id": "hls-5", "format": "m3u8[h264+aac]", "resolution": "1920x1080", "bitrate": "3164kbps", "url": "https://d1ctz4dshc0ubt.cloudfront.net/live/omroepbrabant/tv/1599642273-fast-1920-1080-2750000-index.m3u8"}]}
{"name": "L1: Livestream", "date": "2020-12-20T15:08:59Z", "formats": [[...], {"id": "hls-3", "format": "m3u8[h264+aac]", "resolution": "1280x720", "bitrate": "3817kbps", "url": "https://d34pj260kw1xmk.cloudfront.net/live/l1/tv/1596634197-fast-1280-720-3500000-index.m3u8"}]}

------------------------------------------------------------------------------------------------

Blue Billywig on-demand video-streams:

$ xidel -se '
  for $x in (
    "https://www.omropfryslan.nl/utstjoering/fryslan-hjoed-fan-3-oktober-2020-1800",
    "https://www.rtvnoord.nl/tv/programma/10010/Noord-Vandaag/aflevering/35117",
    "https://www.rtvdrenthe.nl/tv/programma/10/Drenthe-Nu/aflevering/57260",
    "https://www.rtvoost.nl/tv/programma/1035/Thuis-in-Overijssel/aflevering/559728",
    "https://www.omroepwest.nl/tv/programma/170000115/TV-West-Nieuws/aflevering/170345791",
    "https://www.rijnmond.nl/tv/programma/27/Welkom-bij-Rijnmond/aflevering/27246",
    "https://www.rtvutrecht.nl/gemist/uitzending/rtvutrecht/unieuws/20201002-1700",
    "https://www.omroepgelderland.nl/tv/programma/31/GLD-Nieuws/aflevering/43332",
    "https://www.omroepzeeland.nl/tv/programma/370059803/Zeeland-Nu/aflevering/370236927",
    "https://www.omroepbrabant.nl/tv/programma/3116322/Brabant-Nieuws-2020/aflevering/3253165/Brabant-Nieuws",
    "https://l1.nl/l1mburg-centraal-3-oktober-2020-159971"
  ) return
  doc($x)/concat(
    resolve-uri(
      if ($x="https://www.omroepgelderland.nl/tv") then
        extract(
          unparsed-text("https://web.omroepgelderland.nl/epg/tv_vanavond/data/html/script.js"),
          "bbw_media_config_url = &apos;(.+)&apos;",1
        )
      else (
        //@data-media-url,                                                        (: RTV- Noord, Drenthe, Oost, Omroep- West en Gelderland :)
        //article/iframe/@src,                                                    (: RTV Utrecht :)
        //div[
          starts-with(@class,"bluebillywig") or                                   (: Omrop Fryslân :)
          starts-with(@class,"customhtml") or                                     (: Rijnmond :)
          @class="bbwLive-player"                                                 (: L1 :)
        ]/script/@src,
        //div[starts-with(@class,"inlinemedia")]/iframe/@src,                     (: Omroep Zeeland :)
        //div[starts-with(@class,"bluebillywig")]/iframe/@data-src,               (: Omrop Fryslân :)
        parse-json(
          //script/extract(.,"playerInstance\.setup\((.+)\)",1,"s")[.],           (: RTV Utrecht :)
          {"liberal":true()}
        )//file,
        parse-json(//script[@id="__NEXT_DATA__"])/props/pageProps/props/concat(   (: Omroep Brabant :)
          "https://omroepbrabant.bbvms.com/p/default/",
          if (clip) then "c/"||integer(clip) else "q/sourceid_string:"||programId,
          ".json"
        ),
        //div[@class="bbw bbwVideo"]/concat(
          "https://limburg.bbvms.com/p/L1_video/c/",@data-id,".json"              (: L1 :)
        )
      ),
      $x
    ) ! (
      if (ends-with(.,"mp4")) then
        x:request({"method":"HEAD","url":.})/url
      else
        extract(.,".+\.")||"json"
    ),
    " - ",
    //meta[@name="publisher" or @property="og:site_name"]/@content,
    ": ",
    (
      //div[@class="media-details"]/h3,                                            (: RTV- Noord, Drenthe, Oost, Omroep- West, Gelderland, Zeeland en Rijnmond :)
      //div[@class="node-content-wrapper"]/header/normalize-space(h3),             (: Omrop Fryslân :)
      //h1[@class="title-KX" and not(contains(text(),"live"))],                    (: Omroep Brabant :)
      //form[@name="quick_menu2"]//option[@selected],                              (: RTV Utrecht :)
      parse-json(
        //script/substring-after(.,"var msTag = ")[.],                             (: L1 :)
        {"liberal":true()}
      )/data/(content)()
    )
  )
'
https://omropfryslan.bbvms.com/p/omropfryslan_video/c/3930670.json - Omrop Fryslân: Fryslân Hjoed
https://www.rtvnoord.nl/media/bluebillywigplayeroptions/rtv/Tv/35117.json - RTV Noord: Noord Vandaag
https://www.rtvdrenthe.nl/media/bluebillywigplayeroptions/rtv/Tv/57260.json - RTV Drenthe: Drenthe Nu
https://www.rtvoost.nl/media/bluebillywigplayeroptions/rtv/Tv/559728.json - RTV Oost: Thuis in Overijssel
https://omroepwest.bbvms.com/p/regiogrid/q/sourceId_string:170345791.json - Omroep West: TV West Nieuws
https://rijnmond.bbvms.com/p/regiogrid_16-9_responsive/q/sourceid_string:9097D24729832965C12585DD00421C42.json - Rijnmond: Welkom bij Rijnmond
https://content1b.omroep.nl/urishieldv2/[...]/2020/10/02/RTV2079851_MQ.mp4 - RTV Utrecht: UNieuws
https://omroepgelderland.bbvms.com/p/default/q/sourceid_string:SREGIOOG_43332.json - Omroep Gelderland: GLD Nieuws
https://www.omroepzeeland.nl/media/bluebillywigplayeroptions/rtv/Tv/370236927.json - Omroep Zeeland: Zeeland Nu
https://omroepbrabant.bbvms.com/p/default/q/sourceid_string:3253165.json - Omroep Brabant: Brabant Nieuws
https://limburg.bbvms.com/p/L1_video/c/3930664.json - L1: L1mburg Centraal

$ xidel -s --module=xivid.xqm -e '
  for $x in (
    "https://www.omropfryslan.nl/utstjoering/fryslan-hjoed-fan-3-oktober-2020-1800",
    "https://www.rtvnoord.nl/tv/programma/10010/Noord-Vandaag/aflevering/35117",
    "https://www.rtvdrenthe.nl/tv/programma/10/Drenthe-Nu/aflevering/57260",
    "https://www.rtvoost.nl/tv/programma/1035/Thuis-in-Overijssel/aflevering/559728",
    "https://www.omroepwest.nl/tv/programma/170000115/TV-West-Nieuws/aflevering/170345791",
    "https://www.rijnmond.nl/tv/programma/27/Welkom-bij-Rijnmond/aflevering/27246",
    "https://www.rtvutrecht.nl/gemist/uitzending/rtvutrecht/unieuws/20201002-1700",
    "https://www.omroepgelderland.nl/tv/programma/31/GLD-Nieuws/aflevering/43332",
    "https://www.omroepzeeland.nl/tv/programma/370059803/Zeeland-Nu/aflevering/370236927",
    "https://www.omroepbrabant.nl/tv/programma/3116322/Brabant-Nieuws-2020/aflevering/3253165/Brabant-Nieuws",
    "https://l1.nl/l1mburg-centraal-3-oktober-2020-159971"
  )
  let $src:=doc($x),
      $script:=resolve-uri(
        if ($x="https://www.omroepgelderland.nl/tv") then
          extract(
            unparsed-text("https://web.omroepgelderland.nl/epg/tv_vanavond/data/html/script.js"),
            "bbw_media_config_url = &apos;(.+)&apos;",1
          )
        else
          $src/(
            //@data-media-url,                                                        (: RTV- Noord, Drenthe, Oost, Omroep- West en Gelderland :)
            //article/iframe/@src,                                                    (: RTV Utrecht :)
            //div[
              starts-with(@class,"bluebillywig") or                                   (: Omrop Fryslân :)
              starts-with(@class,"customhtml") or                                     (: Rijnmond :)
              @class="bbwLive-player"                                                 (: L1 :)
            ]/script/@src,
            //div[starts-with(@class,"inlinemedia")]/iframe/@src,                     (: Omroep Zeeland :)
            //div[starts-with(@class,"bluebillywig")]/iframe/@data-src,               (: Omrop Fryslân :)
            parse-json(
              //script/extract(.,"playerInstance\.setup\((.+)\)",1,"s")[.],           (: RTV Utrecht :)
              {"liberal":true()}
            )//file,
            parse-json(//script[@id="__NEXT_DATA__"])/props/pageProps/props/concat(   (: Omroep Brabant :)
              "https://omroepbrabant.bbvms.com/p/default/",
              if (clip) then "c/"||integer(clip) else "q/sourceid_string:"||programId,
              ".json"
            ),
            //div[@class="bbw bbwVideo"]/concat(
              "https://limburg.bbvms.com/p/L1_video/c/",@data-id,".json"              (: L1 :)
            )
          ),
        $x
      ),
      $title:=$src/(
        //div[@class="media-details"]/h3,                                            (: RTV- Noord, Drenthe, Oost, Omroep- West, Gelderland, Zeeland en Rijnmond :)
        //div[@class="node-content-wrapper"]/header/normalize-space(h3),             (: Omrop Fryslân :)
        //h1[@class="title-KX" and not(contains(text(),"live"))],                    (: Omroep Brabant :)
        parse-json(
          //script/substring-after(.,"var msTag = ")[.],                             (: L1 :)
          {"liberal":true()}
        )/data/(content)()
      )
  return
  if (ends-with($script,"mp4")) then                                                 (: RTV Utrecht :)
    {
      "name":$src/concat(
        //meta[@name="publisher"]/@content,
        ": ",
        //form[@name="quick_menu2"]//option[@selected]
      ),
      "date":dateTime(
        date(replace($script,".+?(\d+)/(\d+)/(\d+).+","$1-$2-$3")),
        time("00:00:00Z")
      ),
      "formats":array{
        {
          "id":"pg-1",
          "format":"mp4[h264+aac]",
          "url":x:request({"method":"HEAD","url":$script})/url
        }
      }
    }
  else
    xivid:bbvms(
      extract($script,".+\.")||"json",
      $src//meta[@name="publisher" or @property="og:site_name"]/@content,
      if ($title) then $title else "Livestream"
    )
' --printed-json-format=compact
{"name": "Omrop Fryslân: Fryslân Hjoed", "date": "2020-10-03T16:14:52Z", "duration": "PT11M34S", "formats": [[...], {"id": "pg-3", "format": "mp4[h264+aac]", "resolution": "1920x1080", "bitrate": "6134kbps", "url": "https://d3pvma9xb2775h.cloudfront.net/omropfryslan/video/2020/10/03/Asset_HD_FRYSLANHJOED_2020-10-03.mp4"}]}
{"name": "RTV Noord: Noord Vandaag", "date": "2020-10-02T17:00:00Z", "formats": [{"id": "pg-1", "format": "mp4[h264+aac]", "resolution": "720x400", "bitrate": "1200kbps", "url": "https://media.rtvnoord.nl/video/2020/201002/201002_NVREC_XHQ.mp4"}]}
{"name": "RTV Drenthe: Drenthe Nu", "date": "2020-10-04T16:00:00Z", "formats": [{"id": "pg-1", "format": "mp4[h264+aac]", "resolution": "720x400", "bitrate": "1200kbps", "url": "https://av.rtvdrenthe.nl/media/drnl20201004-hhuitz.mp4"}]}
{"name": "RTV Oost: Thuis in Overijssel", "date": "2020-10-04T16:00:00Z", "formats": [{"id": "pg-1", "format": "mp4[h264+aac]", "resolution": "720x400", "bitrate": "1200kbps", "url": "https://tvarchief.rtvoost.nl/hi/559728.mp4"}]}
{"name": "Omroep West: TV West Nieuws", "date": "2020-10-02T16:25:49Z", "formats": [[...], {"id": "pg-3", "format": "mp4[h264+aac]", "resolution": "1280x720", "bitrate": "2000kbps", "url": "https://d3r6frfb0ko02q.cloudfront.net/video/2020/10/02/170345791_2000.mp4"}]}
{"name": "Rijnmond: Welkom bij Rijnmond", "date": "2020-10-04T15:55:06Z", "duration": "PT10M21S", "formats": [[...], {"id": "pg-2", "format": "mp4[h264+aac]", "resolution": "1920x1080", "bitrate": "3602kbps", "url": "https://dcur8bjarl5c2.cloudfront.net/rijnmond/media/2020/10/04/3931211.mp4"}]}
{"name": "RTV Utrecht: UNieuws", "date": "2020-10-02T00:00:00Z", "formats": [{"id": "pg-1", "format": "mp4[h264+aac]", "url": "https://content1b.omroep.nl/urishieldv2/[...]/2020/10/02/RTV2079851_MQ.mp4"}]}
{"name": "Omroep Gelderland: GLD Nieuws", "date": "2020-10-04T15:21:16Z", "formats": [{"id": "sub-1", "format": "srt", "language": "nl", "label": "Nederlands", "url": "https://omroepgelderland.bbvms.com/subtitle/63808.srt"}, {"id": "pg-1", "format": "mp4[h264+aac]", "url": "https://d2od87akyl46nm.cloudfront.net/epg/prod/media/videos/8Y7vw33Qv4W.mp4"}]}
{"name": "Omroep Zeeland: Zeeland Nu", "date": "2020-10-04T17:00:00Z", "formats": [{"id": "pg-1", "format": "mp4[h264+aac]", "resolution": "720x400", "bitrate": "1200kbps", "url": "https://d3isaxd2t6q8zm.cloudfront.net/omroepzeeland/media/2020/10/04/Asset_HD_370236927-Zeeland-Nu-04-10-2020-ZNB201002NG.mp4"}]}
{"name": "Omroep Brabant: Brabant Nieuws", "date": "2020-10-02T16:16:09Z", "duration": "PT13M48S", "formats": [{"id": "sub-1", "format": "srt", "language": "nl", "label": "Nederlands", "url": "https://omroepbrabant.bbvms.com/subtitle/63441.srt"}, [...], {"id": "pg-6", "format": "mp4[h264+aac]", "resolution": "1920x1080", "bitrate": "3500kbps", "url": "https://d1ctz4dshc0ubt.cloudfront.net/omroepbrabant/2020/video/3253165_ehq.mp4"}, {"id": "pg-7", "format": "mxf[h264+aac]", "resolution": "1920x1080", "bitrate": "54049kbps", "url": "https://s3.eu-west-1.amazonaws.com/mm.omroepbrabant.bbvms.com/upload/omroepbrabant/3253165.mxf"}]}
{"name": "L1: L1mburg Centraal", "date": "2020-10-03T16:06:51Z", "duration": "PT23M36S", "formats": [[...], {"id": "pg-2", "format": "mp4[h264+aac]", "resolution": "1280x720", "bitrate": "3500kbps", "url": "https://d34pj260kw1xmk.cloudfront.net/video/201003-180111-589_720.mp4"}]}

------------------------------------------------------------------------------------------------

declare function xivid:regio($url as string) as object()? {
  let $src:=doc($url),
      $script:=resolve-uri(
        if ($url="https://www.omroepgelderland.nl/tv") then
          extract(
            unparsed-text("https://web.omroepgelderland.nl/epg/tv_vanavond/data/html/script.js"),
            "bbw_media_config_url = &apos;(.+)&apos;",1
          )
        else
          $src/(
            //@data-media-url,
            //article/iframe/@src,
            //div[
              starts-with(@class,"bluebillywig") or
              starts-with(@class,"customhtml") or
              @class="bbwLive-player"
            ]/script/@src,
            //div[starts-with(@class,"inlinemedia")]/iframe/@src,
            //div[starts-with(@class,"bluebillywig")]/iframe/@data-src,
            parse-json(
              //script/extract(.,"playerInstance\.setup\((.+)\)",1,"s")[.],
              {"liberal":true()}
            )//file,
            parse-json(//script[@id="__NEXT_DATA__"])/props/pageProps/props/concat(
              "https://omroepbrabant.bbvms.com/p/default/",
              if (clip) then "c/"||integer(clip) else "q/sourceid_string:"||programId,
              ".json"
            ),
            //div[@class="bbw bbwVideo"]/concat(
              "https://limburg.bbvms.com/p/L1_video/c/",@data-id,".json"
            )
          ),
        $url
      ),
      $title:=$src/(
        //div[@class="media-details"]/h3,
        //div[@class="node-content-wrapper"]/header/normalize-space(h3),
        //h1[@class="title-KX" and not(contains(text(),"live"))],
        parse-json(
          //script/substring-after(.,"var msTag = ")[.],
          {"liberal":true()}
        )/data/(content)()
      )
  return
  if (ends-with($script,"mp4")) then
    {
      "name":$src/concat(
        //meta[@name="publisher"]/@content,
        ": ",
        //form[@name="quick_menu2"]//option[@selected]
      ),
      "date":dateTime(
        date(replace($script,".+?(\d+)/(\d+)/(\d+).+","$1-$2-$3")),
        time("00:00:00Z")
      ),
      "formats":array{
        {
          "id":"pg-1",
          "format":"mp4[h264+aac]",
          "url":x:request({"method":"HEAD","url":$script})/url
        }
      }
    }
  else
    xivid:bbvms(
      extract($script,".+\.")||"json",
      $src//meta[@name="publisher" or @property="og:site_name"]/@content,
      if ($title) then $title else "Livestream"
    )
};

================================================================================================

[nh nieuws, at5]

$ url=https://www.nhnieuws.nl/media

$ xidel -s --module=xivid.xqm -e 'doc("'$url'")/{"name":substring-after(//title,"Media - ")||": Livestream","date":substring(adjust-dateTime-to-timezone(current-dateTime() + duration("PT0.5S"),duration("PT0S")),1,19)||"Z","formats":xivid:m3u8-to-json(parse-json(//script/substring-after(.,"INIT_DATA__ = ")[.])/videoStream)}'
{
  "name": "NH Nieuws: Livestream",
  "date": "2020-09-15T14:43:47Z",
  "formats": [
    {
      "id": "hls-0",
      "format": "m3u8[manifest]",
      "url": "https://ngx.cr2.streamzilla.xlcdn.com/session/b698f6a49ad321c97d82cbdcc113c215/sz/nhnieuws/wowza4/live/live.smil/playlist.m3u8?token=zdtc3K3vbDbL2JQjfGuHtg&time=1600212413"
    },
    {
      "id": "hls-1",
      "format": "m3u8[h264+aac]",
      "resolution": "640x360",
      "bitrate": "1153kbps",
      "url": "https://ngx.cr2.streamzilla.xlcdn.com/session/b698f6a49ad321c97d82cbdcc113c215/sz/nhnieuws/wowza4/live/live.smil/chunklist_b1048576.m3u8"
    },
    [...]
    {
      "id": "hls-3",
      "format": "m3u8[h264+aac]",
      "resolution": "1920x1080",
      "bitrate": "3487kbps",
      "url": "https://ngx.cr2.streamzilla.xlcdn.com/session/b698f6a49ad321c97d82cbdcc113c215/sz/nhnieuws/wowza4/live/live.smil/chunklist_b3170304.m3u8"
    }
  ]
}

$ url=https://www.at5.nl/media

$ xidel -s --module=xivid.xqm -e '[...]'
{
  "name": "AT5: Livestream",
  "date": "2020-09-15T14:44:38Z",
  "formats": [
    {
      "id": "hls-0",
      "format": "m3u8[manifest]",
      "url": "https://ngx.cr1.streamzilla.xlcdn.com/session/6a5316f25c9c3bd8071b45ab1ccb62d4/sz/atvijf/wowza4/live/live.smil/playlist.m3u8?token=Rv1VyO3DDzV0Iv4qcroKGQ&time=1600213524"
    },
    {
      "id": "hls-1",
      "format": "m3u8[h264+aac]",
      "resolution": "640x512",
      "bitrate": "1153kbps",
      "url": "https://ngx.cr1.streamzilla.xlcdn.com/session/6a5316f25c9c3bd8071b45ab1ccb62d4/sz/atvijf/wowza4/live/live.smil/chunklist_b1048576.m3u8"
    },
    {
      "id": "hls-2",
      "format": "m3u8[h264+aac]",
      "resolution": "768x608",
      "bitrate": "2307kbps",
      "url": "https://ngx.cr1.streamzilla.xlcdn.com/session/6a5316f25c9c3bd8071b45ab1ccb62d4/sz/atvijf/wowza4/live/live.smil/chunklist_b2097152.m3u8"
    },
    {
      "id": "hls-3",
      "format": "m3u8[h264+aac]",
      "resolution": "1920x1536",
      "bitrate": "3460kbps",
      "url": "https://ngx.cr1.streamzilla.xlcdn.com/session/6a5316f25c9c3bd8071b45ab1ccb62d4/sz/atvijf/wowza4/live/live.smil/chunklist_b3145728.m3u8"
    }
  ]
}

------------------------------------------------------------------------------------------------

$ url=https://www.nhnieuws.nl/nieuws/273051/overval-op-cafe-in-enkhuizen-de-barvrouw-rende-gillend-de-straat-op

$ xidel -s --module=xivid.xqm -e 'doc("'$url'")/(if (//article) then parse-json(//script/substring-after(.,"INITIAL_PROPS__ = ")[.])/pageData/{"name":(blocks)()[type="video"]/video/concat(author,": ",caption),"date":updated * duration("PT1S") + dateTime("1970-01-01T00:00:00Z"),"formats":xivid:m3u8-to-json(.//stream/url)} else {"name":substring-after(//title,"Media - ")||": Livestream","date":substring(adjust-dateTime-to-timezone(current-dateTime() + duration("PT0.5S"),duration("PT0S")),1,19)||"Z","formats":xivid:m3u8-to-json(parse-json(//script/substring-after(.,"INIT_DATA__ = ")[.])/videoStream)})'
{
  "name": "NH Nieuws: Overval op café de Vriendschap in Enkhuizen",
  "date": "2020-09-15T21:23:50Z",
  "formats": [
    {
      "id": "hls-0",
      "format": "m3u8[manifest]",
      "url": "https://wos.cr2.streamzilla.xlcdn.com/session/8ec1ff7f8b2ca8e2c4126e3de4a5bdcf/vod/_definst_/sz/nhnieuws/2020/09/15/5f61304eb80485f61304eb8083.smil/playlist.m3u8?token=1Ap_J1m9OXzue2kBVtcv6w&time=1600216187"
    },
    {
      "id": "hls-1",
      "format": "m3u8[h264+aac]",
      "resolution": "568x320",
      "bitrate": "649kbps",
      "url": "https://wos.cr2.streamzilla.xlcdn.com/session/8ec1ff7f8b2ca8e2c4126e3de4a5bdcf/vod/_definst_/sz/nhnieuws/2020/09/15/5f61304eb80485f61304eb8083.smil/chunklist_b589824.m3u8"
    },
    [...]
    {
      "id": "hls-4",
      "format": "m3u8[h264+aac]",
      "resolution": "1920x1080",
      "bitrate": "4794kbps",
      "url": "https://wos.cr2.streamzilla.xlcdn.com/session/8ec1ff7f8b2ca8e2c4126e3de4a5bdcf/vod/_definst_/sz/nhnieuws/2020/09/15/5f61304eb80485f61304eb8083.smil/chunklist_b4358144.m3u8"
    }
  ]
}

$ url=https://www.at5.nl/artikelen/e28238/inbrekers-gefilmd-terwijl-ze-een-woning-in-amstelveen-overhoop-halen

$ xidel -s --module=xivid.xqm -e 'doc("'$url'")/(if (//article) then parse-json(//script/substring-after(.,"INITIAL_PROPS__ = ")[.])/pageData/{"name":let $info:=(blocks)()[type=("video","headerVideo")]/video return if ($info/caption) then $info/concat(author,": ",caption) else concat(media//author,": ",title),"date":updated * duration("PT1S") + dateTime("1970-01-01T00:00:00Z"),"formats":xivid:m3u8-to-json(.//stream/url)} else {"name":substring-after(//title,"Media - ")||": Livestream","date":substring(adjust-dateTime-to-timezone(current-dateTime() + duration("PT0.5S"),duration("PT0S")),1,19)||"Z","formats":xivid:m3u8-to-json(parse-json(//script/substring-after(.,"INIT_DATA__ = ")[.])/videoStream)})'
{
  "name": "AT5: Inbrekers gefilmd terwijl ze een woning in Amstelveen overhoop halen",
  "date": "2020-04-05T11:13:35Z",
  "formats": [
    {
      "id": "hls-0",
      "format": "m3u8[manifest]",
      "url": "https://wos.cr2.streamzilla.xlcdn.com/session/84999fac2f88ccc249d84f3d1ba508b7/vod/_definst_/sz/atvijf/2020/04/01/5e847e53d70f55e847e53d712f.smil/playlist.m3u8?token=SiKAx0WbOt0yBatLKnfpEw&time=1600217812"
    },
    {
      "id": "hls-1",
      "format": "m3u8[h264+aac]",
      "resolution": "568x320",
      "bitrate": "649kbps",
      "url": "https://wos.cr2.streamzilla.xlcdn.com/session/84999fac2f88ccc249d84f3d1ba508b7/vod/_definst_/sz/atvijf/2020/04/01/5e847e53d70f55e847e53d712f.smil/chunklist_b589926.m3u8"
    },
    [...]
    {
      "id": "hls-4",
      "format": "m3u8[h264+aac]",
      "resolution": "1920x1080",
      "bitrate": "5924kbps",
      "url": "https://wos.cr2.streamzilla.xlcdn.com/session/84999fac2f88ccc249d84f3d1ba508b7/vod/_definst_/sz/atvijf/2020/04/01/5e847e53d70f55e847e53d712f.smil/chunklist_b5385216.m3u8"
    }
  ]
}

------------------------------------------------------------------------------------------------

declare function xivid:nhnieuws($url as string) as object()? {
  doc($url)/(
    if (//article) then
      parse-json(
        //script/substring-after(.,"INITIAL_PROPS__ = ")[.]
      )/pageData/{
        "name":let $info:=(blocks)()[type=("video","headerVideo")]/video return
        if ($info/caption) then
          $info/concat(author,": ",caption)
        else
          concat(media//author,": ",title),
        "date":updated * duration("PT1S") + dateTime("1970-01-01T00:00:00Z"),
        "formats":xivid:m3u8-to-json(.//stream/url)
      }
    else {
      "name":substring-after(//title,"Media - ")||": Livestream",
      "date":substring(
        adjust-dateTime-to-timezone(
          current-dateTime() + duration("PT0.5S"),
          duration("PT0S")
        ),
        1,19
      )||"Z",
      "formats":xivid:m3u8-to-json(
        parse-json(
          //script/substring-after(.,"INIT_DATA__ = ")[.]
        )/videoStream
      )
    }
  )
};

================================================================================================

[omroep flevoland]

$ url=https://www.omroepflevoland.nl/

$ xidel -s --module=xivid.xqm -e '{"name":"Omroep Flevoland: Livestream","date":substring(adjust-dateTime-to-timezone(current-dateTime() + duration("PT0.5S"),duration("PT0S")),1,19)||"Z","formats":xivid:m3u8-to-json(doc("'$url'")//div[@class="fn-jw-player fn-videoplayer"]/@data-file)}'
{
  "name": "Omroep Flevoland: Livestream",
  "date": "2020-09-16T14:54:05Z",
  "formats": [
    {
      "id": "hls-0",
      "format": "m3u8[manifest]",
      "url": "https://d5ms27yy6exnf.cloudfront.net/live/omroepflevoland/tv/index.m3u8"
    },
    {
      "id": "hls-1",
      "format": "m3u8[h264+aac]",
      "resolution": "480x270@25fps",
      "bitrate": "528kbps",
      "url": "https://d5ms27yy6exnf.cloudfront.net/live/omroepflevoland/tv/400/prog_index.m3u8"
    },
    [...]
    {
      "id": "hls-4",
      "format": "m3u8[h264+aac]",
      "resolution": "1280x720@25fps",
      "bitrate": "2128kbps",
      "url": "https://d5ms27yy6exnf.cloudfront.net/live/omroepflevoland/tv/2000/prog_index.m3u8"
    }
  ]
}

------------------------------------------------------------------------------------------------

$ url=https://www.omroepflevoland.nl/gemist/video/200915-dif

$ xidel -se 'doc("'$url'")//div[@class="card__info t--xsm"]/span/normalize-space()'
Di 15-09-2020
| 17:00

$ xidel -s --module=xivid.xqm -e 'doc("'$url'")//div[@class="card__info t--xsm"]/join(span/extract(.,"[\d:-]+",0,"*")) ! (.,xivid:string-to-utc-dateTime(.))'
15-09-2020 17:00
2020-09-15T15:00:00Z

$ xidel -s --module=xivid.xqm -e 'doc("'$url'")/(let $info:=//div[@class="fn-jw-player fn-videoplayer"] return if ($info/@data-has-streams) then {"name":"Omroep Flevoland: Livestream","date":substring(adjust-dateTime-to-timezone(current-dateTime() + duration("PT0.5S"),duration("PT0S")),1,19)||"Z","formats":xivid:m3u8-to-json($info/@data-file)} else {"name":"Omroep Flevoland: "||$info/@data-title,"date":xivid:string-to-utc-dateTime(//div[@class="card__info t--xsm"]/join(span/extract(.,"[\d:-]+",0,"*"))),"formats":array{{"id":"pg-1","format":"mp4[h264+aac]","resolution":"960x540","url":$info/@data-file}}})'
{
  "name": "Omroep Flevoland: Dit is Flevoland nieuws",
  "date": "2020-09-15T15:00:00Z",
  "formats": [
    {
      "id": "pg-1",
      "format": "mp4[h264+aac]",
      "resolution": "960x540",
      "url": "https://d5ms27yy6exnf.cloudfront.net/video/middel/200915_DIF.mp4"
    }
  ]
}

------------------------------------------------------------------------------------------------

$ url=https://www.omroepflevoland.nl/nieuws/193656/massale-zoekactie-naar-verdachte-van-misdrijf

$ xidel -s --module=xivid.xqm -e 'doc("ofl_193656.htm")//div[@class="card__info t--xsm"]/join(if (.//span[@class="d--block--sm"]) then extract(.//span[@class="d--block--sm"],"(\d+ \w+ \d+) \| ([\d:]+)",(1,2)) else span/extract(.,"[\d:-]+",0,"*")) ! (.,xivid:string-to-utc-dateTime(.))'
14 september 2020 19:27
2020-09-14T17:27:00Z

$ xidel -s --module=xivid.xqm -e 'doc("'$url'")/(let $info:=//div[@class="fn-jw-player fn-videoplayer"] return if ($info/@data-has-streams) then {"name":"Omroep Flevoland: Livestream","date":substring(adjust-dateTime-to-timezone(current-dateTime() + duration("PT0.5S"),duration("PT0S")),1,19)||"Z","formats":xivid:m3u8-to-json($info/@data-file)} else {"name":concat("Omroep Flevoland: ",if ($info/normalize-space(@data-title)) then $info/@data-title else normalize-space(//h2)),"date":xivid:string-to-utc-dateTime(//div[@class="card__info t--xsm"]/join(if (.//span[@class="d--block--sm"]) then extract(.//span[@class="d--block--sm"],"(\d+ \w+ \d+) \| ([\d:]+)",(1,2)) else span/extract(.,"[\d:-]+",0,"*"))),"formats":array{{"id":"pg-1","format":"mp4[h264+aac]","resolution":"960x540","url":$info/@data-file}}})'
{
  "name": "Omroep Flevoland: Massale zoekactie naar verdachte van misdrijf",
  "date": "2020-09-14T17:27:00Z",
  "formats": [
    {
      "id": "pg-1",
      "format": "mp4[h264+aac]",
      "resolution": "960x540",
      "url": "https://d5ms27yy6exnf.cloudfront.net/video/middel/200915_Zoekactie_Lelystad2.mp4"
    }
  ]
}

------------------------------------------------------------------------------------------------

declare function xivid:ofl($url as string) as object()? {
  doc($url)/(
    let $info:=//div[@class="fn-jw-player fn-videoplayer"] return
    if ($info/@data-has-streams) then {
      "name":"Omroep Flevoland: Livestream",
      "date":substring(
        adjust-dateTime-to-timezone(
          current-dateTime() + duration("PT0.5S"),
          duration("PT0S")
        ),
        1,19
      )||"Z",
      "formats":xivid:m3u8-to-json($info/@data-file)
    } else {
      "name":concat(
        "Omroep Flevoland: ",
        if ($info/normalize-space(@data-title)) then
          $info/@data-title
        else
          normalize-space(//h2)
      ),
      "date":xivid:string-to-utc-dateTime(
        //div[@class="card__info t--xsm"]/join(
          if (.//span[@class="d--block--sm"]) then
            extract(
              .//span[@class="d--block--sm"],
              "(\d+ \w+ \d+) \| ([\d:]+)",(1,2)
            )
          else
            span/extract(.,"[\d:-]+",0,"*")
          )
      ),
      "formats":array{
        {
          "id":"pg-1",
          "format":"mp4[h264+aac]",
          "resolution":"960x540",
          "url":$info/@data-file
        }
      }
    }
  )
};

================================================================================================

[telegraaf]

$ url=https://www.telegraaf.nl/video/823947308/ordinaire-verkeersruzie-op-snelweg-a10

$ xidel -se 'concat("https://content.tmgvideo.nl/playlist/item=",parse-json(doc("'$url'")//script/extract(.,"APOLLO_STATE__=(.+);",1)[.])/(.//videoId)[1],"/playlist.json")'
https://content.tmgvideo.nl/playlist/item=WiVkrqlbQ5OW/playlist.json

$ xidel -se 'json-doc(concat("https://content.tmgvideo.nl/playlist/item=",parse-json(doc("'$url'")//script/extract(.,"APOLLO_STATE__=(.+);",1)[.])/(.//videoId)[1],"/playlist.json"))/(items)()'
{
  "id": "WiVkrqlbQ5OW",
  "account": "Kx1PKc",
  "audioonly": false,
  "live": false,
  "title": "Ordinaire verkeersruzie op snelweg A10_duplicated",
  "description": "Twee automobilisten krijgen op de ring van Amsterdam dusdanig ruzie dat ze elkaar van de weg proberen te rijden. Ook iets gefilmd? Mail het ons via verkeer@telegraaf.nl ",
  "poster": "//content.tmgvideo.nl/img/account=Kx1PKc/item=WiVkrqlbQ5OW/thumbid=1/image.jpg?v=20200904190849",
  "datecreated": "2020-09-04 19:07:28",
  "duration": 53,
  "locations": {
    "progressive": [
      {
        "label": "1080p",
        "height": 1080,
        "width": 1920,
        "sources": [
          {
            "type": "video/mp4",
            "src": "https://media.tmgvideo.nl/progressive/account=Kx1PKc/item=WiVkrqlbQ5OW/file=XqFlquTLAxuy/WiVkrqlbQ5OW.mp4"
          }
        ]
      },
      [...]
      {
        "label": "270p",
        "height": 270,
        "width": 480,
        "sources": [
          {
            "type": "video/mp4",
            "src": "https://media.tmgvideo.nl/progressive/account=Kx1PKc/item=WiVkrqlbQ5OW/file=TgVlr6FLSJiS/WiVkrqlbQ5OW.mp4"
          }
        ]
      }
    ],
    "adaptive": [
      {
        "type": "application/dash+xml",
        "src": "https://media.tmgvideo.nl/dash/account=Kx1PKc/item=WiVkrqlbQ5OW/WiVkrqlbQ5OW.mpd?v=20200904190849_5"
      },
      {
        "type": "application/x-mpegURL",
        "src": "https://media.tmgvideo.nl/hls/account=Kx1PKc/item=WiVkrqlbQ5OW/WiVkrqlbQ5OW.m3u8?v=20200904190849_5"
      }
    ]
  },
  [...]
  "publishedstart": "2020-09-04 18:57:14",
  "publishedend": "2035-09-04 19:07:14",
  [...]
}

$ xidel -s --module=xivid.xqm -e 'json-doc(concat("https://content.tmgvideo.nl/playlist/item=",parse-json(doc("'$url'")//script/extract(.,"APOLLO_STATE__=(.+);",1)[.])/(.//videoId)[1],"/playlist.json"))/(items)()/{"name":"Telegraaf: "||title,"date":xivid:string-to-utc-dateTime(replace(publishedstart,"\s","T")),"duration":duration * duration("PT1S"),"expdate":publishedend ! xivid:string-to-utc-dateTime(replace(.,"\s","T")),"formats":array{locations/reverse((progressive)())/{"id":"pg-"||position(),"format":"mp4[h264+aac]","resolution":concat(width,"x",height),"url":.//src},xivid:m3u8-to-json(locations/(adaptive)()[type="application/x-mpegURL"]/extract(src,".+m3u8"))()}}'
{
  "name": "Telegraaf: Ordinaire verkeersruzie op snelweg A10_duplicated",
  "date": "2020-09-04T16:57:14Z",
  "duration": "PT53S",
  "expdate": "2035-09-04T17:07:14Z",
  "formats": [
    {
      "id": "pg-1",
      "format": "mp4[h264+aac]",
      "resolution": "480x270",
      "url": "https://media.tmgvideo.nl/progressive/account=Kx1PKc/item=WiVkrqlbQ5OW/file=TgVlr6FLSJiS/WiVkrqlbQ5OW.mp4"
    },
    [...]
    {
      "id": "pg-5",
      "format": "mp4[h264+aac]",
      "resolution": "1920x1080",
      "url": "https://media.tmgvideo.nl/progressive/account=Kx1PKc/item=WiVkrqlbQ5OW/file=XqFlquTLAxuy/WiVkrqlbQ5OW.mp4"
    },
    {
      "id": "hls-0",
      "format": "m3u8[manifest]",
      "url": "https://media.tmgvideo.nl/hls/account=Kx1PKc/item=WiVkrqlbQ5OW/WiVkrqlbQ5OW.m3u8"
    },
    {
      "id": "hls-1",
      "format": "m3u8[aac]",
      "bitrate": "64kbps",
      "url": "https://media.tmgvideo.nl/hls/account=Kx1PKc/item=WiVkrqlbQ5OW/WiVkrqlbQ5OW-19700101_1-audio=64000.m3u8"
    },
    [...]
    {
      "id": "hls-7",
      "format": "m3u8[h264+aac]",
      "resolution": "1920x1080",
      "bitrate": "3600|128kbps",
      "url": "https://media.tmgvideo.nl/hls/account=Kx1PKc/item=WiVkrqlbQ5OW/WiVkrqlbQ5OW-19700101_1-audio=128000-video=3600000.m3u8"
    }
  ]
}

------------------------------------------------------------------------------------------------

declare function xivid:telegraaf($url as string) as object()? {
  json-doc(
    concat(
      "https://content.tmgvideo.nl/playlist/item=",
      parse-json(
        doc($url)//script/extract(.,"APOLLO_STATE__=(.+);",1)[.]
      )/(.//videoId)[1],
      "/playlist.json"
    )
  )/(items)()/{
    "name":"Telegraaf: "||title,
    "date":xivid:string-to-utc-dateTime(
      replace(publishedstart,"\s","T")
    ),
    "duration":duration * duration("PT1S"),
    "expdate":publishedend ! xivid:string-to-utc-dateTime(
      replace(.,"\s","T")
    ),
    "formats":array{
      locations/reverse((progressive)())/{
        "id":"pg-"||position(),
        "format":"mp4[h264+aac]",
        "resolution":concat(width,"x",height),
        "url":.//src
      },
      xivid:m3u8-to-json(
        locations/(adaptive)()[type="application/x-mpegURL"]/extract(src,".+m3u8")
      )()
    }
  }
};

================================================================================================

[ad]

$ url=https://www.ad.nl/video/loekasjenko-voorziet-val-poetin-bij-zijn-vertrek~p167517

$ xidel -se 'let $id:=extract("'$url'","~p(\d+)",1) return concat("https://embed.mychannels.video/sdk/production/",$id,"?options=FUTFU_default")'
https://embed.mychannels.video/sdk/production/167517?options=FUTFU_default

$ xidel -se 'let $id:=extract("'$url'","~p(\d+)",1) return json-doc(concat("https://embed.mychannels.video/sdk/production/",$id,"?options=FUTFU_default"))'
{
  "shows": [
    {
      "title": "Snel Nieuws",
      "id": 921,
      "channelId": 401,
      "adsForbidden": false
    }
  ],
  "productions": [
    {
      "title": "Loekasjenko voorziet val Poetin bij zijn vertrek",
      "theme": "News",
      "sources": [
        {
          "type": "application/vnd.apple.mpegurl",
          "src": "https://tkx.apis.anvato.net/rest/v2/mcp/video/10189472~~syv8ed1JI0T0eA/master.m3u8?anvack=yjqOEWaqi37WK2u26oMesa6LMGiJNeZl"
        },
        {
          "type": "video/mp4",
          "src": "https://tkx.apis.anvato.net/rest/v2/mcp/video/10189472~~s2i9P90Fbwq6eGBWZVaiE7k?anvack=yjqOEWaqi37WK2u26oMesa6LMGiJNeZl"
        },
        {
          "type": "video/mp4",
          "src": "https://tkx.apis.anvato.net/rest/v2/mcp/video/10189472~~s2i9P90ObQr0eChTZxDs?anvack=yjqOEWaqi37WK2u26oMesa6LMGiJNeZl"
        }
      ],
      "showId": 921,
      "publication_status": "published",
      "publicationDate": "2020-09-08 20:24:00",
      "premium": "free",
      "posterUrl": "https://img.mychannels.video/imgix/e1517301-3717-462f-9672-491dc3bc66fdU3RpbGwxLmpwZw==.jpg?dpr=1&h=383&w=680&fit=cover&auto=format%2Ccompress&fm=jpg&q=75&crop=focalpoint&fp-x=0.5&fp-y=0.35",
      "playerSkin": "default",
      "origin": "origin_ap_associated_press",
      "ooyalaId": "10189472",
      "live": false,
      "interactiveAdsEnabled": true,
      "id": 167517,
      "genreId": 10,
      "durationFormatted": "01:03",
      "duration": 63,
      "displayLogo": true,
      "description": null,
      "clickoutUrlTimeOffset": null,
      "clickoutUrl": null,
      "clickoutTitle": null,
      "adsEnabled": true
    }
  ],
  [...]
}

$ xidel -s --module=xivid.xqm -e 'let $id:=extract("'$url'","~p(\d+)",1),$json:=json-doc(concat("https://embed.mychannels.video/sdk/production/",$id,"?options=FUTFU_default")) return $json/map:merge(({"name":concat("AD: ",(shows)()/title," - ",(productions)()/title)},(productions)()/{"date":xivid:string-to-utc-dateTime(replace(publicationDate,"\s","T")),"duration":duration * duration("PT1S"),"formats":array{for $x at $i in reverse((sources)()[type="video/mp4"]) return {"id":"pg-"||$i,"format":"mp4[h264+aac]","resolution":("640x360","1280x720")[$i],"url":$x/src},xivid:m3u8-to-json((sources)(1)/src)()}}))'
{
  "name": "AD: Snel Nieuws - Loekasjenko voorziet val Poetin bij zijn vertrek",
  "date": "2020-09-08T18:24:00Z",
  "duration": "PT1M3S",
  "formats": [
    {
      "id": "pg-1",
      "format": "mp4[h264+aac]",
      "resolution": "640x360",
      "url": "https://tkx.apis.anvato.net/rest/v2/mcp/video/10189472~~s2i9P90ObQr0eChTZxDs?anvack=yjqOEWaqi37WK2u26oMesa6LMGiJNeZl"
    },
    {
      "id": "pg-2",
      "format": "mp4[h264+aac]",
      "resolution": "1280x720",
      "url": "https://tkx.apis.anvato.net/rest/v2/mcp/video/10189472~~s2i9P90Fbwq6eGBWZVaiE7k?anvack=yjqOEWaqi37WK2u26oMesa6LMGiJNeZl"
    },
    {
      "id": "hls-0",
      "format": "m3u8[manifest]",
      "url": "https://tkx.apis.anvato.net/rest/v2/mcp/video/10189472~~syv8ed1JI0T0eA/master.m3u8?anvack=yjqOEWaqi37WK2u26oMesa6LMGiJNeZl"
    },
    {
      "id": "hls-1",
      "format": "m3u8[h264+aac]",
      "resolution": "320x180@30fps",
      "bitrate": "481kbps",
      "url": "https://dcs-vod.apis.anvato.net/vod/p/481400/prog.m3u8?i=i177995814-n9cf68072-49de-4ea2-bb30-8091382629a5&anvtrid=44f60006fd92471886f64add2915d34d"
    },
    [...]
    {
      "id": "hls-5",
      "format": "m3u8[h264+aac]",
      "resolution": "1280x720@30fps",
      "bitrate": "2510kbps",
      "url": "https://dcs-vod.apis.anvato.net/vod/p/2510000/prog.m3u8?i=i177995814-n9cf68072-49de-4ea2-bb30-8091382629a5&anvtrid=44f60006fd92471886f64add2915d34d"
    }
  ]
}

------------------------------------------------------------------------------------------------

$ url=https://www.ad.nl/koken-en-eten/keukenheks-pasta-droog-en-klef-bij-het-opwarmen-niet-met-deze-truc~ae79204f/

$ xidel -se 'x:request({"headers":"Cookie: authId=8ac8ac9f-3782-4ba2-a449-9dc1fcdacbd5","url":"'$url'"})/doc//div[@data-mychannels-type="video"]/outer-html()'   # Is "authId" altijd hetzelfde?
<div xmlns="http://www.w3.org/2000/svg" class="mychannels" data-mychannels-type="video" data-mychannels-id="138236" data-mychannels-options="FUTFU_default"></div>

$ xidel -se 'let $id:=extract("'$url'","~p(\d+)",1) return concat("https://embed.mychannels.video/sdk/production/",if ($id) then $id else x:request({"headers":"Cookie: authId=8ac8ac9f-3782-4ba2-a449-9dc1fcdacbd5","url":"'$url'"})/doc//div[@data-mychannels-type="video"]/@data-mychannels-id,"?options=FUTFU_default")'
https://embed.mychannels.video/sdk/production/138236?options=FUTFU_default

$ xidel -s --module=xivid.xqm -e 'let $id:=extract("'$url'","~p(\d+)",1),$json:=json-doc(concat("https://embed.mychannels.video/sdk/production/",if ($id) then $id else x:request({"headers":"Cookie: authId=8ac8ac9f-3782-4ba2-a449-9dc1fcdacbd5","url":"'$url'"})/doc//div[@data-mychannels-type="video"]/@data-mychannels-id,"?options=FUTFU_default")) return $json/map:merge(({"name":concat("AD: ",(shows)()/title," - ",(productions)()/title)},(productions)()/{"date":xivid:string-to-utc-dateTime(replace(publicationDate,"\s","T")),"duration":duration * duration("PT1S"),"formats":array{for $x at $i in reverse((sources)()[type="video/mp4"]) return {"id":"pg-"||$i,"format":"mp4[h264+aac]","resolution":("640x360","1280x720")[$i],"url":$x/src},xivid:m3u8-to-json((sources)(1)/src)()}}))'
{
  "name": "AD: Keuken Heks - Pasta droog en klef bij het opwarmen? Niet met deze truc",
  "date": "2020-07-30T09:27:00Z",
  "duration": "PT44S",
  "formats": [
    {
      "id": "pg-1",
      "format": "mp4[h264+aac]",
      "resolution": "640x360",
      "url": "https://tkx.apis.anvato.net/rest/v2/mcp/video/10131662~~s2i9P90ObQr0eChTZxDs?anvack=yjqOEWaqi37WK2u26oMesa6LMGiJNeZl"
    },
    {
      "id": "pg-2",
      "format": "mp4[h264+aac]",
      "resolution": "1280x720",
      "url": "https://tkx.apis.anvato.net/rest/v2/mcp/video/10131662~~s2i9P90Fbwq6eGBWZVaiE7k?anvack=yjqOEWaqi37WK2u26oMesa6LMGiJNeZl"
    },
    {
      "id": "hls-0",
      "format": "m3u8[manifest]",
      "url": "https://tkx.apis.anvato.net/rest/v2/mcp/video/10131662~~syv8ed1JI0T0eA/master.m3u8?anvack=yjqOEWaqi37WK2u26oMesa6LMGiJNeZl"
    },
    {
      "id": "hls-1",
      "format": "m3u8[h264+aac]",
      "resolution": "320x180@30fps",
      "bitrate": "481kbps",
      "url": "https://dcs-vod.apis.anvato.net/vod/p/481400/prog.m3u8?i=i176422958-nf6457c55-cbe0-404d-8bbb-230c0e6a7a7e&anvtrid=acc8a8532bedfd557d7c79bb19a237f0"
    },
    [...]
    {
      "id": "hls-5",
      "format": "m3u8[h264+aac]",
      "resolution": "1280x720@30fps",
      "bitrate": "2510kbps",
      "url": "https://dcs-vod.apis.anvato.net/vod/p/2510000/prog.m3u8?i=i176422958-nf6457c55-cbe0-404d-8bbb-230c0e6a7a7e&anvtrid=acc8a8532bedfd557d7c79bb19a237f0"
    }
  ]
}

------------------------------------------------------------------------------------------------

$ url=https://www.ad.nl/dossier-autotest/test-tesla-model-3-geniaal-maar-ook-onhandig~aaf9e018/

$ xidel -se 'x:request({"headers":"Cookie: authId=8ac8ac9f-3782-4ba2-a449-9dc1fcdacbd5","url":"'$url'"})/doc//iframe[@class="mc-embed"]/outer-html()'
<iframe xmlns="http://www.w3.org/2000/svg" allowfullscreen="" class="mc-embed" height="100%" mozallowfullscreen="" src="https://mychannels.video/embed/66560?automute=true&amp;autoplay=true&amp;autoplay_onscreen=true&amp;display_logo=true&amp;play_ads=true&amp;single_play=true" style="border: 0; position: absolute; left:0; top: 0; overflow:hidden;" webkitallowfullscreen="" width="100%"></iframe>

$ xidel -se 'let $id:=extract("'$url'","~p(\d+)",1) return concat("https://embed.mychannels.video/sdk/production/",if ($id) then $id else x:request({"headers":"Cookie: authId=8ac8ac9f-3782-4ba2-a449-9dc1fcdacbd5","url":"'$url'"})/doc/(if (//iframe[@class="mc-embed"]) then //iframe[@class="mc-embed"]/extract(@src,"\d+") else //div[@data-mychannels-type="video"]/@data-mychannels-id),"?options=FUTFU_default")'
https://embed.mychannels.video/sdk/production/66560?options=FUTFU_default

$ xidel -s --module=xivid.xqm -e 'let $id:=extract("'$url'","~p(\d+)",1),$json:=json-doc(concat("https://embed.mychannels.video/sdk/production/",if ($id) then $id else x:request({"headers":"Cookie: authId=8ac8ac9f-3782-4ba2-a449-9dc1fcdacbd5","url":"'$url'"})/doc/(if (//iframe[@class="mc-embed"]) then //iframe[@class="mc-embed"]/extract(@src,"\d+") else //div[@data-mychannels-type="video"]/@data-mychannels-id),"?options=FUTFU_default")) return $json/map:merge(({"name":concat("AD: ",(shows)()/title," - ",(productions)()/title)},(productions)()/{"date":xivid:string-to-utc-dateTime(replace(publicationDate,"\s","T")),"duration":duration * duration("PT1S"),"formats":array{for $x at $i in reverse((sources)()[type="video/mp4"]) return {"id":"pg-"||$i,"format":"mp4[h264+aac]","resolution":("640x360","1280x720")[$i],"url":$x/src},xivid:m3u8-to-json((sources)(1)/src)()}}))'
{
  "name": "AD: Auto - Teslatest",
  "date": "2019-03-04T12:52:00Z",
  "duration": "PT9M4S",
  "formats": [
    {
      "id": "hls-0",
      "format": "m3u8[manifest]",
      "url": "https://video.persgroep.be/N0Mm43aDE6trOJW5e2SKTFb5NO9Mm7gy/index.m3u8"
    },
    {
      "id": "hls-1",
      "format": "m3u8[h264+aac]",
      "resolution": "320x180@25fps",
      "bitrate": "490kbps",
      "url": "https://video.persgroep.be/N0Mm43aDE6trOJW5e2SKTFb5NO9Mm7gy/index300.m3u8"
    },
    [...]
    {
      "id": "hls-5",
      "format": "m3u8[h264+aac]",
      "resolution": "1280x720@25fps",
      "bitrate": "24208kbps",
      "url": "https://video.persgroep.be/N0Mm43aDE6trOJW5e2SKTFb5NO9Mm7gy/index2200.m3u8"
    }
  ]
}

------------------------------------------------------------------------------------------------

$ url=https://www.ad.nl/auto/je-gaat-anders-tanken-euro-95-wordt-e10-op-1-oktober~a497450a/

$ xidel -se 'x:request({"headers":"Cookie: authId=8ac8ac9f-3782-4ba2-a449-9dc1fcdacbd5","url":"'$url'"})/doc//script[@class="mc-embed"]/outer-html()'
<script xmlns="http://www.w3.org/2000/svg" class="mc-embed" src="https://embed.mychannels.video/script/production/53235?options=TUTF_default&amp;mode=iframe"></script>

$ xidel -se 'let $id:=extract("'$url'","~p(\d+)",1) return concat("https://embed.mychannels.video/sdk/production/",if ($id) then $id else x:request({"headers":"Cookie: authId=8ac8ac9f-3782-4ba2-a449-9dc1fcdacbd5","url":"'$url'"})/doc/(if (//*[@class="mc-embed"]) then //*[@class="mc-embed"]/extract(@src,"\d+") else //div[@data-mychannels-type="video"]/@data-mychannels-id),"?options=FUTFU_default")'
https://embed.mychannels.video/sdk/production/53235?options=FUTFU_default

$ xidel -s --module=xivid.xqm -e 'let $id:=extract("'$url'","~p(\d+)",1),$json:=json-doc(concat("https://embed.mychannels.video/sdk/production/",if ($id) then $id else x:request({"headers":"Cookie: authId=8ac8ac9f-3782-4ba2-a449-9dc1fcdacbd5","url":"'$url'"})/doc/(if (//*[@class="mc-embed"]) then //*[@class="mc-embed"]/extract(@src,"\d+") else //div[@data-mychannels-type="video"]/@data-mychannels-id),"?options=FUTFU_default")) return $json/map:merge(({"name":concat("AD: ",(shows)()/title," - ",(productions)()/title)},(productions)()/{"date":xivid:string-to-utc-dateTime(replace(publicationDate,"\s","T")),"duration":duration * duration("PT1S"),"formats":array{for $x at $i in reverse((sources)()[type="video/mp4"]) return {"id":"pg-"||$i,"format":"mp4[h264+aac]","resolution":("640x360","1280x720")[$i],"url":$x/src},xivid:m3u8-to-json((sources)(1)/src)()}}))'
{
  "name": "AD: Snel Nieuws - De nummers op benzinepompen zijn veranderd",
  "date": "2019-02-03T19:03:57Z",
  "duration": "PT30S",
  "formats": [
    {
      "id": "hls-0",
      "format": "m3u8[manifest]",
      "url": "https://video.persgroep.be/k3MGNmZzE62C7JZZBxHCWgECXn8756TG/index.m3u8"
    },
    {
      "id": "hls-1",
      "format": "m3u8[h264+aac]",
      "resolution": "320x180@25fps",
      "bitrate": "450kbps",
      "url": "https://video.persgroep.be/k3MGNmZzE62C7JZZBxHCWgECXn8756TG/index300.m3u8"
    },
    [...]
    {
      "id": "hls-5",
      "format": "m3u8[h264+aac]",
      "resolution": "1280x720@25fps",
      "bitrate": "23105kbps",
      "url": "https://video.persgroep.be/k3MGNmZzE62C7JZZBxHCWgECXn8756TG/index2200.m3u8"
    }
  ]
}

------------------------------------------------------------------------------------------------

declare function xivid:ad($url as string) as object()? {
  let $id:=extract($url,"~p(\d+)",1),
      $json:=json-doc(
        concat(
          "https://embed.mychannels.video/sdk/production/",
          if ($id) then
            $id
          else
            x:request({
              "headers":"Cookie: authId=8ac8ac9f-3782-4ba2-a449-9dc1fcdacbd5",
              "url":$url
            })/doc/(
              if (//*[@class="mc-embed"]) then
                //*[@class="mc-embed"]/extract(@src,"\d+")
              else
                //div[@data-mychannels-type="video"]/@data-mychannels-id
            ),
          "?options=FUTFU_default"
        )
      )
  return
  $json/map:merge((
    {
      "name":concat(
        "AD: ",
        (shows)()/title,
        " - ",
        (productions)()/title
      )
    },
    (productions)()/{
      "date":xivid:string-to-utc-dateTime(
        replace(publicationDate,"\s","T")
      ),
      "duration":duration * duration("PT1S"),
      "formats":array{
        for $x at $i in reverse((sources)()[type="video/mp4"]) return {
          "id":"pg-"||$i,
          "format":"mp4[h264+aac]",
          "resolution":("640x360","1280x720")[$i],
          "url":$x/src
        },
        xivid:m3u8-to-json((sources)(1)/src)()
      }
    }
  ))
};

================================================================================================

[leeuwarder courant]

$ url=https://www.lc.nl/friesland/heerenveen/Alle-gratis-perenbomen-weggegeven-in-Friesland-25949273.html

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

De door internet browser gegenereerde cookie:

Cookie: ndc_consent=%7B%22createdAt%22%3A%222020-09-11T14%3A43%3A51.315Z%22%2C%22validTill%22%3A%222020-09-12T02%3A43%3A51.315Z%22%2C%22ID%22%3A%22c0c45272-9fcf-4ea5-9ee7-a24ab45f999a%22%2C%22templateID%22%3A%22lc%22%2C%22userID%22%3A%226d4c2b2f-9927-4fba-bac4-e6a9f56235e1%22%2C%22permissions%22%3A%7B%22analytics%22%3Afalse%2C%22personalization%22%3Afalse%2C%22functional%22%3Atrue%2C%22advertising%22%3Afalse%2C%22socialMedia%22%3Afalse%7D%7D

Url-decoded:

Cookie: ndc_consent={"createdAt":"2020-09-11T14:43:51.315Z","validTill":"2020-09-12T02:43:51.315Z","ID":"c0c45272-9fcf-4ea5-9ee7-a24ab45f999a","templateID":"lc","userID":"6d4c2b2f-9927-4fba-bac4-e6a9f56235e1","permissions":{"analytics":false,"personalization":false,"functional":true,"advertising":false,"socialMedia":false}}

Minimale wat voor mij (en hopelijk iedereen) werkt:

Cookie: ndc_consent={"permissions":{"functional":true}}

$ xidel -se '"Cookie: ndc_consent="||uri-encode(serialize-json({"permissions":{"functional":true}}))'
Cookie: ndc_consent=%7B%22permissions%22%3A%20%7B%22functional%22%3A%20true%7D%7D

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

$ xidel -se 'x:request({"headers":"Cookie: ndc_consent="||uri-encode(serialize-json({"permissions":{"functional":true}})),"url":"'$url'"})/doc ! (//div[@class="article-page__video-wrapper"]/div/substring-after(@id,"video-"),//meta[@property="og:site_name"]/@content)'
3892522
Leeuwarder Courant

$ xidel -se 'x:request({"headers":"Cookie: ndc_consent="||uri-encode(serialize-json({"permissions":{"functional":true}})),"url":"'$url'"})/doc/(let $id:=//div[@class="article-page__video-wrapper"]/div/substring-after(@id,"video-") return //script/tokenize(.,",")[contains(.,$id)])'
"https:\u002F\u002Fndc.bbvms.com\u002Fp\u002Flc_videoplayer_v2\u002Fc\u002F3892522.html?inheritDimensions=true"

$ xidel -se 'x:request({"headers":"Cookie: ndc_consent="||uri-encode(serialize-json({"permissions":{"functional":true}})),"url":"'$url'"})/doc/(let $id:=//div[@class="article-page__video-wrapper"]/div/substring-after(@id,"video-") return parse-json(//script/tokenize(.,",")[contains(.,$id)]))'
https://ndc.bbvms.com/p/lc_videoplayer_v2/c/3892522.html?inheritDimensions=true

$ xidel -se 'x:request({"headers":"Cookie: ndc_consent="||uri-encode(serialize-json({"permissions":{"functional":true}})),"url":"'$url'"})/doc/(let $id:=//div[@class="article-page__video-wrapper"]/div/substring-after(@id,"video-") return substring-before(parse-json(//script/tokenize(.,",")[contains(.,$id)]),"html")||"json")'
https://ndc.bbvms.com/p/lc_videoplayer_v2/c/3892522.json   # Blue Billywig

$ xidel -s --module=xivid.xqm -e 'let $src:=x:request({"headers":"Cookie: ndc_consent="||uri-encode(serialize-json({"permissions":{"functional":true}})),"url":"'$url'"})/doc,$id:=$src//div[@class="article-page__video-wrapper"]/div/substring-after(@id,"video-") return $src/xivid:bbvms(substring-before(parse-json(//script/tokenize(.,",")[contains(.,$id)]),"html")||"json",//meta[@property="og:site_name"]/@content,())'
{
  "name": "Leeuwarder Courant: Enorme belangstelling voor gratis perenbomen in Heerenveen",
  "date": "2020-08-22T10:03:48Z",
  "duration": "PT1M42S",
  "formats": [
    {
      "id": "pg-1",
      "format": "mp4[h264+aac]",
      "resolution": "512x288",
      "bitrate": "400kbps",
      "url": "https://d3jbi46382yahz.cloudfront.net/ndc/media/2020/08/22/asset-3892522-1598093329299560.mp4"
    },
    [...]
    {
      "id": "pg-6",
      "format": "mp4[h264+aac]",
      "resolution": "1920x1080",
      "bitrate": "3000kbps",
      "url": "https://d3jbi46382yahz.cloudfront.net/ndc/media/2020/08/22/asset-3892522-1598093329696575.mp4"
    },
    {
      "id": "pg-7",
      "format": "mp4[h264+aac]",
      "resolution": "1920x1080",
      "bitrate": "10296kbps",
      "url": "https://s3.eu-west-1.amazonaws.com/mm.ndc.bbvms.com/upload/ndc/2020/08/22/58d8c9860156bf19f0bf4ae6160297fc/58d8c9860156bf19f0bf4ae6160297fc.mp4"
    }
  ]
}

------------------------------------------------------------------------------------------------

declare function xivid:lc($url as string) as object()? {
  let $src:=x:request({
        "headers":"Cookie: ndc_consent="||uri-encode(
          serialize-json({"permissions":{"functional":true}})
        ),
        "url":$url
      })/doc,
      $id:=$src//div[@class="article-page__video-wrapper"]/div/substring-after(@id,"video-")
  return
  $src/xivid:bbvms(
    substring-before(
      parse-json(//script/tokenize(.,",")[contains(.,$id)]),
      "html"
    )||"json",
    //meta[@property="og:site_name"]/@content,
    ()
  )
};

================================================================================================

[facebook]

$ url=https://www.facebook.com/watch/?v=374747990176575   # https://nl.hardware.info/nieuws/72584/

$ xidel -se 'doc("'$url'")/parse-json(//script[@type="application/ld+json"])'
{
  "@type": "VideoObject",
  "name": "LEGO NES | Facebook",
  "description": "Het LEGO Nintendo Entertainment System, de perfecte combinatie van videogames en LEGO. \n\nhttps://lego.build/NESReveal",
  "thumbnailUrl": "https://scontent.fams1-1.fna.fbcdn.net/v/t15.5256-10/108554373_374751573509550_5904191927523521476_n.jpg?[...]",
  "duration": "T1M8S",
  "uploadDate": "2020-07-14T01:06:20-07:00",
  "contentUrl": "https://video.fams1-2.fna.fbcdn.net/v/t42.9040-2/108049244_739098363574790_5900093428100578067_n.mp4?[...]",
  "interactionCount": 33659,
  "publication": [
    {
      "@type": "BroadcastEvent",
      "isLiveBroadcast": false
    }
  ],
  "@id": "https://video.fams1-2.fna.fbcdn.net/v/t42.9040-2/108049244_739098363574790_5900093428100578067_n.mp4?[...]",
  "url": "https://video.fams1-2.fna.fbcdn.net/v/t42.9040-2/108049244_739098363574790_5900093428100578067_n.mp4?[...]",
  "datePublished": "2020-07-14T01:06:20-07:00",
  [...]
  "headline": "LEGO NES | Facebook",
  "isFamilyFriendly": true,
  [...]
}

$ xidel -se 'doc("'$url'")//script/extract(.,"onPageletArrive\((.+?)\);",1)[contains(.,"videoData")]'
{displayResources:["gthHO","t9MZQ","Y4UD9",[...],dash_manifest:null,[...]

$ xidel -se 'x:request({"headers":"User-Agent: Mozilla/5.0 Firefox/84.0","url":"'$url'"})/doc//script/extract(.,"onPageletArrive\((.+?)\);",1)[contains(.,"videoData")]'
{displayResources:["gthHO","t9MZQ","Y4UD9",[...],dash_manifest:"\x3C?xml version=\"1.0\"?>\n\x3CMPD[...]

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 
$ xidel -se 'x:request({"user-agent":"Mozilla/5.0 Firefox/84.0","url":"'$url'"})/doc//script/extract(.,"onPageletArrive\((.+?)\);",1)[contains(.,"videoData")]'
Dit werkt (nog) niet. Zie https://github.com/benibela/xidel/issues/58.
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

$ xidel -se 'x:request({"headers":"User-Agent: Mozilla/5.0 Firefox/84.0","url":"'$url'"})/doc/parse-json(//script/extract(.,"onPageletArrive\((.+?)\);",1)[contains(.,"videoData")],{"liberal":true()})'
Error:
jerr:JNDY0021: Failed to parse JSON: Invalid character at line 0, pos 9360: 'x' at  (tkColon) in [...]

[...]dash_manifest:"\x3C?xml version=\"1.0\"?>\n\x3CMPD[...]
                    ^positie 9360

$ xidel -se 'join(("3C_16",x:integer("3C",16)||"_10",x:cps(x:integer("3C",16)))," = ")'
3C_16 = 60_10 = <

\x3C is de Javascript notatie voor <. In JSON is alleen de Unicode codering, \u003C ,toegestaan.

$ xidel -se 'x:request({"headers":"User-Agent: Mozilla/5.0 Firefox/84.0","url":"'$url'"})/doc/parse-json(replace(//script/extract(.,"onPageletArrive\((.+?)\);",1)[contains(.,"videoData")],"\\\x","\\\u00"),{"liberal":true()})/(.//videoData)()'   # Alleen de "videoData"-array is van belang voor de video formaten.
{
  "is_hls": false,
  "video_id": "374747990176575",
  "is_live_stream": false,
  "is_servable_via_fbms": false,
  "rotation": 0,
  "is_facecast_audio": false,
  "content_category": "general",
  "is_low_latency": false,
  "desired_latency_ms": null,
  "latency_tolerance_ms": null,
  "is_predictive_dash": false,
  "is_live_trace_enabled_on_player": false,
  "p2p_settings": null,
  "ms_param": null,
  "captions_autogenerated_indicator_config": null,
  "sd_src_no_ratelimit": "https://video.fams1-2.fna.fbcdn.net/v/t42.9040-2/108049244_739098363574790_5900093428100578067_n.mp4?[...]",
  "aspect_ratio": 0.8,
  "hd_src": "https://scontent.fams1-2.fna.fbcdn.net/v/t66.36240-6/49915952_378325833593524_1098325198102408920_n.mp4?[...]",
  "sd_src": "https://video.fams1-2.fna.fbcdn.net/v/t42.9040-2/108049244_739098363574790_5900093428100578067_n.mp4?[...]",
  "hd_tag": "oep_hd",
  "sd_tag": "sve_sd",
  "stream_type": "dash",
  "live_routing_token": "",
  "projection": "flat",
  "subtitles_src": "https://scontent.fams1-1.fna.fbcdn.net/v/t39.2093-6/109296938_710113536438950_7732833811523707442_n.srt?[...]",
  "dash_manifest": "<?xml version=\"1.0\"?>\n<MPD [...]\x3C/AdaptationSet>\x3C/Period>\x3C/MPD>\n",
  "dash_prefetched_representation_ids": ["1243446782689657v", "405461810413399a"],
  "player_version_overwrite": "pleasantville",
  "spherical_config": {},
  "is_spherical": false,
  "original_height": 1080,
  "original_width": 864,
  "video_url": "https://www.facebook.com/LEGONetherlands/videos/374747990176575/",
  "is_broadcast": false,
  "override_config": null,
  "prefetch_cache": null
}

$ xidel -s --module=xivid.xqm -e 'x:request({"headers":"User-Agent: Mozilla/5.0 Firefox/84.0","url":"'$url'"})/doc/map:merge((parse-json(//script[@type="application/ld+json"])/{"name":join(reverse(tokenize(name," \| ")),": "),"date":adjust-dateTime-to-timezone(dateTime(uploadDate),duration("PT0S")),"duration":duration("P"||duration)},parse-json(replace(//script/extract(.,"onPageletArrive\((.+?)\);",1)[contains(.,"videoData")],"\\\x","\\\u00"),{"liberal":true()})/(.//videoData)()/{"formats":array{{"id":"sub-1","format":"srt","url":subtitles_src}[url],((sd_src_no_ratelimit,sd_src)[.][1],(hd_src_no_ratelimit,hd_src)[.][1]) ! {"id":"pg-"||position(),"format":"mp4[h264+aac]","url":.},xivid:mpd-to-json(parse-xml(dash_manifest))()}}))'
{
  "name": "Facebook: LEGO NES",
  "date": "2020-07-14T08:06:20Z",
  "duration": "PT1M8S",
  "formats": [
    {
      "id": "sub-1",
      "format": "srt",
      "url": "https://scontent.fams1-1.fna.fbcdn.net/v/t39.2093-6/109296938_710113536438950_7732833811523707442_n.srt?[...]"
    },
    {
      "id": "pg-1",
      "format": "mp4[h264+aac]",
      "url": "https://video.fams1-2.fna.fbcdn.net/v/t42.9040-2/108049244_739098363574790_5900093428100578067_n.mp4?[...]"
    },
    {
      "id": "pg-2",
      "format": "mp4[h264+aac]",
      "url": "https://scontent.fams1-2.fna.fbcdn.net/v/t66.36240-6/49915952_378325833593524_1098325198102408920_n.mp4?[...]"
    },
    {
      "id": "dash-1",
      "format": "mp4[aac]",
      "samplerate": "48kHz",
      "bitrate": "65kbps",
      "url": "https://video.fams1-1.fna.fbcdn.net/v/t42.1790-2/109281327_405461813746732_178858496964516997_n.mp4?[...]"

    },
    [...]
    {
      "id": "dash-5",
      "format": "mp4[h264]",
      "resolution": "720x900@25fps",
      "bitrate": "378kbps",
      "url": "https://video.fams1-1.fna.fbcdn.net/v/t39.25447-2/121418431_154480879657509_7493886390368626002_n.mp4?[...]"
    }
  ]
}

------------------------------------------------------------------------------------------------

declare function xivid:facebook($url as string) as object()? {
  x:request({
    "headers":"User-Agent: Mozilla/5.0 Firefox/84.0",
    "url":$url
  })/doc/map:merge((
    parse-json(//script[@type="application/ld+json"])/{
      "name":join(
        reverse(tokenize(name," \| ")),
        ": "
      ),
      "date":adjust-dateTime-to-timezone(
        dateTime(uploadDate),
        duration("PT0S")
      ),
      "duration":duration("P"||duration)
    },
    parse-json(
      replace(
        //script/extract(.,"onPageletArrive\((.+?)\);",1)[contains(.,"videoData")],
        "\\x","\\u00"
      ),
      {"liberal":true()}
    )/(.//videoData)()/{
      "formats":array{
        {
          "id":"sub-1",
          "format":"srt",
          "url":subtitles_src
        }[url],
        (
          (sd_src_no_ratelimit,sd_src)[.][1],
          (hd_src_no_ratelimit,hd_src)[.][1]
        ) ! {
          "id":"pg-"||position(),
          "format":"mp4[h264+aac]",
          "url":.
        },
        xivid:mpd-to-json(parse-xml(dash_manifest))()
      }
    }
  ))
};

================================================================================================

[twitter]

$ url=https://twitter.com/themandalorian/status/1188986316194635777   # https://github.com/ytdl-org/youtube-dl/issues/14977#issuecomment-551283708

$ xidel -se '(doc("'$url'")//script/@src)[last()]'
https://abs.twimg.com/responsive-web/client-web-legacy/main.94494ea5.js

$ xidel -se 'extract(unparsed-text((doc("'$url'")//script/@src)[last()]),"c=&quot;([A-Za-z0-9%]{96,})&quot;",1)'
AAAAAAAAAAAAAAAAAAAAANRILgAAAAAAnNwIzUejRCOuH5E6I8xnZz4puTs%3D1Zv7ttfk8LF81IUq16cHjhLTvJu4FA33AGWWjCpTnA

$ xidel -se 'let $bearer_token:=extract(unparsed-text((doc("'$url'")//script/@src)[last()]),"c=&quot;([A-Za-z0-9%]{96,})&quot;",1) return x:request({"method":"POST","headers":"Authorization: Bearer "||$bearer_token,"url":"https://api.twitter.com/1.1/guest/activate.json"})/json'
{
  "guest_token": "1391371369762496514"
}

$ xidel -se 'request-combine("https://api.twitter.com/1.1/statuses/show.json",{"id":extract("'$url'","\d+$"),"tweet_mode":"extended"})'
{
  "url": "https://api.twitter.com/1.1/statuses/show.json?id=1188986316194635777&tweet_mode=extended"
}

$ xidel -se 'let $bearer_token:=extract(unparsed-text((doc("'$url'")//script/@src)[last()]),"c=&quot;([A-Za-z0-9%]{96,})&quot;",1),$guest_token:=x:request({"method":"POST","headers":"Authorization: Bearer "||$bearer_token,"url":"https://api.twitter.com/1.1/guest/activate.json"})/json/guest_token return x:request({"headers":("Authorization: Bearer "||$bearer_token,"x-guest-token: "||$guest_token),"url":request-combine("https://api.twitter.com/1.1/statuses/show.json",{"id":extract("'$url'","\d+$"),"tweet_mode":"extended"})/url})/json'
{
  "created_at": "Tue Oct 29 01:10:02 +0000 2019",
  [...]
  "full_text": "“Mandalorian, look outside. They’re waiting for you.” Watch the brand new trailer for #TheMandalorian, an original Star Wars series. Start streaming Nov. 12, only on #DisneyPlus. https://t.co/Ac38wozhZz",
  [...]
  "extended_entities": {
    "media": [
      {
        [...]
        "video_info": {
          "aspect_ratio": [433, 180],
          "duration_millis": 104646,
          "variants": [
            {
              "content_type": "application/x-mpegURL",
              "url": "https://video.twimg.com/amplify_video/1188974444523315201/pl/OTSOTGtTUnYMAVnX.m3u8?tag=13&v=6b4"
            },
            {
              "bitrate": 2176000,
              "content_type": "video/mp4",
              "url": "https://video.twimg.com/amplify_video/1188974444523315201/vid/1732x720/Gih93EU1RaZnXxpx.mp4?tag=13"
            },
            {
              "bitrate": 832000,
              "content_type": "video/mp4",
              "url": "https://video.twimg.com/amplify_video/1188974444523315201/vid/866x360/K3aaE5vAughE7huI.mp4?tag=13"
            },
            {
              "bitrate": 288000,
              "content_type": "video/mp4",
              "url": "https://video.twimg.com/amplify_video/1188974444523315201/vid/648x270/mNhOOfzYKNFj__tb.mp4?tag=13"
            }
          ]
        },
        "media_key": "13_1188974444523315201",
        "additional_media_info": {
          "title": "The Mandalorian | Official Trailer 2 | Disney+ | Streaming Nov. 12",
          "description": "",
          "embeddable": true,
          "monetizable": false
        }
      }
    ]
  },
  [...]
}

$ xidel -s --module=xivid.xqm -e 'let $bearer_token:=extract(unparsed-text((doc("'$url'")//script/@src)[last()]),"c=&quot;([A-Za-z0-9%]{96,})&quot;",1),$guest_token:=x:request({"method":"POST","headers":"Authorization: Bearer "||$bearer_token,"url":"https://api.twitter.com/1.1/guest/activate.json"})/json/guest_token return x:request({"headers":("Authorization: Bearer "||$bearer_token,"x-guest-token: "||$guest_token),"url":request-combine("https://api.twitter.com/1.1/statuses/show.json",{"id":extract("'$url'","\d+$"),"tweet_mode":"extended"})/url})/json/{"name":"Twitter: "||.//title,"date":parse-ietf-date(created_at),"duration":round(.//duration_millis div 1000) * duration("PT1S"),"formats":array{for $x at $i in (.//variants)()[content_type="video/mp4"] order by $x/bitrate count $i return {"id":"pg-"||$i,"format":"mp4[h264+aac]","resolution":extract($x/url,"\d+x\d+"),"bitrate":$x/bitrate div 1000||"kbps","url":$x/url},xivid:m3u8-to-json((.//variants)()[content_type="application/x-mpegURL"]/url)()}}'
{
  "name": "Twitter: The Mandalorian | Official Trailer 2 | Disney+ | Streaming Nov. 12",
  "date": "2019-10-29T01:10:02Z",
  "duration": "PT1M45S",
  "formats": [
    {
      "id": "pg-1",
      "format": "mp4[h264+aac]",
      "resolution": "648x270",
      "bitrate": "288kbps",
      "url": "https://video.twimg.com/amplify_video/1188974444523315201/vid/648x270/mNhOOfzYKNFj__tb.mp4?tag=13"
    },
    [...]
    {
      "id": "pg-3",
      "format": "mp4[h264+aac]",
      "resolution": "1732x720",
      "bitrate": "2176kbps",
      "url": "https://video.twimg.com/amplify_video/1188974444523315201/vid/1732x720/Gih93EU1RaZnXxpx.mp4?tag=13"
    },
    {
      "id": "sub-1",
      "format": "m3u8[vtt]",
      "language": "en",
      "url": "https://video.twimg.com/amplify_video/1188974444523315201/pl/s0/3sjE70yJdGgqp0g1.m3u8"
    },
    {
      "id": "hls-0",
      "format": "m3u8[manifest]",
      "url": "https://video.twimg.com/amplify_video/1188974444523315201/pl/OTSOTGtTUnYMAVnX.m3u8?tag=13&v=6b4"
    },
    {
      "id": "hls-1",
      "format": "m3u8[h264+aac]",
      "resolution": "648x270",
      "bitrate": "288kbps",
      "url": "https://video.twimg.com/amplify_video/1188974444523315201/pl/648x270/O7Yd4NsLa4hRURCX.m3u8"
    },
    [...]
    {
      "id": "hls-3",
      "format": "m3u8[h264+aac]",
      "resolution": "1732x720",
      "bitrate": "2176kbps",
      "url": "https://video.twimg.com/amplify_video/1188974444523315201/pl/1732x720/yG0_asM0v9yBC-Xd.m3u8"
    }
  ]
}

------------------------------------------------------------------------------------------------

$ url=https://twitter.com/ViviEducation/status/1136534865145286656

Creëer een interne $call_api functie om de nodige api-urls makkelijker aan te spreken:

$ xidel -se 'let $bearer_token:=extract(unparsed-text((doc("'$url'")//script/@src)[last()]),"c=&quot;([A-Za-z0-9%]{96,})&quot;",1),$guest_token:=x:request({"method":"POST","headers":"Authorization: Bearer "||$bearer_token,"url":"https://api.twitter.com/1.1/guest/activate.json"})/json/guest_token,$call_api:=function($path as string,$query as object()) as object() {x:request({"headers":("Authorization: Bearer "||$bearer_token,"x-guest-token: "||$guest_token),"url":request-combine("https://api.twitter.com/1.1/"||$path,$query)/url})/json} return $call_api("statuses/show.json",{"id":extract("'$url'","\d+$"),"tweet_mode":"extended"})'
{
  "created_at": "Thu Jun 06 07:26:42 +0000 2019",
  [...]
  "entities": {
    [...]
    "urls": [
      {
        "url": "https://t.co/HJOtr4djsW",
        "expanded_url": "https://twitter.com/i/broadcasts/1vOGwqejwoWxB",
        "display_url": "twitter.com/i/broadcasts/1.",
        "indices": [100, 123]
      }
    ]
  },
  [...]
}

$ xidel -se 'let $bearer_token:=extract(unparsed-text((doc("'$url'")//script/@src)[last()]),"c=&quot;([A-Za-z0-9%]{96,})&quot;",1),$guest_token:=x:request({"method":"POST","headers":"Authorization: Bearer "||$bearer_token,"url":"https://api.twitter.com/1.1/guest/activate.json"})/json/guest_token,$call_api:=function($path as string,$query as object()?) as object() {x:request({"headers":("Authorization: Bearer "||$bearer_token,"x-guest-token: "||$guest_token),"url":if (empty($query)) then concat("https://api.twitter.com/1.1/",$path) else request-combine("https://api.twitter.com/1.1/"||$path,$query)/url})/json},$statuses:=$call_api("statuses/show.json",{"id":extract("'$url'","\d+$"),"tweet_mode":"extended"}) return if (exists($statuses/extended_entities)) then $statuses else let $id:=substring-after($statuses/entities//expanded_url,"broadcasts/") return $call_api("broadcasts/show.json",{"ids":$id})/(broadcasts)($id)/(.,$call_api("live_video_stream/status/"||media_key,()))'
{
  "id": "1vOGwqejwoWxB",
  "broadcast_id": "1vOGwqejwoWxB",
  "media_key": "28_1136534646529769472",
  "media_id": "1136534646529769472",
  [...]
  "status": "Vivi founder @lior_rauchy announcing our new student feedback tool live at @EduTECH_AU #EduTECH2019",
  [...]
  "height": 568,
  "width": 320,
  [...]
  "start_ms": "1559806001825",
  "end_ms": "1559807524882",
  [...]
}
{
  "source": {
    "location": "https://prod-fastly-ap-southeast-2.video.pscp.tv/[...]/playlist_16886936549721737423.m3u8?type=replay",
    "noRedirectPlaybackUrl": "https://prod-fastly-ap-southeast-2.video.pscp.tv/[...]/playlist_16886936549721737423.m3u8?type=replay",
    "status": "LIVE_PUBLIC",
    "streamType": "HLS"
  },
  [...]
}

$ xidel -s --module=xivid.xqm -e 'let $bearer_token:=extract(unparsed-text((doc("'$url'")//script/@src)[last()]),"c=&quot;([A-Za-z0-9%]{96,})&quot;",1),$guest_token:=x:request({"method":"POST","headers":"Authorization: Bearer "||$bearer_token,"url":"https://api.twitter.com/1.1/guest/activate.json"})/json/guest_token,$call_api:=function($path as string,$query as object()?) as object() {x:request({"headers":("Authorization: Bearer "||$bearer_token,"x-guest-token: "||$guest_token),"url":if (empty($query)) then concat("https://api.twitter.com/1.1/",$path) else request-combine("https://api.twitter.com/1.1/"||$path,$query)/url})/json},$statuses:=$call_api("statuses/show.json",{"id":extract("'$url'","\d+$"),"tweet_mode":"extended"}) return if (exists($statuses/extended_entities)) then $statuses/{"name":"Twitter: "||.//title,"date":parse-ietf-date(created_at),"duration":round(.//duration_millis div 1000) * duration("PT1S"),"formats":array{for $x at $i in (.//variants)()[content_type="video/mp4"] order by $x/bitrate count $i return {"id":"pg-"||$i,"format":"mp4[h264+aac]","resolution":extract($x/url,"\d+x\d+"),"bitrate":$x/bitrate div 1000||"kbps","url":$x/url},xivid:m3u8-to-json((.//variants)()[content_type="application/x-mpegURL"]/url)()}} else let $id:=substring-after($statuses/entities//expanded_url,"broadcasts/") return $call_api("broadcasts/show.json",{"ids":$id})/(broadcasts)($id)/{"name":"Twitter: "||status,"date":round(start_ms div 1000) * duration("PT1S") + dateTime("1970-01-01T00:00:00Z"),"duration":round((end_ms - start_ms) div 1000) * duration("PT1S"),"formats":array{{"id":"hls-1","format":"m3u8[h264+aac]","resolution":concat(width,"x",height),"url":$call_api("live_video_stream/status/"||media_key,())//location}}}'
{
  "name": "Twitter: Vivi founder @lior_rauchy announcing our new student feedback tool live at @EduTECH_AU #EduTECH2019",
  "date": "2019-06-06T07:26:42Z",
  "duration": "PT25M23S",
  "formats": [
    {
      "id": "hls-1",
      "format": "m3u8[h264+aac]",
      "resolution": "320x568",
      "url": "https://prod-fastly-ap-southeast-2.video.pscp.tv/[...]/playlist_16886936549721737423.m3u8?type=replay"
    }
  ]
}

------------------------------------------------------------------------------------------------

$ url=https://twitter.com/I_Leak_VN/status/1369649839546400776

$ xidel -se 'let $bearer_token:=extract(unparsed-text((doc("'$url'")//script/@src)[last()]),"c=&quot;([A-Za-z0-9%]{96,})&quot;",1),$guest_token:=x:request({"method":"POST","headers":"Authorization: Bearer "||$bearer_token,"url":"https://api.twitter.com/1.1/guest/activate.json"})/json/guest_token,$call_api:=function($path as string,$query as object()) as object() {x:request({"headers":("Authorization: Bearer "||$bearer_token,"x-guest-token: "||$guest_token),"url":request-combine("https://api.twitter.com/1.1/"||$path,$query)/url})/json} return $call_api("statuses/show.json",{"id":extract("'$url'","\d+$"),"tweet_mode":"extended"})'
{
  "created_at": "Wed Mar 10 14:02:23 +0000 2021",
  [...]
  "full_text": "... with oil cooling = the craziest mining ever in the world\n\nhttps://t.co/beYwz9pAux\n\n@elchapuzas @hms1193 @harukaze5719 @hardwareluxx_de @nbc_net @VideoCardz https://t.co/QSSaUxOPwG https://t.co/WVW3dNmo7C",
  [...]
  "extended_entities": {
    "media": [
      {
        [...]
        "video_info": {
          "aspect_ratio": [25, 14],
          "duration_millis": 69970,
          "variants": [
            {
              "bitrate": 256000,
              "content_type": "video/mp4",
              "url": "https://video.twimg.com/ext_tw_video/1369649503557550089/pu/vid/400x224/DeAvoL4ntzUZ7do_.mp4?tag=12"
            },
            {
              "content_type": "application/x-mpegURL",
              "url": "https://video.twimg.com/ext_tw_video/1369649503557550089/pu/pl/3OafwKdT_40CDWUH.m3u8?tag=12"
            }
          ]
        },
        "media_key": "7_1369649503557550089",
        "additional_media_info": {
          "monetizable": false
        }
      }
    ]
  },
  [...]
  "quoted_status": {
    [...]
    "extended_entities": {
      "media": [
        {
          [...]
          "video_info": {
            "aspect_ratio": [249, 244],
            "variants": [
              {
                "bitrate": 0,
                "content_type": "video/mp4",
                "url": "https://video.twimg.com/tweet_video/EwH17TuXMAAhv-S.mp4"
              }
            ]
          },
          "media_key": "16_1369646160953159680"
        }
      ]
    },
    [...]
  },
  [...]
}

$ xidel -s --module=xivid.xqm -e 'let $bearer_token:=extract(unparsed-text((doc("'$url'")//script/@src)[last()]),"c=&quot;([A-Za-z0-9%]{96,})&quot;",1),$guest_token:=x:request({"method":"POST","headers":"Authorization: Bearer "||$bearer_token,"url":"https://api.twitter.com/1.1/guest/activate.json"})/json/guest_token,$call_api:=function($path as string,$query as object()?) as object() {x:request({"headers":("Authorization: Bearer "||$bearer_token,"x-guest-token: "||$guest_token),"url":if (empty($query)) then concat("https://api.twitter.com/1.1/",$path) else request-combine("https://api.twitter.com/1.1/"||$path,$query)/url})/json},$statuses:=$call_api("statuses/show.json",{"id":extract("'$url'","\d+$"),"tweet_mode":"extended"}) return if (exists($statuses/extended_entities)) then $statuses/extended_entities/{"name":"Twitter: "||(.//title,$statuses/full_text)[1],"date":parse-ietf-date($statuses/created_at),"duration":round(video_info/duration_millis div 1000) * duration("PT1S"),"formats":array{for $x at $i in video_info/(variants)()[content_type="video/mp4"] order by $x/bitrate count $i return {"id":"pg-"||$i,"format":"mp4[h264+aac]","resolution":extract($x/url,"\d+x\d+"),"bitrate":$x/bitrate div 1000||"kbps","url":$x/url},xivid:m3u8-to-json((.//variants)()[content_type="application/x-mpegURL"]/url)()}} else let $id:=substring-after($statuses/entities//expanded_url,"broadcasts/") return $call_api("broadcasts/show.json",{"ids":$id})/(broadcasts)($id)/{"name":"Twitter: "||status,"date":round(start_ms div 1000) * duration("PT1S") + dateTime("1970-01-01T00:00:00Z"),"duration":round((end_ms - start_ms) div 1000) * duration("PT1S"),"formats":array{{"id":"hls-1","format":"m3u8[h264+aac]","resolution":concat(width,"x",height),"url":$call_api("live_video_stream/status/"||media_key,())//location}}}'
{
  "name": "Twitter: ... with oil cooling = the craziest mining ever in the world\n\nhttps://t.co/beYwz9pAux\n\n@elchapuzas @hms1193 @harukaze5719 @hardwareluxx_de @nbc_net @VideoCardz https://t.co/QSSaUxOPwG https://t.co/WVW3dNmo7C",
  "date": "2021-03-10T14:02:23Z",
  "duration": "PT1M10S",
  "formats": [
    {
      "id": "pg-1",
      "format": "mp4[h264+aac]",
      "resolution": "400x224",
      "bitrate": "256kbps",
      "url": "https://video.twimg.com/ext_tw_video/1369649503557550089/pu/vid/400x224/DeAvoL4ntzUZ7do_.mp4?tag=12"
    },
    {
      "id": "hls-0",
      "format": "m3u8[manifest]",
      "url": "https://video.twimg.com/ext_tw_video/1369649503557550089/pu/pl/3OafwKdT_40CDWUH.m3u8?tag=12"
    },
    {
      "id": "hls-1",
      "format": "m3u8[h264+aac]",
      "resolution": "400x224",
      "bitrate": "256kbps",
      "url": "https://video.twimg.com/ext_tw_video/1369649503557550089/pu/pl/400x224/-qd-LGmPMdvWGhIp.m3u8"
    }
  ]
}

------------------------------------------------------------------------------------------------

declare function xivid:twitter($url as string) as object()? {
  let $bearer_token:=extract(
        unparsed-text((doc($url)//script/@src)[last()]),
        "c=&quot;([A-Za-z0-9%]{96,})&quot;",1
      ),
      $guest_token:=x:request({
        "method":"POST",
        "headers":"Authorization: Bearer "||$bearer_token,
        "url":"https://api.twitter.com/1.1/guest/activate.json"
      })/json/guest_token,
      $call_api:=function($path as string,$query as object()?) as object() {
        x:request({
          "headers":(
            "Authorization: Bearer "||$bearer_token,
            "x-guest-token: "||$guest_token
          ),
          "url":if (empty($query)) then
            concat("https://api.twitter.com/1.1/",$path)
          else
            request-combine("https://api.twitter.com/1.1/"||$path,$query)/url
        })/json
      },
      $statuses:=$call_api(
        "statuses/show.json",
        {"id":extract($url,"\d+$"),"tweet_mode":"extended"}
      )
  return
  if (exists($statuses/extended_entities)) then
    $statuses/extended_entities/(media)()/{
      "name":"Twitter: "||(.//title,$statuses/full_text)[1],
      "date":parse-ietf-date($statuses/created_at),
      "duration":round(.//duration_millis div 1000) * duration("PT1S"),
      "formats":array{
        for $x at $i in (.//variants)()[content_type="video/mp4"]
        order by $x/bitrate
        count $i
        return {
          "id":"pg-"||$i,
          "format":"mp4[h264+aac]",
          "resolution":extract($x/url,"\d+x\d+"),
          "bitrate":$x/bitrate div 1000||"kbps",
          "url":$x/url
        },
        xivid:m3u8-to-json(
          (.//variants)()[content_type="application/x-mpegURL"]/url
        )()
      }
    }
  else
    let $id:=substring-after($statuses/entities//expanded_url,"broadcasts/") return
    $call_api("broadcasts/show.json",{"ids":$id})/(broadcasts)($id)/{
      "name":"Twitter: "||status,
      "date":round(start_ms div 1000) *
        duration("PT1S") + dateTime("1970-01-01T00:00:00Z"),
      "duration":round((end_ms - start_ms) div 1000) * duration("PT1S"),
      "formats":array{
        {
          "id":"hls-1",
          "format":"m3u8[h264+aac]",
          "resolution":concat(width,"x",height),
          "url":$call_api("live_video_stream/status/"||media_key,())//location
        }
      }
    }
};

================================================================================================

[instagram]

$ url=https://www.instagram.com/p/CIx3NBpJ3BU

$ xidel -se 'parse-json(doc("'$url'")//script/extract(.,"_sharedData = (.+);",1)[.])'
{
  [...]
  "entry_data": {
    "PostPage": [
      {
        "graphql": {
          "shortcode_media": {
            "__typename": "GraphVideo",
            "id": "2463993258823872596",
            "shortcode": "CIx3NBpJ3BU",
            "dimensions": {
              "height": 750,
              "width": 750
            },
            [...]
            "dash_info": {
              "is_dash_eligible": false,
              "video_dash_manifest": null,
              "number_of_qualities": 0
            },
            "has_audio": true,
            "video_url": "https://instagram.fams1-1.fna.fbcdn.net/v/t50.2886-16/130702470_426047925446010_2470762876495489406_n.mp4?_nc_ht=instagram.fams1-1.fna.fbcdn.net&_nc_cat=106&_nc_ohc=8NPj7zy3XdYAX9ExPgT&oe=5FE1233A&oh=944168c9dc2da5cf2e7642c6bdbec6c3",
            [...]
            "edge_media_to_caption": {
              "edges": [
                {
                  "node": {
                    "text": "Merry Christmas, you filthy animals 🙀🎄 #HomeAlone #OwlKitty @culkamania\n-\n-\n#adoptdontshop #blackcat #catsofinstagram #catlife #putowlkittyonellen"
                  }
                }
              ]
            },
            [...]
            "taken_at_timestamp": 1607950917,
            [...]
            "title": "",
            "video_duration": 42.839,
            [...]
          }
        }
      }
    ]
  },
  [...]
}

$ xidel -se 'parse-json(doc("'$url'")//script/extract(.,"_sharedData = (.+);",1)[.])//shortcode_media/{"name":"Instagram: "||edge_media_to_caption//text,"date":taken_at_timestamp * duration("PT1S") + dateTime("1970-01-01T00:00:00Z"),"duration":round(video_duration) * duration("PT1S"),"formats":array{{"id":"pg-1","format":"mp4[h264+aac]","resolution":dimensions/concat(height,"x",width),"url":video_url}}}'
{
  "name": "Instagram: Merry Christmas, you filthy animals 🙀🎄 #HomeAlone #OwlKitty @culkamania\n-\n-\n#adoptdontshop #blackcat #catsofinstagram #catlife #putowlkittyonellen",
  "date": "2020-12-14T13:01:57Z",
  "duration": "PT43S",
  "formats": [
    {
      "id": "pg-1",
      "format": "mp4[h264+aac]",
      "resolution": "750x750",
      "url": "https://instagram.fams1-1.fna.fbcdn.net/v/t50.2886-16/130702470_426047925446010_2470762876495489406_n.mp4?_nc_ht=instagram.fams1-1.fna.fbcdn.net&_nc_cat=106&_nc_ohc=8NPj7zy3XdYAX9ExPgT&oe=5FE1233A&oh=944168c9dc2da5cf2e7642c6bdbec6c3"
    }
  ]
}

------------------------------------------------------------------------------------------------

declare function xivid:instagram($url as string) as object()? {
  parse-json(
    doc($url)//script/extract(.,"_sharedData = (.+);",1)[.]
  )//shortcode_media/{
    "name":"Instagram: "||edge_media_to_caption//text,
    "date":taken_at_timestamp * duration("PT1S") + dateTime("1970-01-01T00:00:00Z"),
    "duration":round(video_duration) * duration("PT1S"),
    "formats":array{
      {
        "id":"pg-1",
        "format":"mp4[h264+aac]",
        "url":video_url
      }
    }
  }
};

================================================================================================

[pornhub]

$ url=https://nl.pornhub.com/view_video.php?viewkey=ph5c8e7e44e1da9

$ xidel -se 'parse-json(doc("'$url'")//script[@type="application/ld+json"])'
{
  "@context": "http://schema.org/",
  "@type": "VideoObject",
  "name": "Strongest orgasm with magic wand in my life - Mini Diva",
  "embedUrl": "https://nl.pornhub.com/embed/ph5c8e7e44e1da9",
  "duration": "PT00H09M09S",
  "thumbnailUrl": "https://di.phncdn.com/videos/201903/17/213567022/thumbs_15/(m=eaAaGwObaaaa)(mh=y9U5PUCUUhw4TvQr)11.jpg",
  "uploadDate": "2019-03-17T17:12:50+00:00",
  "description": [...],
  "author": "Mini Diva",
  "interactionStatistic": [
    {
      "@type": "InteractionCounter",
      "interactionType": "http://schema.org/WatchAction",
      "userInteractionCount": "1 234 998"
    },
    {
      "@type": "InteractionCounter",
      "interactionType": "http://schema.org/LikeAction",
      "userInteractionCount": "9 557"
    }
  ]
}

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

Alle "media_"-streams incl. bijbehorende "ra"-variabelen:

$ xidel -se 'doc("'$url'")//div[@id="player"]/tokenize(script,"flashvars.+?;")[contains(.,"var media_")]'

		var raornhubra64raornhubra64="ornhu" + "b";var rahttpsra17rahttpsra17="https:";var raky2e3yra90raky2e3yra90="kY2E3" + "Y";var raideogra87raideogra87="ideo/g";var racomvra46racomvra46=".com/v";var radu4mzrra32radu4mzrra32="DU4Mz" + "R";var ranqiojera14ranqiojera14="nQiOjE";var ralmmuznra98ralmmuznra98="lMmUzN";var ratpra88ratpra88="t=p";var rajy3ndmra17rajy3ndmra17="jY3NDM";var ra3mdgymra14ra3mdgymra14="3MDgyM";var ramy0mgyra17ramy0mgyra17="mY0MGY";var rajnyisira27rajnyisira27="jNyIs" + "I";var ratiwnjjra91ratiwnjjra91="TIwNjJ";var rajzguxmra86rajzguxmra86="jZGUxM";var raiasera93raiasera93="ia?s=" + "e";var ra2mtkxora90ra2mtkxora90="2MTkxO";var ra9e0ra59ra9e0ra59="9&e=0" + "&";var ra5c8e7era77ra5c8e7era77="5c8e7" + "e";var raindvkyra43raindvkyra43="iNDVkY";var ranlpra72ranlpra72="//nl." + "p";var raznmmdbra74raznmmdbra74="zNmMD" + "B";var razblmgzra20razblmgzra20="zBlMG" + "Z";var raetmedra36raetmedra36="et_me" + "d";var ra2m2vimra88ra2m2vimra88="2M2Vi" + "M";var ratbmnmnra17ratbmnmnra17="TBmNm" + "N";var ra9vphra13ra9vphra13="9&v=p" + "h";var ra44e1dara64ra44e1dara64="44e1d" + "a";var rawnlodrra100rawnlodrra100="WNlOD" + "R";var raiogy0zra24raiogy0zra24="iOGY0" + "Z";var rayjrijora88rayjrijora88="yJrIjo";var media_0=/* + raornhubra64raornhubra64 + */rahttpsra17rahttpsra17 + /* + radu4mzrra32radu4mzrra32 + */ranlpra72ranlpra72 + /* + racomvra46racomvra46 + */raornhubra64raornhubra64 + /* + ratiwnjjra91ratiwnjjra91 + */racomvra46racomvra46 + /* + ratbmnmnra17ratbmnmnra17 + */raideogra87raideogra87 + /* + ratiwnjjra91ratiwnjjra91 + */raetmedra36raetmedra36 + /* + rajnyisira27rajnyisira27 + */raiasera93raiasera93 + /* + razblmgzra20razblmgzra20 + */rayjrijora88rayjrijora88 + /* + ranlpra72ranlpra72 + */raiogy0zra24raiogy0zra24 + /* + ra2m2vimra88ra2m2vimra88 + */ramy0mgyra17ramy0mgyra17 + /* + raornhubra64raornhubra64 + */ra3mdgymra14ra3mdgymra14 + /* + raiogy0zra24raiogy0zra24 + */razblmgzra20razblmgzra20 + /* + racomvra46racomvra46 + */raky2e3yra90raky2e3yra90 + /* + rajy3ndmra17rajy3ndmra17 + */raznmmdbra74raznmmdbra74 + /* + ramy0mgyra17ramy0mgyra17 + */raindvkyra43raindvkyra43 + /* + ra44e1dara64ra44e1dara64 + */ratbmnmnra17ratbmnmnra17 + /* + ra2m2vimra88ra2m2vimra88 + */rajzguxmra86rajzguxmra86 + /* + raindvkyra43raindvkyra43 + */rajy3ndmra17rajy3ndmra17 + /* + raindvkyra43raindvkyra43 + */ra2m2vimra88ra2m2vimra88 + /* + rahttpsra17rahttpsra17 + */rawnlodrra100rawnlodrra100 + /* + raetmedra36raetmedra36 + */ralmmuznra98ralmmuznra98 + /* + rawnlodrra100rawnlodrra100 + */radu4mzrra32radu4mzrra32 + /* + ra2m2vimra88ra2m2vimra88 + */rajnyisira27rajnyisira27 + /* + ranlpra72ranlpra72 + */ranqiojera14ranqiojera14 + /* + raornhubra64raornhubra64 + */ra2mtkxora90ra2mtkxora90 + /* + rajzguxmra86rajzguxmra86 + */ratiwnjjra91ratiwnjjra91 + /* + raiogy0zra24raiogy0zra24 + */ra9vphra13ra9vphra13 + /* + ra9e0ra59ra9e0ra59 + */ra5c8e7era77ra5c8e7era77 + /* + raky2e3yra90raky2e3yra90 + */ra44e1dara64ra44e1dara64 + /* + ratiwnjjra91ratiwnjjra91 + */ra9e0ra59ra9e0ra59 + /* + ratiwnjjra91ratiwnjjra91 + */ratpra88ratpra88;
[...]

Verwijder de aanhalingstekens en de +jes in alle "ra"-variabelen:

$ xidel -se 'for $x in doc("'$url'")//div[@id="player"]/tokenize(replace(script,"&quot; \+ &quot;|&quot;",""),"flashvars.+?;")[contains(.,"var media_")] return $x'

		var raornhubra64raornhubra64=ornhub;var rahttpsra17rahttpsra17=https:;var raky2e3yra90raky2e3yra90=kY2E3Y;var raideogra87raideogra87=ideo/g;var racomvra46racomvra46=.com/v;var radu4mzrra32radu4mzrra32=DU4MzR;var ranqiojera14ranqiojera14=nQiOjE;var ralmmuznra98ralmmuznra98=lMmUzN;var ratpra88ratpra88=t=p;var rajy3ndmra17rajy3ndmra17=jY3NDM;var ra3mdgymra14ra3mdgymra14=3MDgyM;var ramy0mgyra17ramy0mgyra17=mY0MGY;var rajnyisira27rajnyisira27=jNyIsI;var ratiwnjjra91ratiwnjjra91=TIwNjJ;var rajzguxmra86rajzguxmra86=jZGUxM;var raiasera93raiasera93=ia?s=e;var ra2mtkxora90ra2mtkxora90=2MTkxO;var ra9e0ra59ra9e0ra59=9&e=0&;var ra5c8e7era77ra5c8e7era77=5c8e7e;var raindvkyra43raindvkyra43=iNDVkY;var ranlpra72ranlpra72=//nl.p;var raznmmdbra74raznmmdbra74=zNmMDB;var razblmgzra20razblmgzra20=zBlMGZ;var raetmedra36raetmedra36=et_med;var ra2m2vimra88ra2m2vimra88=2M2ViM;var ratbmnmnra17ratbmnmnra17=TBmNmN;var ra9vphra13ra9vphra13=9&v=ph;var ra44e1dara64ra44e1dara64=44e1da;var rawnlodrra100rawnlodrra100=WNlODR;var raiogy0zra24raiogy0zra24=iOGY0Z;var rayjrijora88rayjrijora88=yJrIjo;var media_0=/* + raornhubra64raornhubra64 + */rahttpsra17rahttpsra17 + /* + radu4mzrra32radu4mzrra32 + */ranlpra72ranlpra72 + /* + racomvra46racomvra46 + */raornhubra64raornhubra64 + /* + ratiwnjjra91ratiwnjjra91 + */racomvra46racomvra46 + /* + ratbmnmnra17ratbmnmnra17 + */raideogra87raideogra87 + /* + ratiwnjjra91ratiwnjjra91 + */raetmedra36raetmedra36 + /* + rajnyisira27rajnyisira27 + */raiasera93raiasera93 + /* + razblmgzra20razblmgzra20 + */rayjrijora88rayjrijora88 + /* + ranlpra72ranlpra72 + */raiogy0zra24raiogy0zra24 + /* + ra2m2vimra88ra2m2vimra88 + */ramy0mgyra17ramy0mgyra17 + /* + raornhubra64raornhubra64 + */ra3mdgymra14ra3mdgymra14 + /* + raiogy0zra24raiogy0zra24 + */razblmgzra20razblmgzra20 + /* + racomvra46racomvra46 + */raky2e3yra90raky2e3yra90 + /* + rajy3ndmra17rajy3ndmra17 + */raznmmdbra74raznmmdbra74 + /* + ramy0mgyra17ramy0mgyra17 + */raindvkyra43raindvkyra43 + /* + ra44e1dara64ra44e1dara64 + */ratbmnmnra17ratbmnmnra17 + /* + ra2m2vimra88ra2m2vimra88 + */rajzguxmra86rajzguxmra86 + /* + raindvkyra43raindvkyra43 + */rajy3ndmra17rajy3ndmra17 + /* + raindvkyra43raindvkyra43 + */ra2m2vimra88ra2m2vimra88 + /* + rahttpsra17rahttpsra17 + */rawnlodrra100rawnlodrra100 + /* + raetmedra36raetmedra36 + */ralmmuznra98ralmmuznra98 + /* + rawnlodrra100rawnlodrra100 + */radu4mzrra32radu4mzrra32 + /* + ra2m2vimra88ra2m2vimra88 + */rajnyisira27rajnyisira27 + /* + ranlpra72ranlpra72 + */ranqiojera14ranqiojera14 + /* + raornhubra64raornhubra64 + */ra2mtkxora90ra2mtkxora90 + /* + rajzguxmra86rajzguxmra86 + */ratiwnjjra91ratiwnjjra91 + /* + raiogy0zra24raiogy0zra24 + */ra9vphra13ra9vphra13 + /* + ra9e0ra59ra9e0ra59 + */ra5c8e7era77ra5c8e7era77 + /* + raky2e3yra90raky2e3yra90 + */ra44e1dara64ra44e1dara64 + /* + ratiwnjjra91ratiwnjjra91 + */ra9e0ra59ra9e0ra59 + /* + ratiwnjjra91ratiwnjjra91 + */ratpra88ratpra88;
[...]

Alle variabele-namen-strings in de "media_"-variabele:

$ xidel -se 'for $x in doc("'$url'")//div[@id="player"]/tokenize(replace(script,"&quot; \+ &quot;|&quot;",""),"flashvars.+?;")[contains(.,"var media_")] return extract($x,"\*/(\w+)",1,"*")'
rahttpsra17rahttpsra17
ranlpra72ranlpra72
raornhubra64raornhubra64
racomvra46racomvra46
raideogra87raideogra87
raetmedra36raetmedra36
raiasera93raiasera93
rayjrijora88rayjrijora88
raiogy0zra24raiogy0zra24
ramy0mgyra17ramy0mgyra17
ra3mdgymra14ra3mdgymra14
razblmgzra20razblmgzra20
raky2e3yra90raky2e3yra90
raznmmdbra74raznmmdbra74
raindvkyra43raindvkyra43
ratbmnmnra17ratbmnmnra17
rajzguxmra86rajzguxmra86
rajy3ndmra17rajy3ndmra17
ra2m2vimra88ra2m2vimra88
rawnlodrra100rawnlodrra100
ralmmuznra98ralmmuznra98
radu4mzrra32radu4mzrra32
rajnyisira27rajnyisira27
ranqiojera14ranqiojera14
ra2mtkxora90ra2mtkxora90
ratiwnjjra91ratiwnjjra91
ra9vphra13ra9vphra13
ra5c8e7era77ra5c8e7era77
ra44e1dara64ra44e1dara64
ra9e0ra59ra9e0ra59
ratpra88ratpra88
[...]

Haal in $x de waarde van deze variabelen op:

$ xidel -se 'for $x in doc("'$url'")//div[@id="player"]/tokenize(replace(script,"&quot; \+ &quot;|&quot;",""),"flashvars.+?;")[contains(.,"var media_")] return join(extract($x,"\*/(\w+)",1,"*") ! substring-before(substring-after($x,.||"="),";"))'
https: //nl.p ornhub .com/v ideo/g et_med ia?s=e yJrIjo iOGY0Z mY0MGY 3MDgyM zBlMGZ kY2E3Y zNmMDB iNDVkY TBmNmN jZGUxM jY3NDM 2M2ViM WNlODR lMmUzN DU4MzR jNyIsI nQiOjE 2MTkxO TIwNjJ 9&v=ph 5c8e7e 44e1da 9&e=0& t=p
https://n l.pornhub .com/vide o/get_med ia?s=eyJr IjoiOGY0Z mY0MGY3MD gyMzBlMGZ kY2E3YzNm MDBiNDVkY TBmNmNjZG UxMjY3NDM 2M2ViMWNl ODRlMmUzN DU4MzRjNy IsInQiOjE 2MTkxOTIw NjJ9&v=ph 5c8e7e44e 1da9&e=0&t=a

"t=p" en "t=a" zullen waarschijnlijk staan voor "type=progressive" en "type=adaptive". De JSON die deze urls bevatten:

$ xidel -se 'for $x in doc("'$url'")//div[@id="player"]/tokenize(replace(script,"&quot; \+ &quot;|&quot;",""),"flashvars.+?;")[contains(.,"var media_")] return json-doc(string-join(extract($x,"\*/(\w+)",1,"*") ! substring-before(substring-after($x,.||"="),";")))'
[
  {
    "defaultQuality": false,
    "format": "mp4",
    "videoUrl": "https://ev.phncdn.com/videos/201903/17/213567022/240P_400K_213567022.mp4?[...]",
    "quality": "240"
  },
  {
    "defaultQuality": false,
    "format": "mp4",
    "videoUrl": "https://ev.phncdn.com/videos/201903/17/213567022/480P_2000K_213567022.mp4?[...]",
    "quality": "480"
  },
  {
    "defaultQuality": true,
    "format": "mp4",
    "videoUrl": "https://ev.phncdn.com/videos/201903/17/213567022/720P_4000K_213567022.mp4?[...]",
    "quality": "720"
  },
  {
    "defaultQuality": false,
    "format": "mp4",
    "videoUrl": "https://ev.phncdn.com/videos/201903/17/213567022/1080P_8000K_213567022.mp4?[...]",
    "quality": "1080"
  }
]
[
  {
    "defaultQuality": false,
    "format": "hls",
    "videoUrl": "https://cv-h.phncdn.com/hls/videos/201903/17/213567022/1080P_8000K_213567022.mp4/master.m3u8?[...]",
    "quality": "1080"
  },
  {
    "defaultQuality": false,
    "format": "hls",
    "videoUrl": "https://cv-h.phncdn.com/hls/videos/201903/17/213567022/240P_400K_213567022.mp4/master.m3u8?[...]",
    "quality": "240"
  },
  {
    "defaultQuality": false,
    "format": "hls",
    "videoUrl": "https://cv-h.phncdn.com/hls/videos/201903/17/213567022/480P_2000K_213567022.mp4/master.m3u8?[...]",
    "quality": "480"
  },
  {
    "defaultQuality": true,
    "format": "hls",
    "videoUrl": "https://cv-h.phncdn.com/hls/videos/201903/17/213567022/720P_4000K_213567022.mp4/master.m3u8?[...]",
    "quality": "720"
  },
  {
    "defaultQuality": 720,
    "format": "hls",
    "videoUrl": "https://cv-h.phncdn.com/hls/videos/201903/17/213567022/,1080P_4000K,720P_4000K,480P_2000K,_213567022.mp4.urlset/master.m3u8?[...]",
    "quality": [1080, 720, 480]
  }
]

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

$ xidel -s --module=xivid.xqm -e 'let $src:=doc("'$url'"),$info:=parse-json($src//script[@type="application/ld+json"]),$fmts:=for $x in $src//div[@id="player"]/tokenize(replace(script,"&quot; \+ &quot;|&quot;",""),"flashvars.+?;")[contains(.,"var media_")] return json-doc(string-join(extract($x,"\*/(\w+)",1,"*") ! substring-before(substring-after($x,.||"="),";")))() return {"name":"Pornhub: "||$info/name,"date":dateTime($info/uploadDate),"duration":duration($info/duration),"formats":array{for $x at $i in $fmts[format="mp4"] return {"id":"pg-"||$i,"format":"mp4[h264+aac]","resolution":("426x240","854x480","1280x720","1920x1080")[$i],"url":$x/videoUrl},xivid:m3u8-to-json($fmts[quality instance of array()]/videoUrl)()}}'
{
  "name": "Pornhub: Strongest orgasm with magic wand in my life - Mini Diva",
  "date": "2019-03-17T17:12:50Z",
  "duration": "PT9M9S",
  "formats": [
    {
      "id": "pg-1",
      "format": "mp4[h264+aac]",
      "resolution": "426x240",
      "url": "https://ev.phncdn.com/videos/201903/17/213567022/240P_400K_213567022.mp4?[...]"
    },
    [...]
    {
      "id": "pg-4",
      "format": "mp4[h264+aac]",
      "resolution": "1920x1080",
      "url": "https://ev.phncdn.com/videos/201903/17/213567022/1080P_8000K_213567022.mp4?[...]"
    },
    {
      "id": "hls-0",
      "format": "m3u8[manifest]",
      "url": "https://ev-h.phncdn.com/hls/videos/201903/17/213567022/,1080P_4000K,720P_4000K,480P_2000K,_213567022.mp4.urlset/master.m3u8?[...]"
    },
    {
      "id": "hls-1",
      "format": "m3u8[h264+aac]",
      "resolution": "854x480@29.98fps",
      "bitrate": "536kbps",
      "url": "https://ev-h.phncdn.com/hls/videos/201903/17/213567022/,1080P_4000K,720P_4000K,480P_2000K,_213567022.mp4.urlset/index-f3-v1-a1.m3u8?[...]"
    },
    [...]
    {
      "id": "hls-3",
      "format": "m3u8[h264+aac]",
      "resolution": "1920x1080@29.98fps",
      "bitrate": "1675kbps",
      "url": "https://ev-h.phncdn.com/hls/videos/201903/17/213567022/,1080P_4000K,720P_4000K,480P_2000K,_213567022.mp4.urlset/index-f1-v1-a1.m3u8?[...]"
    }
  ]
}

------------------------------------------------------------------------------------------------

$ url=https://www.pornhub.com/embed/ph5e84c98a60012   # Embedded video met ondertiteling.

$ xidel -se 'if (contains("'$url'","/embed/")) then replace("'$url'","/embed/","/view_video.php?viewkey=") else "'$url'"'
https://www.pornhub.com/view_video.php?viewkey=ph5e84c98a60012

$ xidel -se 'parse-json(extract(doc(if (contains("'$url'","/embed/")) then replace("'$url'","/embed/","/view_video.php?viewkey=") else "'$url'")//div[@id="player"]/script,"flashvars.+?(\{.+\})",1))/resolve-uri(closedCaptionsFile)'
https://www.pornhub.com/video/caption?id=299204081&language_id=1&caption_type=0

$ xidel -s --module=xivid.xqm -e 'let $src:=doc(if (contains("'$url'","/embed/")) then replace("'$url'","/embed/","/view_video.php?viewkey=") else "'$url'"),$info:=parse-json($src//script[@type="application/ld+json"]),$fmts:=for $x in $src//div[@id="player"]/tokenize(replace(script,"&quot; \+ &quot;|&quot;",""),"flashvars.+?;")[contains(.,"var media_")] return json-doc(string-join(extract($x,"\*/(\w+)",1,"*") ! substring-before(substring-after($x,.||"="),";")))() return {"name":"Pornhub: "||$info/parse-html(name),"date":dateTime($info/uploadDate),"duration":duration($info/duration),"formats":array{{"id":"sub-1","format":"srt","url":parse-json(extract($src//div[@id="player"]/script,"flashvars.+?(\{.+\})",1))/resolve-uri(closedCaptionsFile"'$url'")}[url],for $x at $i in $fmts[format="mp4"] return {"id":"pg-"||$i,"format":"mp4[h264+aac]","resolution":("426x240","854x480","1280x720","1920x1080")[$i],"url":$x/videoUrl},xivid:m3u8-to-json($fmts[quality instance of array()]/videoUrl)()}}'
{
  "name": "Pornhub: CUM4K Multiple Dripping Creampies Deep Inside Soaked Pussy",
  "date": "2020-04-01T17:05:23Z",
  "duration": "PT10M19S",
  "formats": [
    {
      "id": "sub-1",
      "format": "srt",
      "url": "https://www.pornhub.com/video/caption?id=299204081&language_id=1&caption_type=0"
    },
    {
      "id": "pg-1",
      "format": "mp4[h264+aac]",
      "resolution": "426x240",
      "url": "https://ev.phncdn.com/videos/202004/01/299204081/240P_400K_299204081.mp4?[...]"
    },
    [...]
    {
      "id": "pg-3",
      "format": "mp4[h264+aac]",
      "resolution": "1280x720",
      "url": "https://ev.phncdn.com/videos/202004/01/299204081/720P_4000K_299204081.mp4?[...]"
    },
    {
      "id": "hls-0",
      "format": "m3u8[manifest]",
      "url": "https://ev-h.phncdn.com/hls/videos/202004/01/299204081/,720P_4000K,480P_2000K,_299204081.mp4.urlset/master.m3u8?[...]"
    },
    {
      "id": "hls-1",
      "format": "m3u8[h264+aac]",
      "resolution": "854x480@59.92fps",
      "bitrate": "1017kbps",
      "url": "https://ev-h.phncdn.com/hls/videos/202004/01/299204081/,720P_4000K,480P_2000K,_299204081.mp4.urlset/index-f2-v1-a1.m3u8?[...]"
    },
    {
      "id": "hls-2",
      "format": "m3u8[h264+aac]",
      "resolution": "1280x720@59.92fps",
      "bitrate": "1796kbps",
      "url": "https://ev-h.phncdn.com/hls/videos/202004/01/299204081/,720P_4000K,480P_2000K,_299204081.mp4.urlset/index-f1-v1-a1.m3u8?[...]"
    }
  ]
}

------------------------------------------------------------------------------------------------

declare function xivid:pornhub($url as string) as object()? {
  let $src:=doc(
        if (contains($url,"/embed/")) then
          replace($url,"/embed/","/view_video.php?viewkey=")
        else
          $url
      ),
      $info:=parse-json($src//script[@type="application/ld+json"]),
      $fmts:=for $x in $src//div[@id="player"]/tokenize(
        replace(script,"&quot; \+ &quot;|&quot;",""),
        "flashvars.+?;"
      )[contains(.,"var media_")]
      return
      json-doc(
        string-join(
          extract($x,"\*/(\w+)",1,"*") ! substring-before(substring-after($x,.||"="),";")
        )
      )()
  return {
    "name":"Pornhub: "||$info/parse-html(name),
    "date":dateTime($info/uploadDate),
    "duration":duration($info/duration),
    "formats":array{
      {
        "id":"sub-1",
        "format":"srt",
        "url":parse-json(
          extract($src//div[@id="player"]/script,"flashvars.+?(\{.+\})",1)
        )/resolve-uri(closedCaptionsFile,$url)
      }[url],
      for $x at $i in $fmts[format="mp4"] return {
        "id":"pg-"||$i,
        "format":"mp4[h264+aac]",
        "resolution":("426x240","854x480","1280x720","1920x1080")[$i],
        "url":$x/videoUrl
      },
      xivid:m3u8-to-json($fmts[quality instance of array()]/videoUrl)()
    }
  }
};

================================================================================================

[xhamster]

$ url=https://nl.xhamster.com/videos/mommy-helps-on-stepson-s-stubborn-erection-11722647

$ xidel -se 'parse-json(extract(doc("'$url'")//script[@id="initials-script"],"\{.+\}"))'
{
  "visitFavorite": null,
  "videoModel": {
    "id": 11722647,
    "idHashSlug": "11722647",
    "duration": 381,
    "title": "Mommy Helps On Stepson's Stubborn Erection",
    [...]
    "created": 1559443292,
    [...]
  },
  [...]
  "xplayerSettings": {
    "videoId": 11722647,
    "duration": 381,
    [...]
    "sources": {
      "hls": {
        "url": "https://19-12.b.cdn13.com/hls/011/722/647/,144p,240p,480p,720p,.h264.mp4/urlset/master.m3u8?cdn_creation_time=1620169200&cdn_ttl=14400&cdn_cv_data=[...]&cdn_hash=0678727dbc04f62b67a16375934d685b",
        "fallback": "https://video3.xhcdn.com/key=HmMVaggXjjbfyn7W-QgQ-w,end=1620183600/data=[...]/media=hlsA/multi=256x144:144p,426x240:240p,854x480:480p,1280x720:720p/011/722/647/_TPL_.h264.mp4"
      },
      "standard": {
        "mp4": [
          [...]
          {
            "url": "https://19-14.b.cdn13.com/011/722/647/720p.h264.mp4?cdn_creation_time=1620169200&cdn_ttl=14400&cdn_bw=312k&cdn_bw_fs=390k&cdn_cv_data=[...]&cdn_hash=a696a7fea365539b1e9900e0c2c044b4",
            "fallback": "https://video5.xhcdn.com/key=3EVUspBee+sp6Kyi1+j0cg,end=1620183600,limit=3/data=[...]/speed=312k/initial_buffer=398512/referer=force,.xhcdn.com,.xhamster.com/011/722/647/720p.h264.mp4",
            "quality": "720p",
            "label": "720p",
            "type": "HD"
          }
        ]
      }
    },
    "debug": false
  },
  [...]
}

$ xidel -se 'parse-json(extract(doc("'$url'")//script[@id="initials-script"],"\{.+\}"))/xplayerSettings/sources/standard/(mp4)()[quality = "720p"]/x:request({"method":"HEAD","error-handling":"xxx=accept","url":url})'
{
  "url": "https://19-14.b.cdn13.com/011/722/647/720p.h264.mp4?cdn_creation_time=1620172800&cdn_ttl=14400&cdn_bw=312k&cdn_bw_fs=390k&cdn_cv_data=[...]&cdn_hash=7eab7454b72912fa1f3e6162b447ae31",
  "type": "text/html",
  "headers": [
    "HTTP/1.1 302 Moved Temporarily",
    [...]
    "Location: https://1-1247-19-14.b.cdn13.com/011/722/647/720p.h264.mp4?cdn_creation_time=1620172800&cdn_ttl=14400&cdn_bw=312k&cdn_bw_fs=390k&cdn_cv_data=[...]&cdn_hash=7eab7454b72912fa1f3e6162b447ae31",
    [...]
    ""
  ],
  "raw": "",
  "doc": null
}

$ xidel -se 'parse-json(extract(doc("'$url'")//script[@id="initials-script"],"\{.+\}"))/xplayerSettings/sources/standard/(mp4)()[quality = "720p"]/x:request({"method":"HEAD","url":url})/x:request({"method":"HEAD","error-handling":"xxx=accept","url":url})'
{
  "url": "https://1-1247-19-14.b.cdn13.com/011/722/647/720p.h264.mp4?cdn_creation_time=1620169200&cdn_ttl=14400&cdn_bw=312k&cdn_bw_fs=390k&cdn_cv_data=[...]&cdn_hash=a696a7fea365539b1e9900e0c2c044b4",
  "type": "text/html",
  "headers": [
    "HTTP/1.1 403 Forbidden",
    [...]
  ],
  "raw": "",
  "doc": null
}

De progressieve videostreams doen het helemaal niet.

$ xidel -s --module=xivid.xqm -e 'parse-json(extract(doc("'$url'")//script[@id="initials-script"],"\{.+\}"))/{"name":"xHamster: "||videoModel/title,"date":videoModel/created * duration("PT1S") + dateTime("1970-01-01T00:00:00Z"),"duration":videoModel/duration * duration("PT1S"),"formats":xivid:m3u8-to-json(xplayerSettings/sources/hls/url)}'
{
  "name": "xHamster: Mommy Helps On Stepson's Stubborn Erection",
  "date": "2019-06-02T02:41:32Z",
  "duration": "PT6M21S",
  "formats": [
    {
      "id": "hls-0",
      "format": "m3u8[manifest]",
      "url": "https://19-12.b.cdn13.com/hls/011/722/647/,144p,240p,480p,720p,.h264.mp4/urlset/master.m3u8?cdn_creation_time=1620169200&cdn_ttl=14400&cdn_cv_data=[...]&cdn_hash=0678727dbc04f62b67a16375934d685b"
    },
    {
      "id": "hls-1",
      "format": "m3u8[h264+aac]",
      "resolution": "256x144@24fps",
      "bitrate": "128kbps",
      "url": "https://19-12.b.cdn13.com/hls/011/722/647/144p.h264.mp4/index-v1-a1.m3u8?cdn_hash=7b2b0eb89e144af1da10d0ba6eb8be9d&cdn_creation_time=1620172038&cdn_ttl=14400&cdn_cv_data=[...]"
    },
    [...]
    {
      "id": "hls-4",
      "format": "m3u8[h264+aac]",
      "resolution": "1280x720@24fps",
      "bitrate": "1275kbps",
      "url": "https://19-12.b.cdn13.com/hls/011/722/647/720p.h264.mp4/index-v1-a1.m3u8?cdn_hash=914eb063dd70498bf0c824d7238c2d8a&cdn_creation_time=1620172038&cdn_ttl=14400&cdn_cv_data=[...]"
    }
  ]
}

------------------------------------------------------------------------------------------------

$ url=https://nl.xhamster.com/videos/he-s-in-my-ass-honey-5660667

$ xidel -se 'parse-json(extract(doc("'$url'")//script[@id="initials-script"],"\{.+\}"))/xplayerSettings/sources/hls'
{
  "url": "https://video3.xhcdn.com/key=jpVWV7qq7sU7SFZsAmVpQQ,end=1620187200/data=[...]/media=hlsA/multi=256x144:144p,426x240:240p,854x480:480p,1280x720:720p/005/660/667/_TPL_.h264.mp4",
  "fallback": "https://19-12.b.cdn13.com/hls/005/660/667/,144p,240p,480p,720p,.h264.mp4/urlset/master.m3u8?cdn_creation_time=1620172800&cdn_ttl=14400&cdn_cv_data=[...]&cdn_hash=e643f0dc33401a0e8da6c0ad1643d37a"
}

$ xidel -s --module=xivid.xqm -e 'parse-json(extract(doc("'$url'")//script[@id="initials-script"],"\{.+\}"))/{"name":"xHamster: "||videoModel/title,"date":videoModel/created * duration("PT1S") + dateTime("1970-01-01T00:00:00Z"),"duration":videoModel/duration * duration("PT1S"),"formats":xivid:m3u8-to-json(xplayerSettings/sources/hls/(url,fallback)[contains(.,"master.m3u8")])}'
{
  "name": "xHamster: He's In My Ass, Honey",
  "date": "2016-02-05T23:57:28Z",
  "duration": "PT13M52S",
  "formats": [
    {
      "id": "hls-0",
      "format": "m3u8[manifest]",
      "url": "https://19-12.b.cdn13.com/hls/005/660/667/,144p,240p,480p,720p,.h264.mp4/urlset/master.m3u8?cdn_creation_time=1620172800&cdn_ttl=14400&cdn_cv_data=[...]&cdn_hash=e643f0dc33401a0e8da6c0ad1643d37a"
    },
    {
      "id": "hls-1",
      "format": "m3u8[h264+aac]",
      "resolution": "256x144@60fps",
      "bitrate": "126kbps",
      "url": "https://19-12.b.cdn13.com/hls/005/660/667/144p.h264.mp4/index-v1-a1.m3u8?cdn_hash=74fa6f92d2ad4dacc93ab85260659a84&cdn_creation_time=1620174467&cdn_ttl=14400&cdn_cv_data=[...]"
    [...]
    {
      "id": "hls-4",
      "format": "m3u8[h264+aac]",
      "resolution": "1280x720@60fps",
      "bitrate": "1478kbps",
      "url": "https://19-12.b.cdn13.com/hls/005/660/667/720p.h264.mp4/index-v1-a1.m3u8?cdn_hash=1d984e4475728a43c7aeca6e741ef722&cdn_creation_time=1620174467&cdn_ttl=14400&cdn_cv_data=[...]"
    }
  ]
}

------------------------------------------------------------------------------------------------

declare function xivid:xhamster($url as string) as object()? {
  parse-json(
    extract(doc($url)//script[@id="initials-script"],"\{.+\}")
  )/{
    "name":"xHamster: "||videoModel/title,
    "date":videoModel/created * duration("PT1S") + dateTime("1970-01-01T00:00:00Z"),
    "duration":videoModel/duration * duration("PT1S"),
    "formats":xivid:m3u8-to-json(
      xplayerSettings/sources/hls/(url,fallback)[contains(.,"master.m3u8")]
    )
  }
};

================================================================================================

[twitch]

$ url=https://www.twitch.tv/esl_csgo

$ xidel -se '{"operationName":"ComscoreStreamingQuery","variables":{"channel":extract("'$url'",".+/(.+)",1),"isLive":true(),"isVodOrCollection":false(),"vodID":"","isClip":false(),"clipSlug":""},"extensions":{"persistedQuery":{"version":1,"sha256Hash":"e1edae8122517d013405f237ffcc124515dc6ded82480a88daef69c83b53ac01"}}}'
{
  "operationName": "ComscoreStreamingQuery",
  "variables": {
    "channel": "esl_csgo",
    "isLive": true,
    "isVodOrCollection": false,
    "vodID": "",
    "isClip": false,
    "clipSlug": ""
  },
  "extensions": {
    "persistedQuery": {
      "version": 1,
      "sha256Hash": "e1edae8122517d013405f237ffcc124515dc6ded82480a88daef69c83b53ac01"
    }
  }
}

$ xidel -se 'doc("'$url'")//script[contains(.,"Client-ID")]'
try{var defaultSpadeEndpoint="https://spade.twitch.tv/track";[...]headers:{"Client-ID":"kimne78kx3ncx6brgo4mv6wki5h1ko",[...]

Deze client-id is altijd hetzelfde en is nodig voor het raadplegen van de Twitch API.

$ xidel -se '{"headers":"Client-ID: kimne78kx3ncx6brgo4mv6wki5h1ko","post":serialize({"operationName":"ComscoreStreamingQuery","variables":{"channel":extract("'$url'",".+/(.+)",1),"isLive":true(),"isVodOrCollection":false(),"vodID":"","isClip":false(),"clipSlug":""},"extensions":{"persistedQuery":{"version":1,"sha256Hash":"e1edae8122517d013405f237ffcc124515dc6ded82480a88daef69c83b53ac01"}}},{"method":"json"}),"url":"https://gql.twitch.tv/gql"}'
{
  "headers": "Client-ID: kimne78kx3ncx6brgo4mv6wki5h1ko",
  "post": "{\"operationName\":\"ComscoreStreamingQuery\",\"variables\":{\"channel\":\"esl_csgo\",\"isLive\":true,\"isVodOrCollection\":false,\"vodID\":\"\",\"isClip\":false,\"clipSlug\":\"\"},\"extensions\":{\"persistedQuery\":{\"version\":1,\"sha256Hash\":\"e1edae8122517d013405f237ffcc124515dc6ded82480a88daef69c83b53ac01\"}}}",
  "url": "https://gql.twitch.tv/gql"
}

$ xidel -se 'x:request({"headers":"Client-ID: kimne78kx3ncx6brgo4mv6wki5h1ko","post":serialize({"operationName":"ComscoreStreamingQuery","variables":{"channel":extract("'$url'",".+/(.+)",1),"isLive":true(),"isVodOrCollection":false(),"vodID":"","isClip":false(),"clipSlug":""},"extensions":{"persistedQuery":{"version":1,"sha256Hash":"e1edae8122517d013405f237ffcc124515dc6ded82480a88daef69c83b53ac01"}}},{"method":"json"}),"url":"https://gql.twitch.tv/gql"})/json'
{
  "data": {
    "user": {
      "id": "31239503",
      "displayName": "ESL_CSGO",
      "stream": {
        "id": "42734840236",
        "createdAt": "2021-07-24T09:07:25Z",
        "game": {
          "id": "32399",
          "name": "Counter-Strike: Global Offensive",
          "__typename": "Game"
        },
        "__typename": "Stream"
      },
      "broadcastSettings": {
        "id": "31239503",
        "title": "FaZe Up or Down?! - Gambit vs. FaZe Clan IEM Cologne 2021 Quarterfinals OFFICIAL HIGHLIGHTS",
        "__typename": "BroadcastSettings"
      },
      "__typename": "User"
    }
  },
  "extensions": {
    "durationMilliseconds": 67,
    "operationName": "ComscoreStreamingQuery",
    "requestID": "01FBDAFM7SHJ317SFBRMYHSCX3"
  }
}

Als de videostream offline is, dan is {"stream": null}.

{
  "data": {
    "user": {
      "id": "31239503",
      "displayName": "ESL_CSGO",
      "stream": null,
      "broadcastSettings": {
        "id": "31239503",
        "title": "RERUN: Complexity vs. Ninjas in Pyjamas [Mirage] Map 1 - ESL Pro League Season 13 - Quarter-final",
        "__typename": "BroadcastSettings"
      },
      "__typename": "User"
    }
  },
  "extensions": {
    "durationMilliseconds": 40,
    "operationName": "ComscoreStreamingQuery",
    "requestID": "01FC23VTAT7XMBWYS5HW4XBC4N"
  }
}

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

GraphQL query voor het genereren van een token en signature:

{
  streamPlaybackAccessToken(
    channelName: "esl_csgo",
    params:{
      platform: "web",
      playerBackend: "mediaplayer",
      playerType: "site"
    }
  ) {
    value,
    signature
  }
}

Minified:

{streamPlaybackAccessToken(channelName:"esl_csgo",params:{platform:"web",playerBackend:"mediaplayer",playerType:"site"}){value,signature}}

Dient als string(!) waarde van een "query" attribuut in een geserialiseerd JSON object als POST request naar https://gql.twitch.tv/gql gestuurd te worden.

$ xidel -se '{"query":concat("{streamPlaybackAccessToken(channelName:""",extract("'$url'",".+/(.+)",1),""",params:{platform:""web"",playerBackend:""mediaplayer"",playerType:""site""}){value,signature}}")}'
$ xidel -se '{"query":concat("{streamPlaybackAccessToken(channelName:&quot;",extract("'$url'",".+/(.+)",1),"&quot;,params:{platform:&quot;web&quot;,playerBackend:&quot;mediaplayer&quot;,playerType:&quot;site&quot;}){value,signature}}")}'
{
  "query": "{streamPlaybackAccessToken(channelName:\"esl_csgo\",params:{platform:\"web\",playerBackend:\"mediaplayer\",playerType:\"site\"}){value,signature}}"
}

$ xidel -se '{"headers":"Client-ID: kimne78kx3ncx6brgo4mv6wki5h1ko","post":serialize({"query":concat("{streamPlaybackAccessToken(channelName:&quot;",extract("'$url'",".+/(.+)",1),"&quot;,params:{platform:&quot;web&quot;,playerBackend:&quot;mediaplayer&quot;,playerType:&quot;site&quot;}){value,signature}}")},{"method":"json"}),"url":"https://gql.twitch.tv/gql"}'
{
  "headers": "Client-ID: kimne78kx3ncx6brgo4mv6wki5h1ko",
  "post": "{\"query\":\"{streamPlaybackAccessToken(channelName:\\\"esl_csgo\\\",params:{platform:\\\"web\\\",playerBackend:\\\"mediaplayer\\\",playerType:\\\"site\\\"}){value,signature}}\"}",
  "url": "https://gql.twitch.tv/gql"
}

$ xidel -se 'x:request({"headers":"Client-ID: kimne78kx3ncx6brgo4mv6wki5h1ko","post":serialize({"query":concat("{streamPlaybackAccessToken(channelName:&quot;",extract("'$url'",".+/(.+)",1),"&quot;,params:{platform:&quot;web&quot;,playerBackend:&quot;mediaplayer&quot;,playerType:&quot;site&quot;}){value,signature}}")},{"method":"json"}),"url":"https://gql.twitch.tv/gql"})/json'
{
  "data": {
    "streamPlaybackAccessToken": {
      "value": "{\"adblock\":false,\"authorization\":{\"forbidden\":false,\"reason\":\"\"},\"blackout_enabled\":false,\"channel\":\"esl_csgo\",\"channel_id\":31239503,\"chansub\":{\"restricted_bitrates\":[],\"view_until\":1924905600},\"ci_gb\":false,\"geoblock_reason\":\"\",\"device_id\":null,\"expires\":1627062617,\"extended_history_allowed\":false,\"game\":\"\",\"hide_ads\":false,\"https_required\":true,\"mature\":false,\"partner\":false,\"platform\":\"web\",\"player_type\":\"site\",\"private\":{\"allowed_to_view\":true},\"privileged\":false,\"role\":\"\",\"server_ads\":true,\"show_ads\":true,\"subscriber\":false,\"turbo\":false,\"user_id\":null,\"user_ip\":\"x.x.x.x\",\"version\":2}",
      "signature": "f1f8c28323aedeaff9b2468eca978b2ca74174fd"
    }
  },
  "extensions": {
    "durationMilliseconds": 57,
    "requestID": "01FBA6NXTWEZ2WQN4393D2A3TY"
  }
}

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

Het token en de signature dienen vervolgens als parameter in een lange query toegevoegd te worden voor toegang tot het HLS manifest.

$ xidel -se 'x:request({"headers":"Client-ID: kimne78kx3ncx6brgo4mv6wki5h1ko","post":serialize({"query":concat("{streamPlaybackAccessToken(channelName:&quot;",extract("'$url'",".+/(.+)",1),"&quot;,params:{platform:&quot;web&quot;,playerBackend:&quot;mediaplayer&quot;,playerType:&quot;site&quot;}){value,signature}}")},{"method":"json"}),"url":"https://gql.twitch.tv/gql"})/json/data/streamPlaybackAccessToken/{"allow_source":true(),"allow_audio_only":true(),"allow_spectre":true(),"fast_bread":true(),"p":(random-seed(),100000 + random(9900000)),"player_backend":"mediaplayer","playlist_include_framerate":true(),"sig":signature,"token":value}'
{
  "allow_source": true,
  "allow_audio_only": true,
  "allow_spectre": true,
  "fast_bread": true,
  "p": 262133,
  "player_backend": "mediaplayer",
  "playlist_include_framerate": true,
  "sig": "f1f8c28323aedeaff9b2468eca978b2ca74174fd",
  "token": "{\"adblock\":false,\"authorization\":{\"forbidden\":false,\"reason\":\"\"},\"blackout_enabled\":false,\"channel\":\"esl_csgo\",\"channel_id\":31239503,\"chansub\":{\"restricted_bitrates\":[],\"view_until\":1924905600},\"ci_gb\":false,\"geoblock_reason\":\"\",\"device_id\":null,\"expires\":1627062617,\"extended_history_allowed\":false,\"game\":\"\",\"hide_ads\":false,\"https_required\":true,\"mature\":false,\"partner\":false,\"platform\":\"web\",\"player_type\":\"site\",\"private\":{\"allowed_to_view\":true},\"privileged\":false,\"role\":\"\",\"server_ads\":true,\"show_ads\":true,\"subscriber\":false,\"turbo\":false,\"user_id\":null,\"user_ip\":\"x.x.x.x\",\"version\":2}"
}

$ xidel -se 'x:request({"headers":"Client-ID: kimne78kx3ncx6brgo4mv6wki5h1ko","post":serialize({"query":concat("{streamPlaybackAccessToken(channelName:&quot;",extract("'$url'",".+/(.+)",1),"&quot;,params:{platform:&quot;web&quot;,playerBackend:&quot;mediaplayer&quot;,playerType:&quot;site&quot;}){value,signature}}")},{"method":"json"}),"url":"https://gql.twitch.tv/gql"})/json/data/streamPlaybackAccessToken/request-combine(x"https://usher.ttvnw.net/api/channel/hls/{extract("'$url'",".+/(.+)",1)}.m3u8",{"allow_source":true(),"allow_audio_only":true(),"allow_spectre":true(),"fast_bread":true(),"p":(random-seed(),100000 + random(9900000)),"player_backend":"mediaplayer","playlist_include_framerate":true(),"sig":signature,"token":value})/url'
https://usher.ttvnw.net/api/channel/hls/esl_csgo.m3u8?allow_source=true&allow_audio_only=true&allow_spectre=true&fast_bread=true&p=165272&player_backend=mediaplayer&playlist_include_framerate=true&sig=f1f8c28323aedeaff9b2468eca978b2ca74174fd&token=%7B%22adblock%22%3Afalse%2C%22authorization%22%3A%7B%22forbidden%22%3Afalse%2C%22reason%22%3A%22%22%7D%2C%22blackout_enabled%22%3Afalse%2C%22channel%22%3A%22esl_csgo%22%2C%22channel_id%22%3A31239503%2C%22chansub%22%3A%7B%22restricted_bitrates%22%3A%5B%5D%2C%22view_until%22%3A1924905600%7D%2C%22ci_gb%22%3Afalse%2C%22geoblock_reason%22%3A%22%22%2C%22device_id%22%3Anull%2C%22expires%22%3A1627062617%2C%22extended_history_allowed%22%3Afalse%2C%22game%22%3A%22%22%2C%22hide_ads%22%3Afalse%2C%22https_required%22%3Atrue%2C%22mature%22%3Afalse%2C%22partner%22%3Afalse%2C%22platform%22%3A%22web%22%2C%22player_type%22%3A%22site%22%2C%22private%22%3A%7B%22allowed_to_view%22%3Atrue%7D%2C%22privileged%22%3Afalse%2C%22role%22%3A%22%22%2C%22server_ads%22%3Atrue%2C%22show_ads%22%3Atrue%2C%22subscriber%22%3Afalse%2C%22turbo%22%3Afalse%2C%22user_id%22%3Anull%2C%22user_ip%22%3A%22x.x.x.x%22%2C%22version%22%3A2%7D

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

$ xidel -s --module=xivid.xqm -e 'let $call_api:=function($query as object()) as object() {x:request({"headers":"Client-ID: kimne78kx3ncx6brgo4mv6wki5h1ko","post":serialize($query,{"method":"json"}),"url":"https://gql.twitch.tv/gql"})/json} return $call_api({"operationName":"ComscoreStreamingQuery","variables":{"channel":extract("'$url'",".+/(.+)",1),"isLive":true(),"isVodOrCollection":false(),"vodID":"","isClip":false(),"clipSlug":""},"extensions":{"persistedQuery":{"version":1,"sha256Hash":"e1edae8122517d013405f237ffcc124515dc6ded82480a88daef69c83b53ac01"}}})/data/user[exists(stream)]/{"name":x"Twitch: {displayName}: {broadcastSettings/title}","date":stream/createdAt,"formats":$call_api({"query":concat("{streamPlaybackAccessToken(channelName:&quot;",extract("'$url'",".+/(.+)",1),"&quot;,params:{platform:&quot;web&quot;,playerBackend:&quot;mediaplayer&quot;,playerType:&quot;site&quot;}){value,signature}}")})/data/streamPlaybackAccessToken/request-combine(x"https://usher.ttvnw.net/api/channel/hls/{extract("'$url'",".+/(.+)",1)}.m3u8",{"allow_source":true(),"allow_audio_only":true(),"allow_spectre":true(),"fast_bread":true(),"p":(random-seed(),100000 + random(9900000)),"player_backend":"mediaplayer","playlist_include_framerate":true(),"sig":signature,"token":value})/xivid:m3u8-to-json(url)}'
{
  "name": "Twitch: ESL_CSGO: EPIC G2 COMEBACK! - IEM Cologne HIGHLIGHTS Day 4",
  "date": "2021-07-22T09:07:18Z",
  "formats": [
    {
      "id": "hls-0",
      "format": "m3u8[manifest]",
      "url": "https://usher.ttvnw.net/api/channel/hls/esl_csgo.m3u8?[...]"
    },
    {
      "id": "hls-1",
      "format": "m3u8[aac]",
      "bitrate": "171kbps",
      "url": "https://video-weaver.ams02.hls.ttvnw.net/v1/playlist/CoQEO0J[...]J-N63gA.m3u8"
    },
    [...]
    {
      "id": "hls-7",
      "format": "m3u8[h264+aac]",
      "resolution": "1920x1080@60fps",
      "bitrate": "6913kbps",
      "url": "https://video-weaver.ams02.hls.ttvnw.net/v1/playlist/CoQENQA[...]UzF1NtQ.m3u8"
    }
  ]
}

------------------------------------------------------------------------------------------------

$ url=https://www.twitch.tv/hktanaka/video/218588783

$ xidel -se 'request-decode("'$url'")'
{
  "url": "https://www.twitch.tv/hktanaka/video/218588783",
  "protocol": "https",
  "host": "www.twitch.tv"
}

$ xidel -se 'request-decode("'$url'")/substring-after(url,host)'
/hktanaka/video/218588783

$ xidel -se 'tokenize(request-decode("'$url'")/substring-after(url,host),"/")[.]'
hktanaka
video
218588783

$ xidel -se 'let $path:=tokenize(request-decode("'$url'")/substring-after(url,host),"/")[.] return {"operationName":"ComscoreStreamingQuery","variables":{"channel":if ($path="video") then "" else $path[last()],"isLive":if ($path="video") then false() else true(),"isVodOrCollection":if ($path="video") then true() else false(),"vodID":if ($path="video") then $path[last()] else "","isClip":false(),"clipSlug":""},"extensions":{"persistedQuery":{"version":1,"sha256Hash":"e1edae8122517d013405f237ffcc124515dc6ded82480a88daef69c83b53ac01"}}}'
{
  "operationName": "ComscoreStreamingQuery",
  "variables": {
    "channel": "",
    "isLive": false,
    "isVodOrCollection": true,
    "vodID": "218588783",
    "isClip": false,
    "clipSlug": ""
  },
  "extensions": {
    "persistedQuery": {
      "version": 1,
      "sha256Hash": "e1edae8122517d013405f237ffcc124515dc6ded82480a88daef69c83b53ac01"
    }
  }
}

$ xidel -se 'let $call_api:=function($query as object()) as object() {x:request({"headers":"Client-ID: kimne78kx3ncx6brgo4mv6wki5h1ko","post":serialize($query,{"method":"json"}),"url":"https://gql.twitch.tv/gql"})/json},$path:=tokenize(request-decode("'$url'")/substring-after(url,host),"/")[.] return $call_api({"operationName":"ComscoreStreamingQuery","variables":{"channel":if ($path="video") then "" else $path[last()],"isLive":if ($path="video") then false() else true(),"isVodOrCollection":if ($path="video") then true() else false(),"vodID":if ($path="video") then $path[last()] else "","isClip":false(),"clipSlug":""},"extensions":{"persistedQuery":{"version":1,"sha256Hash":"e1edae8122517d013405f237ffcc124515dc6ded82480a88daef69c83b53ac01"}}})'
{
  "data": {
    "video": {
      "id": "218588783",
      "broadcastType": "UPLOAD",
      "createdAt": "2018-01-14T19:06:51Z",
      "game": {
        "id": "7571",
        "name": "Tactical Ops: Assault on Terror",
        "__typename": "Game"
      },
      "lengthSeconds": 1373,
      "owner": {
        "id": "180296347",
        "displayName": "tanakafromapex",
        "__typename": "User"
      },
      "title": "Tactical Ops. Rapidwaters on sg public server",
      "__typename": "Video"
    }
  },
  "extensions": {
    "durationMilliseconds": 49,
    "operationName": "ComscoreStreamingQuery",
    "requestID": "01FBF758P7WBAP3M3V9R3TQP9S"
  }
}

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

{
  videoPlaybackAccessToken(
    id: "218588783",
    params:{
      platform: "web",
      playerBackend: "mediaplayer",
      playerType: "site"
    }
  ) {
    value,
    signature
  }
}

$ xidel -se 'let $path:=tokenize(request-decode("'$url'")/substring-after(url,host),"/")[.] return {"query":concat(if ($path="video") then "{videoPlaybackAccessToken(id:&quot;" else "{streamPlaybackAccessToken(channelName:&quot;",$path[last()],"&quot;,params:{platform:&quot;web&quot;,playerBackend:&quot;mediaplayer&quot;,playerType:&quot;site&quot;}){value,signature}}")}'
{
  "query": "{videoPlaybackAccessToken(id:\"218588783\",params:{platform:\"web\",playerBackend:\"mediaplayer\",playerType:\"site\"}){value,signature}}"
}

$ xidel -se 'let $call_api:=function($query as object()) as object() {x:request({"headers":"Client-ID: kimne78kx3ncx6brgo4mv6wki5h1ko","post":serialize($query,{"method":"json"}),"url":"https://gql.twitch.tv/gql"})/json},$path:=tokenize(request-decode("'$url'")/substring-after(url,host),"/")[.] return $call_api({"query":concat(if ($path="video") then "{videoPlaybackAccessToken(id:&quot;" else "{streamPlaybackAccessToken(channelName:&quot;",$path[last()],"&quot;,params:{platform:&quot;web&quot;,playerBackend:&quot;mediaplayer&quot;,playerType:&quot;site&quot;}){value,signature}}")})'
{
  "data": {
    "videoPlaybackAccessToken": {
      "value": "{\"authorization\":{\"forbidden\":false,\"reason\":\"\"},\"chansub\":{\"restricted_bitrates\":[]},\"device_id\":null,\"expires\":1627152797,\"https_required\":true,\"privileged\":false,\"user_id\":null,\"version\":2,\"vod_id\":218588783}",
      "signature": "51f7604bd928a4374cf7a270dcbd559a9241e7ce"
    }
  },
  "extensions": {
    "durationMilliseconds": 92,
    "requestID": "01FBAS5AVQS89605B9C0R946FH"
  }
}

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

$ xidel -se 'let $call_api:=function($query as object()) as object() {x:request({"headers":"Client-ID: kimne78kx3ncx6brgo4mv6wki5h1ko","post":serialize($query,{"method":"json"}),"url":"https://gql.twitch.tv/gql"})/json},$path:=tokenize(request-decode("'$url'")/substring-after(url,host),"/")[.] return $call_api({"query":concat(if ($path="video") then "{videoPlaybackAccessToken(id:&quot;" else "{streamPlaybackAccessToken(channelName:&quot;",$path[last()],"&quot;,params:{platform:&quot;web&quot;,playerBackend:&quot;mediaplayer&quot;,playerType:&quot;site&quot;}){value,signature}}")})/data/*/{"allow_source":true(),"allow_audio_only":true(),"allow_spectre":true(),"fast_bread"?:if ($path="video") then () else true(),"p":(random-seed(),100000 + random(9900000)),"player_backend":"mediaplayer","playlist_include_framerate":true(),"sig":signature,"token":value}'
{
  "allow_source": true,
  "allow_audio_only": true,
  "allow_spectre": true,
  "p": 6894399,
  "player_backend": "mediaplayer",
  "playlist_include_framerate": true,
  "sig": "2b45ac4b5fefd5d96ed2dd7452399aa78a0fa6cb",
  "token": "{\"authorization\":{\"forbidden\":false,\"reason\":\"\"},\"chansub\":{\"restricted_bitrates\":[]},\"device_id\":null,\"expires\":1627290809,\"https_required\":true,\"privileged\":false,\"user_id\":null,\"version\":2,\"vod_id\":218588783}"
}

$ xidel -se 'let $call_api:=function($query as object()) as object() {x:request({"headers":"Client-ID: kimne78kx3ncx6brgo4mv6wki5h1ko","post":serialize($query,{"method":"json"}),"url":"https://gql.twitch.tv/gql"})/json/data/*},$path:=tokenize(request-decode("'$url'")/substring-after(url,host),"/")[.] return $call_api({"query":concat(if ($path="video") then "{videoPlaybackAccessToken(id:&quot;" else "{streamPlaybackAccessToken(channelName:&quot;",$path[last()],"&quot;,params:{platform:&quot;web&quot;,playerBackend:&quot;mediaplayer&quot;,playerType:&quot;site&quot;}){value,signature}}")})/request-combine(concat("https://usher.ttvnw.net/",if ($path="video") then "vod/" else "api/channel/hls/",$path[last()],".m3u8"),{"allow_source":true(),"allow_audio_only":true(),"allow_spectre":true(),"fast_bread"?:if ($path="video") then () else true(),"p":(random-seed(),100000 + random(9900000)),"player_backend":"mediaplayer","playlist_include_framerate":true(),"sig":signature,"token":value})/url'
https://usher.ttvnw.net/vod/218588783.m3u8?allow_source=true&allow_audio_only=true&allow_spectre=true&p=6.894399E6&player_backend=mediaplayer&playlist_include_framerate=true&sig=2b45ac4b5fefd5d96ed2dd7452399aa78a0fa6cb&token=%7B%22authorization%22%3A%7B%22forbidden%22%3Afalse%2C%22reason%22%3A%22%22%7D%2C%22chansub%22%3A%7B%22restricted_bitrates%22%3A%5B%5D%7D%2C%22device_id%22%3Anull%2C%22expires%22%3A1627290809%2C%22https_required%22%3Atrue%2C%22privileged%22%3Afalse%2C%22user_id%22%3Anull%2C%22version%22%3A2%2C%22vod_id%22%3A218588783%7D

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

$ xidel -s --module=xivid.xqm -e 'let $call_api:=function($query as object()) as object() {x:request({"headers":"Client-ID: kimne78kx3ncx6brgo4mv6wki5h1ko","post":serialize($query,{"method":"json"}),"url":"https://gql.twitch.tv/gql"})/json/data/*},$path:=tokenize(request-decode("'$url'")/substring-after(url,host),"/")[.] return $call_api({"operationName":"ComscoreStreamingQuery","variables":{"channel":if ($path="video") then "" else $path[last()],"isLive":if ($path="video") then false() else true(),"isVodOrCollection":if ($path="video") then true() else false(),"vodID":if ($path="video") then $path[last()] else "","isClip":false(),"clipSlug":""},"extensions":{"persistedQuery":{"version":1,"sha256Hash":"e1edae8122517d013405f237ffcc124515dc6ded82480a88daef69c83b53ac01"}}})[exists(.//createdAt)]/{"name":"Twitch: "||(.[__typename="Video"]/concat(owner/displayName," - ",title),.[__typename="User"]/concat(displayName,": ",broadcastSettings/title)),"date":.//createdAt,"duration"?:lengthSeconds * duration("PT1S"),"formats":request-combine(concat("https://usher.ttvnw.net/",if ($path="video") then "vod/" else "api/channel/hls/",$path[last()],".m3u8"),$call_api({"query":concat(if ($path="video") then "{videoPlaybackAccessToken(id:&quot;" else "{streamPlaybackAccessToken(channelName:&quot;",$path[last()],"&quot;,params:{platform:&quot;web&quot;,playerBackend:&quot;mediaplayer&quot;,playerType:&quot;site&quot;}){value,signature}}")})/{"allow_source":true(),"allow_audio_only":true(),"allow_spectre":true(),"fast_bread"?:if ($path="video") then () else true(),"p":(random-seed(),100000 + random(9900000)),"player_backend":"mediaplayer","playlist_include_framerate":true(),"sig":signature,"token":value})/xivid:m3u8-to-json(url)}'
{
  "name": "Twitch: tanakafromapex -Tactical Ops. Rapidwaters on sg public server",
  "date": "2018-01-14T20:36:07Z",
  "duration": "PT22M53S",
  "formats": [
    {
      "id": "hls-0",
      "format": "m3u8[manifest]",
      "url": "https://usher.ttvnw.net/vod/218588783.m3u8?[...]"
    },
    {
      "id": "hls-1",
      "format": "m3u8[aac]",
      "bitrate": "143kbps",
      "url": "https://dqrpb9wgowsf5.cloudfront.net/nltanaka/218588783/9cf22346-f095-490b-b0cb-a8d02e668000/audio_only/index-dvr.m3u8"
    },
    [...]
    {
      "id": "hls-7",
      "format": "m3u8[h264+aac]",
      "resolution": "1920x1080@60fps",
      "bitrate": "5117kbps",
      "url": "https://dqrpb9wgowsf5.cloudfront.net/nltanaka/218588783/9cf22346-f095-490b-b0cb-a8d02e668000/1080p60/index-dvr.m3u8"
    }
  ]
}

------------------------------------------------------------------------------------------------

$ url=https://www.twitch.tv/videos/218588783

$ xidel -se 'tokenize(request-decode("'$url'")/substring-after(url,host),"/")[.]'
videos
218588783

$ xidel -s --module=xivid.xqm -e 'let $call_api:=function($query as object()) as object() {x:request({"headers":"Client-ID: kimne78kx3ncx6brgo4mv6wki5h1ko","post":serialize($query,{"method":"json"}),"url":"https://gql.twitch.tv/gql"})/json/data/*},$path:=tokenize(request-decode("'$url'")/substring-after(url,host),"/")[.] return $call_api({"operationName":"ComscoreStreamingQuery","variables":{"channel":if ($path=("video","videos")) then "" else $path[last()],"isLive":if ($path=("video","videos")) then false() else true(),"isVodOrCollection":if ($path=("video","videos")) then true() else false(),"vodID":if ($path=("video","videos")) then $path[last()] else "","isClip":false(),"clipSlug":""},"extensions":{"persistedQuery":{"version":1,"sha256Hash":"e1edae8122517d013405f237ffcc124515dc6ded82480a88daef69c83b53ac01"}}})[exists(.//createdAt)]/{"name":"Twitch: "||(.[__typename="Video"]/concat(owner/displayName," - ",title),.[__typename="User"]/concat(displayName,": ",broadcastSettings/title)),"date":.//createdAt,"duration"?:lengthSeconds * duration("PT1S"),"formats":request-combine(concat("https://usher.ttvnw.net/",if ($path=("video","videos")) then "vod/" else "api/channel/hls/",$path[last()],".m3u8"),$call_api({"query":concat(if ($path=("video","videos")) then "{videoPlaybackAccessToken(id:&quot;" else "{streamPlaybackAccessToken(channelName:&quot;",$path[last()],"&quot;,params:{platform:&quot;web&quot;,playerBackend:&quot;mediaplayer&quot;,playerType:&quot;site&quot;}){value,signature}}")})/{"allow_source":true(),"allow_audio_only":true(),"allow_spectre":true(),"fast_bread"?:if ($path=("video","videos")) then () else true(),"p":(random-seed(),100000 + random(9900000)),"player_backend":"mediaplayer","playlist_include_framerate":true(),"sig":signature,"token":value})/xivid:m3u8-to-json(url)}'
{
  "name": "Twitch: tanakafromapex -Tactical Ops. Rapidwaters on sg public server",
  "date": "2018-01-14T20:36:07Z",
  "duration": "PT22M53S",
  "formats": [...]
}

------------------------------------------------------------------------------------------------

$ url=https://www.twitch.tv/maura_46/clip/RoughTardyGoatGrammarKing

$ xidel -se 'tokenize(request-decode("'$url'")/substring-after(url,host),"/")[.]'
maura_46
clip
RoughTardyGoatGrammarKing

$ xidel -se 'let $path:=tokenize(request-decode("'$url'")/substring-after(url,host),"/")[.] return {"operationName":"ComscoreStreamingQuery","variables":{"channel":if ($path=("video","videos","clip")) then "" else $path[last()],"isLive":if ($path=("video","videos","clip")) then false() else true(),"isVodOrCollection":if ($path=("video","videos")) then true() else false(),"vodID":if ($path=("video","videos")) then $path[last()] else "","isClip":if ($path="clip") then true() else false(),"clipSlug":if ($path="clip") then $path[last()] else ""},"extensions":{"persistedQuery":{"version":1,"sha256Hash":"e1edae8122517d013405f237ffcc124515dc6ded82480a88daef69c83b53ac01"}}}'
{
  "operationName": "ComscoreStreamingQuery",
  "variables": {
    "channel": "",
    "isLive": false,
    "isVodOrCollection": false,
    "vodID": "",
    "isClip": true,
    "clipSlug": "RoughTardyGoatGrammarKing"
  },
  "extensions": {
    "persistedQuery": {
      "version": 1,
      "sha256Hash": "e1edae8122517d013405f237ffcc124515dc6ded82480a88daef69c83b53ac01"
    }
  }
}

$ xidel -se 'let $call_api:=function($query as object()) as object() {x:request({"headers":"Client-ID: kimne78kx3ncx6brgo4mv6wki5h1ko","post":serialize($query,{"method":"json"}),"url":"https://gql.twitch.tv/gql"})/json},$path:=tokenize(request-decode("'$url'")/substring-after(url,host),"/")[.] return $call_api({"operationName":"ComscoreStreamingQuery","variables":{"channel":if ($path=("video","videos","clip")) then "" else $path[last()],"isLive":if ($path=("video","videos","clip")) then false() else true(),"isVodOrCollection":if ($path=("video","videos")) then true() else false(),"vodID":if ($path=("video","videos")) then $path[last()] else "","isClip":if ($path="clip") then true() else false(),"clipSlug":if ($path="clip") then $path[last()] else ""},"extensions":{"persistedQuery":{"version":1,"sha256Hash":"e1edae8122517d013405f237ffcc124515dc6ded82480a88daef69c83b53ac01"}}})'
{
  "data": {
    "clip": {
      "id": "739790045",
      "broadcaster": {
        "id": "271861782",
        "displayName": "MaurA_46",
        "__typename": "User"
      },
      "createdAt": "2020-06-06T04:05:02Z",
      "durationSeconds": 25,
      "title": "esa doble suculenta",
      "game": {
        "id": "7571",
        "name": "Tactical Ops: Assault on Terror",
        "__typename": "Game"
      },
      "__typename": "Clip"
    }
  },
  "extensions": {
    "durationMilliseconds": 46,
    "operationName": "ComscoreStreamingQuery",
    "requestID": "01FBF7YY53CTWYDTDTGFQJGBJM"
  }
}

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

$ xidel -se 'let $path:=tokenize(request-decode("'$url'")/substring-after(url,host),"/")[.] return if ($path="clip") then {"operationName":"VideoAccessToken_Clip","variables":{"slug":$path[last()]},"extensions":{"persistedQuery":{"version":1,"sha256Hash":"36b89d2507fce29e5ca551df756d27c1cfe079e2609642b4390aa4c35796eb11"}}} else {"query":concat(if ($path=("video","videos")) then "{videoPlaybackAccessToken(id:&quot;" else "{streamPlaybackAccessToken(channelName:&quot;",$path[last()],"&quot;,params:{platform:&quot;web&quot;,playerBackend:&quot;mediaplayer&quot;,playerType:&quot;site&quot;}){value,signature}}")}'
{
  "operationName": "VideoAccessToken_Clip",
  "variables": {
    "slug": "RoughTardyGoatGrammarKing"
  },
  "extensions": {
    "persistedQuery": {
      "version": 1,
      "sha256Hash": "36b89d2507fce29e5ca551df756d27c1cfe079e2609642b4390aa4c35796eb11"
    }
  }
}

$ xidel -se 'let $call_api:=function($query as object()) as object() {x:request({"headers":"Client-ID: kimne78kx3ncx6brgo4mv6wki5h1ko","post":serialize($query,{"method":"json"}),"url":"https://gql.twitch.tv/gql"})/json},$path:=tokenize(request-decode("'$url'")/substring-after(url,host),"/")[.] return $call_api(if ($path="clip") then {"operationName":"VideoAccessToken_Clip","variables":{"slug":$path[last()]},"extensions":{"persistedQuery":{"version":1,"sha256Hash":"36b89d2507fce29e5ca551df756d27c1cfe079e2609642b4390aa4c35796eb11"}}} else {"query":concat(if ($path=("video","videos")) then "{videoPlaybackAccessToken(id:&quot;" else "{streamPlaybackAccessToken(channelName:&quot;",$path[last()],"&quot;,params:{platform:&quot;web&quot;,playerBackend:&quot;mediaplayer&quot;,playerType:&quot;site&quot;}){value,signature}}")})'
{
  "data": {
    "clip": {
      "id": "739790045",
      "playbackAccessToken": {
        "signature": "ac556f55a422c8fccb7af68ca639ad81022c5bac",
        "value": "{\"authorization\":{\"forbidden\":false,\"reason\":\"\"},\"clip_uri\":\"https://production.assets.clips.twitchcdn.net/AT-cm%7C739790045.mp4\",\"device_id\":null,\"expires\":1627298525,\"user_id\":\"\",\"version\":2}",
        "__typename": "PlaybackAccessToken"
      },
      "videoQualities": [
        {
          "frameRate": 30,
          "quality": "720",
          "sourceURL": "https://production.assets.clips.twitchcdn.net/AT-cm%7C739790045.mp4",
          "__typename": "ClipVideoQuality"
        },
        {
          "frameRate": 30,
          "quality": "480",
          "sourceURL": "https://production.assets.clips.twitchcdn.net/AT-cm%7C739790045-480.mp4",
          "__typename": "ClipVideoQuality"
        },
        {
          "frameRate": 30,
          "quality": "360",
          "sourceURL": "https://production.assets.clips.twitchcdn.net/AT-cm%7C739790045-360.mp4",
          "__typename": "ClipVideoQuality"
        }
      ],
      "__typename": "Clip"
    }
  },
  "extensions": {
    "durationMilliseconds": 111,
    "operationName": "VideoAccessToken_Clip",
    "requestID": "01FBF44KKCM54G962DAH2B3M2K"
  }
}

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

$ xidel -s --module=xivid.xqm -e 'let $call_api:=function($query as object()) as object() {x:request({"headers":"Client-ID: kimne78kx3ncx6brgo4mv6wki5h1ko","post":serialize($query,{"method":"json"}),"url":"https://gql.twitch.tv/gql"})/json/data/*},$path:=tokenize(request-decode("'$url'")/substring-after(url,host),"/")[.] return $call_api({"operationName":"ComscoreStreamingQuery","variables":{"channel":if ($path=("video","videos","clip")) then "" else $path[last()],"isLive":if ($path=("video","videos","clip")) then false() else true(),"isVodOrCollection":if ($path=("video","videos")) then true() else false(),"vodID":if ($path=("video","videos")) then $path[last()] else "","isClip":if ($path="clip") then true() else false(),"clipSlug":if ($path="clip") then $path[last()] else ""},"extensions":{"persistedQuery":{"version":1,"sha256Hash":"e1edae8122517d013405f237ffcc124515dc6ded82480a88daef69c83b53ac01"}}})[exists(.//createdAt)]/{"name":"Twitch: "||(.[__typename="Video"]/concat(owner/displayName," - ",title),.[__typename="Clip"]/concat(broadcaster/displayName," - ",title),.[__typename="User"]/concat(displayName,": ",broadcastSettings/title)),"date":.//createdAt,"duration"?:(lengthSeconds,durationSeconds) * duration("PT1S"),"formats":if ($path="clip") then $call_api({"operationName":"VideoAccessToken_Clip","variables":{"slug":$path[last()]},"extensions":{"persistedQuery":{"version":1,"sha256Hash":"36b89d2507fce29e5ca551df756d27c1cfe079e2609642b4390aa4c35796eb11"}}})/array{for $x at $i in (videoQualities)() order by $x/quality count $i return {"id":"pg-"||$i,"format":"mp4[h264+aac]","resolution":("640x320","854x480","1280x720","1920x1080")[$i],"url":request-combine($x/sourceURL,playbackAccessToken/{"sig":signature,"token":value})/url}} else request-combine(concat("https://usher.ttvnw.net/",if ($path=("video","videos")) then "vod/" else "api/channel/hls/",$path[last()],".m3u8"),$call_api({"query":concat(if ($path=("video","videos")) then "{videoPlaybackAccessToken(id:&quot;" else "{streamPlaybackAccessToken(channelName:&quot;",$path[last()],"&quot;,params:{platform:&quot;web&quot;,playerBackend:&quot;mediaplayer&quot;,playerType:&quot;site&quot;}){value,signature}}")})/{"allow_source":true(),"allow_audio_only":true(),"allow_spectre":true(),"fast_bread"?:if ($path=("video","videos")) then () else true(),"p":(random-seed(),100000 + random(9900000)),"player_backend":"mediaplayer","playlist_include_framerate":true(),"sig":signature,"token":value})/xivid:m3u8-to-json(url)}'
{
  "name": "Twitch: MaurA_46 - esa doble suculenta",
  "date": "2020-06-06T04:05:02Z",
  "duration": "PT25S",
  "formats": [
    {
      "id": "pg-1",
      "format": "mp4[h264+aac]",
      "resolution": "640x320",
      "url": "https://production.assets.clips.twitchcdn.net/AT-cm%7C739790045-360.mp4?sig=[...]&token=[...]"
    },
    {
      "id": "pg-2",
      "format": "mp4[h264+aac]",
      "resolution": "854x480",
      "url": "https://production.assets.clips.twitchcdn.net/AT-cm%7C739790045-480.mp4?sig=[...]&token=[...]"
    },
    {
      "id": "pg-3",
      "format": "mp4[h264+aac]",
      "resolution": "1280x720",
      "url": "https://production.assets.clips.twitchcdn.net/AT-cm%7C739790045.mp4?sig=[...]&token=[...]"
    }
  ]
}

------------------------------------------------------------------------------------------------

declare function xivid:twitch($url as string) as object()? {
  let $call_api:=function($query as object()) as object() {
        x:request({
          "headers":"Client-ID: kimne78kx3ncx6brgo4mv6wki5h1ko",
          "post":serialize($query,{"method":"json"}),
          "url":"https://gql.twitch.tv/gql"
        })/json/data/*
      },
      $path:=tokenize(
        request-decode($url)/substring-after(url,host),"/"
      )[.]
  return
  $call_api(
    {
      "operationName":"ComscoreStreamingQuery",
      "variables":{
        "channel":if ($path=("video","videos","clip")) then "" else $path[last()],
        "isLive":if ($path=("video","videos","clip")) then false() else true(),
        "isVodOrCollection":if ($path=("video","videos")) then true() else false(),
        "vodID":if ($path=("video","videos")) then $path[last()] else "",
        "isClip":if ($path="clip") then true() else false(),
        "clipSlug":if ($path="clip") then $path[last()] else ""
      },
      "extensions":{
        "persistedQuery":{
          "version":1,
          "sha256Hash":"e1edae8122517d013405f237ffcc124515dc6ded82480a88daef69c83b53ac01"
        }
      }
    }
  )/{
    "name":"Twitch: "||(
      .[__typename="Video"]/concat(owner/displayName," - ",title),
      .[__typename="Clip"]/concat(broadcaster/displayName," - ",title),
      .[__typename="User"]/concat(displayName,": ",broadcastSettings/title)
    ),
    "date":.//createdAt,
    "duration"?:(lengthSeconds,durationSeconds) * duration("PT1S"),
    "formats":if ($path="clip") then
      $call_api({
        "operationName":"VideoAccessToken_Clip",
        "variables":{"slug":$path[last()]},
        "extensions":{
          "persistedQuery":{
            "version":1,
            "sha256Hash":"36b89d2507fce29e5ca551df756d27c1cfe079e2609642b4390aa4c35796eb11"
          }
        }
      })/array{
        for $x at $i in (videoQualities)()
        order by $x/quality
        count $i
        return {
          "id":"pg-"||$i,
          "format":"mp4[h264+aac]",
          "resolution":("640x320","854x480","1280x720","1920x1080")[$i],
          "url":request-combine(
            $x/sourceURL,
            playbackAccessToken/{"sig":signature,"token":value}
          )/url
        }
      }
    else
      request-combine(
        concat(
          "https://usher.ttvnw.net/",
          if ($path=("video","videos")) then
            "vod/"
          else
            "api/channel/hls/",
          $path[last()],
          ".m3u8"
        ),
        $call_api({
          "query":concat(
            if ($path=("video","videos")) then
              "{videoPlaybackAccessToken(id:&quot;"
            else
              "{streamPlaybackAccessToken(channelName:&quot;",
            $path[last()],
            "&quot;,params:{platform:&quot;web&quot;,playerBackend:&quot;",
            "mediaplayer&quot;,playerType:&quot;site&quot;}){value,signature}}"
          )
        })/{
          "allow_source":true(),
          "allow_audio_only":true(),
          "allow_spectre":true(),
          "fast_bread"?:if ($path=("video","videos")) then () else true(),
          "p":(random-seed(),100000 + random(9900000)),
          "player_backend":"mediaplayer",
          "playlist_include_framerate":true(),
          "sig":signature,
          "token":value
        }
      )/xivid:m3u8-to-json(url)
  }
};

================================================================================================

[autojunk]

$ url=https://www.autojunk.nl/2018/03/2018-ford-mustang-rijtest

$ xidel -s --module=xivid.xqm -e '
  doc("'$url'") ! (
    extract(//div[@id="playerWrapper"]/script,"clipData.title=&quot;(.+)&quot;",1),
    //span[@class="posted"],
    join(extract(//span[@class="posted"]/text(),"[\d:-]+",0,"*")),
    xivid:string-to-utc-dateTime(join(extract(.//span[@class="posted"]/text(),"[\d:-]+",0,"*")))
  )
'
2018 Ford Mustang rijtest
Gepost op 26-03-2018 om 15:55 5.721 views | Geen reacties
26-03-2018 15:55
2018-03-26T13:55:00Z

$ xidel -se 'doc("'$url'")//meta[@property="og:image"] ! (@content,extract(@content,"\d{4}/\d{4}/\d+"))'
https://static.autojunk.nl/video_thumbnails/2018/0326/092439_preview480_play.jpg
2018/0326/092439

$ xidel -se 'doc("'$url'")//div[@id="playerWrapper"]/script/outer-html()'
<script type="text/javascript">

        window.onBBPlayerReady=function(player){
          var clipData = player.getClipData();
          clipData.title="2018 Ford Mustang rijtest";
          clipData.id="215581";

                    clipData.disablecommercials = true;

          // duration of the video in seconds
          clipData["length"] = "0";

          // use blue billywig jQuery within this scope:
          var $ = window.bluebillywig.jQuery;

          // hack to set the thumbnail URL to a custom image URL:
          setTimeout(function(){
              $(player.getWrapper()).find('.bb-poster-layer img').each(function(i, el){
                  $(el).attr('src', '');
              });
          }, 1);


          player.load({clipData: clipData, autoPlay: false});
        }
        </script>
<script type="text/javascript" src="//autoblog.bbvms.com/p/autojunk_standard/c/2895330.js?callback=onBBPlayerReady"></script>

$ xidel -se 'doc("'$url'")//div[@id="playerWrapper"]/resolve-uri(substring-before(script/@src,"?")||"on")'
https://autoblog.bbvms.com/p/autojunk_standard/c/2895330.json

$ xidel -s --module=xivid.xqm -e 'doc("'$url'")//div[@id="playerWrapper"]/xivid:bbvms(resolve-uri(substring-before(script/@src,"?")||"on"),(),())'
{
  "name": "Autoblog: Placeholder clip",   # 2895330 is dus een dummie ID.
  "date": "2018-01-19T10:13:59Z"
}

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

In 2020 zaten de oude video-urls nog in de <div id="playerWrapper">...

$ xidel -se 'doc("'$url'")//div[@id="playerWrapper"]/script/parse-json(replace(extract(.,"clipData.assets = (.+\]);",1,"s")," //.+",""),{"liberal":true()})'
[
  {
    "id": 1,
    "mediatype": "MP4_HD",
    "src": "https://static.autojunk.nl/flv/2018/0326/092439_720p.mp4",
    "width": "1280",
    "height": "720",
    "bandwidth": "2000"
  },
  {
    "id": 2,
    "mediatype": "MP4_MAIN",
    "src": "https://static.autojunk.nl/flv/2018/0326/092439.mp4",
    "width": "640",
    "height": "360",
    "bandwidth": "1200"
  }
]

...en deze video-urls lijken nu (2021) nog steeds te werken.

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

$ xidel -se '(".mp4","_hq.mp4","_720p.mp4") ! concat("https://static.autojunk.nl/flv/",doc("'$url'")/extract(//meta[@property="og:image"]/@content,"\d{4}/\d{4}/\d+"),.)'
https://static.autojunk.nl/flv/2018/0326/092439.mp4
https://static.autojunk.nl/flv/2018/0326/092439_hq.mp4
https://static.autojunk.nl/flv/2018/0326/092439_720p.mp4

$ xidel -s --module=xivid.xqm -e 'doc("'$url'")/{"name":"Autojunk: "||//meta[@property="og:title"]/@content,"date":xivid:string-to-utc-dateTime(join(extract(//span[@class="posted"]/text(),"[\d:-]+",0,"*"))),"formats":array{let $id:=extract(//meta[@property="og:image"]/@content,"\d{4}/\d{4}/\d+") for $x at $i in (".mp4","_hq.mp4","_720p.mp4") ! concat("https://static.autojunk.nl/flv/",$id,.) return {"id":"pg-"||$i,"format":"mp4[h264+aac]","resolution":("640x360","852x480","1280x720")[$i],"bitrate":(600,1200,2000)[$i]||"kbps","url":$x}}}'
{
  "name": "Autojunk: 2018 Ford Mustang rijtest",
  "date": "2018-03-26T13:55:00Z",
  "formats": [
    {
      "id": "pg-1",
      "format": "mp4[h264+aac]",
      "resolution": "640x360",
      "bitrate": "600kbps",
      "url": "https://static.autojunk.nl/flv/2018/0326/092439.mp4"
    },
    {
      "id": "pg-2",
      "format": "mp4[h264+aac]",
      "resolution": "852x480",
      "bitrate": "1200kbps",
      "url": "https://static.autojunk.nl/flv/2018/0326/092439_hq.mp4"
    },
    {
      "id": "pg-3",
      "format": "mp4[h264+aac]",
      "resolution": "1280x720",
      "bitrate": "2000kbps",
      "url": "https://static.autojunk.nl/flv/2018/0326/092439_720p.mp4"
    }
  ]
}

------------------------------------------------------------------------------------------------

$ url=http://www.autojunk.nl/2009/11/peugeot-206-rally-crash

$ xidel -se 'for $x in (".mp4","_hq.mp4","_720p.mp4") ! concat("https://static.autojunk.nl/flv/",doc("'$url'")/extract(//meta[@property="og:image"]/@content,"\d{4}/\d{4}/\d+"),.) return join(($x,x:request({"method":"HEAD","error-handling":"xxx=accept","url":$x})/headers[1]))'
https://static.autojunk.nl/flv/2009/1115/135833.mp4 HTTP/1.1 200 OK
https://static.autojunk.nl/flv/2009/1115/135833_hq.mp4 HTTP/1.1 403 Forbidden
https://static.autojunk.nl/flv/2009/1115/135833_720p.mp4 HTTP/1.1 403 Forbidden

$ xidel -s --module=xivid.xqm -e 'doc("'$url'")/{"name":"Autojunk: "||//meta[@property="og:title"]/@content,"date":xivid:string-to-utc-dateTime(join(extract(//span[@class="posted"]/text(),"[\d:-]+",0,"*"))),"formats":array{let $id:=extract(//meta[@property="og:image"]/@content,"\d{4}/\d{4}/\d+") for $x at $i in (".mp4","_hq.mp4","_720p.mp4") ! concat("https://static.autojunk.nl/flv/",$id,.) where x:request({"method":"HEAD","error-handling":"xxx=accept","url":$x})/headers[1] = "HTTP/1.1 200 OK" return {"id":"pg-"||$i,"format":"mp4[h264+aac]","resolution":("640x360","852x480","1280x720")[$i],"bitrate":(600,1200,2000)[$i]||"kbps","url":$x}}}'
{
  "name": "Autojunk: Peugeot 206 rally crash",
  "date": "2009-11-15T12:58:00Z",
  "formats": [
    {
      "id": "pg-1",
      "format": "mp4[h264+aac]",
      "resolution": "640x360",
      "bitrate": "600kbps",
      "url": "https://static.autojunk.nl/flv/2009/1115/135833.mp4"
    }
  ]
}

------------------------------------------------------------------------------------------------

$ url=https://www.autojunk.nl/2020/11/aston-martin-db9r-epic-onboard-sounds-on-the-nurburgring-pedal-cam

$ xidel -se 'doc("'$url'")//div[@id="playerWrapper"]/outer-html()'
<div id="playerWrapper">
<iframe width="100%" height="100%" src="https://www.youtube.com/embed/0TVlRM8E6ok" frameborder="0" allowfullscreen=""></iframe>
</div>

$ xidel -s --module=xivid.xqm -e 'doc("'$url'")/{"name":"Autojunk: "||//meta[@property="og:title"]/@content,"date":xivid:string-to-utc-dateTime(join(extract(//span[@class="posted"]/text(),"[\d:-]+",0,"*"))),"formats"?://div[@id="playerWrapper" and script]/array{let $id:=extract(//meta[@property="og:image"]/@content,"\d{4}/\d{4}/\d+") for $x at $i in (".mp4","_hq.mp4","_720p.mp4") ! concat("https://static.autojunk.nl/flv/",$id,.) where x:request({"method":"HEAD","error-handling":"xxx=accept","url":$x})/headers[1] = "HTTP/1.1 200 OK" return {"id":"pg-"||$i,"format":"mp4[h264+aac]","resolution":("640x360","852x480","1280x720")[$i],"bitrate":(600,1200,2000)[$i]||"kbps","url":$x}}}'
{
  "name": "Autojunk: Aston Martin DB9R EPIC Onboard Sounds on the Nurburgring -Pedal cam",
  "date": "2020-11-14T18:39:00Z"
}

------------------------------------------------------------------------------------------------

declare function xivid:autojunk($url as string) as object()? {
  doc($url)/{
    "name":"Autojunk: "||//meta[@property="og:title"]/@content,
    "date":xivid:string-to-utc-dateTime(
      join(extract(//span[@class="posted"]/text(),"[\d:-]+",0,"*"))
    ),
    "formats"?://div[@id="playerWrapper" and script]/array{
      let $id:=extract(//meta[@property="og:image"]/@content,"\d{4}/\d{4}/\d+")
      for $x at $i in (".mp4","_hq.mp4","_720p.mp4") ! concat(
        "https://static.autojunk.nl/flv/",$id,.
      )
      where x:request({
        "method":"HEAD",
        "error-handling":"xxx=accept",
        "url":$x
      })/headers[1] = "HTTP/1.1 200 OK"
      return {
        "id":"pg-"||$i,
        "format":"mp4[h264+aac]",
        "resolution":("640x360","852x480","1280x720")[$i],
        "bitrate":(600,1200,2000)[$i]||"kbps",
        "url":$x
      }
    }
  }
};

================================================================================================

[abhd]

$ url=https://www.abhd.nl/video/ford-mustang-2018/

$ xidel -se 'doc("'$url'")//div[@id="playerObject"]/script'
[...]
    clipData.assets = [{
      id: 1,
      mediatype: 'MP4_HD', // HD if higher then 720p, MP4_MAIN otherwise.
      src: 'https://static.autojunk.nl/flv/2018/0326/092439_hq.mp4',
      width: '1280',
      height: '720',
      bandwidth: '2000'
    }
    ,{
      id: 2,
      mediatype: 'MP4_MAIN',
      src: 'https://static.autojunk.nl/flv/2018/0326/092439_720p.mp4',
      width: '640',
      height: '360',
      bandwidth: '1200',
    }
    ];
    player.load({clipData: clipData, autoPlay: false});
  }

$ xidel -se 'doc("'$url'")//div[@id="playerObject"]/script/parse-json(replace(extract(.,"clipData.assets = (.+\]);",1,"s")," //.+",""),{"liberal":true()})'
[
  {
    "id": 1,
    "mediatype": "MP4_HD",
    "src": "https://static.autojunk.nl/flv/2018/0326/092439_hq.mp4",   # I.t.t. wat "width" en "height" suggereren is dit niet de 720p video!
    "width": "1280",                                                   # En deze video heeft in werkelijkheid een resolutie van 852x480.
    "height": "720",
    "bandwidth": "2000"
  },
  {
    "id": 2,
    "mediatype": "MP4_MAIN",
    "src": "https://static.autojunk.nl/flv/2018/0326/092439_720p.mp4",
    "width": "640",
    "height": "360",
    "bandwidth": "1200"
  }
]

$ xidel -se 'let $src:=doc("'$url'")//div[@id="playerObject"],$info:=$src/script/parse-json(replace(extract(.,"clipData.assets = (.+\]);",1,"s")," //.+",""),{"liberal":true()}) return {"name":"ABHD: "||$src/h1/a,"date":dateTime(join(extract($info(1)/src,"(\d{4})/(\d{2})(\d{2})",1 to 3),"-")||"T00:00:00Z"),"formats":array{for $x at $i in $info() order by $x/bandwidth count $i return {"id":"pg-"||$i,"format":"mp4[h264+aac]","resolution":if ($x/height="360") then "852x480" else $x/concat(width,"x",height),"bitrate":$x/bandwidth||"kbps","url":$info($i)/src}}}'
{
  "name": "ABHD: Ford Mustang (2018)",
  "date": "2018-03-26T00:00:00Z",
  "formats": [
    {
      "id": "pg-1",
      "format": "mp4[h264+aac]",
      "resolution": "852x480",
      "bitrate": "1200kbps",
      "url": "https://static.autojunk.nl/flv/2018/0326/092439_hq.mp4"
    },
    {
      "id": "pg-2",
      "format": "mp4[h264+aac]",
      "resolution": "1280x720",
      "bitrate": "2000kbps",
      "url": "https://static.autojunk.nl/flv/2018/0326/092439_720p.mp4"
    }
  ]
}

------------------------------------------------------------------------------------------------

$ url=https://www.abhd.nl/video/range-rover-sport-tdv8-hse/   # Oudste video op abhd.nl (https://www.abhd.nl/page/125/).

$ xidel -se 'doc("'$url'")//div[@id="playerObject"]/script/parse-json(replace(extract(.,"clipData.assets = (.+\]);",1,"s")," //.+",""),{"liberal":true()})'
[
  {
    "id": 1,
    "mediatype": "MP4_HD",
    "src": "https://static.autojunk.nl/flv/20070521082934_hq.mp4",
    "width": "1280",
    "height": "720",
    "bandwidth": "2000"
  }
]

$ xidel -se '
  (
    "https://static.autojunk.nl/flv/20070521082934_hq.mp4",
    "https://static.autojunk.nl/flv/2007/0521/082934_hq.mp4"
  ) ! x:request({"method":"HEAD","url":.,"error-handling":"xxx=accept"})/headers[1]
'
HTTP/1.1 403 Forbidden   # Forward slashes doelbewust vergeten?
HTTP/1.1 200 OK

$ xidel -se 'let $src:=doc("'$url'")//div[@id="playerObject"],$info:=$src/script/parse-json(replace(extract(.,"clipData.assets = (.+\]);",1,"s")," //.+",""),{"liberal":true()}) return {"name":"ABHD: "||$src/h1/a,"date":dateTime(join(extract($info(1)/src,"(\d{4})/?(\d{2})(\d{2})",1 to 3),"-")||"T00:00:00Z"),"formats":array{for $x at $i in $info()/src return {"id":"pg-"||$i,"format":"mp4[h264+aac]","resolution":if (ends-with($x,"hq.mp4")) then "852x480" else "1280x720","bitrate":if (ends-with($x,"hq.mp4")) then "1200kbps" else "2000kbps","url":if (matches($x,"\d{14}")) then replace($x,"(.+?\d{4})(\d{4})(.+)","$1/$2/$3") else $x}}}'
{
  "name": "ABHD: Range Rover Sport TDV8 HSE",
  "date": "2007-05-21T00:00:00Z",
  "formats": [
    {
      "id": "pg-1",
      "format": "mp4[h264+aac]",
      "resolution": "852x480",
      "bitrate": "1200kbps",
      "url": "https://static.autojunk.nl/flv/2007/0521/082934_hq.mp4"
    }
  ]
}

------------------------------------------------------------------------------------------------

declare function xivid:abhd($url as string) as object()? {
  let $src:=doc($url)//div[@id="playerObject"],
      $info:=$src/script/parse-json(
        replace(
          extract(.,"clipData.assets = (.+\]);",1,"s"),
          " //.+",""
        ),
        {"liberal":true()}
      )
  return {
    "name":"ABHD: "||$src/h1/a,
    "date":dateTime(
      join(
        extract($info(1)/src,"(\d{4})/?(\d{2})(\d{2})",1 to 3),
        "-"
      )||"T00:00:00Z"
    ),
    "formats":array{
      for $x at $i in $info()/src return {
        "id":"pg-"||$i,
        "format":"mp4[h264+aac]",
        "resolution":if (ends-with($x,"hq.mp4")) then "852x480" else "1280x720",
        "bitrate":if (ends-with($x,"hq.mp4")) then "1200kbps" else "2000kbps",
        "url":if (matches($x,"\d{14}")) then
          replace($x,"(.+?\d{4})(\d{4})(.+)","$1/$2/$3")
        else
          $x
      }
    }
  }
};

================================================================================================

[autoblog]

$ url=https://www.autoblog.nl/nieuws/brute-richmond-jeep-wrangler-rijtest-en-video-143735   # Eerste bbvms-video (16-03-2020) in het rijtesten-archief.

$ xidel -se 'doc("'$url'")//iframe[@data-lazy-src]/resolve-uri(replace(@data-lazy-src,"html.+","json"))'
https://autoblog.bbvms.com/p/autoblog_yt/c/3679822.json

$ xidel -s --module=xivid.xqm -e 'doc("'$url'")//iframe[@data-lazy-src]/xivid:bbvms(resolve-uri(replace(@data-lazy-src,"html.+","json")),(),())'
{
  "name": "Autoblog: Brute Richmond (Jeep Wrangler) rijtest",
  "date": "2020-03-15T09:51:01Z",
  "duration": "PT15M45S",
  "formats": [
    {
      "id": "pg-1",
      "format": "mp4[h264+aac]",
      "resolution": "512x288",
      "bitrate": "400kbps",
      "url": "https://d2bbsl4gakrtjf.cloudfront.net/autoblog/media/2020/03/15/asset-3679822-1584265633439393.mp4"
    },
    [...]
    {
      "id": "pg-6",
      "format": "mp4[h264+aac]",
      "resolution": "1920x1080",
      "bitrate": "3000kbps",
      "url": "https://d2bbsl4gakrtjf.cloudfront.net/autoblog/media/2020/03/15/asset-3679822-1584265634228029.mp4"
    },
    {
      "id": "pg-7",
      "format": "mkv[h264+opus]",
      "resolution": "1920x1080",
      "url": "https://d2bbsl4gakrtjf.cloudfront.net/autoblog/media/2020/03/15/3679822.mkv"
    }
  ]
}

------------------------------------------------------------------------------------------------

$ url=https://www.autoblog.nl/nieuws/volvo-s60-t8-polestar-engineered-rijtest-en-video-142196

$ xidel -se 'doc("'$url'")//iframe[@data-lazy-src]/@data-lazy-src'
https://www.youtube.com/embed/IR8AlNUP5xo?feature=oembed

$ xidel -s --module=xivid.xqm -e 'doc("'$url'")//iframe[starts-with(@data-lazy-src,"//autoblog.bbvms.com")]/xivid:bbvms(resolve-uri(replace(@data-lazy-src,"html.+","json")),(),())'

------------------------------------------------------------------------------------------------

declare function xivid:autoblog($url as string) as object()? {
  doc($url)//iframe[starts-with(@data-lazy-src,"//autoblog.bbvms.com")]/xivid:bbvms(
    resolve-uri(replace(@data-lazy-src,"html.+","json")),(),()
  )
};

================================================================================================

[dailymotion]

$ url=https://www.dailymotion.com/video/x5aa1uc

$ xidel -se 'replace("'$url'","video","player/metadata/video")'
https://www.dailymotion.com/player/metadata/video/x5aa1uc

$ xidel -s --module=xivid.xqm -e 'json-doc(replace("'$url'","video","player/metadata/video"))/{"name":"Dailymotion: "||title,"date":created_time * duration("PT1S") + dateTime("1970-01-01T00:00:00Z"),"duration":duration * duration("PT1S"),"formats":xivid:m3u8-to-json(qualities//url)}'
{
  "name": "Dailymotion: PENOZA Seizoen 3 aflevering 9 (S03E09) [HD]",
  "date": "2017-02-01T11:16:39Z",
  "duration": "PT43M44S"
  "formats": [
    {
      "id": "pg-1",
      "format": "mp4[h264+aac]",
      "resolution": "192x112",
      "bitrate": "105kbps",
      "url": "https://proxy-019.dc3.dailymotion.com/[...]/319595988_mp4_h264_aac_l2_1.mp4"
    },
    [...]
    {
      "id": "pg-8",
      "format": "mp4[h264+aac]",
      "resolution": "640x360",
      "bitrate": "836kbps",
      "url": "https://proxy-022.dc3.dailymotion.com/[...]/319595988_mp4_h264_aac_hq_1.mp4"
    },
    {
      "id": "hls-0",
      "format": "m3u8[manifest]",
      "url": "https://www.dailymotion.com/cdn/manifest/video/x5aa1uc.m3u8?sec=eyMNx4dh_i1GpAS8KZdvuLpv_OYPeXseQRrYAtoqvsjKaTEW2g4-03MeQmu4oIC1"
    },
    {
      "id": "hls-1",
      "format": "m3u8[h264+aac]",
      "resolution": "192x112",
      "bitrate": "105kbps",
      "url": "https://proxy-019.dc3.dailymotion.com/[...]/319595988_mp4_h264_aac_l2_1.m3u8"
    },
    [...]
    {
      "id": "hls-8",
      "format": "m3u8[h264+aac]",
      "resolution": "640x360",
      "bitrate": "836kbps",
      "url": "https://proxy-022.dc3.dailymotion.com/[...]/319595988_mp4_h264_aac_hq_1.m3u8"
    }
  ]
}

------------------------------------------------------------------------------------------------

declare function xivid:dailymotion($url as string) as object()? {
  json-doc(replace($url,"video","player/metadata/video"))/{
    "name":"Dailymotion: "||title,
    "date":created_time * duration("PT1S") + dateTime("1970-01-01T00:00:00Z"),
    "duration":duration * duration("PT1S"),
    "formats":xivid:m3u8-to-json(qualities//url)
  }
};

================================================================================================

[mixcloud]

$ url=https://www.mixcloud.com/EricVanKleef/clubbin-12-wildfm-30-mei-2020

$ xidel -se 'tokenize(substring-after("'$url'","mixcloud.com/"),"/")[.]'
EricVanKleef
clubbin-12-wildfm-30-mei-2020

$ xidel -se 'x:request({"method":"HEAD","url":"'$url'"})/(headers[contains(.,"csrftoken")],substring-before(substring-after(headers[contains(.,"csrftoken")],"="),";"))'
set-cookie: csrftoken=DByTziojuvWczCcmPzUMJUx83hXB5s9OpRhhLmNZ6rpF3fedGCIA0ZmUX8CDdoug; Domain=.mixcloud.com; expires=Sun, 11-Jul-2021 09:37:49 GMT; Max-Age=31449600; Path=/; secure
DByTziojuvWczCcmPzUMJUx83hXB5s9OpRhhLmNZ6rpF3fedGCIA0ZmUX8CDdoug

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

JSON serialisatie in alle 4 vormen (voor Linux en Windows) incl. benodigde escape-characters:

$ xidel -se 'let $us:=tokenize(substring-after("'$url'","mixcloud.com/"),"/") return concat("{""query"": ""{cloudcastLookup(lookup:{username:\""",$us[1],"\"",slug:\""",$us[2],"\""}){name,owner{displayName,url,username},publishDate,audioLength,streamInfo{hlsUrl,url}}}""}")'
$ xidel -se 'let $us:=tokenize(substring-after("'$url'","mixcloud.com/"),"/") return concat("{&quot;query&quot;: &quot;{cloudcastLookup(lookup:{username:\&quot;",$us[1],"\&quot;,slug:\&quot;",$us[2],"\&quot;}){name,owner{displayName,url,username},publishDate,audioLength,streamInfo{hlsUrl,url}}}&quot;}")'
$ xidel -se 'let $us:=tokenize(substring-after("'$url'","mixcloud.com/"),"/") return serialize-json({"query":concat("{cloudcastLookup(lookup:{username:""",$us[1],""",slug:""",$us[2],"""}){name,owner{displayName,url,username},publishDate,audioLength,streamInfo{hlsUrl,url}}}")})'
$ xidel -se 'let $us:=tokenize(substring-after("'$url'","mixcloud.com/"),"/") return serialize-json({"query":concat("{cloudcastLookup(lookup:{username:&quot;",$us[1],"&quot;,slug:&quot;",$us[2],"&quot;}){name,owner{displayName,url,username},publishDate,audioLength,streamInfo{hlsUrl,url}}}")})'
$ xidel -se "let \$us:=tokenize(substring-after('$url','mixcloud.com/'),'/') return concat('{\"query\": \"{cloudcastLookup(lookup:{username:\\\"',\$us[1],'\\\",slug:\\\"',\$us[2],'\\\"}){name,owner{displayName,url,username},publishDate,audioLength,streamInfo{hlsUrl,url}}}\"}')"
$ xidel -se "let \$us:=tokenize(substring-after('$url','mixcloud.com/'),'/') return concat('{&quot;query&quot;: &quot;{cloudcastLookup(lookup:{username:\\&quot;',\$us[1],'\\&quot;,slug:\\&quot;',\$us[2],'\\&quot;}){name,owner{displayName,url,username},publishDate,audioLength,streamInfo{hlsUrl,url}}}&quot;}')"
$ xidel -se "let \$us:=tokenize(substring-after('$url','mixcloud.com/'),'/') return serialize-json({'query':concat('{cloudcastLookup(lookup:{username:\"',\$us[1],'\",slug:\"',\$us[2],'\"}){name,owner{displayName,url,username},publishDate,audioLength,streamInfo{hlsUrl,url}}}')})"
$ xidel -se "let \$us:=tokenize(substring-after('$url','mixcloud.com/'),'/') return serialize-json({'query':concat('{cloudcastLookup(lookup:{username:&quot;',\$us[1],'&quot;,slug:&quot;',\$us[2],'&quot;}){name,owner{displayName,url,username},publishDate,audioLength,streamInfo{hlsUrl,url}}}')})"
{"query": "{cloudcastLookup(lookup:{username:\"EricVanKleef\",slug:\"clubbin-12-wildfm-30-mei-2020\"}){name,owner{displayName,url,username},publishDate,audioLength,streamInfo{hlsUrl,url}}}"}

$ csrf=$(xidel -s --method=HEAD "$url" -e 'substring-before(substring-after($headers[contains(.,"csrftoken")],"="),";")')

$ xidel -s -H "Content-Type: application/json" -H "Referer: $url" -H "X-CSRFToken: $csrf" -H "Cookie: csrftoken=$csrf" -d '{let $us:=tokenize(substring-after("'$url'","mixcloud.com/"),"/") return concat("{""query"":""{cloudcastLookup(lookup:{username:\""",$us[1],"\"",slug:\""",$us[2],"\""}){name,owner{displayName,url,username},publishDate,audioLength,streamInfo{hlsUrl,url}}}""}")}' https://www.mixcloud.com/graphql -e '$json//cloudcastLookup'
$ xidel -se 'let $csrf:=x:request({"method":"HEAD","url":"'$url'"})/substring-before(substring-after(headers[contains(.,"csrftoken")],"="),";") return x:request({"headers":("Content-Type: application/json","Referer: '$url'","X-CSRFToken: "||$csrf,"Cookie: csrftoken="||$csrf),"post":let $us:=tokenize(substring-after("'$url'","mixcloud.com/"),"/") return serialize-json({"query":concat("{cloudcastLookup(lookup:{username:&quot;",$us[1],"&quot;,slug:&quot;",$us[2],"&quot;}){name,owner{displayName,url,username},publishDate,audioLength,streamInfo{hlsUrl,url}}}")}),"url":"https://www.mixcloud.com/graphql"})/json//cloudcastLookup'
{
  "name": "CLUBBIN #12 @WILDFM 30 MEI 2020.",
  "owner": {
    "displayName": "Eric van Kleef",
    "url": "https://www.mixcloud.com/EricVanKleef/",
    "username": "EricVanKleef"
  },
  "publishDate": "2020-05-31T10:55:53+00:00",
  "audioLength": 5842,
  "streamInfo": {
    "hlsUrl": "ITItPyZtbmE1ISwsLmNmZz49KzcjKDAwfiImKWs8KywhNip4JiA8bnRpYmB8Yip3dSosNml9dWp6eGMgLzJ5cHZxZ3lxZzFkZHYkJjdhJXBqKXsvYD0qKzI2YiJyMX4=",
    "url": "ITItPyZtbmEnIDogID9le305OiwsKyohNG8qKylgPSo3MT0yYS9gLHAnfXl5Ynl3c2N+eidmcD8sNnp1fWdhZXEgMzJka2djYWJ/cTFncXAnJyx/K21qImMvczwoI3sUBX90KjkhJgFlEiUcPBAvMxkfBTc/"
  }
}

Windows:

SET url=https://www.mixcloud.com/EricVanKleef/clubbin-12-wildfm-30-mei-2020
FOR /F "delims=" %A IN ('xidel -s --method=HEAD "%url%" -e "substring-before(substring-after($headers[contains(.,'csrftoken')],'='),';')"') DO SET csrf=%A

xidel -s -H "Content-Type: application/json" -H "Referer: %url%" -H "X-CSRFToken: %csrf%" -H "Cookie: csrftoken=%csrf%" -d "{let $us:=tokenize(substring-after('%url%','mixcloud.com/'),'/') return concat('{\"query\":\"{cloudcastLookup(lookup:{username:\\\"',$us[1],'\\\",slug:\\\"',$us[2],'\\\"}){name,owner{displayName,url,username},publishDate,audioLength,streamInfo{hlsUrl,url}}}\"}')}" https://www.mixcloud.com/graphql -e "$json//cloudcastLookup"
xidel -se "let $csrf:=x:request({'method':'HEAD','url':'%url%'})/substring-before(substring-after(headers[contains(.,'csrftoken')],'='),';') return x:request({'headers':('Content-Type: application/json','Referer: %url%','X-CSRFToken: '||$csrf,'Cookie: csrftoken='||$csrf),'post':let $us:=tokenize(substring-after('%url%','mixcloud.com/'),'/') return serialize-json({'query':concat('{cloudcastLookup(lookup:{username:&quot;',$us[1],'&quot;,slug:&quot;',$us[2],'&quot;}){name,owner{displayName,url,username},publishDate,audioLength,streamInfo{hlsUrl,url}}}')}),'url':'https://www.mixcloud.com/graphql'})/json/data/cloudcastLookup"
{
  "name": "CLUBBIN #12 @WILDFM 30 MEI 2020.",
  "owner": {
    "displayName": "Eric van Kleef",
    "url": "https://www.mixcloud.com/EricVanKleef/",
    "username": "EricVanKleef"
  },
  "publishDate": "2020-05-31T10:55:53+00:00",
  "audioLength": 5842,
  "streamInfo": {
    "hlsUrl": "ITItPyZtbmE1ISwsLmNmZz49KzcjKDAwfiImKWs8KywhNip4JiA8bnRpYmB8Yip3dSosNml9dWp6eGMgLzJ5cHZxZ3lxZzFkZHYkJjdhJXBqKXsvYD0qKzI2YiJyMX4=",
    "url": "ITItPyZtbmEnIDogID9le305OiwsKyohNG8qKylgPSo3MT0yYS9gLHAnfXl5Ynl3c2N+eidmcD8sNnp1fWdhZXEgMzJka2djYWJ/cTFncXAnJyx/K21qImMvczwoI3sUBX90KjkhJgFlEiUcPBAvMxkfBTc/"
  }
}

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

Decryptie:

$ xidel -se 'binary-to-string(base64Binary("ITItPyZtbmE1ISwsLmNmZz49KzcjKDAwfiImKWs8KywhNip4JiA8bnRpYmB8Yip3dSosNml9dWp6eGMgLzJ5cHZxZ3lxZzFkZHYkJjdhJXBqKXsvYD0qKzI2YiJyMX4="))'
!2-?&mna5!,,.cfg>=+7#(00~"&)k<+,!6*x& <ntib`|b*wu*,6i}ujzxc /2ypvqgyqg1ddv$&7a%pj){/`=*+26b"r1~

De decryptie-sleutel is "IFYOUWANTTHEARTISTSTOGETPAIDDONOTDOWNLOADFROMMIXCLOUD". De base64-gedecodeerde url...
!2-?&mna5!,,.cfg>=+7#(00~"&)k<+,!6*x& <ntib`|b*wu*,6i}ujzxc /2ypvqgyqg1ddv$&7a%pj){/`=*+26b"r1~
...moet ontsleuteld worden met...
IFYOUWANTTHEARTISTSTOGETPAIDDONOTDOWNLOADFROMMIXCLOUDIFYOUWANTTHEARTISTSTOGETPAIDDONOTDOWNLOADF
...waarbij de decryptie-sleutel dus herhaald wordt tot de lengte van de base64-gedecodeerde url.
Vervolgens moet van ieder teken de "binarywise exclusive-or" van de corresponderende codepoints berekend worden.
x:cps("!") --> 33 en x:integer-to-base(33,2) -->  100001
x:cps("I") --> 73 en x:integer-to-base(73,2) --> 1001001
0100001 XOR 1001001 = 1101000
x:integer(1101000,2) --> 104 en x:cps(104) --> "h"

----------------------------------------------------------------

- Substrings

$ xidel -se '
  let $key:="IFYOUWANTTHEARTISTSTOGETPAIDDONOTDOWNLOADFROMMIXCLOUD",
      $arg:=binary-to-string(base64Binary("ITItPyZtbmE1ISwsLmNmZz49KzcjKDAwfiImKWs8KywhNip4JiA8bnRpYmB8Yip3dSosNml9dWp6eGMgLzJ5cHZxZ3lxZzFkZHYkJjdhJXBqKXsvYD0qKzI2YiJyMX4="))
  return (
    string-length($arg),
    $arg,
    string-length($key),
    $key,
    string-length($arg) div string-length($key),
    ceiling(string-length($arg) div string-length($key)),
    string-join((1 to ceiling(string-length($arg) div string-length($key))) ! $key),
    substring(
      string-join((1 to ceiling(string-length($arg) div string-length($key))) ! $key),
      1,string-length($arg)
    )
  )
'
95
!2-?&mna5!,,.cfg>=+7#(00~"&)k<+,!6*x& <ntib`|b*wu*,6i}ujzxc /2ypvqgyqg1ddv$&7a%pj){/`=*+26b"r1~
53
IFYOUWANTTHEARTISTSTOGETPAIDDONOTDOWNLOADFROMMIXCLOUD
1.792452830188679245
2
IFYOUWANTTHEARTISTSTOGETPAIDDONOTDOWNLOADFROMMIXCLOUDIFYOUWANTTHEARTISTSTOGETPAIDDONOTDOWNLOADFROMMIXCLOUD
IFYOUWANTTHEARTISTSTOGETPAIDDONOTDOWNLOADFROMMIXCLOUDIFYOUWANTTHEARTISTSTOGETPAIDDONOTDOWNLOADF

$ xidel -se 'let $key:="IFYOUWANTTHEARTISTSTOGETPAIDDONOTDOWNLOADFROMMIXCLOUD",$arg1:=binary-to-string(base64Binary("ITItPyZtbmE1ISwsLmNmZz49KzcjKDAwfiImKWs8KywhNip4JiA8bnRpYmB8Yip3dSosNml9dWp6eGMgLzJ5cHZxZ3lxZzFkZHYkJjdhJXBqKXsvYD0qKzI2YiJyMX4=")),$arg2:=substring(string-join((1 to ceiling(string-length($arg1) div string-length($key))) ! $key),1,string-length($arg1)) return for $x in 1 to string-length($arg1) return join((substring($arg1,$x,1),substring($arg2,$x,1)))'
! I
2 F
- Y
? O
& U
[...]

$ xidel -se 'let $key:="IFYOUWANTTHEARTISTSTOGETPAIDDONOTDOWNLOADFROMMIXCLOUD",$arg1:=binary-to-string(base64Binary("ITItPyZtbmE1ISwsLmNmZz49KzcjKDAwfiImKWs8KywhNip4JiA8bnRpYmB8Yip3dSosNml9dWp6eGMgLzJ5cHZxZ3lxZzFkZHYkJjdhJXBqKXsvYD0qKzI2YiJyMX4=")),$arg2:=substring(string-join((1 to ceiling(string-length($arg1) div string-length($key))) ! $key),1,string-length($arg1)) return for $x in 1 to string-length($arg1) return join((x:cps(substring($arg1,$x,1)),x:cps(substring($arg2,$x,1))))'
33 73
50 70
45 89
63 79
38 85
[...]

$ xidel -s --module=xivid.xqm -e 'let $key:="IFYOUWANTTHEARTISTSTOGETPAIDDONOTDOWNLOADFROMMIXCLOUD",$arg1:=binary-to-string(base64Binary("ITItPyZtbmE1ISwsLmNmZz49KzcjKDAwfiImKWs8KywhNip4JiA8bnRpYmB8Yip3dSosNml9dWp6eGMgLzJ5cHZxZ3lxZzFkZHYkJjdhJXBqKXsvYD0qKzI2YiJyMX4=")),$arg2:=substring(string-join((1 to ceiling(string-length($arg1) div string-length($key))) ! $key),1,string-length($arg1)) return join(x:cps(for $x in 1 to string-length($arg1) return xivid:bin-xor(x:cps(substring($arg1,$x,1)),x:cps(substring($arg2,$x,1)))))'
h t t p s : / / a u d i o 1 2 . m i x c l o u d . c o m / s e c u r e / h l s / 0 / 0 / 1 / c / 6 f c c - 4 3 3 5 - 4 a a f - 8 3 0 5 - 8 4 e 7 0 9 c c c 1 d 9 . m 4 a / i n d e x . m 3 u 8

$ time xidel -s --module=xivid.xqm -e '((1 to 1000) ! (let $key:="IFYOUWANTTHEARTISTSTOGETPAIDDONOTDOWNLOADFROMMIXCLOUD",$arg1:=binary-to-string(base64Binary("ITItPyZtbmE1ISwsLmNmZz49KzcjKDAwfiImKWs8KywhNip4JiA8bnRpYmB8Yip3dSosNml9dWp6eGMgLzJ5cHZxZ3lxZzFkZHYkJjdhJXBqKXsvYD0qKzI2YiJyMX4=")),$arg2:=substring(string-join((1 to ceiling(string-length($arg1) div string-length($key))) ! $key),1,string-length($arg1)) return string-join(x:cps(for $x in 1 to string-length($arg1) return xivid:bin-xor(x:cps(substring($arg1,$x,1)),x:cps(substring($arg2,$x,1)))))))[1]'
https://audio12.mixcloud.com/secure/hls/0/0/1/c/6fcc-4335-4aaf-8305-84e709ccc1d9.m4a/index.m3u8

real    0m20.734s
user    0m0.015s
sys     0m0.000s

----------------------------------------------------------------

- Reeksen

$ xidel -se '
  let $key:=x:cps("IFYOUWANTTHEARTISTSTOGETPAIDDONOTDOWNLOADFROMMIXCLOUD"),
      $arg:=x:cps(binary-to-string(base64Binary("ITItPyZtbmE1ISwsLmNmZz49KzcjKDAwfiImKWs8KywhNip4JiA8bnRpYmB8Yip3dSosNml9dWp6eGMgLzJ5cHZxZ3lxZzFkZHYkJjdhJXBqKXsvYD0qKzI2YiJyMX4=")))
  return (
    count($arg),
    string-join(x:cps($arg)),
    count($key),
    string-join(x:cps($key)),
    count($arg) div count($key),
    ceiling(count($arg) div count($key)),
    string-join(x:cps(((1 to ceiling(count($arg) div count($key))) ! $key))),
    string-join(x:cps(((1 to ceiling(count($arg) div count($key))) ! $key)[position() lt count($arg) + 1]))
  )
'
95
!2-?&mna5!,,.cfg>=+7#(00~"&)k<+,!6*x& <ntib`|b*wu*,6i}ujzxc /2ypvqgyqg1ddv$&7a%pj){/`=*+26b"r1~
53
IFYOUWANTTHEARTISTSTOGETPAIDDONOTDOWNLOADFROMMIXCLOUD
1.792452830188679245
2
IFYOUWANTTHEARTISTSTOGETPAIDDONOTDOWNLOADFROMMIXCLOUDIFYOUWANTTHEARTISTSTOGETPAIDDONOTDOWNLOADFROMMIXCLOUD
IFYOUWANTTHEARTISTSTOGETPAIDDONOTDOWNLOADFROMMIXCLOUDIFYOUWANTTHEARTISTSTOGETPAIDDONOTDOWNLOADF

$ xidel -se 'let $key:=x:cps("IFYOUWANTTHEARTISTSTOGETPAIDDONOTDOWNLOADFROMMIXCLOUD"),$arg1:=x:cps(binary-to-string(base64Binary("ITItPyZtbmE1ISwsLmNmZz49KzcjKDAwfiImKWs8KywhNip4JiA8bnRpYmB8Yip3dSosNml9dWp6eGMgLzJ5cHZxZ3lxZzFkZHYkJjdhJXBqKXsvYD0qKzI2YiJyMX4="))),$arg2:=((1 to ceiling(count($arg1) div count($key))) ! $key)[position() lt count($arg1) + 1] for $x at $i in $arg1 return join(($x,$arg2[$i]))'
33 73
50 70
45 89
63 79
38 85

$ xidel -s --module=xivid.xqm -e 'let $key:=x:cps("IFYOUWANTTHEARTISTSTOGETPAIDDONOTDOWNLOADFROMMIXCLOUD"),$arg1:=x:cps(binary-to-string(base64Binary("ITItPyZtbmE1ISwsLmNmZz49KzcjKDAwfiImKWs8KywhNip4JiA8bnRpYmB8Yip3dSosNml9dWp6eGMgLzJ5cHZxZ3lxZzFkZHYkJjdhJXBqKXsvYD0qKzI2YiJyMX4="))),$arg2:=((1 to ceiling(count($arg1) div count($key))) ! $key)[position() lt count($arg1) + 1] return join(x:cps(for $x at $i in $arg1 return xivid:bin-xor($x,$arg2[$i])))'
h t t p s : / / a u d i o 1 2 . m i x c l o u d . c o m / s e c u r e / h l s / 0 / 0 / 1 / c / 6 f c c - 4 3 3 5 - 4 a a f - 8 3 0 5 - 8 4 e 7 0 9 c c c 1 d 9 . m 4 a / i n d e x . m 3 u 8

$ time xidel -s --module=xivid.xqm -e '((1 to 1000) ! (let $key:=x:cps("IFYOUWANTTHEARTISTSTOGETPAIDDONOTDOWNLOADFROMMIXCLOUD"),$arg1:=x:cps(binary-to-string(base64Binary("ITItPyZtbmE1ISwsLmNmZz49KzcjKDAwfiImKWs8KywhNip4JiA8bnRpYmB8Yip3dSosNml9dWp6eGMgLzJ5cHZxZ3lxZzFkZHYkJjdhJXBqKXsvYD0qKzI2YiJyMX4="))),$arg2:=((1 to ceiling(count($arg1) div count($key))) ! $key)[position() lt count($arg1) + 1] return string-join(x:cps(for $x at $i in $arg1 return xivid:bin-xor($x,$arg2[$i])))))[1]'
https://audio12.mixcloud.com/secure/hls/0/0/1/c/6fcc-4335-4aaf-8305-84e709ccc1d9.m4a/index.m3u8

real    0m19.656s
user    0m0.015s
sys     0m0.000s

----------------------------------------------------------------

- Reeksen (de youtube-dl manier)

$ xidel -se 'let $key:=x:cps("IFYOUWANTTHEARTISTSTOGETPAIDDONOTDOWNLOADFROMMIXCLOUD") return string-join(x:cps(for $x at $i in x:cps(binary-to-string(base64Binary("ITItPyZtbmE1ISwsLmNmZz49KzcjKDAwfiImKWs8KywhNip4JiA8bnRpYmB8Yip3dSosNml9dWp6eGMgLzJ5cHZxZ3lxZzFkZHYkJjdhJXBqKXsvYD0qKzI2YiJyMX4="))) return $key[$i mod count($key)]))'
IFYOUWANTTHEARTISTSTOGETPAIDDONOTDOWNLOADFROMMIXCLOUIFYOUWANTTHEARTISTSTOGETPAIDDONOTDOWNLOADF
                                                    ^ # "D" mist en lengte is 94 i.p.v. 95.

Dit komt omdat in XPath/XQuery de index van een reeks bij positie 1 begint i.p.v. 0.

$ xidel -se '    $ xidel -se '
   1 mod 53,        (1 - 1) mod 53 + 1,
  52 mod 53,       (52 - 1) mod 53 + 1,
  53 mod 53,       (53 - 1) mod 53 + 1,
  54 mod 53        (54 - 1) mod 53 + 1
'                '
1                1
52               52
0                53
1                1

$ xidel -se 'let $key:=x:cps("IFYOUWANTTHEARTISTSTOGETPAIDDONOTDOWNLOADFROMMIXCLOUD") return string-join(x:cps(for $x at $i in x:cps(binary-to-string(base64Binary("ITItPyZtbmE1ISwsLmNmZz49KzcjKDAwfiImKWs8KywhNip4JiA8bnRpYmB8Yip3dSosNml9dWp6eGMgLzJ5cHZxZ3lxZzFkZHYkJjdhJXBqKXsvYD0qKzI2YiJyMX4="))) return $key[($i - 1) mod count($key) + 1]))'
IFYOUWANTTHEARTISTSTOGETPAIDDONOTDOWNLOADFROMMIXCLOUDIFYOUWANTTHEARTISTSTOGETPAIDDONOTDOWNLOADF
                                                     ^ # Eindigt goed en herhaalt zichzelf tot de juiste lengte.

$ xidel -s --module=xivid.xqm -e 'let $key:=x:cps("IFYOUWANTTHEARTISTSTOGETPAIDDONOTDOWNLOADFROMMIXCLOUD") return join(x:cps(for $x at $i in x:cps(binary-to-string(base64Binary("ITItPyZtbmE1ISwsLmNmZz49KzcjKDAwfiImKWs8KywhNip4JiA8bnRpYmB8Yip3dSosNml9dWp6eGMgLzJ5cHZxZ3lxZzFkZHYkJjdhJXBqKXsvYD0qKzI2YiJyMX4="))) return xivid:bin-xor($x,$key[($i - 1) mod count($key) + 1])))'
h t t p s : / / a u d i o 1 2 . m i x c l o u d . c o m / s e c u r e / h l s / 0 / 0 / 1 / c / 6 f c c - 4 3 3 5 - 4 a a f - 8 3 0 5 - 8 4 e 7 0 9 c c c 1 d 9 . m 4 a / i n d e x . m 3 u 8

$ time xidel -s --module=xivid.xqm -e '((1 to 1000) ! (let $key:=x:cps("IFYOUWANTTHEARTISTSTOGETPAIDDONOTDOWNLOADFROMMIXCLOUD") return string-join(x:cps(for $x at $i in x:cps(binary-to-string(base64Binary("ITItPyZtbmE1ISwsLmNmZz49KzcjKDAwfiImKWs8KywhNip4JiA8bnRpYmB8Yip3dSosNml9dWp6eGMgLzJ5cHZxZ3lxZzFkZHYkJjdhJXBqKXsvYD0qKzI2YiJyMX4="))) return xivid:bin-xor($x,$key[($i - 1) mod count($key) + 1])))))[1]'
https://audio12.mixcloud.com/secure/hls/0/0/1/c/6fcc-4335-4aaf-8305-84e709ccc1d9.m4a/index.m3u8

real    0m19.750s   # Net zo snel als de 2e methode, maar minder code.
user    0m0.015s
sys     0m0.000s

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

$ xidel -s --module=xivid.xqm -e 'let $key:=x:cps("IFYOUWANTTHEARTISTSTOGETPAIDDONOTDOWNLOADFROMMIXCLOUD"),$decrypt:=function($arg as string) as string {string-join(x:cps(for $x at $i in x:cps(binary-to-string(base64Binary($arg))) return xivid:bin-xor($x,$key[($i - 1) mod count($key) + 1])))},$csrf:=x:request({"method":"HEAD","url":"'$url'"})/substring-before(substring-after(headers[contains(.,"csrftoken")],"="),";") return x:request({"headers":("Content-Type: application/json","Referer: '$url'","X-CSRFToken: "||$csrf,"Cookie: csrftoken="||$csrf),"post":let $us:=tokenize(substring-after("'$url'","mixcloud.com/"),"/") return serialize-json({"query":concat("{cloudcastLookup(lookup:{username:&quot;",$us[1],"&quot;,slug:&quot;",$us[2],"&quot;}){name,owner{displayName,url,username},publishDate,audioLength,streamInfo{hlsUrl,url}}}")}),"url":"https://www.mixcloud.com/graphql"})/json//cloudcastLookup/{"name":concat(owner/displayName," - ",name),"date":dateTime(publishDate),"duration":audioLength * duration("PT1S"),"formats":array{{"id":"pg-1","format":"m4a[aac]","url":$decrypt(streamInfo/url)},xivid:m3u8-to-json($decrypt(streamInfo/hlsUrl))()}}'
{
  "name": "Eric van Kleef - CLUBBIN #12 @WILDFM 30 MEI 2020.",
  "date": "2020-05-31T10:55:53Z",
  "duration": "PT1H37M22S",
  "formats": [
    {
      "id": "pg-1",
      "format": "m4a[aac]",
      "url": "https://stream12.mixcloud.com/secure/c/m4a/64/0/0/1/c/6fcc-4335-4aaf-8305-84e709ccc1d9.m4a?sig=FJ29cabjN0VlZe_zdXQQcw"
    },
    {
      "id": "hls-0",
      "format": "m3u8[manifest]",
      "url": "https://audio12.mixcloud.com/secure/hls/0/0/1/c/6fcc-4335-4aaf-8305-84e709ccc1d9.m4a/index.m3u8"
    },
    {
      "id": "hls-1",
      "format": "m3u8[aac]",
      "bitrate": "71kbps",
      "url": "https://audio12.mixcloud.com/secure/hls/0/0/1/c/6fcc-4335-4aaf-8305-84e709ccc1d9.m4a/streamindex-a1.m3u8"
    }
  ]
}

------------------------------------------------------------------------------------------------

declare function xivid:mixcloud($url as string) as object()? {
  let $key:=x:cps("IFYOUWANTTHEARTISTSTOGETPAIDDONOTDOWNLOADFROMMIXCLOUD"),
      $decrypt:=function($arg as string) as string {
        string-join(
          x:cps(
            for $x at $i in x:cps(binary-to-string(base64Binary($arg))) return
            xivid:bin-xor($x,$key[($i - 1) mod count($key) + 1])
          )
        )
      },
      $csrf:=x:request(
        {"method":"HEAD","url":$url}
      )/substring-before(substring-after(headers[contains(.,"csrftoken")],"="),";"),
      $us:=tokenize(substring-after($url,"mixcloud.com/"),"/")
  return
  x:request({
    "headers":(
      "Content-Type: application/json",
      "Referer: "||$url,
      "X-CSRFToken: "||$csrf,
      "Cookie: csrftoken="||$csrf
    ),
    "post":serialize-json({
      "query":concat(
        "{cloudcastLookup(lookup:{username:&quot;",
        $us[1],
        "&quot;,slug:&quot;",
        $us[2],
        "&quot;}){name,owner{displayName,url,username},",
        "publishDate,audioLength,streamInfo{hlsUrl,url}}}"
      )
    }),
    "url":"https://www.mixcloud.com/graphql"
  })/json//cloudcastLookup/{
    "name":concat(owner/displayName," - ",name),
    "date":dateTime(publishDate),
    "duration":audioLength * duration("PT1S"),
    "formats":array{
      {
        "id":"pg-1",
        "format":"m4a[aac]",
        "url":$decrypt(streamInfo/url)
      },
      xivid:m3u8-to-json(
        $decrypt(streamInfo/hlsUrl)
      )()
    }
  }
};

================================================================================================

[soundcloud]

$ url=https://soundcloud.com/laidbackluke/laidback-luke-dj-set-live-at

$ xidel -se 'parse-json(doc("'$url'")//script/extract(.,"(\[\{.+)\)",1)[.])()[last()]/(data)()'
{
  "comment_count": 675,
  "full_duration": 3610982,
  "downloadable": true,
  "created_at": "2012-11-05T10:53:55Z",
  "description": "",
  "media": {
    "transcodings": [
      {
        "url": "https://api-v2.soundcloud.com/media/soundcloud:tracks:66196563/da74b653-7f46-443b-ad44-2337d07383c3/stream/hls",
        "preset": "mp3_0_0",
        "duration": 3610982,
        "snipped": false,
        "format": {
          "protocol": "hls",
          "mime_type": "audio/mpeg"
        },
        "quality": "sq"
      },
      {
        "url": "https://api-v2.soundcloud.com/media/soundcloud:tracks:66196563/da74b653-7f46-443b-ad44-2337d07383c3/stream/progressive",
        "preset": "mp3_0_0",
        "duration": 3610982,
        "snipped": false,
        "format": {
          "protocol": "progressive",
          "mime_type": "audio/mpeg"
        },
        "quality": "sq"
      },
      {
        "url": "https://api-v2.soundcloud.com/media/soundcloud:tracks:66196563/354da271-3480-4c98-8b3d-8729d4014a9d/stream/hls",
        "preset": "opus_0_0",
        "duration": 3610982,
        "snipped": false,
        "format": {
          "protocol": "hls",
          "mime_type": "audio/ogg; codecs=\"opus\""
        },
        "quality": "sq"
      }
    ]
  },
  "title": "Laidback Luke DJ set Live At Escape From Wonderland Oct 2012",
  "publisher_metadata": null,
  "duration": 3610982,
  "has_downloads_left": true,
  "artwork_url": "https://i1.sndcdn.com/artworks-000033583042-nk61e0-large.jpg",
  "public": true,
  "streamable": true,
  "tag_list": "",
  "genre": "DJ Mix",
  "id": 66196563,
  "reposts_count": 1068,
  "state": "finished",
  "label_name": "",
  "last_modified": "2020-02-26T06:13:28Z",
  "commentable": true,
  "policy": "MONETIZE",
  "visuals": null,
  "kind": "track",
  "purchase_url": null,
  "sharing": "public",
  "uri": "https://api.soundcloud.com/tracks/66196563",
  "secret_token": null,
  "download_count": 19606,
  "likes_count": 7306,
  "urn": "soundcloud:tracks:66196563",
  "license": "cc-by",
  "purchase_title": null,
  "display_date": "2012-11-05T10:53:55Z",
  "embeddable_by": "all",
  "release_date": null,
  "user_id": 236295,
  "monetization_model": "BLACKBOX",
  "waveform_url": "https://wave.sndcdn.com/gF2U20J9lZfU_m.json",
  "permalink": "laidback-luke-dj-set-live-at",
  "permalink_url": "https://soundcloud.com/laidbackluke/laidback-luke-dj-set-live-at",
  "user": {
    "avatar_url": "https://i1.sndcdn.com/avatars-000332190570-lfp2jp-large.jpg",
    "city": "",
    "comments_count": 69,
    "country_code": "NL",
    "created_at": "2009-08-31T23:58:14Z",
    "creator_subscriptions": [
      {
        "product": {
          "id": "creator-pro-unlimited"
        }
      }
    ],
    "creator_subscription": {
      "product": {
        "id": "creator-pro-unlimited"
      }
    },
    "description": "",
    "followers_count": 428519,
    "followings_count": 9,
    "first_name": "Laidback",
    "full_name": "Laidback Luke",
    "groups_count": 0,
    "id": 236295,
    "kind": "user",
    "last_modified": "2020-06-26T10:26:41Z",
    "last_name": "Luke",
    "likes_count": 49,
    "playlist_likes_count": 8,
    "permalink": "laidbackluke",
    "permalink_url": "https://soundcloud.com/laidbackluke",
    "playlist_count": 92,
    "reposts_count": null,
    "track_count": 375,
    "uri": "https://api.soundcloud.com/users/236295",
    "urn": "soundcloud:users:236295",
    "username": "LaidbackLuke",
    "verified": false,
    "visuals": {
      "urn": "soundcloud:users:236295",
      "enabled": true,
      "visuals": [
        {
          "urn": "soundcloud:visuals:102511671",
          "entry_time": 0,
          "visual_url": "https://i1.sndcdn.com/visuals-000000236295-JBYMVN-original.jpg"
        }
      ],
      "tracking": null
    }
  },
  "playback_count": 319259
}

$ xidel -se 'doc("'$url'")//script[@crossorigin][last()]/@src'
https://a-v2.sndcdn.com/assets/46-4d78cbe8-3.js

$ xidel -se 'substring(substring-after(unparsed-text(doc("'$url'")//script[@crossorigin][last()]/@src),"client_id:"),2,32)'
rlZXIMK5JrRgRVARIuViQdb5WzF7VlHP

$ xidel -se 'let $src:=doc("'$url'"),$cid:=substring(substring-after(unparsed-text($src//script[@crossorigin][last()]/@src),"client_id:"),2,32) return parse-json($src//script/extract(.,"(\[\{.+)\)",1)[.])()[last()]/(.//transcodings)()/concat(url,"?client_id=",$cid)'
https://api-v2.soundcloud.com/media/soundcloud:tracks:66196563/da74b653-7f46-443b-ad44-2337d07383c3/stream/hls?client_id=rlZXIMK5JrRgRVARIuViQdb5WzF7VlHP
https://api-v2.soundcloud.com/media/soundcloud:tracks:66196563/da74b653-7f46-443b-ad44-2337d07383c3/stream/progressive?client_id=rlZXIMK5JrRgRVARIuViQdb5WzF7VlHP
https://api-v2.soundcloud.com/media/soundcloud:tracks:66196563/354da271-3480-4c98-8b3d-8729d4014a9d/stream/hls?client_id=rlZXIMK5JrRgRVARIuViQdb5WzF7VlHP

$ xidel -se 'let $src:=doc("'$url'"),$cid:=substring(substring-after(unparsed-text($src//script[@crossorigin][last()]/@src),"client_id:"),2,32) return parse-json($src//script/extract(.,"(\[\{.+)\)",1)[.])()[last()]/(.//transcodings)()/json-doc(concat(url,"?client_id=",$cid))/url'
https://cf-hls-media.sndcdn.com/playlist/gF2U20J9lZfU.128.mp3/playlist.m3u8?[...]
https://cf-media.sndcdn.com/gF2U20J9lZfU.128.mp3?[...]
https://cf-hls-opus-media.sndcdn.com/playlist/gF2U20J9lZfU.64.opus/playlist.m3u8?[...]

$ xidel -se 'let $src:=doc("'$url'"),$cid:=substring(substring-after(unparsed-text($src//script[@crossorigin][last()]/@src),"client_id:"),2,32),$json:=parse-json($src//script/extract(.,"(\[\{.+)\)",1)[.])()[last()]/(data)(),$fmts:=($json//transcodings)() return $json/{"name":concat(user/(full_name,username)[.][1]," - ",title),"date":created_at,"duration":round(duration div 1000) * duration("PT1S"),"formats":array{$fmts[format/protocol="progressive"]/(let $url:=json-doc(concat(url,"?client_id=",$cid))/url return {"id":"pg-1","format":substring-before(preset,"_"),"bitrate":extract($url,"\.(\d+)\.",1)||"kbps","url":$url}),for $x at $i in $fmts[format/protocol="hls"] order by $x/preset descending count $i let $url:=json-doc(concat($x/url,"?client_id=",$cid))/url return {"id":"hls-"||$i,"format":concat("m3u8[",substring-before($x/preset,"_"),"]"),"bitrate":extract($url,"\.(\d+)\.",1)||"kbps","url":$url}}}'
{
  "name": "Laidback Luke - Laidback Luke DJ set Live At Escape From Wonderland Oct 2012",
  "date": "2012-11-05T10:53:55Z",
  "duration": "PT1H11S",
  "formats": [
    {
      "id": "pg-1",
      "format": "mp3",
      "bitrate": "128kbps",
      "url": "https://cf-media.sndcdn.com/gF2U20J9lZfU.128.mp3?[...]"
    },
    {
      "id": "hls-1",
      "format": "m3u8[opus]",
      "bitrate": "64kbps",
      "url": "https://cf-hls-opus-media.sndcdn.com/playlist/gF2U20J9lZfU.64.opus/playlist.m3u8?[...]"
    },
    {
      "id": "hls-2",
      "format": "m3u8[mp3]",
      "bitrate": "128kbps",
      "url": "https://cf-hls-media.sndcdn.com/playlist/gF2U20J9lZfU.128.mp3/playlist.m3u8?[...]"
    }
  ]
}

------------------------------------------------------------------------------------------------

declare function xivid:soundcloud($url as string) as object()? {
  let $src:=doc($url),
      $cid:=substring(
        substring-after(
          unparsed-text($src//script[@crossorigin][last()]/@src),
          "client_id:"
        ),
        2,32
      ),
      $json:=parse-json($src//script/extract(.,"(\[\{.+)\)",1)[.])()[last()]/(data)(),
      $fmts:=($json//transcodings)()
  return
  $json/{
    "name":concat(user/(full_name,username)[.][1]," - ",title),
    "date":created_at,
    "duration":round(duration div 1000) * duration("PT1S"),
    "formats":array{
      $fmts[format/protocol="progressive"]/(
        let $url:=json-doc(concat(url,"?client_id=",$cid))/url return {
          "id":"pg-1",
          "format":substring-before(preset,"_"),
          "bitrate":extract($url,"\.(\d+)\.",1)||"kbps",
          "url":$url
        }
      ),
      for $x at $i in $fmts[format/protocol="hls"]
      order by $x/preset descending
      count $i
      let $url:=json-doc(concat($x/url,"?client_id=",$cid))/url
      return {
        "id":"hls-"||$i,
        "format":concat("m3u8[",substring-before($x/preset,"_"),"]"),
        "bitrate":extract($url,"\.(\d+)\.",1)||"kbps",
        "url":$url
      }
    }
  }
};
